<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIT Challenge PRO</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111827"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FIT Challenge PRO">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/111827/ffffff?text=FIT">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --font-inter: 'Inter', sans-serif;
            
            /* Dark Theme Color Palette */
            --bg-main: #111827; /* Very Dark Blue/Gray */
            --bg-sidebar: #1f2937; /* Dark Slate */
            --bg-card: #1f2937; /* Dark Slate for cards */
            --bg-header: #1f2937;
            --text-light: #f9fafb; /* Almost white */
            --text-dark: #e5e7eb; /* Light Gray */
            --text-muted: #9ca3af; /* Muted Gray */
            --border-color: #374151; /* Darker border */

            --primary-color: #6366f1; /* Indigo */
            --primary-hover: #4f46e5;
            --danger-color: #ef4444; /* Red */
            --danger-hover: #dc2626;
            --success-color: #22c55e; /* Green */
            --success-hover: #16a34a;
            --warning-color: #f59e0b; /* Amber */
            --warning-hover: #d97706;
        }
        html, body { 
            font-family: var(--font-inter); 
            background-color: var(--bg-main); 
            color: var(--text-dark); 
        }
        
        #sidebar { 
            background-color: var(--bg-sidebar);
            transition: transform 0.3s ease-in-out; 
        }
        .sidebar-link { 
            display: flex;
            align-items: center;
            color: var(--text-muted);
            transition: all 0.2s;
        }
        .sidebar-link:hover { 
            background-color: #374151;
            color: var(--text-light);
        }
        .sidebar-link.active { 
            background-color: var(--primary-color); 
            color: white; 
            font-weight: 600; 
        }
        .sidebar-link svg { 
            width: 1.25rem; height: 1.25rem; margin-right: 0.75rem; flex-shrink: 0; 
        }

        /* Modern Table Style */
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th, td { 
            padding: 0.75rem; /* Padding reduzido para melhor visualiza√ß√£o mobile */
            text-align: left; 
            border-bottom: 1px solid var(--border-color); 
            vertical-align: middle; 
        }
        th { 
            background-color: #374151; /* Slightly lighter than card bg */
            font-weight: 600; 
            color: var(--text-muted); 
            position: sticky; top: 0; z-index: 10; 
            font-size: 0.75rem; 
            text-transform: uppercase; 
            letter-spacing: 0.05em; 
        }
        th:first-child { border-top-left-radius: 0.5rem; }
        th:last-child { border-top-right-radius: 0.5rem; }
        tr:last-child td:first-child { border-bottom-left-radius: 0.5rem; }
        tr:last-child td:last-child { border-bottom-right-radius: 0.5rem; }
        tr:last-child td { border-bottom: none; }
        .leader-row { 
            background-color: rgba(99, 102, 241, 0.1) !important; 
            border-left: 4px solid var(--primary-color); 
        }
        
        .card {
            background-color: var(--bg-card);
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }
        .feedback-message { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--success-color); color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); opacity: 0; transition: opacity 0.3s; z-index: 1001; }
        .feedback-message.show { opacity: 1; }
        .feedback-message.error { background-color: var(--danger-color); }
        
        .modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        .modal.show {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content { 
            background-color: #1f2937;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 0.75rem;
            padding: 2rem;
        }
        .close-button { color: #9ca3af; }

        /* Modern Form Elements */
        input, select, textarea {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: var(--text-light);
            border-radius: 0.5rem;
            padding: 0.75rem;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5);
        }
        
        .loader { border: 8px solid #374151; border-top: 8px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        .ai-tip-loader { border: 4px solid #374151; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .profile-card {
            background-color: var(--bg-card);
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            padding: 1.5rem;
        }
        
        .activity-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 0.5rem;
        }
        .activity-cell {
            width: 100%;
            padding-bottom: 100%; /* Creates a square aspect ratio */
            border-radius: 0.25rem;
            position: relative;
            transition: transform 0.2s;
        }
        .activity-cell:hover {
            transform: scale(1.1);
        }
        .activity-cell-label {
            position: absolute;
            top: -1.2rem;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.65rem;
            color: var(--text-muted);
        }
        .activity-cell.current-week {
            border: 2px solid var(--primary-color);
        }
        .activity-none { background-color: #374151; } /* Dark Gray */
        .activity-partial { background-color: var(--warning-color); } /* Amber */
        .activity-complete { background-color: var(--success-color); } /* Green */

        .action-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            color: var(--text-dark);
            font-weight: 600;
            background-color: #374151; /* Cor de fundo padr√£o */
            transition: background-color 0.2s ease-in-out;
            border: none;
            cursor: pointer;
            text-align: center;
        }
        
        .action-btn:hover {
            background-color: #4b5563; /* Cor de fundo um pouco mais clara */
        }

        .imc-badge {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            color: white;
        }
        .imc-normal { background-color: var(--success-color); }
        .imc-sobrepeso { background-color: var(--warning-color); }
        .imc-obesidade { background-color: var(--danger-color); }
        .imc-abaixo { background-color: var(--primary-color); }

        .ai-result-box {
            background-color: var(--bg-main);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            min-height: 100px;
            border: 1px solid var(--border-color);
            white-space: pre-wrap; /* Preserves line breaks from AI */
            max-height: 300px; /* Altura m√°xima para a caixa */
            overflow-y: auto; /* Adiciona scroll se o conte√∫do for maior */
        }

        /* --- REACTION BUTTON STYLES --- */
        .reaction-btn {
            background-color: #374151;
            border: 1px solid #4b5563;
            border-radius: 9999px;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            color: var(--text-muted);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .reaction-btn:hover {
            transform: scale(1.05);
            border-color: var(--primary-color);
        }
        .reaction-btn svg path {
            fill: none;
            stroke: var(--text-muted);
            transition: all 0.2s;
        }
        .reaction-btn:hover svg path {
            stroke: var(--text-light);
        }
        .reaction-btn.reacted {
            background-color: rgba(239, 68, 68, 0.1);
            border-color: var(--danger-color);
            color: var(--danger-color);
        }
        .reaction-btn.reacted svg path {
            fill: var(--danger-color);
            stroke: var(--danger-color);
        }

    </style>
</head>
<body class="bg-gray-900">

    <div id="loginScreen" class="flex items-center justify-center min-h-screen bg-gray-900 p-4">
        <div class="bg-gray-800 p-8 sm:p-10 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700">
            <div class="text-center mb-10">
                <h1 class="text-4xl font-extrabold text-white">FIT Challenge <span style="color: var(--primary-color);">PRO</span></h1>
                <p class="text-gray-400 mt-2">Acesse para acompanhar o desafio</p>
            </div>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-300 mb-1">Usu√°rio</label>
                    <input type="text" id="username" placeholder="Seu usu√°rio" class="w-full" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-300 mb-1">Senha</label>
                    <input type="password" id="password" placeholder="Sua senha" class="w-full" required>
                </div>
                <p id="loginError" class="text-red-500 text-sm italic mb-4 hidden text-center">Usu√°rio ou senha inv√°lidos.</p>
                <button type="submit" style="background-color: var(--primary-color);" class="hover:opacity-90 text-white font-bold py-3 px-6 rounded-lg shadow-md transition w-full">Entrar</button>
            </form>
        </div>
    </div>
    
    <div id="loadingIndicator" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex flex-col items-center justify-center z-50">
        <div class="loader"></div>
        <p class="mt-4 text-lg font-semibold text-gray-300">Carregando dados...</p>
    </div>

    <div id="app" class="hidden flex h-screen font-sans">
        <aside id="sidebar" class="w-64 flex-shrink-0 flex flex-col fixed lg:relative h-full z-30 transform -translate-x-full lg:translate-x-0">
            <div class="px-6 py-4 border-b border-gray-700">
                <h1 class="text-2xl font-bold text-white">FIT <span style="color: var(--primary-color);">PRO</span></h1>
            </div>
            <nav id="sidebarNav" class="flex-1 px-4 py-4 space-y-2 overflow-y-auto"></nav>
            <div class="px-4 py-4 border-t border-gray-700">
                <input type="text" id="searchParticipantInput" placeholder="Buscar participante..." class="w-full">
            </div>
        </aside>

        <div id="sidebar-overlay" class="hidden lg:hidden fixed inset-0 bg-black opacity-50 z-20"></div>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header id="header" class="bg-gray-800 border-b border-gray-700 p-4 flex justify-between items-center z-10">
                <button id="mobileMenuBtn" class="lg:hidden text-gray-400">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-16 6h16"></path></svg>
                </button>
                <h2 id="pageTitle" class="text-xl font-semibold text-white"></h2>
                <div class="flex items-center gap-4">
                   <div id="header-action-buttons" class="hidden sm:flex items-center gap-2 flex-wrap"></div>
                   <button id="logoutBtn" style="background-color: var(--danger-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm">Sair</button>
                </div>
            </header>

            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-900 p-6">
                <div id="summary-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div id="leaderBox" class="card"></div>
                    <div id="weeklyHighlightBox" class="card"></div>
                    <div id="monthlyHighlightBox" class="card"></div>
                    <div id="daysRemainingBox" class="card"></div>
                </div>
                
                <div id="dynamic-content">
                </div>
            </main>
        </div>
    </div>

    <div id="feedbackMessage" class="feedback-message"></div>
    <div id="participantModal" class="modal"></div>
    <div id="deleteConfirmModal" class="modal"></div> <script>
        // --- PWA Service Worker (Placeholder) ---
        if ('serviceWorker' in navigator) {
            const manifest = {
                "name": "FIT Challenge PRO", "short_name": "FIT PRO", "start_url": ".", "display": "standalone",
                "background_color": "#111827", "theme_color": "#4f46e5", "description": "Acompanhamento do FIT Challenge.",
                "icons": [{ "src": "https://placehold.co/192x192/4f46e5/ffffff?text=FIT", "sizes": "192x192", "type": "image/png" }]
            };
            const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(manifestBlob);
            document.querySelector('link[rel="manifest"]').setAttribute('href', manifestURL);
        }
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURA√á√ÉO DO SUPABASE ---
            const SUPABASE_URL = 'https://wkvwrtwovcfnvfgleslq.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndrdndydHdvdmNmbnZmZ2xlc2xxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzNTE2MTQsImV4cCI6MjA2NzkyNzYxNH0.osy_C1SsPJ7t8BJlri7DpVDJU64S_IfRzy9KEBP9VMY';
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            // --- CONFIGURA√á√ïES E CONSTANTES DO DESAFIO ---
            const ADMIN_USER = { username: 'admin', password: 'admin' }; // Admin credentials - Mover para vari√°veis de ambiente ou servi√ßo de autentica√ß√£o!
            let CHALLENGE_START_DATE = new Date('2025-07-07T00:00:00');
            let CHALLENGE_END_DATE = new Date('2025-10-07T23:59:59');
            const MAX_WEEKS = 12;
            const MIN_ACTIVITIES_FOR_VALID_WEEK = 3;
            const MAX_ACTIVITY_POINTS = 50;
            const ACTIVITY_TYPES = ['Muscula√ß√£o', 'Corrida', 'Caminhada', 'Nata√ß√£o', 'Yoga', 'Dan√ßa', 'Ciclismo', 'Outro'];
            
            // --- NAVIGATION LINKS WITH ROLE-BASED ACCESS ---
            const NAV_LINKS = [
                { id: 'myProfile', text: 'Meu Perfil', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>', roles: ['participant'] },
                { id: 'ranking', text: 'Ranking Geral', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>', roles: ['admin', 'participant'] },
                { id: 'activityFeed', text: 'Mural', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path></svg>', roles: ['admin', 'participant'] },
                { id: 'participants', text: 'Participantes', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>', roles: ['admin'] },
                { id: 'aiCenter', text: 'Central de IA', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>', roles: ['admin', 'participant'] },
                { id: 'weeklySummary', text: 'Resumo Semanal', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>', roles: ['admin', 'participant'] },
                { id: 'activityLog', text: 'Hist√≥rico de Atividades', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>', roles: ['admin', 'participant'] },
                { id: 'coachVirtual', text: 'Coach Virtual', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>', roles: ['admin', 'participant'] },
                { id: 'individualEvolution', text: 'Evolu√ß√£o Individual', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"></path></svg>', roles: ['admin', 'participant'] },
                { id: 'groupEvolution', text: 'Evolu√ß√£o do Grupo', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>', roles: ['admin', 'participant']},
                { id: 'comparison', text: 'Comparativo', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>', roles: ['admin', 'participant'] },
                { id: 'rules', text: 'Regras', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>', roles: ['admin', 'participant'] },
                { id: 'configuracoes', text: 'Configura√ß√µes', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>', roles: ['admin'] },
                { id: 'participantProfile', text: 'Perfil do Participante', icon: '', hidden: true, roles: ['admin'] } // Hidden route for admin access
            ];
            
            // --- APPLICATION STATE ---
            let currentUser = null; // Will be an object: { username, role, participantId }
            let participants = [];
            let reactions = [];
            let weeklyPointsWinnerName = null;
            let rankingSortConfig = { key: 'totalPoints', direction: 'desc' };
            let currentProfileParticipantId = null;
            let currentViewId = null; // State to track the current view

            // --- DOM ELEMENTS ---
            const loginScreen = document.getElementById('loginScreen');
            const appContainer = document.getElementById('app');
            const feedbackMessageDiv = document.getElementById('feedbackMessage');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const dynamicContentContainer = document.getElementById('dynamic-content');
            const pageTitle = document.getElementById('pageTitle');
            const headerActionButtons = document.getElementById('header-action-buttons');
            
            // --- INITIALIZATION AND AUTH ---
            function initApp() {
                loadChallengeConfig();
                setupEventListeners();
                checkLoginState();
            }

            async function reloadData() {
                // Mostra um indicador de carregamento r√°pido
                loadingIndicator.classList.remove('hidden');

                // Busca novamente todos os participantes e rea√ß√µes do banco
                const { data: participantsData, error: pError } = await supabase.from('participants').select('*').order('name');
                const { data: reactionsData, error: rError } = await supabase.from('reactions').select('*');

                // Se houver erro, para e avisa
                if (pError || rError) {
                    showFeedbackMessage('Erro ao recarregar os dados.', true);
                    loadingIndicator.classList.add('hidden');
                    return;
                }
                
                // Atualiza as vari√°veis globais com os dados novos e frescos
                participants = participantsData.map(p => ({
                    ...p,
                    semanas_validas: (p.semanas_validas && Array.isArray(p.semanas_validas)) ? p.semanas_validas : Array.from({ length: 12 }, () => []),
                    // Garante que weight_history e measurements_history s√£o arrays, e cada item tem is_public (default true se n√£o existir)
                    weight_history: (p.weight_history || []).map(entry => ({ ...entry, is_public: entry.is_public !== undefined ? entry.is_public : true })),
                    measurements_history: p.measurements_history || [],
                }));
                reactions = reactionsData;
                
                // Esconde o indicador e redesenha a view ATUAL com os dados novos
                loadingIndicator.classList.add('hidden');
                updateCurrentView();
            }

            function loadChallengeConfig() {
                const config = localStorage.getItem('challengeConfig');
                if (config) {
                    const { start, end } = JSON.parse(config);
                    CHALLENGE_START_DATE = new Date(start);
                    CHALLENGE_END_DATE = new Date(end);
                }
            }

            function saveChallengeConfig() {
                localStorage.setItem('challengeConfig', JSON.stringify({
                    start: CHALLENGE_START_DATE.toISOString(),
                    end: CHALLENGE_END_DATE.toISOString()
                }));
            }

            async function loadDataAndLogin(user) {
                loadingIndicator.classList.remove('hidden');
                appContainer.classList.add('opacity-50', 'pointer-events-none');

                const { data: participantsData, error: participantsError } = await supabase.from('participants').select('*').order('name');
                
                if (participantsError) {
                    console.error('Error loading participants data:', participantsError);
                    showFeedbackMessage('Erro ao carregar dados do banco.', true);
                    handleLogout();
                    return;
                }

                participants = participantsData.map(p => ({
                    ...p,
                    semanas_validas: (p.semanas_validas && Array.isArray(p.semanas_validas)) ? p.semanas_validas : Array.from({ length: 12 }, () => []),
                    // Garante que weight_history e measurements_history s√£o arrays, e cada item tem is_public (default true se n√£o existir)
                    weight_history: (p.weight_history || []).map(entry => ({ ...entry, is_public: entry.is_public !== undefined ? entry.is_public : true })),
                    measurements_history: p.measurements_history || [],
                }));

                const { data: reactionsData, error: reactionsError } = await supabase.from('reactions').select('*');
                if (reactionsError) {
                    console.warn("Could not load reactions. This is normal if the table doesn't exist yet.", reactionsError.message);
                    reactions = []; 
                } else {
                    reactions = reactionsData;
                }

                loadingIndicator.classList.add('hidden');
                appContainer.classList.remove('opacity-50', 'pointer-events-none');
                
                currentUser = user;
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                loginScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
                appContainer.classList.add('flex');
                renderSidebarNav();
                
                calculateWeeklyWinners();
                updateSummaryBoxes();
                
                if (currentUser.role === 'admin') {
                    showSection('ranking');
                } else {
                    currentProfileParticipantId = currentUser.participantId;
                    showSection('myProfile');
                }
            }

            function checkLoginState() {
                const storedUser = sessionStorage.getItem('currentUser');
                if (storedUser) {
                    const user = JSON.parse(storedUser);
                    loadDataAndLogin(user);
                } else {
                    loginScreen.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    appContainer.classList.remove('flex');
                    loadingIndicator.classList.add('hidden');
                }
            }

            async function handleLogin(e) {
                e.preventDefault();
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;
                const loginError = document.getElementById('loginError');
                loginError.classList.add('hidden');

                if (username === ADMIN_USER.username && password === ADMIN_USER.password) {
                    const user = { username: ADMIN_USER.username, role: 'admin', participantId: null };
                    await loadDataAndLogin(user);
                    return;
                }

                const { data, error } = await supabase.from('participants').select('*').eq('username', username);

                if (error || !data || data.length === 0) {
                    loginError.classList.remove('hidden');
                    return;
                }
                
                const participant = data[0];
                if (participant.password === password) {
                    const user = { username: participant.username, role: 'participant', participantId: participant.id };
                    await loadDataAndLogin(user);
                } else {
                    loginError.classList.remove('hidden');
                }
            }

            function handleLogout() {
                currentUser = null;
                sessionStorage.removeItem('currentUser');
                participants = [];
                loginScreen.classList.remove('hidden');
                appContainer.classList.add('hidden');
                appContainer.classList.remove('flex');
            }

            // --- EVENT LISTENERS SETUP ---
            function setupEventListeners() {
                document.getElementById('loginForm').addEventListener('submit', handleLogin);
                document.getElementById('logoutBtn').addEventListener('click', handleLogout);
                document.getElementById('searchParticipantInput').addEventListener('keyup', debounce(updateCurrentView, 300));
                
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                document.getElementById('mobileMenuBtn').addEventListener('click', () => {
                    sidebar.classList.remove('-translate-x-full');
                    overlay.classList.remove('hidden');
                });
                overlay.addEventListener('click', () => {
                    sidebar.classList.add('-translate-x-full');
                    overlay.classList.add('hidden');
                });

                appContainer.addEventListener('click', handleMainContentClick);
                
                dynamicContentContainer.addEventListener('change', e => {
                    if (e.target.matches('.comparison-checkbox') || e.target.matches('input[name="comparisonMetric"]')) {
                        updateComparisonChart();
                    }
                });
            }
            
            function renderSidebarNav() {
                const navContainer = document.getElementById('sidebarNav');
                navContainer.innerHTML = '';

                NAV_LINKS.forEach(link => {
                    if (link.hidden || !currentUser || !link.roles.includes(currentUser.role)) return;

                    const navItem = document.createElement('a');
                    navItem.href = '#';
                    navItem.className = 'sidebar-link text-gray-300';
                    navItem.dataset.section = link.id;
                    navItem.innerHTML = `${link.icon}<span>${link.text}</span>`;
                    
                    navItem.addEventListener('click', e => {
                        e.preventDefault();
                        if (link.id === 'myProfile') {
                            currentProfileParticipantId = currentUser.participantId;
                        }
                        showSection(link.id);
                        if (window.innerWidth < 1024) {
                            document.getElementById('sidebar').classList.add('-translate-x-full');
                            document.getElementById('sidebar-overlay').classList.add('hidden');
                        }
                    });
                    navContainer.appendChild(navItem);
                });
            }

            function handleMainContentClick(e) {
                const targetElement = e.target;
                const button = targetElement.closest('button[data-action]');
                const link = targetElement.closest('a[data-action]');
                const th = targetElement.closest('th.sortable');

                if (th) {
                    const sortKey = th.dataset.sortKey;
                    if (rankingSortConfig.key === sortKey) {
                        rankingSortConfig.direction = rankingSortConfig.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        rankingSortConfig.key = sortKey;
                        rankingSortConfig.direction = 'desc';
                    }
                    showSection('ranking');
                    return;
                }

                const interactiveTarget = button || link;
                if (!interactiveTarget) return;

                const action = interactiveTarget.dataset.action;
                const id = interactiveTarget.dataset.id;
                const name = interactiveTarget.dataset.name;

                switch(action) {
                    case 'open-add-modal': openParticipantModal(); break;
                    case 'open-edit-modal': openParticipantModal(id); break;
                    case 'open-delete-modal': 
                        openConfirmModal(`Tem certeza que deseja excluir <strong>${name}</strong>? Esta a√ß√£o n√£o pode ser desfeita.`, () => {
                            // A√ß√£o de exclus√£o do participante
                            supabase.from('participants').delete().eq('id', id)
                                .then(({ error }) => {
                                    if (error) showFeedbackMessage('Erro ao excluir participante.', true);
                                    else { showFeedbackMessage("Participante exclu√≠do com sucesso!"); loadDataAndLogin(currentUser); }
                                    document.getElementById('deleteConfirmModal').classList.remove('show');
                                    document.body.style.overflow = 'auto';
                                });
                        });
                        break;
                    case 'view-profile': e.preventDefault(); currentProfileParticipantId = id; showSection('participantProfile'); break;
                    case 'go-to-participants': e.preventDefault(); showSection('participants'); break;
                    case 'generate-report': exportDetailsToPDF(id); break;
                    case 'ai-coach': getAICoachingTip(id); break;
                    case 'update-weight': handleUpdateWeight(id); break;
                    case 'detect-weight-ai': detectWeightFromImage(id); break; // Nova a√ß√£o para IA
                    case 'delete-weight-entry': 
                        const entryDate = interactiveTarget.dataset.entryDate;
                        openConfirmModal(`Tem certeza que deseja excluir este registro de peso de ${name} (${new Date(entryDate).toLocaleDateString('pt-BR')})?`, () => handleDeleteWeightEntryConfirmed(id, entryDate));
                        break;
                    case 'add-activity': handleAddActivity(id); break;
                    case 'delete-activity': 
                        const week = interactiveTarget.dataset.week;
                        const activityId = interactiveTarget.dataset.activityId;
                        openConfirmModal(`Tem certeza que deseja excluir esta atividade de ${name} (Semana ${parseInt(week) + 1})?`, () => handleDeleteActivityConfirmed(id, week, activityId));
                        break;
                    case 'update-measurements': handleUpdateMeasurements(id); break;
                    case 'generate-meal-plan': handleGenerateMealPlan(); break;
                    case 'generate-workout': handleGenerateWorkout(); break;
                    case 'generate-motivation': handleGenerateMotivation(); break;
                    case 'generate-group-analysis': handleGenerateGroupAnalysis(); break;
                    case 'generate-stagnation-tip': handleGenerateStagnationTip(); break;
                    case 'react': handleReactionClick(interactiveTarget); break;
                }
            }
            
            // --- DATA & VIEW MANAGEMENT ---
            function calculateIMC(weight, height) {
                if (!weight || !height || height <= 0) {
                    return { value: 'N/A', classification: 'Dados incompletos', className: '' };
                }
                const imc = weight / (height * height);
                let classification = '';
                let className = '';
                if (imc < 18.5) {
                    classification = 'Abaixo do peso';
                    className = 'imc-abaixo';
                } else if (imc < 24.9) {
                    classification = 'Peso Normal';
                    className = 'imc-normal';
                } else if (imc < 29.9) {
                    classification = 'Sobrepeso';
                    className = 'imc-sobrepeso';
                } else {
                    classification = 'Obesidade';
                    className = 'imc-obesidade';
                }
                return { value: imc.toFixed(1), classification, className };
            }

            function calculateMetrics(p, referenceDate = new Date()) {
                const pesoNaData = getWeightAtDate(p, referenceDate); // Peso mais recente at√© a data de refer√™ncia
                
                const pesoPerdido = p.peso_inicial - pesoNaData; // Perda de peso em rela√ß√£o ao peso inicial
                const percentLoss = p.peso_inicial > 0 ? (pesoPerdido / p.peso_inicial) * 100 : 0;
                let weightPoints = 0;
                if (percentLoss >= 15) weightPoints = 50; else if (percentLoss >= 12) weightPoints = 40;
                else if (percentLoss >= 10) weightPoints = 35; else if (percentLoss >= 8) weightPoints = 30;
                else if (percentLoss >= 6) weightPoints = 20; else if (percentLoss >= 4) weightPoints = 15;
                else if (percentLoss >= 2) weightPoints = 10; else if (percentLoss > 0) weightPoints = 5;
                
                const semanasConsideradas = p.semanas_validas || [];
                const validWeeksCount = semanasConsideradas.filter(week => Array.isArray(week) && week.length >= MIN_ACTIVITIES_FOR_VALID_WEEK).length;
                const totalActivities = semanasConsideradas.reduce((sum, week) => sum + (Array.isArray(week) ? week.length : 0), 0);
                const activityPoints = (validWeeksCount / MAX_WEEKS) * MAX_ACTIVITY_POINTS;
                
                let progressToTarget = null;
                if (p.target_weight && p.peso_inicial > p.target_weight) {
                    const totalNeeded = p.peso_inicial - p.target_weight;
                    const currentLossToTarget = p.peso_inicial - pesoNaData; // Usa pesoNaData para o progresso da meta
                    progressToTarget = Math.max(0, Math.min(100, (currentLossToTarget / totalNeeded) * 100));
                }
                
                // O IMC deve ser calculado com base no peso na data de refer√™ncia
                const imcData = calculateIMC(pesoNaData, p.altura);

                // O 'peso_atual' retornado pelo calculateMetrics agora √© o pesoNaData
                return { 
                    ...p, 
                    name: p.name, 
                    peso_atual: pesoNaData, // Garante que peso_atual reflete o pesoNaData
                    pesoPerdidoTotal: pesoPerdido, 
                    percentLoss: Math.max(0, percentLoss), 
                    weightPoints, 
                    validWeeksCount, 
                    totalActivities, 
                    activityPoints, 
                    totalPoints: weightPoints + activityPoints, 
                    progressToTarget, 
                    imc: imcData.value, 
                    imcClassification: imcData.classification, 
                    imcClassName: imcData.className 
                };
            }

            function getBadges(p) {
                let badges = '';
                // Assegura que peso_atual aqui tamb√©m usa o peso mais recente (que agora √© retornado por calculateMetrics)
                if (p.target_weight && p.peso_atual <= p.target_weight) badges += `<span class="badge" title="Meta Atingida!">üéØ</span>`;
                const pesoPerdido = p.peso_inicial - p.peso_atual; // p.peso_atual j√° √© o pesoNaData aqui
                if (pesoPerdido >= 10) badges += `<span class="badge" title="Clube dos 10kg!">üîü</span>`;
                else if (pesoPerdido >= 5) badges += `<span class="badge" title="Clube dos 5kg!">5Ô∏è‚É£</span>`;
                const consecutive = (p.semanas_validas || []).map(w => (Array.isArray(w) && w.length >= MIN_ACTIVITIES_FOR_VALID_WEEK) ? '1' : '0').join('').split('0').reduce((max, s) => Math.max(max, s.length), 0);
                if (consecutive >= 4) badges += `<span class="badge" title="${consecutive} Semanas em Chamas!">üî•</span>`;
                if (p.name === weeklyPointsWinnerName) badges += `<span class="badge" title="Rei/Rainha da Semana!">üëë</span>`;
                return badges;
            }

            function getWeightAtDate(participant, targetDate) {
                const history = participant.weight_history || [];
                // Filtra entradas do hist√≥rico que s√£o na ou antes da data alvo
                const relevantHistory = history.filter(entry => new Date(entry.date) <= targetDate); 
                
                if (relevantHistory.length === 0) {
                    // Se n√£o h√° hist√≥rico relevante, retorna o peso inicial do participante
                    return participant.peso_inicial;
                }
                
                // Ordena o hist√≥rico relevante para pegar a entrada mais recente
                relevantHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                return relevantHistory[0].weight; // Retorna o peso da entrada mais recente
            }

            function calculateWeeklyWinners() {
                const today = new Date();
                const oneWeekAgo = new Date(); oneWeekAgo.setDate(today.getDate() - 7);
                let weeklyWinner = { name: null, pointsGained: -1 };
                participants.forEach(p => {
                    // calculateMetrics j√° usa getWeightAtDate internamente
                    const pointsNow = calculateMetrics(p, today).totalPoints; 
                    const pointsThen = calculateMetrics(p, oneWeekAgo).totalPoints;
                    const pointsGained = pointsNow - pointsThen;
                    if (pointsGained > weeklyWinner.pointsGained) weeklyWinner = { name: p.name, pointsGained };
                });
                weeklyPointsWinnerName = weeklyWinner.pointsGained > 0 ? weeklyWinner.name : null;
            }

            function updateCurrentView() {
                if (!currentUser) return;
                calculateWeeklyWinners();
                
                if (currentViewId) {
                    showSection(currentViewId);
                } else {
                    const initialSection = currentUser.role === 'admin' ? 'ranking' : 'myProfile';
                    showSection(initialSection);
                }
                updateSummaryBoxes();
            }

            function showSection(sectionId) {
                currentViewId = sectionId;
                const link = NAV_LINKS.find(l => l.id === sectionId);
                if (!link || !currentUser || !link.roles.includes(currentUser.role)) {
                    // Fallback para uma se√ß√£o permitida se a se√ß√£o solicitada n√£o for v√°lida para o usu√°rio
                    return showSection(currentUser.role === 'admin' ? 'ranking' : 'myProfile');
                }
                
                pageTitle.textContent = link.text;
                if (sectionId === 'myProfile') {
                    pageTitle.textContent = 'Meu Perfil';
                }
                
                // Passa a data atual como refer√™ncia para calculateMetrics aqui tamb√©m
                const allMetrics = participants.map(p => calculateMetrics(p, new Date())); 
                const searchTerm = document.getElementById('searchParticipantInput').value.toLowerCase();
                const filteredMetrics = allMetrics.filter(p => p.name.toLowerCase().includes(searchTerm));

                dynamicContentContainer.innerHTML = '<div class="card"></div>';
                const contentWrapper = dynamicContentContainer.firstChild;
                headerActionButtons.innerHTML = '';
                document.getElementById('summary-grid').style.display = 'grid';

                switch(sectionId) {
                    case 'ranking': renderRankingTable(sortData(filteredMetrics, rankingSortConfig), contentWrapper); break;
                    case 'participants': renderParticipantsPage(filteredMetrics, dynamicContentContainer); break; // Renders directly
                    case 'participantProfile':
                    case 'myProfile':
                        renderParticipantProfilePage(dynamicContentContainer);
                        document.getElementById('summary-grid').style.display = 'none';
                        break;
                    case 'aiCenter':
                        renderAiCenterPage(dynamicContentContainer);
                        document.getElementById('summary-grid').style.display = 'none';
                        break;
                    case 'activityFeed':
                        renderActivityFeedPage(dynamicContentContainer);
                        document.getElementById('summary-grid').style.display = 'none';
                        break;
                    case 'weeklySummary': renderWeeklySummaryPage(allMetrics, contentWrapper); break;
                    case 'activityLog': renderActivityLogPage(filteredMetrics, dynamicContentContainer); break; // Renders directly
                    case 'coachVirtual': renderCoachVirtualPage(contentWrapper); break;
                    case 'individualEvolution': renderIndividualEvolutionPage(allMetrics, contentWrapper); break;
                    case 'groupEvolution': renderGroupEvolutionChart(allMetrics, contentWrapper); break;
                    case 'comparison': renderComparisonChart(allMetrics, contentWrapper); break;
                    case 'rules': renderRulesPage(contentWrapper); break;
                    case 'configuracoes': renderSettingsPage(contentWrapper); break;
                }
                
                document.querySelectorAll('.sidebar-link').forEach(item => item.classList.toggle('active', item.dataset.section === sectionId));
            }
            
            function sortData(data, config) {
                return [...data].sort((a, b) => {
                    if (a[config.key] < b[config.key]) return config.direction === 'asc' ? -1 : 1;
                    if (a[config.key] > b[config.key]) return config.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            // --- PAGE RENDERERS ---

            function renderRankingTable(data, container) {
                // calculateMetrics j√° √© chamado com a data atual em showSection, ent√£o os dados 'p' aqui j√° s√£o os mais recentes
                const pointRanked = [...participants.map(p => calculateMetrics(p))].sort((a, b) => b.totalPoints - a.totalPoints);
                const sortArrow = (key) => rankingSortConfig.key === key ? (rankingSortConfig.direction === 'asc' ? ' ‚ñ≤' : ' ‚ñº') : '';
                
                let tableHTML = `<div class="overflow-x-auto"><table class="w-full"><thead><tr>
                    <th class="sortable" data-sort-key="totalPoints">Rank${sortArrow('totalPoints')}</th>
                    <th class="sortable" data-sort-key="name">Nome${sortArrow('name')}</th>
                    <th>Progresso Meta</th>
                    <th class="sortable" data-sort-key="percentLoss">% Perda${sortArrow('percentLoss')}</th>
                    <th class="sortable" data-sort-key="weightPoints">Pts. Peso${sortArrow('weightPoints')}</th>
                    <th class="sortable" data-sort-key="activityPoints">Pts. Ativ.${sortArrow('activityPoints')}</th>
                    <th class="sortable" data-sort-key="totalPoints">Total${sortArrow('totalPoints')}</th>
                </tr></thead><tbody>`;
                
                if (data.length === 0) {
                    tableHTML += `<tr><td colspan="7" class="text-center py-4 text-gray-500">Nenhum participante encontrado.</td></tr>`;
                } else {
                    data.forEach(p => {
                        const pointRankIndex = pointRanked.findIndex(rankedP => rankedP.name === p.name);
                        const medal = ['üèÜ', 'ü•à', 'ü•â'][pointRankIndex] || '';
                        const progress = p.progressToTarget !== null ? `<div class="w-full bg-gray-600 rounded-full h-2.5"><div class="bg-indigo-500 h-2.5 rounded-full" style="width: ${p.progressToTarget}%" title="${p.progressToTarget.toFixed(1)}%"></div></div>` : 'N/A';
                        const avatarSrc = p.avatar_url || `https://placehold.co/40x40/E2E8F0/4A5568?text=${p.name.charAt(0)}`;
                        
                        let nameHTML = p.name;
                        if (currentUser.role === 'admin') {
                             nameHTML = `<a href="#" style="color: var(--primary-color);" class="hover:underline font-semibold" data-action="view-profile" data-id="${p.id}">${p.name}</a>`;
                        }

                        tableHTML += `<tr class="${pointRankIndex === 0 ? 'leader-row' : ''}">
                            <td class="font-semibold">${pointRankIndex + 1}</td>
                            <td class="py-2">
                                <div class="flex items-center">
                                    <img src="${avatarSrc}" alt="Avatar de ${p.name}" class="w-8 h-8 rounded-full mr-3 object-cover flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/40x40/E2E8F0/4A5568?text=${p.name.charAt(0)}';">
                                    <div>
                                        ${nameHTML}
                                        <span class="ml-1">${medal} ${getBadges(p)}</span>
                                    </div>
                                </div>
                            </td>
                            <td>${progress}</td>
                            <td>${p.percentLoss.toFixed(2)}%</td>
                            <td>${p.weightPoints.toFixed(2)}</td>
                            <td>${p.activityPoints.toFixed(2)}</td>
                            <td class="font-bold">${p.totalPoints.toFixed(2)}</td>
                        </tr>`;
                    });
                }
                tableHTML += `</tbody></table></div>`;
                container.innerHTML = tableHTML;
            }

            function renderParticipantsPage(data, container) {
                if (currentUser.role !== 'admin') return;
                
                headerActionButtons.innerHTML = `<button data-action="open-add-modal" style="background-color: var(--success-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm">Adicionar Participante</button>`;

                if (data.length === 0) {
                    container.innerHTML = `<div class="card"><div class="text-center py-10 text-gray-500">Nenhum participante encontrado. Clique em "Adicionar Participante" para come√ßar.</div></div>`;
                    return;
                }

                let cardsHTML = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">';
                // Garante que os dados de participantes est√£o atualizados para a renderiza√ß√£o
                const participantsToRender = participants.map(p => calculateMetrics(p, new Date()));

                participantsToRender.sort((a,b) => a.name.localeCompare(b.name)).forEach(p => {
                    const avatarSrc = p.avatar_url || `https://placehold.co/80x80/E2E8F0/4A5568?text=${p.name.charAt(0)}`;
                    const pesoPerdido = p.pesoPerdidoTotal; 
                    cardsHTML += `
                        <div class="card transform hover:bg-gray-700 transition-colors duration-300 flex flex-col">
                            <div class="p-5 flex-grow">
                                <div class="flex items-center gap-4 mb-4">
                                    <img src="${avatarSrc}" alt="Avatar de ${p.name}" class="w-16 h-16 rounded-full object-cover border-2 border-gray-700" onerror="this.onerror=null;this.src='https://placehold.co/80x80/E2E8F0/4A5568?text=${p.name.charAt(0)}';">
                                    <div>
                                        <h3 class="text-lg font-bold text-white">${p.name}</h3>
                                        <p class="text-sm text-gray-400">Total: ${p.totalPoints.toFixed(1)} pts</p>
                                    </div>
                                </div>
                                <div class="text-sm space-y-1">
                                    <p><strong>Peso Atual:</strong> ${p.peso_atual.toFixed(1)} kg</p>
                                    <p><strong>Perda Total:</strong> <span class="${pesoPerdido >= 0 ? 'text-green-400' : 'text-red-400'} font-semibold">${pesoPerdido.toFixed(1)} kg</span></p>
                                </div>
                            </div>
                            <div class="bg-gray-800 p-3 grid grid-cols-3 gap-2 rounded-b-lg">
                                <button data-action="view-profile" data-id="${p.id}" class="action-btn">Ver Perfil</button>
                                <button data-action="open-edit-modal" data-id="${p.id}" class="action-btn">Editar</button>
                                <button data-action="open-delete-modal" data-id="${p.id}" data-name="${p.name}" class="action-btn">Excluir</button>
                            </div>
                        </div>
                    `;
                });
                cardsHTML += '</div>';
                container.innerHTML = cardsHTML;
            }

            function renderParticipantProfilePage(container) {
                // Ao renderizar o perfil, sempre pegue o peso mais atual
                const pMetric = calculateMetrics(participants.find(p => p.id == currentProfileParticipantId), new Date()); 
                if (!pMetric) {
                    container.innerHTML = `<div class="card"><div class="text-center py-10 text-gray-500">Participante n√£o encontrado.</div></div>`;
                    return;
                }
                
                const isOwnProfile = currentUser.participantId == pMetric.id;
                const canEditProfile = currentUser.role === 'admin' || isOwnProfile;

                const avatarSrc = pMetric.avatar_url || `https://placehold.co/100x100/E2E8F0/4A5568?text=${pMetric.name.charAt(0)}`;
                const todayStr = new Date().toISOString().split('T')[0];
                const lastM = pMetric.measurements_history && pMetric.measurements_history.length > 0 ? pMetric.measurements_history[pMetric.measurements_history.length - 1] : {};

                let backButtonHTML = '';
                if (currentUser.role === 'admin' && !isOwnProfile) {
                    backButtonHTML = `<a href="#" data-action="go-to-participants" style="color: var(--primary-color);" class="hover:underline mb-4 inline-block">&larr; Voltar para todos os participantes</a>`;
                }
                
                const pesoPerdido = pMetric.pesoPerdidoTotal; // J√° usa pesoNaData atual

                container.innerHTML = `
                    <div id="profile-content" class="max-w-4xl mx-auto space-y-6">
                        <div class="flex justify-between items-start mb-2">
                            ${backButtonHTML}
                            ${currentUser.role === 'admin' ? `<div><button data-action="generate-report" data-id="${pMetric.id}" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded-lg text-sm">Gerar PDF</button></div>` : '<div></div>'}
                        </div>

                        <div class="profile-card flex flex-col sm:flex-row items-center gap-6">
                            <img src="${avatarSrc}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/E2E8F0/4A5568?text=${pMetric.name.charAt(0)}';" class="rounded-full w-24 h-24 object-cover border-4 border-indigo-500">
                            <div class="flex-grow text-center sm:text-left">
                                <h3 class="text-3xl font-bold text-white">${pMetric.name} <span class="text-2xl">${getBadges(pMetric)}</span></h3>
                                <div class="flex items-center gap-4 mt-1 justify-center sm:justify-start flex-wrap">
                                    <p class="text-gray-400">Altura: ${pMetric.altura ? pMetric.altura.toFixed(2) + 'm' : 'N/A'}</p>
                                    <p class="text-gray-400 flex items-center gap-2">IMC: <strong>${pMetric.imc}</strong> <span class="imc-badge ${pMetric.imcClassName}">${pMetric.imcClassification}</span></p>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-4 text-center w-full sm:w-auto mt-4 sm:mt-0">
                                <div>
                                    <p class="text-2xl font-bold text-indigo-400">${pMetric.totalPoints.toFixed(1)}</p>
                                    <p class="text-xs text-gray-400 uppercase">Pontos</p>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold ${pesoPerdido >= 0 ? 'text-green-400' : 'text-red-400'}">${pesoPerdido.toFixed(1)}</p>
                                    <p class="text-xs text-gray-400 uppercase">Kg Perdidos</p>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-indigo-400">${pMetric.progressToTarget ? pMetric.progressToTarget.toFixed(0) : '0'}%</p>
                                    <p class="text-xs text-gray-400 uppercase">Meta</p>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="space-y-6">
                                ${canEditProfile ? `
                                <div class="profile-card">
                                    <h4 class="font-bold text-lg mb-4 text-white">Registrar Peso</h4>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="text-sm font-medium text-gray-300">Novo Peso (kg)</label>
                                            <input id="profile-weight-input" type="number" step="any" class="mt-1 w-full p-2" placeholder="${pMetric.peso_atual.toFixed(2)}">
                                        </div>
                                        <div>
                                            <label class="text-sm font-medium text-gray-300">Data do Registro</label>
                                            <input id="profile-weight-date" type="date" class="mt-1 w-full p-2" value="${todayStr}" max="${todayStr}" ${currentUser.role !== 'admin' ? 'readonly' : ''}>
                                        </div>
                                        
                                        <div class="border border-gray-700 p-3 rounded-lg bg-gray-800">
                                            <label for="profile-weight-photo" class="block text-sm font-medium text-gray-300 mb-1">Foto da Balan√ßa (Opcional)</label>
                                            <input type="file" id="profile-weight-photo" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-200 file:text-indigo-700 hover:file:bg-indigo-300" accept="image/*">
                                            <button data-action="detect-weight-ai" data-id="${pMetric.id}" class="w-full mt-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md text-sm">Detectar Peso (IA)</button>
                                            <p id="ai-weight-feedback" class="text-xs text-gray-400 mt-2 text-center"></p>
                                            <div class="mt-2">
                                                <label for="profile-weight-photo-privacy" class="block text-sm font-medium text-gray-300 mb-1">Privacidade da Foto:</label>
                                                <select id="profile-weight-photo-privacy" class="w-full p-2">
                                                    <option value="public">P√∫blico (Vis√≠vel no Mural)</option>
                                                    <option value="private">Privado (Vis√≠vel apenas pra voc√™ e Administrador)</option>
                                                </select>
                                            </div>
                                        </div>

                                        <button data-action="update-weight" data-id="${pMetric.id}" style="background-color: var(--primary-color);" class="w-full hover:opacity-90 text-white font-bold py-2.5 px-4 rounded-md">Salvar Peso</button>
                                    </div>
                                </div>
                                <div class="profile-card">
                                    <h4 class="font-bold text-lg mb-4 text-white">Registrar Atividade</h4>
                                    <div class="space-y-4">
                                        <div><label class="text-sm font-medium text-gray-300">Tipo</label><select id="profile-activity-type" class="mt-1 w-full p-2">${ACTIVITY_TYPES.map(t => `<option value="${t}">${t}</option>`).join('')}</select></div>
                                        <div><label class="text-sm font-medium text-gray-300">Dura√ß√£o (min)</label><input type="number" id="profile-activity-duration" class="w-full p-2"></div>
                                        <div>
                                            <label for="profile-activity-photo" class="text-sm font-medium text-gray-300">Foto do Treino (Opcional)</label>
                                            <input type="file" id="profile-activity-photo" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-200 file:text-indigo-700 hover:file:bg-indigo-300" accept="image/*">
                                            <div class="mt-2">
                                                <label for="profile-activity-photo-privacy" class="block text-sm font-medium text-gray-300 mb-1">Privacidade da Foto:</label>
                                                <select id="profile-activity-photo-privacy" class="w-full p-2">
                                                    <option value="public">P√∫blico (Vis√≠vel no Mural)</option>
                                                    <option value="private">Privado (Vis√≠vel apenas pra voc√™ e Administrador)</option>
                                                </select>
                                            </div>
                                        </div>
                                        <button data-action="add-activity" data-id="${pMetric.id}" style="background-color: var(--success-color);" class="w-full hover:opacity-90 text-white font-bold py-2.5 px-4 rounded-md">Adicionar Atividade</button>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            <div class="space-y-6">
                                <div class="profile-card"><h4 class="font-bold text-lg mb-3 text-white">Hist√≥rico de Pesagem</h4><div id="profile-weight-history-list" class="max-h-60 overflow-y-auto pr-2 space-y-2"></div></div>
                                <div class="profile-card"><h4 class="font-bold text-lg mb-3 text-white">Hist√≥rico de Atividades</h4><div id="profile-activity-history-list" class="max-h-60 overflow-y-auto pr-2 space-y-2"></div></div>
                                <div class="profile-card">
                                    <h4 class="font-bold text-lg mb-3 text-white">Medidas Corporais (cm)</h4>
                                    ${canEditProfile ? `
                                    <div class="grid grid-cols-1 sm:grid-cols-4 gap-3 items-end">
                                        <div><label class="text-xs font-medium text-gray-300">Cintura</label><input type="number" step="any" id="profile-cintura" class="w-full p-2" value="${lastM.cintura || ''}"></div>
                                        <div><label class="text-xs font-medium text-gray-300">Quadril</label><input type="number" step="any" id="profile-quadril" class="w-full p-2" value="${lastM.quadril || ''}"></div>
                                        <div><label class="text-xs font-medium text-gray-300">Abd√¥men</label><input type="number" step="any" id="profile-abdomen" class="w-full p-2" value="${lastM.abdomen || ''}"></div>
                                        <button data-action="update-measurements" data-id="${pMetric.id}" style="background-color: var(--primary-color);" class="w-full hover:opacity-90 text-white font-bold py-2 px-4 rounded-md h-10">Salvar</button>
                                    </div>
                                    ` : `
                                    <div class="grid grid-cols-3 gap-4 text-center">
                                        <div><p class="text-sm text-gray-400">Cintura</p><p class="font-bold text-lg text-white">${lastM.cintura || 'N/A'}</p></div>
                                        <div><p class="text-sm text-gray-400">Quadril</p><p class="font-bold text-lg text-white">${lastM.quadril || 'N/A'}</p></div>
                                        <div><p class="text-sm text-gray-400">Abd√¥men</p><p class="font-bold text-lg text-white">${lastM.abdomen || 'N/A'}</p></div>
                                    </div>
                                    `}
                                </div>
                                <div class="profile-card">
                                    <div class="flex justify-between items-center mb-3">
                                        <h4 class="text-lg font-semibold text-white">ü§ñ Dica do Coach</h4>
                                        <button data-action="ai-coach" data-id="${pMetric.id}" style="background-color: var(--primary-color);" class="hover:opacity-90 text-white font-bold py-2 px-3 rounded-lg text-sm">Gerar Dica</button>
                                    </div>
                                    <div id="ai-tip-container" class="p-4 bg-gray-800 rounded-lg text-gray-300 min-h-[80px]">Clique no bot√£o para receber uma dica personalizada.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                updateProfileWeightList(pMetric);
                updateProfileActivityList(pMetric);
            }
            
            function renderAiCenterPage(container) {
                container.innerHTML = `
                    <div class="space-y-6">
                        <div class="text-center">
                            <h2 class="text-3xl font-extrabold text-white">Central de IA ü§ñ</h2>
                            <p class="mt-2 text-lg text-gray-400">Ferramentas inteligentes para turbinar seu desafio.</p>
                        </div>
                        
                        ${currentUser.role === 'admin' ? `
                        <div class="card">
                            <h3 class="text-xl font-bold text-red-400 mb-2">An√°lise de Tend√™ncias do Grupo (Admin)</h3>
                            <p class="text-sm text-gray-400 mb-4">Receba uma an√°lise inteligente sobre o desempenho geral do grupo, identificando tend√™ncias e sugerindo a√ß√µes.</p>
                            <button data-action="generate-group-analysis" style="background-color: var(--danger-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg">Analisar Grupo</button>
                            <div id="group-analysis-result" class="ai-result-box">Clique em "Analisar" para receber os insights.</div>
                        </div>

                        <div class="card">
                            <h3 class="text-xl font-bold text-blue-400 mb-2">Dica Anti-Plat√¥ (Admin)</h3>
                            <p class="text-sm text-gray-400 mb-4">Verifique se algum participante est√° estagnado e gere uma dica para ajud√°-lo a quebrar o plat√¥.</p>
                            <div class="flex items-center gap-4 mb-4">
                                <select id="stagnation-participant-selector" class="w-full">${participants.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}</select>
                            </div>
                            <button data-action="generate-stagnation-tip" style="background-color: #3b82f6;" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg">Verificar e Gerar Dica</button>
                            <div id="stagnation-tip-result" class="ai-result-box">Selecione um participante e clique para verificar se est√° em um plat√¥ e receber uma dica.</div>
                        </div>
                        ` : ''}

                        <div class="card">
                            <h3 class="text-xl font-bold text-indigo-400 mb-2">Plano de Refei√ß√µes Sugerido</h3>
                            <p class="text-sm text-gray-400 mb-4">Receba um card√°pio di√°rio, gerado por IA, com base no seu perfil e metas.</p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label for="liked-foods" class="block text-sm font-medium text-gray-300 mb-1">Meus alimentos preferidos:</label>
                                    <textarea id="liked-foods" rows="2" class="w-full" placeholder="Ex: frango, batata doce, salada"></textarea>
                                </div>
                                <div>
                                    <label for="disliked-foods" class="block text-sm font-medium text-gray-300 mb-1">Alimentos a evitar (restri√ß√µes, etc.):</label>
                                    <textarea id="disliked-foods" rows="2" class="w-full" placeholder="Ex: br√≥colis, lactose, gl√∫ten"></textarea>
                                </div>
                            </div>
                            <button data-action="generate-meal-plan" style="background-color: var(--primary-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg">Gerar Card√°pio do Dia</button>
                            <div id="meal-plan-result" class="ai-result-box">Preencha suas prefer√™ncias e clique em "Gerar" para receber sua sugest√£o.</div>
                        </div>

                        <div class="card">
                            <h3 class="text-xl font-bold text-green-400 mb-2">Sugest√£o de Treino Din√¢mica</h3>
                            <p class="text-sm text-gray-400 mb-4">Com base nas suas atividades recentes, a IA sugere treinos complementares para otimizar seus resultados.</p>
                            <button data-action="generate-workout" style="background-color: var(--success-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg">Sugerir Pr√≥ximo Treino</button>
                            <div id="workout-result" class="ai-result-box">Clique em "Gerar" para receber sua sugest√£o.</div>
                        </div>

                        <div class="card">
                            <h3 class="text-xl font-bold text-amber-400 mb-2">Resumo Semanal</h3>
                            <p class="text-sm text-gray-400 mb-4">Receba uma an√°lise motivacional do seu progresso na √∫ltima semana, escrita pela nossa IA.</p>
                            <button data-action="generate-motivation" style="background-color: var(--warning-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg">Gerar Resumo da Semana</button>
                            <div id="motivation-result" class="ai-result-box">Clique em "Gerar" para receber sua an√°lise.</div>
                        </div>
                    </div>
                `;
            }

            function renderActivityFeedPage(container) {
                let allActivities = [];
                const now = new Date();

                participants.forEach(p => {
                    // Adiciona atividades de peso ao mural se forem p√∫blicas ou se for admin
                    p.weight_history.forEach(wh => {
                        // Garante que a data de registro de peso n√£o √© no futuro (para evitar posts "futuros" no mural)
                        if (new Date(wh.date) <= now && (wh.imageUrl && (wh.is_public || currentUser.role === 'admin'))) {
                             // ID √∫nico para a entrada de peso no mural. Use um prefixo para distinguir.
                            const weightEntryId = `weight-${p.id}-${new Date(wh.date).getTime()}`; 
                            allActivities.push({
                                id: weightEntryId,
                                participantId: p.id,
                                participantName: p.name,
                                participantAvatar: p.avatar_url || `https://placehold.co/48x48/E2E8F0/4A5568?text=${p.name.charAt(0)}`,
                                type: 'Pesagem',
                                duration: null,
                                date: wh.date,
                                imageUrl: wh.imageUrl,
                                is_public: wh.is_public,
                                // Adiciona um texto descritivo para a pesagem
                                description: `pesou ${parseFloat(wh.weight).toFixed(1)} kg.`, 
                                isWeightEntry: true
                            });
                        }
                    });

                    // Adiciona atividades de treino ao mural
                    (p.semanas_validas || []).flat().forEach(act => {
                        // Garante que a data da atividade n√£o √© no futuro
                        if (new Date(act.date) <= now) {
                            // Se a atividade tem foto, verifica a privacidade
                            if (act.imageUrl) {
                                if (act.is_public || currentUser.role === 'admin') {
                                    allActivities.push({
                                        ...act,
                                        participantId: p.id,
                                        participantName: p.name,
                                        participantAvatar: p.avatar_url || `https://placehold.co/48x48/E2E8F0/4A5568?text=${p.name.charAt(0)}`,
                                        isWeightEntry: false
                                    });
                                }
                            } else {
                                // Atividades sem foto sempre s√£o consideradas p√∫blicas no mural (se n√£o houver outro requisito)
                                allActivities.push({
                                    ...act,
                                    participantId: p.id,
                                    participantName: p.name,
                                    participantAvatar: p.avatar_url || `https://placehold.co/48x48/E2E8F0/4A5568?text=${p.name.charAt(0)}`,
                                    isWeightEntry: false
                                });
                            }
                        }
                    });
                });

                // Ordena por data, mais recente primeiro
                allActivities.sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime()); 

                const heartSVG = `
                    <svg class="w-6 h-6" viewBox="0 0 24 24">
                        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                    </svg>
                `;
                const privateSVG = `<svg class="w-4 h-4 text-gray-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path></svg>`;

                let feedHTML = `
                    <div class="space-y-4 max-w-2xl mx-auto">
                        <div class="text-center mb-6">
                            <h2 class="text-3xl font-extrabold text-white">Mural de Conquistas</h2>
                            <p class="mt-2 text-lg text-gray-400">Veja e reaja √†s atividades recentes do grupo!</p>
                        </div>
                `;

                if (allActivities.length === 0) {
                    feedHTML += `<div class="card text-center py-10 text-gray-500">Nenhuma atividade registrada ainda. Seja o primeiro!</div>`;
                } else {
                    allActivities.slice(0, 50).forEach(item => { // Limit to last 50 activities
                        const itemId = item.id; 
                        const itemDate = new Date(item.date);
                        const timeAgo = formatTimeAgo(itemDate);

                        // Ajuste para garantir que r.activity_id √© compar√°vel ao itemId (que pode ser string ou number)
                        const itemReactions = reactions.filter(r => r.activity_id == itemId); 
                        const count = itemReactions.length;
                        
                        const userReacted = reactions.some(r => r.activity_id == itemId && r.user_id == currentUser.participantId);

                        const reactionsHTML = `
                            <button data-action="react" data-activity-id="${itemId}" data-reaction-type="‚ù§Ô∏è" class="reaction-btn ${userReacted ? 'reacted' : ''}">
                                ${heartSVG}
                                <span class="font-semibold">${count}</span>
                            </button>
                        `;

                        const imageHTML = item.imageUrl ? `
                            <img src="${item.imageUrl}" alt="Foto da ${item.type} de ${item.participantName}" class="mt-3 rounded-lg w-full object-cover max-h-96 border border-gray-600" loading="lazy" onerror="this.style.display='none'">
                        ` : '';

                        // Verifica a privacidade e exibe o √≠cone de privado se necess√°rio para participantes
                        const privacyIndicator = item.is_public === false ? `<span class="text-gray-500 text-sm ml-2 flex items-center">${privateSVG} Privado</span>` : '';
                        
                        let activityDescription = '';
                        if (item.isWeightEntry) {
                            activityDescription = `pesou ${parseFloat(item.weight).toFixed(1)} kg.`; // Usa item.weight para entradas de peso
                        } else {
                            activityDescription = `registrou uma atividade: <span class="text-lg font-semibold text-indigo-300">${item.type} - ${item.duration} min</span>`;
                        }

                        feedHTML += `
                            <div class="card">
                                <div class="flex items-start gap-4">
                                    <img src="${item.participantAvatar}" class="w-12 h-12 rounded-full object-cover" onerror="this.onerror=null;this.src='${item.participantAvatar}';">
                                    <div class="flex-1">
                                        <p>
                                            <strong class="text-white">${item.participantName}</strong>
                                            <span class="text-gray-400">${activityDescription}</span>
                                            ${privacyIndicator}
                                        </p>
                                        
                                        ${imageHTML}

                                        <p class="text-xs text-gray-500 mt-2">${timeAgo}</p>
                                        <div class="flex items-center gap-2 mt-3 flex-wrap">
                                            ${reactionsHTML}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }

                feedHTML += `</div>`;
                container.innerHTML = feedHTML;
            }

            function updateProfileWeightList(participant) {
                const listContainer = document.getElementById('profile-weight-history-list');
                if (!listContainer) return;
                listContainer.innerHTML = '';
                const isOwnProfile = currentUser.participantId == participant.id;
                const canEditProfile = currentUser.role === 'admin' || isOwnProfile;
                
                // Ordena o hist√≥rico do mais recente para o mais antigo
                const history = [...(participant.weight_history || [])].sort((a,b) => new Date(b.date) - new Date(a.date));

                if (history.length === 0) {
                    listContainer.innerHTML = `<p class="text-center text-gray-500 py-4">Nenhum registro de peso.</p>`;
                    return;
                }

                history.forEach((entry, index) => {
                    const formattedDate = new Date(entry.date).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                    let currentWeightAndChangeHTML = '';
                    const previousEntry = history[index + 1]; // O registro anterior na linha do tempo (pr√≥ximo item no array ordenado decrescentemente)

                    if (previousEntry) {
                        const change = entry.weight - previousEntry.weight; // Varia√ß√£o do peso atual para o peso anterior
                        const changeColor = change < 0 ? 'text-green-400' : (change > 0 ? 'text-red-400' : 'text-gray-400');
                        const sign = change > 0 ? '+' : '';
                        
                        // Exibe o peso do registro e a varia√ß√£o entre par√™nteses
                        currentWeightAndChangeHTML = `<span class="font-semibold text-white">${parseFloat(entry.weight).toFixed(2)} kg</span> <span class="text-xs ${changeColor}">(${sign}${change.toFixed(2)} kg)</span>`;
                    } else {
                        // Para o primeiro registro (peso inicial), exibe o peso e "IN√çCIO"
                        currentWeightAndChangeHTML = `<span class="font-semibold text-white">${parseFloat(entry.weight).toFixed(2)} kg</span> <span class="text-xs text-gray-500">(IN√çCIO)</span>`;
                    }

                    // A lixeira s√≥ aparece se for poss√≠vel excluir (n√£o o peso inicial se for o √∫nico, ou se n√£o for admin)
                    // NOTA: A l√≥gica para impedir que o usu√°rio comum apague o peso inicial ser√° implementada na pr√≥xima revis√£o.
                    // Por enquanto, a lixeira aparece para todos os registros que n√£o sejam o √öLTIMO remanescente.
                    const canDeleteEntry = canEditProfile && history.length > 1; 

                    listContainer.innerHTML += `
                        <div class="flex justify-between items-center text-sm p-2 bg-gray-800 rounded-lg hover:bg-gray-700">
                            <div class="flex items-center gap-3">
                                <span class="text-gray-400">${formattedDate}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                ${currentWeightAndChangeHTML}
                                ${canDeleteEntry ? `<button data-action="delete-weight-entry" data-id="${participant.id}" data-entry-date="${entry.date}" class="text-gray-500 hover:text-red-500 p-1" title="Excluir">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                                </button>` : `<div class="w-6"></div>`}
                            </div>
                        </div>`;
                });
            }

            function updateProfileActivityList(participant) {
                const listContainer = document.getElementById('profile-activity-history-list');
                if (!listContainer) return;
                listContainer.innerHTML = '';
                const isOwnProfile = currentUser.participantId == participant.id;
                const canEditProfile = currentUser.role === 'admin' || isOwnProfile;

                const allActivities = participant.semanas_validas.flatMap((week, weekIndex) => 
                    (Array.isArray(week) ? week : []).map(activity => ({...activity, weekIndex}))
                ).sort((a, b) => getActivityTimestamp(b) - getActivityTimestamp(a));

                if (allActivities.length === 0) {
                    listContainer.innerHTML = `<p class="text-center text-gray-500 py-4">Nenhuma atividade registrada.</p>`;
                    return;
                }

                allActivities.forEach(act => {
                    const activityDate = new Date(act.date);
                    const formattedDate = !isNaN(activityDate.getTime()) 
                        ? activityDate.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' })
                        : 'Data inv√°lida';

                    listContainer.innerHTML += `
                        <div class="flex justify-between items-center text-sm p-2 bg-gray-800 rounded-lg hover:bg-gray-700">
                            <div>
                                <span class="font-bold text-white">${act.type}</span> - 
                                <span class="text-gray-300">${act.duration} min</span>
                                <span class="text-gray-400 text-xs italic">(Sem. ${act.weekIndex + 1} - ${formattedDate})</span>
                                ${act.is_public === false ? `<span class="text-gray-500 text-xs ml-2 flex items-center"><svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path></svg>Privado</span>` : ''}
                            </div>
                            ${canEditProfile ? `
                            <button data-action="delete-activity" data-id="${participant.id}" data-week="${act.weekIndex}" data-activity-id="${act.id}" class="text-gray-500 hover:text-red-500 p-1" title="Apagar Atividade">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                            </button>` : ''}
                        </div>
                    `;
                });
            }

            function renderActivityLogPage(data, container) {
                const today = new Date();
                const currentWeekIndex = Math.floor((today - CHALLENGE_START_DATE) / (1000 * 60 * 60 * 24 * 7));
                
                let legendHTML = `
                    <div class="flex justify-center items-center gap-4 mb-6 text-xs text-gray-400">
                        <div class="flex items-center gap-2"><div class="w-4 h-4 rounded" style="background-color: #374151;"></div><span>Nenhuma atividade</span></div>
                        <div class="flex items-center gap-2"><div class="w-4 h-4 rounded" style="background-color: var(--warning-color);"></div><span>1-2 atividades</span></div>
                        <div class="flex items-center gap-2"><div class="w-4 h-4 rounded" style="background-color: var(--success-color);"></div><span>Semana validada (3+)</span></div>
                    </div>
                `;

                let cardsHTML = '<div class="space-y-6">';
                if (data.length > 0) {
                    data.sort((a,b) => a.name.localeCompare(b.name)).forEach(p => {
                        const avatarSrc = p.avatar_url || `https://placehold.co/48x48/E2E8F0/4A5568?text=${p.name.charAt(0)}`;
                        let gridHTML = '<div class="activity-grid mt-4">';
                        for (let i = 0; i < MAX_WEEKS; i++) {
                            const weekActivities = p.semanas_validas[i] || [];
                            const activityCount = Array.isArray(weekActivities) ? weekActivities.length : 0;
                            let cellClass = 'activity-none';
                            if (activityCount >= MIN_ACTIVITIES_FOR_VALID_WEEK) {
                                cellClass = 'activity-complete';
                            } else if (activityCount > 0) {
                                cellClass = 'activity-partial';
                            }
                            const isCurrentWeek = i === currentWeekIndex ? 'current-week' : '';
                            gridHTML += `
                                <div class="relative">
                                    <div class="activity-cell-label">${i + 1}</div>
                                    <div class="activity-cell ${cellClass} ${isCurrentWeek}" title="Semana ${i + 1}: ${activityCount} atividades"></div>
                                </div>
                            `;
                        }
                        gridHTML += '</div>';

                        cardsHTML += `
                            <div class="profile-card">
                                <div class="flex items-center gap-4">
                                    <img src="${avatarSrc}" alt="Avatar de ${p.name}" class="w-12 h-12 rounded-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/48x48/E2E8F0/4A5568?text=${p.name.charAt(0)}';">
                                    <h3 class="text-lg font-bold text-white">${p.name}</h3>
                                </div>
                                ${gridHTML}
                            </div>
                        `;
                    });
                } else {
                    cardsHTML += `<div class="text-center py-10 text-gray-500">Nenhum participante para exibir.</div>`;
                }
                cardsHTML += '</div>';

                container.innerHTML = legendHTML + cardsHTML;
            }

            function renderWeeklySummaryPage(data, container) {
                const today = new Date();
                const dayOfWeek = today.getDay(); // Sunday = 0, Monday = 1...
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
                startOfWeek.setHours(0, 0, 0, 0);
                
                const beforeStartOfWeek = new Date(startOfWeek);
                beforeStartOfWeek.setDate(beforeStartOfWeek.getDate() - 1);

                const currentWeekIndex = Math.floor((startOfWeek - CHALLENGE_START_DATE) / (1000 * 60 * 60 * 24 * 7));

                let weeklyData = data.map(p => {
                    const weightThen = getWeightAtDate(p, beforeStartOfWeek);
                    const weightNow = getWeightAtDate(p, today); // Usa getWeightAtDate para o peso 'atual' da semana
                    const weightChange = weightNow - weightThen;
                    
                    const activitiesThisWeek = (p.semanas_validas[currentWeekIndex] || []).length;
                    
                    const lastWeightEntry = p.weight_history && p.weight_history.length > 0 ? new Date(Math.max(...p.weight_history.map(e => new Date(e.date)))) : new Date(0);
                    const isWeightUpdated = lastWeightEntry >= startOfWeek;

                    return { ...p, weightChange, activitiesThisWeek, isWeightUpdated };
                });

                let weightLossLeader = { name: 'N/A', change: Infinity };
                let activityLeader = { name: 'N/A', count: -1 };
                let totalLoss = 0;

                weeklyData.forEach(p => {
                    if (p.weightChange < weightLossLeader.change) {
                        weightLossLeader = { name: p.name, change: p.weightChange };
                    }
                    if (p.activitiesThisWeek > activityLeader.count) {
                        activityLeader = { name: p.name, count: p.activitiesThisWeek };
                    }
                    if (p.weightChange < 0) {
                        totalLoss += -p.weightChange;
                    }
                });
                
                const notUpdated = weeklyData.filter(p => !p.isWeightUpdated);

                container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="card"><div class="text-sm font-medium text-gray-400">Maior Perda de Peso (Semana)</div><div class="text-2xl font-bold" style="color: var(--success-color);">${weightLossLeader.change < 0 ? weightLossLeader.name : 'N/A'}</div><div class="text-sm text-gray-300">${weightLossLeader.change < 0 ? (-weightLossLeader.change).toFixed(2) + ' kg' : 'Nenhuma'}</div></div>
                        <div class="card"><div class="text-sm font-medium text-gray-400">Mais Atividades (Semana)</div><div class="text-2xl font-bold" style="color: var(--warning-color);">${activityLeader.count > 0 ? activityLeader.name : 'N/A'}</div><div class="text-sm text-gray-300">${activityLeader.count > 0 ? activityLeader.count + ' atividades' : 'Nenhuma'}</div></div>
                        <div class="card"><div class="text-sm font-medium text-gray-400">Total Perdido (Semana)</div><div class="text-3xl font-bold" style="color: var(--primary-color);">${totalLoss.toFixed(2)}</div><div class="text-sm text-gray-300">kg pelo grupo</div></div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 card">
                             <h3 class="text-lg font-semibold mb-2 text-white">Progresso da Semana</h3>
                             <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead><tr><th>Nome</th><th>Varia√ß√£o de Peso</th><th>Atividades</th></tr></thead>
                                    <tbody>
                                        ${weeklyData.map(p => {
                                            const avatarSrc = p.avatar_url || `https://placehold.co/40x40/E2E8F0/4A5568?text=${p.name.charAt(0)}`;
                                            return `
                                            <tr>
                                                <td>
                                                    <div class="flex items-center">
                                                        <img src="${avatarSrc}" alt="Avatar de ${p.name}" class="w-8 h-8 rounded-full mr-3 object-cover flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/40x40/E2E8F0/4A5568?text=${p.name.charAt(0)}';">
                                                        <span>${p.name}</span>
                                                    </div>
                                                </td>
                                                <td><span class="font-semibold ${p.weightChange < 0 ? 'text-green-400' : (p.weightChange > 0 ? 'text-red-400' : '')}">${p.weightChange > 0 ? '+' : ''}${p.weightChange.toFixed(2)} kg</span></td>
                                                <td class="text-center">${p.activitiesThisWeek}</td>
                                            </tr>
                                        `}).join('')}
                                    </tbody>
                                </table>
                             </div>
                        </div>
                        <div class="card">
                            <h3 class="text-lg font-semibold mb-2 text-white">Peso Desatualizado</h3>
                            ${notUpdated.length > 0 ? `
                            <ul class="space-y-2">
                                ${notUpdated.map(p => `<li class="p-3 bg-red-900/50 border-l-4 border-red-500 rounded-r-lg">${p.name}</li>`).join('')}
                            </ul>
                            ` : `<div class="p-4 text-center bg-green-900/50 border-l-4 border-green-500 rounded-r-lg">Todos os pesos est√£o atualizados! üéâ</div>`}
                        </div>
                    </div>
                `;
            }

            function renderCoachVirtualPage(container) {
                if (currentUser.role === 'admin') {
                    if (participants.length === 0) {
                        container.innerHTML = `<div class="text-center py-10 text-gray-500">Adicione participantes primeiro para usar o Coach Virtual.</div>`;
                        return;
                    }
                    const options = participants.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                    container.innerHTML = `
                        <div class="max-w-2xl mx-auto text-center">
                            <h3 class="text-2xl font-bold mb-2 text-white">Coach Virtual</h3>
                            <p class="text-gray-400 mb-6">Selecione um participante para receber uma dica personalizada baseada em seu progresso.</p>
                            <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-6">
                                <select id="coach-participant-selector" class="w-full sm:w-auto py-2 px-3">${options}</select>
                                <button id="generate-coach-tip-admin" style="background-color: var(--primary-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg w-full sm:w-auto">Gerar Dica</button>
                            </div>
                            <div id="ai-tip-container" class="p-6 bg-gray-800 rounded-lg text-gray-300 min-h-[120px] text-left">
                                Selecione um participante e clique no bot√£o para come√ßar.
                            </div>
                        </div>`;

                    document.getElementById('generate-coach-tip-admin').addEventListener('click', () => {
                        const selectedId = document.getElementById('coach-participant-selector').value;
                        getAICoachingTip(selectedId);
                    });

                } else {
                    container.innerHTML = `
                        <div class="max-w-2xl mx-auto text-center">
                            <h3 class="text-2xl font-bold mb-2 text-white">Seu Coach Virtual</h3>
                            <p class="text-gray-400 mb-6">Clique no bot√£o abaixo para receber uma dica personalizada baseada no seu progresso.</p>
                            <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-6">
                                <button data-action="ai-coach" data-id="${currentUser.participantId}" style="background-color: var(--primary-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg w-full sm:w-auto">Gerar Minha Dica do Coach</button>
                            </div>
                            <div id="ai-tip-container" class="p-6 bg-gray-800 rounded-lg text-gray-300 min-h-[120px] text-left">
                                Pronto para uma dica?
                            </div>
                        </div>`;
                }
            }

            function renderIndividualEvolutionPage(data, container) {
                container.innerHTML = `
                    <div id="all-charts-wrapper">
                        <h3 class="text-xl font-semibold text-center mb-2 text-white">Evolu√ß√£o de Peso Individual</h3>
                        <p class="text-center text-gray-400 mb-6">Acompanhe a varia√ß√£o do peso ao longo do tempo e a proje√ß√£o de sua meta.</p>
                        <div id="mainWeightChartWrapper" class="mb-8 card"></div>
                        <div id="trendChartWrapper" class="mb-8 card"></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-8">
                            <div id="percentageLossChartContainer" class="card"></div>
                            <div id="totalActivityChartContainer" class="card"></div>
                        </div>
                    </div>`;
                
                renderMainWeightChart(data);
                renderTrendChart(data);
                renderPercentageLossChart(data, document.getElementById('percentageLossChartContainer'));
                renderTotalActivityChart(data, document.getElementById('totalActivityChartContainer'));
            }

            function renderMainWeightChart(data) {
                const chartContainer = document.getElementById('mainWeightChartWrapper');
                // chartContainer.innerHTML = `<h3 class="text-xl font-semibold text-center mb-2 text-white">Evolu√ß√£o do Peso</h3>`; // Removido para evitar duplicidade
                const participantsWithHistory = data.filter(p => p.weight_history && p.weight_history.length > 0);
                if (participantsWithHistory.length === 0) return chartContainer.innerHTML += `<div class="text-center py-10 text-gray-500">N√£o h√° hist√≥rico de peso para exibir.</div>`;

                const margin = {top: 20, right: 120, bottom: 30, left: 40}, width = (chartContainer.clientWidth || 800) - margin.left - margin.right, height = 350 - margin.top - margin.bottom;
                const svg = d3.select(chartContainer).append("svg").attr("width", "100%").attr("height", "100%").attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
                
                let allChartWeights = [];
                participantsWithHistory.forEach(p => { p.weight_history.forEach(d => allChartWeights.push(d.weight)); if (p.target_weight) allChartWeights.push(p.target_weight); });

                const xScale = d3.scaleTime().domain([CHALLENGE_START_DATE, CHALLENGE_END_DATE]).range([0, width]);
                const yScale = d3.scaleLinear().domain([d3.min(allChartWeights) - 2, d3.max(allChartWeights) + 2]).range([height, 0]);
                const colors = d3.scaleOrdinal(d3.schemeTableau10);
                
                svg.append("g").attr("class", "grid").call(d3.axisLeft(yScale).tickSize(-width).tickFormat("")).selectAll("line").attr("stroke", "#374151");
                svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(xScale).tickFormat(d3.timeFormat("%d/%m"))).selectAll("text").style("fill", "var(--text-muted)");
                svg.append("g").call(d3.axisLeft(yScale).tickFormat(d => `${d}kg`)).selectAll("text").style("fill", "var(--text-muted)");

                participantsWithHistory.forEach(p => {
                    // Garante que o hist√≥rico para o gr√°fico est√° ordenado por data
                    const sortedHistory = [...p.weight_history].sort((a,b) => new Date(a.date) - new Date(b.date));
                    const line = d3.line().curve(d3.curveMonotoneX).x(d => xScale(new Date(d.date))).y(d => yScale(d.weight));
                    svg.append("path").datum(sortedHistory).attr("fill", "none").attr("stroke", colors(p.name)).attr("stroke-width", 2.5).attr("d", line);
                    if (sortedHistory.length > 0) {
                        svg.append("text").attr("transform", `translate(${width+5},${yScale(sortedHistory[sortedHistory.length-1].weight)})`).attr("dy", ".35em").attr("text-anchor", "start").style("fill", colors(p.name)).text(p.name);
                    }
                });
            }

            function renderTrendChart(data) {
                const chartContainer = document.getElementById('trendChartWrapper');
                // chartContainer.innerHTML = `<h3 class="text-xl font-semibold text-center mb-2 text-white">Proje√ß√£o de Tend√™ncia</h3>`; // Removido para evitar duplicidade
                const participantsWithHistory = data.filter(p => p.weight_history && p.weight_history.length > 1);
                if (participantsWithHistory.length === 0) return chartContainer.innerHTML += `<div class="text-center py-10 text-gray-500">Dados insuficientes para proje√ß√£o.</div>`;
                
                const margin = {top: 20, right: 120, bottom: 30, left: 40}, width = (chartContainer.clientWidth || 800) - margin.left - margin.right, height = 350 - margin.top - margin.bottom;
                const svg = d3.select(chartContainer).append("svg").attr("width", "100%").attr("height", "100%").attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
                
                let allChartWeights = [];
                participantsWithHistory.forEach(p => {
                    p.weight_history.forEach(d => allChartWeights.push(d.weight));
                    const trend = calculateTrendLine(p.weight_history);
                    if (trend) allChartWeights.push(trend.start.weight, trend.end.weight);
                });
                
                const xScale = d3.scaleTime().domain([CHALLENGE_START_DATE, CHALLENGE_END_DATE]).range([0, width]);
                const yScale = d3.scaleLinear().domain([d3.min(allChartWeights) - 2, d3.max(allChartWeights) + 2]).range([height, 0]);
                const colors = d3.scaleOrdinal(d3.schemeTableau10);

                svg.append("g").attr("class", "grid").call(d3.axisLeft(yScale).tickSize(-width).tickFormat("")).selectAll("line").attr("stroke", "#374151");
                svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(xScale).tickFormat(d3.timeFormat("%d/%m"))).selectAll("text").style("fill", "var(--text-muted)");
                svg.append("g").call(d3.axisLeft(yScale).tickFormat(d => `${d}kg`)).selectAll("text").style("fill", "var(--text-muted)");

                participantsWithHistory.forEach(p => {
                    const trend = calculateTrendLine(p.weight_history);
                    if (trend) {
                        svg.append("line").attr("x1", xScale(trend.start.date)).attr("y1", yScale(trend.start.weight)).attr("x2", xScale(trend.end.date)).attr("y2", yScale(trend.end.weight)).attr("stroke", colors(p.name)).attr("stroke-width", 2.5).attr("stroke-dasharray", "6,6");
                        svg.append("text").attr("transform", "translate(" + (width + 5) + "," + yScale(trend.end.weight) + ")").attr("dy", ".35em").attr("text-anchor", "start").style("fill", colors(p.name)).text(p.name);
                    }
                });
            }

            function renderPercentageLossChart(data, container) {
                container.innerHTML = `<h3 class="text-xl font-semibold text-center mb-2 text-white">Ranking de % de Perda</h3>`;
                const chartData = data.map(p => ({ name: p.name, percentLoss: p.percentLoss })).sort((a, b) => b.percentLoss - a.percentLoss);
                const margin = {top: 20, right: 50, bottom: 30, left: 120}, height = chartData.length * 40, width = (container.clientWidth || 400) - margin.left - margin.right;
                const svg = d3.select(container).append("svg").attr("width", "100%").attr("height", height + margin.top + margin.bottom).attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
                const xScale = d3.scaleLinear().domain([0, d3.max(chartData, d => d.percentLoss) * 1.1 || 10]).range([0, width]);
                const yScale = d3.scaleBand().domain(chartData.map(d => d.name)).range([0, height]).padding(0.2);

                svg.append("g").call(d3.axisLeft(yScale).tickSize(0)).select(".domain").remove();
                svg.selectAll(".tick text").style("fill", "var(--text-muted)");
                svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(xScale).ticks(5).tickFormat(d => `${d.toFixed(1)}%`)).selectAll("text").style("fill", "var(--text-muted)");
                const colors = d3.scaleOrdinal(d3.schemeTableau10).domain(chartData.map(d => d.name));

                svg.selectAll(".bar").data(chartData).enter().append("rect").attr("class", "bar").attr("y", d => yScale(d.name)).attr("x", 0).attr("height", yScale.bandwidth()).attr("width", 0).attr("fill", d => colors(d.name)).transition().duration(800).attr("width", d => xScale(d.percentLoss));
                svg.selectAll(".bar-label").data(chartData).enter().append("text").attr("class", "bar-label").attr("y", d => yScale(d.name) + yScale.bandwidth() / 2).attr("x", d => xScale(d.percentLoss) + 5).attr("dy", ".35em").style("fill", "#fff").style("font-weight", "bold").text(d => `${d.percentLoss.toFixed(2)}%`);
            }

            function renderTotalActivityChart(data, container) {
                container.innerHTML = `<h3 class="text-xl font-semibold text-center mb-2 text-white">Ranking de Atividades Totais</h3>`;
                const chartData = data.map(p => ({ name: p.name, totalActivities: p.totalActivities })).sort((a, b) => b.totalActivities - a.totalActivities);
                const margin = {top: 20, right: 50, bottom: 30, left: 120}, height = chartData.length * 40, width = (container.clientWidth || 400) - margin.left - margin.right;
                const svg = d3.select(container).append("svg").attr("width", "100%").attr("height", height + margin.top + margin.bottom).attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
                const xScale = d3.scaleLinear().domain([0, d3.max(chartData, d => d.totalActivities) * 1.1 || 10]).range([0, width]);
                const yScale = d3.scaleBand().domain(chartData.map(d => d.name)).range([0, height]).padding(0.2);

                svg.append("g").call(d3.axisLeft(yScale).tickSize(0)).select(".domain").remove();
                svg.selectAll(".tick text").style("fill", "var(--text-muted)");
                svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(xScale).ticks(5)).selectAll("text").style("fill", "var(--text-muted)");
                const colors = d3.scaleOrdinal(d3.schemeTableau10).domain(chartData.map(d => d.name));

                svg.selectAll(".bar").data(chartData).enter().append("rect").attr("class", "bar").attr("y", d => yScale(d.name)).attr("x", 0).attr("height", yScale.bandwidth()).attr("width", 0).attr("fill", d => colors(d.name)).transition().duration(800).attr("width", d => xScale(d.totalActivities));
                svg.selectAll(".bar-label").data(chartData).enter().append("text").attr("class", "bar-label").attr("y", d => yScale(d.name) + yScale.bandwidth() / 2).attr("x", d => xScale(d.totalActivities) + 5).attr("dy", ".35em").style("fill", "#fff").style("font-weight", "bold").text(d => d.totalActivities);
            }

            function renderGroupEvolutionChart(data, container) {
                container.innerHTML = `
                    <div id="group-evolution-wrapper">
                        <h3 class="text-xl font-semibold text-center mb-2 text-white">Evolu√ß√£o da Perda de Peso do Grupo</h3>
                        <div id="groupEvolutionChartContainer" class="w-full h-96 mb-8"></div>
                        <div id="groupPieChartContainer" class="w-full mt-8"></div>
                    </div>`;
                const chartContainer = document.getElementById('groupEvolutionChartContainer');
                const pieContainer = document.getElementById('groupPieChartContainer');

                setTimeout(() => {
                    const weeklyLossData = [];
                    for (let i = 0; i < MAX_WEEKS; i++) {
                        const weekStartDate = new Date(CHALLENGE_START_DATE); weekStartDate.setDate(weekStartDate.getDate() + i * 7);
                        const weekEndDate = new Date(CHALLENGE_START_DATE); weekEndDate.setDate(weekEndDate.getDate() + (i + 1) * 7);
                        let totalWeeklyLoss = 0;
                        participants.forEach(p => { 
                            const lossThisWeek = getWeightAtDate(p, weekStartDate) - getWeightAtDate(p, weekEndDate);
                            if (lossThisWeek > 0) {
                                totalWeeklyLoss += lossThisWeek;
                            }
                        });
                        weeklyLossData.push({ week: i + 1, totalLoss: totalWeeklyLoss });
                    }

                    if (weeklyLossData.every(d => d.totalLoss === 0)) {
                        chartContainer.innerHTML = `<div class="text-center py-10 text-gray-500">Nenhuma perda de peso registrada para o grupo.</div>`;
                    } else {
                        const margin = {top: 20, right: 30, bottom: 40, left: 70}, width = chartContainer.clientWidth - margin.left - margin.right, height = chartContainer.clientHeight - margin.top - margin.bottom;
                        const svg = d3.select(chartContainer).append("svg").attr("width", "100%").attr("height", "100%").attr("viewBox", `0 0 ${chartContainer.clientWidth} ${chartContainer.clientHeight}`).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
                        const xScale = d3.scaleBand().domain(weeklyLossData.map(d => d.week)).range([0, width]).padding(0.2);
                        const yScale = d3.scaleLinear().domain([0, d3.max(weeklyLossData, d => d.totalLoss) * 1.1 || 1]).range([height, 0]);
                        svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(xScale)).append("text").attr("y", 35).attr("x", width / 2).attr("text-anchor", "middle").attr("fill", "var(--text-muted)").text("Semana");
                        svg.append("g").call(d3.axisLeft(yScale).tickFormat(d => `${d.toFixed(1)}kg`)).append("text").attr("transform", "rotate(-90)").attr("y", -margin.left + 20).attr("x", -height / 2).attr("text-anchor", "middle").attr("fill", "var(--text-muted)").text("Perda Total (kg)");
                        svg.selectAll(".bar").data(weeklyLossData).enter().append("rect").attr("class", "bar").attr("x", d => xScale(d.week)).attr("y", d => yScale(Math.max(0, d.totalLoss))).attr("width", xScale.bandwidth()).attr("height", d => Math.abs(yScale(0) - yScale(d.totalLoss))).attr("fill", "var(--primary-color)");
                    }
                    
                    const pieData = participants.map(p => ({ name: p.name, value: Math.max(0, p.peso_inicial - getWeightAtDate(p, new Date())) })).filter(p => p.value > 0); // Usa getWeightAtDate
                    const totalLoss = d3.sum(pieData, d => d.value);

                    if (pieData.length > 0) {
                        pieContainer.innerHTML = `<h3 class="text-xl font-semibold text-center mb-4 text-white">Contribui√ß√£o Individual para Perda Total</h3><div id="pie-chart-wrapper" class="grid grid-cols-1 md:grid-cols-3 items-center justify-center gap-8"></div>`;
                        const wrapper = d3.select("#pie-chart-wrapper");
                        wrapper.append("div").attr("class", "flex flex-col items-center justify-center text-center bg-gradient-to-br from-indigo-900 to-gray-800 p-6 rounded-2xl shadow-lg h-full").html(`<h4 class="text-lg font-bold text-indigo-300 mb-2">PERDA TOTAL DO GRUPO</h4><p class="text-6xl font-extrabold text-indigo-400">${totalLoss.toFixed(2)}</p><p class="text-2xl font-semibold text-indigo-300">kg</p>`);
                        const svgContainer = wrapper.append("div").attr("class", "flex items-center justify-center");
                        const legendContainer = wrapper.append("div").attr("class", "flex flex-col justify-center");
                        const pieWidth = 300, pieHeight = 300, radius = Math.min(pieWidth, pieHeight) / 2 - 10;
                        const pieSvg = svgContainer.append("svg").attr("width", pieWidth).attr("height", pieHeight).append("g").attr("transform", `translate(${pieWidth / 2},${pieHeight / 2})`);
                        const colors = d3.scaleOrdinal(d3.schemeTableau10);
                        const pie = d3.pie().value(d => d.value);
                        const arc = d3.arc().innerRadius(radius * 0.5).outerRadius(radius);
                        pieSvg.selectAll('slices').data(pie(pieData)).enter().append('path').attr('d', arc).attr('fill', d => colors(d.data.name)).attr("stroke", "#1f2937").style("stroke-width", "2px");
                        const legend = legendContainer.selectAll(".legend-item").data(pieData).enter().append("div").attr("class", "legend-item flex items-center mb-2 text-sm");
                        legend.append("div").style("width", "18px").style("height", "18px").style("background-color", d => colors(d.name)).attr("class", "mr-2 rounded-sm flex-shrink-0");
                        legend.append("span").text(d => `${d.name}: ${d.value.toFixed(2)}kg (${(d.value / totalLoss * 100).toFixed(1)}%)`);
                    }
                }, 0);
            }
            
            function renderComparisonChart(data, container) {
                let checkboxesHTML = data.map(p => `<label class="inline-flex items-center mr-4 mb-2"><input type="checkbox" class="comparison-checkbox form-checkbox h-5 w-5 text-indigo-500 bg-gray-700 border-gray-600" value="${p.name}"><span class="ml-2">${p.name}</span></label>`).join('');
                let metricsHTML = `<div id="comparison-metrics" class="flex flex-wrap gap-4 mb-4 pb-4 border-b border-gray-700">
                        <label class="inline-flex items-center"><input type="radio" name="comparisonMetric" value="weight" class="form-radio text-indigo-500 bg-gray-700 border-gray-600" checked><span class="ml-2">Peso (kg)</span></label>
                        <label class="inline-flex items-center"><input type="radio" name="comparisonMetric" value="percentLoss" class="form-radio text-indigo-500 bg-gray-700 border-gray-600"><span class="ml-2">% Perda de Peso</span></label>
                        <label class="inline-flex items-center"><input type="radio" name="comparisonMetric" value="activities" class="form-radio text-indigo-500 bg-gray-700 border-gray-600"><span class="ml-2">Total de Atividades</span></label>
                    </div>`;
                container.innerHTML = `<div id="comparison-content">${metricsHTML}<div id="comparison-checkboxes" class="p-4 rounded-lg mb-4">${checkboxesHTML}</div><div id="comparisonChartContainer" class="w-full h-96"></div></div>`;
                updateComparisonChart();
            }

            function updateComparisonChart() {
                const chartContainer = document.getElementById('comparisonChartContainer');
                const selectedMetric = document.querySelector('input[name="comparisonMetric"]:checked')?.value || 'weight';
                const selectedNames = Array.from(document.querySelectorAll('.comparison-checkbox:checked')).map(cb => cb.value);
                const selectedParticipants = participants.filter(p => selectedNames.includes(p.name));
                chartContainer.innerHTML = '';

                if (selectedParticipants.length === 0) {
                    return chartContainer.innerHTML = `<div class="text-center py-10 text-gray-500">Selecione um ou mais participantes para comparar.</div>`;
                }

                const colors = d3.scaleOrdinal(d3.schemeTableau10);
                const margin = {top: 20, right: 160, bottom: 40, left: 50}, width = chartContainer.clientWidth - margin.left - margin.right, height = chartContainer.clientHeight - margin.top - margin.bottom;
                const svg = d3.select(chartContainer).append("svg").attr("width", "100%").attr("height", "100%").attr("viewBox", `0 0 ${chartContainer.clientWidth} ${chartContainer.clientHeight}`).append("g").attr("transform", `translate(${margin.left},${margin.top})`);

                if (selectedMetric === 'weight' || selectedMetric === 'percentLoss') {
                    const participantsWithHistory = selectedParticipants.filter(p => p.weight_history && p.weight_history.length > 0);
                    if (participantsWithHistory.length === 0) return chartContainer.innerHTML = `<div class="text-center py-10 text-gray-500">Nenhum hist√≥rico de peso para os selecionados.</div>`;

                    let allChartDates = [], allChartValues = [];
                    const chartData = participantsWithHistory.map(p => {
                        // Certifique-se de que a hist√≥ria est√° ordenada para o gr√°fico
                        const sortedHistory = [...p.weight_history].sort((a, b) => new Date(a.date) - new Date(b.date));
                        const history = sortedHistory.map(entry => {
                            const value = selectedMetric === 'weight' ? entry.weight : ((p.peso_inicial - entry.weight) / p.peso_inicial) * 100;
                            allChartDates.push(new Date(entry.date)); allChartValues.push(value);
                            return { date: entry.date, value: value };
                        });
                        return { name: p.name, history };
                    });

                    const xScale = d3.scaleTime().domain(d3.extent(allChartDates)).range([0, width]);
                    const yScale = d3.scaleLinear().domain([d3.min(allChartValues) - 1, d3.max(allChartValues) + 1]).range([height, 0]);
                    const line = d3.line().x(d => xScale(new Date(d.date))).y(d => yScale(d.value));

                    svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(xScale).tickFormat(d3.timeFormat("%d/%m"))).selectAll("text").style("fill", "var(--text-muted)");
                    svg.append("g").call(d3.axisLeft(yScale).tickFormat(d => selectedMetric === 'weight' ? `${d}kg` : `${d.toFixed(1)}%`)).selectAll("text").style("fill", "var(--text-muted)");

                    chartData.forEach(p => { svg.append("path").datum(p.history).attr("fill", "none").attr("stroke", colors(p.name)).attr("stroke-width", 2).attr("d", line); });
                    const legend = svg.selectAll(".legend").data(chartData).enter().append("g").attr("class", "legend").attr("transform", (d, i) => `translate(${width + 20},${i * 20})`);
                    legend.append("rect").attr("width", 18).attr("height", 18).style("fill", d => colors(d.name));
                    legend.append("text").attr("x", 24).attr("y", 9).attr("dy", ".35em").style("text-anchor", "start").text(d => d.name).style("fill", "var(--text-light)");

                } else if (selectedMetric === 'activities') {
                    const weeks = Array.from({length: MAX_WEEKS}, (_, i) => i + 1);
                    const maxActivities = d3.max(selectedParticipants, p => d3.max(p.semanas_validas, w => w.length));

                    const xScale = d3.scaleBand().domain(weeks).range([0, width]).padding(0.2);
                    const xSubgroup = d3.scaleBand().domain(selectedNames).range([0, xScale.bandwidth()]).padding([0.05]);
                    const yScale = d3.scaleLinear().domain([0, maxActivities > 0 ? maxActivities : 5]).range([height, 0]);

                    svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(xScale)).append("text").attr("x", width / 2).attr("y", margin.bottom - 5).attr("fill", "var(--text-muted)").text("Semana");
                    svg.append("g").call(d3.axisLeft(yScale)).selectAll("text").style("fill", "var(--text-muted)");

                    svg.append("g").selectAll("g").data(selectedParticipants).enter().append("g")
                        .attr("transform", d => `translate(${xSubgroup(d.name)},0)`)
                        .selectAll("rect").data(d => weeks.map(w => ({ key: d.name, week: w, value: (d.semanas_validas[w-1] || []).length })))
                        .enter().append("rect")
                            .attr("x", d => xScale(d.week)).attr("y", d => yScale(d.value))
                            .attr("width", xSubgroup.bandwidth()).attr("height", d => height - yScale(d.value))
                            .attr("fill", d => colors(d.key));
                    
                    const legend = svg.selectAll(".legend").data(selectedParticipants).enter().append("g").attr("class", "legend").attr("transform", (d, i) => `translate(${width + 20},${i * 20})`);
                    legend.append("rect").attr("width", 18).attr("height", 18).style("fill", d => colors(d.name));
                    legend.append("text").attr("x", 24).attr("y", 9).attr("dy", ".35em").style("text-anchor", "start").text(d => d.name).style("fill", "var(--text-light)");
                }
            }
            
            function renderSettingsPage(container) {
                if (currentUser.role !== 'admin') return;
                const startDate = CHALLENGE_START_DATE.toISOString().split('T')[0];
                const endDate = CHALLENGE_END_DATE.toISOString().split('T')[0];
                
                container.innerHTML = `<div class="space-y-8">
                        <div>
                            <h3 class="text-lg font-semibold mb-2 text-white">Gerenciamento de Participantes</h3>
                            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                                <p class="mb-4 text-gray-300">Adicione, edite ou remova participantes e suas credenciais de login.</p>
                                <button data-action="go-to-participants" style="background-color: var(--primary-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg">Gerenciar Participantes</button>
                            </div>
                        </div>
                        <div>
                             <h3 class="text-lg font-semibold mb-2 text-white">Configura√ß√µes do Desafio</h3>
                             <form id="challengeConfigForm" class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                     <div><label for="startDate" class="block font-bold text-gray-300">Data de In√≠cio:</label><input type="date" id="startDate" class="w-full" value="${startDate}" required></div>
                                     <div><label for="endDate" class="block font-bold text-gray-300">Data de Fim:</label><input type="date" id="endDate" class="w-full" value="${endDate}" required></div>
                                 </div>
                                 <button type="submit" style="background-color: var(--success-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded w-full">Salvar Datas</button>
                             </form>
                        </div>
                    </div>`;

                document.getElementById('challengeConfigForm').addEventListener('submit', e => {
                    e.preventDefault();
                    CHALLENGE_START_DATE = new Date(document.getElementById('startDate').value + 'T00:00:00');
                    CHALLENGE_END_DATE = new Date(document.getElementById('endDate').value + 'T23:59:59');
                    saveChallengeConfig(); showFeedbackMessage('Datas do desafio atualizadas!'); updateCurrentView();
                });
            }
            
            function renderRulesPage(container) {
                container.innerHTML = `
                    <div class="max-w-4xl mx-auto space-y-8">
                        <div class="text-center">
                            <h2 class="text-3xl font-extrabold text-white">Regras do Desafio FIT PRO</h2>
                            <p class="mt-2 text-lg text-gray-400">Entenda como funciona a pontua√ß√£o e conquiste a vit√≥ria!</p>
                        </div>

                        <div class="profile-card">
                            <h3 class="text-xl font-bold text-indigo-400 mb-4 flex items-center">
                                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                                Sistema de Pontua√ß√£o (M√°ximo 100 Pontos)
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                                    <h4 class="font-bold text-lg text-white">Pontos por Perda de Peso (at√© 50 pts)</h4>
                                    <p class="text-sm text-gray-400 mt-1">Os pontos s√£o baseados no **percentual de peso perdido** em rela√ß√£o ao seu peso inicial. Quanto maior o percentual, mais pontos voc√™ ganha!</p>
                                    <ul class="mt-4 space-y-2 text-sm text-gray-300">
                                        <li class="flex items-start"><span class="font-bold text-indigo-400 mr-2">‚ñ∫</span> 2% de perda = 10 pts</li>
                                        <li class="flex items-start"><span class="font-bold text-indigo-400 mr-2">‚ñ∫</span> 4% de perda = 15 pts</li>
                                        <li class="flex items-start"><span class="font-bold text-indigo-400 mr-2">‚ñ∫</span> 6% de perda = 20 pts</li>
                                        <li class="flex items-start"><span class="font-bold text-indigo-400 mr-2">‚ñ∫</span> 8% de perda = 30 pts</li>
                                        <li class="flex items-start"><span class="font-bold text-indigo-400 mr-2">‚ñ∫</span> 10% de perda = 35 pts</li>
                                        <li class="flex items-start"><span class="font-bold text-indigo-400 mr-2">‚ñ∫</span> 12% de perda = 40 pts</li>
                                        <li class="flex items-start"><span class="font-bold text-indigo-400 mr-2">‚ñ∫</span> 15% de perda = 50 pts</li>
                                    </ul>
                                </div>
                                <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                                    <h4 class="font-bold text-lg text-white">Pontos por Atividades (at√© 50 pts)</h4>
                                    <p class="text-sm text-gray-400 mt-1">Para validar uma semana, voc√™ precisa registrar pelo menos **3 atividades f√≠sicas**.</p>
                                    <p class="text-sm text-gray-400 mt-2">A pontua√ß√£o √© calculada com base no n√∫mero de semanas que voc√™ validou. Se validar todas as 12 semanas, voc√™ ganha os 50 pontos!</p>
                                </div>
                            </div>
                        </div>

                        <div class="profile-card">
                            <h3 class="text-xl font-bold text-amber-400 mb-4 flex items-center">
                                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-12v4m-2-2h4m5 10v4m-2-2h4M5 3a2 2 0 00-2 2v1m14 0V5a2 2 0 00-2-2h-1m-4 18a2 2 0 002-2v-1m-4 0v1a2 2 0 002 2h1M5 21a2 2 0 012-2h1m4 0h1a2 2 0 012 2v0M3 17a2 2 0 012-2h1m4 0h1a2 2 0 012 2v0m6-14a2 2 0 00-2-2h-1m-4 0h-1a2 2 0 00-2 2v1"></path></svg>
                                Emblemas e Conquistas
                            </h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                <div class="bg-gray-800 p-4 rounded-lg">
                                    <p class="text-4xl">üéØ</p>
                                    <p class="font-semibold mt-2 text-white">Meta Atingida</p>
                                    <p class="text-xs text-gray-400">Alcance o seu peso meta.</p>
                                </div>
                                <div class="bg-gray-800 p-4 rounded-lg">
                                    <p class="text-4xl">5Ô∏è‚É£</p>
                                    <p class="font-semibold mt-2 text-white">Clube dos 5kg</p>
                                    <p class="text-xs text-gray-400">Perca 5kg no total.</p>
                                </div>
                                <div class="bg-gray-800 p-4 rounded-lg">
                                    <p class="text-4xl">üîü</p>
                                    <p class="font-semibold mt-2 text-white">Clube dos 10kg</p>
                                    <p class="text-xs text-gray-400">Perca 10kg no total.</p>
                                </div>
                                <div class="bg-gray-800 p-4 rounded-lg">
                                    <p class="text-4xl">üî•</p>
                                    <p class="font-semibold mt-2 text-white">Em Chamas!</p>
                                    <p class="text-xs text-gray-400">Valide 4 semanas seguidas.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // --- ACTION HANDLERS ---
            async function handleUpdateWeight(participantId) {
                const weightInput = document.getElementById('profile-weight-input');
                const dateInput = document.getElementById('profile-weight-date');
                const photoFile = document.getElementById('profile-weight-photo').files[0];
                const photoPrivacy = document.getElementById('profile-weight-photo-privacy').value === 'public'; // true for public, false for private
                
                const newWeight = parseFloat(weightInput.value);
                const dateValue = dateInput.value;

                if (isNaN(newWeight) || newWeight <= 0) return showFeedbackMessage("Peso inv√°lido.", true);
                if (!dateValue) return showFeedbackMessage("Selecione uma data.", true);
                
                const participant = participants.find(p => p.id == participantId);
                if (!participant) return;

                let imageUrl = null;
                if (photoFile) {
                    showFeedbackMessage('Enviando foto da balan√ßa...', false);
                    const fileName = `public/weights/${participantId}-${Date.now()}-${photoFile.name}`;
                    const { data: uploadData, error: uploadError } = await supabase.storage.from('activity-photos').upload(fileName, photoFile);
                    
                    if (uploadError) {
                        console.error("Erro no upload da foto da balan√ßa:", uploadError);
                        return showFeedbackMessage('Erro ao enviar a foto da balan√ßa.', true);
                    }
                    imageUrl = supabase.storage.from('activity-photos').getPublicUrl(fileName).data.publicUrl;
                }

                const newEntry = { 
                    date: new Date(dateValue + 'T00:00:00').toISOString(), 
                    weight: newWeight,
                    imageUrl: imageUrl,
                    is_public: photoPrivacy // Salva a privacidade da foto de peso
                };

                const filteredHistory = (participant.weight_history || []).filter(entry => 
                    new Date(entry.date).toDateString() !== new Date(newEntry.date).toDateString()
                );
                const newHistory = [...filteredHistory, newEntry];
                newHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                const latestWeightInHistory = newHistory.length > 0 ? newHistory[newHistory.length - 1].weight : participant.peso_inicial;

                const { error } = await supabase.from('participants').update({ 
                    weight_history: newHistory,
                    peso_atual: latestWeightInHistory 
                }).eq('id', participantId);

                if (error) {
                    showFeedbackMessage('Erro ao atualizar peso.', true);
                } else { 
                    showFeedbackMessage(`Peso de ${participant.name} atualizado!`); 
                    reloadData(); 
                }
            }

            async function detectWeightFromImage(participantId) {
                const weightPhotoInput = document.getElementById('profile-weight-photo');
                const weightInput = document.getElementById('profile-weight-input');
                const aiFeedback = document.getElementById('ai-weight-feedback');
                const photoFile = weightPhotoInput.files[0];

                if (!photoFile) {
                    aiFeedback.textContent = 'Por favor, selecione uma foto da balan√ßa.';
                    return;
                }

                aiFeedback.textContent = 'Detectando peso via IA...';
                showFeedbackMessage('Enviando foto para an√°lise de IA...', false);

                try {
                    // Upload da imagem para o Supabase Storage
                    const fileName = `public/temp_uploads/${participantId}-${Date.now()}-${photoFile.name}`;
                    const { data: uploadData, error: uploadError } = await supabase.storage.from('activity-photos').upload(fileName, photoFile);

                    if (uploadError) {
                        throw new Error('Erro ao enviar foto para o storage: ' + uploadError.message);
                    }
                    const imageUrl = supabase.storage.from('activity-photos').getPublicUrl(fileName).data.publicUrl;

                    // Chamada para a Supabase Edge Function que faz o OCR
                    // ATEN√á√ÉO: Voc√™ precisa ter uma Supabase Edge Function chamada 'get-weight-from-image'
                    // configurada em seu projeto Supabase, que far√° a comunica√ß√£o com um servi√ßo de IA
                    // para reconhecimento de texto em imagem (OCR).
                    // O exemplo conceitual dessa fun√ß√£o foi fornecido na conversa anterior.
                    const { data, error } = await supabase.functions.invoke('get-weight-from-image', {
                        body: { imageUrl: imageUrl },
                    });

                    if (error) {
                        throw new Error('Erro na fun√ß√£o de IA: ' + error.message);
                    }
                    
                    if (data && data.weight) {
                        weightInput.value = parseFloat(data.weight).toFixed(1);
                        aiFeedback.textContent = `Peso detectado: ${parseFloat(data.weight).toFixed(1)} kg. Revise e salve.`;
                        showFeedbackMessage('Peso detectado com sucesso!');
                    } else {
                        aiFeedback.textContent = 'N√£o foi poss√≠vel detectar o peso na imagem. Por favor, insira manualmente.';
                        showFeedbackMessage('N√£o foi poss√≠vel detectar o peso.', true);
                    }

                    // Opcional: Limpar a imagem tempor√°ria do storage ap√≥s a detec√ß√£o
                    supabase.storage.from('activity-photos').remove([fileName]);

                } catch (error) {
                    console.error("Erro na detec√ß√£o de peso por IA:", error);
                    aiFeedback.textContent = `Erro ao detectar peso: ${error.message}`;
                    showFeedbackMessage('Erro na detec√ß√£o de peso por IA.', true);
                }
            }

            async function handleDeleteWeightEntryConfirmed(participantId, entryDateISO) {
                const participant = participants.find(p => p.id == participantId);
                if (!participant) return;

                const newHistory = participant.weight_history.filter(entry => entry.date !== entryDateISO);

                // Permite apagar o √∫ltimo registro apenas se houver peso inicial, caso contr√°rio, avisa.
                if (newHistory.length === 0 && (participant.peso_inicial === undefined || participant.peso_inicial === null)) {
                    showFeedbackMessage("N√£o √© poss√≠vel excluir o √∫nico registro de peso se n√£o houver peso inicial definido.", true);
                    document.getElementById('deleteConfirmModal').classList.remove('show');
                    document.body.style.overflow = 'auto';
                    return;
                }
                
                newHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
                // O novo peso atual ser√° o √∫ltimo no hist√≥rico atualizado, ou o peso inicial se o hist√≥rico estiver vazio
                const newCurrentWeight = newHistory.length > 0 ? newHistory[newHistory.length - 1].weight : participant.peso_inicial;

                const { error } = await supabase.from('participants').update({ 
                    weight_history: newHistory, 
                    peso_atual: newCurrentWeight // Atualiza o campo peso_atual no DB
                }).eq('id', participant.id);

                if (error) {
                    showFeedbackMessage('Erro ao excluir registro de peso.', true);
                } else { 
                    showFeedbackMessage("Registro de peso exclu√≠do!"); 
                    reloadData();
                }
                // Fecha o modal de confirma√ß√£o ap√≥s a a√ß√£o
                document.getElementById('deleteConfirmModal').classList.remove('show');
                document.body.style.overflow = 'auto';
            }
            
            async function handleAddActivity(participantId) {
                const type = document.getElementById('profile-activity-type').value;
                const duration = parseInt(document.getElementById('profile-activity-duration').value);
                const photoFile = document.getElementById('profile-activity-photo').files[0];
                const photoPrivacy = document.getElementById('profile-activity-photo-privacy').value === 'public'; // true for public, false for private
                const activityDate = new Date();
                const weekIndex = Math.floor((activityDate - CHALLENGE_START_DATE) / (1000 * 60 * 60 * 24 * 7));

                if (!type || !duration || duration <= 0) return showFeedbackMessage('Preencha todos os campos da atividade.', true);
                
                const participant = participants.find(p => p.id == participantId);
                if (!participant) return;

                let imageUrl = null;
                if (photoFile) {
                    showFeedbackMessage('Enviando foto da atividade...', false);
                    const fileName = `public/activities/${participantId}-${Date.now()}-${photoFile.name}`;
                    const { error: uploadError } = await supabase.storage.from('activity-photos').upload(fileName, photoFile);
                    
                    if (uploadError) {
                        console.error("Erro no upload da foto da atividade:", uploadError);
                        return showFeedbackMessage('Erro ao enviar a foto da atividade.', true);
                    }
                    
                    imageUrl = supabase.storage.from('activity-photos').getPublicUrl(fileName).data.publicUrl;
                }

                const newActivity = { 
                    id: Date.now(), // Use a numeric timestamp as o ID
                    participantId: participantId,
                    type, 
                    duration, 
                    date: activityDate.toISOString(),
                    imageUrl: imageUrl,
                    is_public: photoPrivacy // Salva a privacidade da foto da atividade
                };

                const newSemanasValidas = JSON.parse(JSON.stringify(participant.semanas_validas));
                if (!Array.isArray(newSemanasValidas[weekIndex])) newSemanasValidas[weekIndex] = [];
                newSemanasValidas[weekIndex].push(newActivity);

                const { error } = await supabase.from('participants').update({ semanas_validas: newSemanasValidas }).eq('id', participantId);
                if (error) {
                    showFeedbackMessage('Erro ao adicionar atividade.', true);
                } else { 
                    showFeedbackMessage('Atividade adicionada com sucesso!'); 
                    await reloadData();
                }
            }

            async function handleDeleteActivityConfirmed(participantId, weekIndex, activityIdStr) {
                const activityId = activityIdStr; 

                const localParticipantIndex = participants.findIndex(p => p.id == participantId);
                if (localParticipantIndex === -1) {
                    document.getElementById('deleteConfirmModal').classList.remove('show');
                    document.body.style.overflow = 'auto';
                    return;
                }

                const participant = participants[localParticipantIndex];
                const originalParticipantState = JSON.parse(JSON.stringify(participant));

                // ATUALIZA√á√ÉO OTIMISTA
                const updatedParticipant = JSON.parse(JSON.stringify(participant));
                if (updatedParticipant.semanas_validas[weekIndex]) {
                    updatedParticipant.semanas_validas[weekIndex] = updatedParticipant.semanas_validas[weekIndex].filter(act => act.id !== activityId);
                } else {
                    document.getElementById('deleteConfirmModal').classList.remove('show');
                    document.body.style.overflow = 'auto';
                    return;
                }

                participants[localParticipantIndex] = updatedParticipant;

                // ATUALIZA√á√ÉO DA TELA
                showFeedbackMessage('Atividade apagada.');
                updateCurrentView();

                // SINCRONIZA√á√ÉO COM O BANCO
                const { error } = await supabase
                    .from('participants')
                    .update({ semanas_validas: updatedParticipant.semanas_validas })
                    .eq('id', participantId);

                // REVERS√ÉO EM CASO DE ERRO
                if (error) {
                    showFeedbackMessage('Erro ao apagar. A atividade ser√° restaurada.', true);
                    participants[localParticipantIndex] = originalParticipantState;
                    updateCurrentView();
                } else {
                    const activityToDelete = originalParticipantState.semanas_validas[weekIndex]?.find(act => act.id === activityId);
                    if (activityToDelete && activityToDelete.imageUrl) {
                        const fileName = activityToDelete.imageUrl.split('/').pop();
                        // As imagens de peso e atividade agora est√£o em subpastas 'weights' e 'activities'
                        // Precisamos determinar qual pasta para remover corretamente
                        let storagePath = '';
                        if (fileName.startsWith('weights/')) { // Assume um prefixo se for o caso
                             storagePath = `public/${fileName}`;
                        } else if (fileName.startsWith('activities/')) { // Assume um prefixo se for o caso
                             storagePath = `public/${fileName}`;
                        } else {
                             // Tenta remover do local original (para compatibilidade com imagens antigas ou se n√£o houver subpasta)
                             storagePath = `public/activities/${fileName}`; // Default para atividades
                             // Ou poderia ser: storagePath = `public/${fileName}`; se o nome j√° for √∫nico e na raiz
                        }
                        
                        // Melhorar a l√≥gica de remo√ß√£o se voc√™ tiver pastas 'public/weights/' e 'public/activities/'
                        // Por agora, o `handleUpdateWeight` e `handleAddActivity` salvam em `public/weights/...` e `public/activities/...`
                        // A remo√ß√£o precisa refletir isso.
                        // Corre√ß√£o: `fileName` j√° vem com `public/weights/` ou `public/activities/` se foi feito upload pelo frontend
                        // A remo√ß√£o precisa apenas do caminho relativo ap√≥s `from('bucket_name')`.
                        const pathToRemove = activityToDelete.imageUrl.split('.co/')[1].split('/').slice(2).join('/'); // Pega path ap√≥s bucket/public/
                        supabase.storage.from('activity-photos').remove([pathToRemove]);
                    }
                }
                // Fecha o modal de confirma√ß√£o ap√≥s a a√ß√£o
                document.getElementById('deleteConfirmModal').classList.remove('show');
                document.body.style.overflow = 'auto';
            }
            
            async function handleUpdateMeasurements(participantId) {
                const cintura = parseFloat(document.getElementById('profile-cintura').value);
                const quadril = parseFloat(document.getElementById('profile-quadril').value);
                const abdomen = parseFloat(document.getElementById('profile-abdomen').value);

                const participant = participants.find(p => p.id == participantId);
                if (participant) {
                    const newEntry = {
                        date: new Date().toISOString(),
                        cintura: !isNaN(cintura) ? cintura : null,
                        quadril: !isNaN(quadril) ? quadril : null,
                        abdomen: !isNaN(abdomen) ? abdomen : null,
                    };

                    const newHistory = [...(participant.measurements_history || []), newEntry];
                    const { error } = await supabase.from('participants').update({ measurements_history: newHistory }).eq('id', participantId);

                    if (error) showFeedbackMessage('Erro ao atualizar medidas.', true);
                    else { 
                        showFeedbackMessage(`Medidas de ${participant.name} atualizadas!`); 
                        participant.measurements_history = newHistory;
                        updateCurrentView();
                    }
                }
            }

            // --- MODALS (Generalizado openConfirmModal) ---
            function openConfirmModal(messageHTML, onConfirmCallback) {
                const modal = document.getElementById('deleteConfirmModal');
                document.body.style.overflow = 'hidden';
                modal.classList.add('show');
                modal.innerHTML = `<div class="modal-content text-center">
                        <h3 class="text-2xl font-bold mb-4 text-white">Confirmar Exclus√£o</h3>
                        <p class="mb-6 text-gray-300">${messageHTML}</p>
                        <div class="flex justify-center gap-4">
                            <button class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg" id="cancelConfirm">Cancelar</button>
                            <button style="background-color: var(--danger-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg" id="confirmAction">Confirmar</button>
                        </div>
                    </div>`;
                
                modal.querySelector('#cancelConfirm').onclick = () => { 
                    modal.classList.remove('show'); 
                    document.body.style.overflow = 'auto'; 
                };
                modal.querySelector('#confirmAction').onclick = () => {
                    onConfirmCallback(); // Executa a fun√ß√£o de callback fornecida
                };
            }
            
            // --- UTILITY FUNCTIONS ---
            function updateSummaryBoxes() {
                const leaderBox = document.getElementById('leaderBox');
                const weeklyBox = document.getElementById('weeklyHighlightBox');
                const monthlyBox = document.getElementById('monthlyHighlightBox');
                const daysBox = document.getElementById('daysRemainingBox');

                const ranked = participants.map(p => calculateMetrics(p, new Date())).sort((a, b) => b.totalPoints - a.totalPoints);
                if (ranked.length > 0) {
                    const leader = ranked[0];
                    leaderBox.innerHTML = `<div class="text-sm font-medium text-gray-400">üëë L√≠der Atual</div><div class="text-2xl font-bold" style="color: var(--success-color);">${leader.name}</div><div class="text-sm text-gray-300">${leader.totalPoints.toFixed(2)} pts</div>`;
                } else {
                    leaderBox.innerHTML = `<div class="text-sm font-medium text-gray-400">üëë L√≠der Atual</div><div class="text-2xl font-bold">N/A</div>`;
                }
                
                let weeklyWinner = { name: 'N/A', loss: Number.NEGATIVE_INFINITY };
                const oneWeekAgo = new Date(); oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                participants.forEach(p => {
                    // Usa getWeightAtDate para garantir a precis√£o
                    const loss = getWeightAtDate(p, oneWeekAgo) - getWeightAtDate(p, new Date()); 
                    if (loss > weeklyWinner.loss) weeklyWinner = { name: p.name, loss };
                });
                weeklyBox.innerHTML = `<div class="text-sm font-medium text-gray-400">üî• Destaque da Semana</div><div class="text-2xl font-bold" style="color: var(--warning-color);">${weeklyWinner.loss > 0 ? weeklyWinner.name : 'N/A'}</div><div class="text-sm text-gray-300">${weeklyWinner.loss > 0 ? weeklyWinner.loss.toFixed(2) : '0.00'} kg</div>`;

                let monthlyWinner = { name: 'N/A', loss: Number.NEGATIVE_INFINITY };
                const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
                participants.forEach(p => {
                    // Usa getWeightAtDate para garantir a precis√£o
                    const loss = getWeightAtDate(p, firstDayOfMonth) - getWeightAtDate(p, new Date()); 
                    if (loss > monthlyWinner.loss) monthlyWinner = { name: p.name, loss };
                });
                monthlyBox.innerHTML = `<div class="text-sm font-medium text-gray-400">üåü Destaque do M√™s</div><div class="text-2xl font-bold" style="color: var(--primary-color);">${monthlyWinner.loss > 0 ? monthlyWinner.name : 'N/A'}</div><div class="text-sm text-gray-300">Perdeu ${monthlyWinner.loss > 0 ? monthlyWinner.loss.toFixed(2) : '0.00'} kg</div>`;

                const daysRemaining = Math.max(0, Math.ceil((CHALLENGE_END_DATE - new Date()) / (1000 * 60 * 60 * 24)));
                daysBox.innerHTML = `<div class="text-sm font-medium text-gray-400">‚è≥ Dias Restantes</div><div class="text-3xl font-bold text-white">${daysRemaining}</div>`;
            }
            
            function calculateTrendLine(data) {
                if (data.length < 2) return null;
                const n = data.length;
                const firstDay = new Date(data[0].date).getTime();
                const x = data.map(d => (new Date(d.date).getTime() - firstDay) / (1000 * 60 * 60 * 24));
                const y = data.map(d => d.weight);
                const sumX = d3.sum(x), sumY = d3.sum(y), sumXY = d3.sum(x.map((xi,i) => xi * y[i])), sumXX = d3.sum(x.map(xi => xi*xi));
                const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
                const intercept = (sumY - slope * sumX) / n;
                const predict = (day) => slope * day + intercept;
                const startDay = (new Date(data[0].date).getTime() - firstDay) / (1000 * 60 * 60 * 24);
                const endDay = (CHALLENGE_END_DATE.getTime() - firstDay) / (1000 * 60 * 60 * 24);
                return { start: { date: new Date(data[0].date), weight: predict(startDay) }, end: { date: CHALLENGE_END_DATE, weight: predict(endDay) } };
            }

            // --- AI FUNCTIONS ---

            async function getAIGeneration(prompt, resultContainer) {
                resultContainer.innerHTML = '<div class="ai-tip-loader"></div>';
                try {
                    const { data, error } = await supabase.functions.invoke('get-ai-tip', {
                        body: { prompt: prompt },
                    });

                    if (error) throw error;
                    
                    if (data && data.tip) {
                        resultContainer.innerHTML = data.tip.replace(/\n/g, '<br>');
                    } else {
                        throw new Error("Resposta da IA inv√°lida.");
                    }

                } catch (error) {
                    console.error("Erro ao chamar a IA:", error);
                    resultContainer.innerHTML = 'Ocorreu um erro ao gerar a resposta. Tente novamente mais tarde.';
                }
            }

            async function handleGenerateMealPlan() {
                const resultContainer = document.getElementById('meal-plan-result');
                // Pega o participante logado para gerar o plano, ou o primeiro se for admin
                const participantId = currentUser.role === 'admin' && participants.length > 0 ? participants[0].id : currentUser.participantId;
                const p = participants.find(p => p.id === participantId);
                if (!p) return resultContainer.innerHTML = 'Nenhum participante encontrado para gerar o plano.';

                const likedFoods = document.getElementById('liked-foods').value || 'nenhuma prefer√™ncia';
                const dislikedFoods = document.getElementById('disliked-foods').value || 'nenhuma restri√ß√£o';
                
                // Usa o peso atual mais recente do participante para a IA
                const currentWeight = getWeightAtDate(p, new Date()); 

                const prompt = `Aja como um nutricionista. Crie um plano de refei√ß√µes simples para um dia (caf√© da manh√£, almo√ßo, lanche da tarde e jantar) para a/o ${p.name}, que atualmente pesa ${currentWeight.toFixed(1)} kg e tem como meta perder peso. O plano deve ter aproximadamente 1800 calorias. Considere que ele(a) gosta de ${likedFoods} e deve evitar ${dislikedFoods}.`;
                getAIGeneration(prompt, resultContainer);
            }

            async function handleGenerateWorkout() {
                const resultContainer = document.getElementById('workout-result');
                // Pega o participante logado para gerar o treino, ou o primeiro se for admin
                const participantId = currentUser.role === 'admin' && participants.length > 0 ? participants[0].id : currentUser.participantId;
                const p = participants.find(p => p.id === participantId);
                if (!p) return resultContainer.innerHTML = 'Nenhum participante encontrado para gerar o treino.';

                const lastActivities = (p.semanas_validas || []).flat().slice(-3).map(a => a.type).join(', ') || 'nenhuma atividade recente';
                const prompt = `Aja como um personal trainer. O participante ${p.name} registrou recentemente as seguintes atividades: ${lastActivities}. Sugira um treino complementar para o pr√≥ximo dia, com 3 a 4 exerc√≠cios que podem ser feitos em casa, explicando cada um brevemente.`;
                getAIGeneration(prompt, resultContainer);
            }

            async function handleGenerateMotivation() {
                const resultContainer = document.getElementById('motivation-result');
                // Pega o participante logado para gerar a motiva√ß√£o, ou o primeiro se for admin
                const participantId = currentUser.role === 'admin' && participants.length > 0 ? participants[0].id : currentUser.participantId;
                const p = participants.find(p => p.id === participantId);
                if (!p) return resultContainer.innerHTML = 'Nenhum participante encontrado para gerar o resumo.';

                const today = new Date();
                const oneWeekAgo = new Date(); oneWeekAgo.setDate(today.getDate() - 7);
                const weightThen = getWeightAtDate(p, oneWeekAgo);
                const weightNow = getWeightAtDate(p, today); // Pega o peso mais recente
                const weightLossThisWeek = weightThen - weightNow;
                const currentWeekIndex = Math.floor((today - CHALLENGE_START_DATE) / (1000 * 60 * 60 * 24 * 7));
                const activitiesThisWeek = (p.semanas_validas[currentWeekIndex] || []).length;
                
                // Usa o peso atual mais recente para o total perdido
                const totalLost = p.peso_inicial - getWeightAtDate(p, today);

                const prompt = `Escreva um resumo motivacional curto e amig√°vel para ${p.name}. Dados da √∫ltima semana: perdeu ${weightLossThisWeek.toFixed(1)}kg, registrou ${activitiesThisWeek} atividades. Perda total no desafio: ${totalLost.toFixed(1)}kg. Parabenize-o(a) pelo esfor√ßo e incentive-o(a) a manter o foco.`;
                getAIGeneration(prompt, resultContainer);
            }
            
            async function handleGenerateGroupAnalysis() {
                if (currentUser.role !== 'admin') return;
                const resultContainer = document.getElementById('group-analysis-result');
                
                let weeklyDataString = '';
                const currentWeekIndex = Math.floor((new Date() - CHALLENGE_START_DATE) / (1000 * 60 * 60 * 24 * 7));

                for (let i = 0; i <= currentWeekIndex && i < MAX_WEEKS; i++) {
                    const weekStartDate = new Date(CHALLENGE_START_DATE);
                    weekStartDate.setDate(weekStartDate.getDate() + i * 7);
                    const weekEndDate = new Date(weekStartDate);
                    weekEndDate.setDate(weekEndDate.getDate() + 7);

                    let totalWeeklyLoss = 0;
                    let totalWeeklyActivities = 0;

                    participants.forEach(p => {
                        const weightStart = getWeightAtDate(p, weekStartDate);
                        const weightEnd = getWeightAtDate(p, weekEndDate);
                        if (weightStart > weightEnd) {
                            totalWeeklyLoss += weightStart - weightEnd;
                        }
                        totalWeeklyActivities += (p.semanas_validas[i] || []).length;
                    });
                    weeklyDataString += `Na Semana ${i + 1}, o grupo perdeu um total de ${totalWeeklyLoss.toFixed(1)}kg e registrou ${totalWeeklyActivities} atividades. `;
                }

                const prompt = `Analise os seguintes dados agregados de um desafio de fitness: ${weeklyDataString} Identifique a tend√™ncia geral (o ritmo est√° diminuindo, aumentando ou est√°vel?), aponte a semana de maior sucesso e sugira uma a√ß√£o para o administrador, como enviar uma mensagem de incentivo geral.`;
                getAIGeneration(prompt, resultContainer);
            }

            async function handleGenerateStagnationTip() {
                const resultContainer = document.getElementById('stagnation-tip-result');
                const participantId = currentUser.role === 'admin' && participants.length > 0 ? (document.getElementById('stagnation-participant-selector')?.value || participants[0].id) : currentUser.participantId;
                const p = participants.find(p => p.id == participantId);
                if (!p) return resultContainer.innerHTML = 'Nenhum participante encontrado.';

                const history = p.weight_history || [];
                if (history.length < 2) {
                    return resultContainer.innerHTML = 'Dados insuficientes. Continue registrando seu peso para detectarmos tend√™ncias.';
                }

                // Pega os dois √∫ltimos pesos na ordem cronol√≥gica
                const sortedHistory = [...history].sort((a, b) => new Date(a.date) - new Date(b.date));
                const lastWeightEntry = sortedHistory[sortedHistory.length - 1];
                const secondLastWeightEntry = sortedHistory[sortedHistory.length - 2];

                if (lastWeightEntry.weight >= secondLastWeightEntry.weight) {
                    // Stagnation detected
                    const lastActivities = (p.semanas_validas || []).flat().slice(-3).map(a => a.type).join(', ') || 'Caminhada';
                    const prompt = `O participante ${p.name} n√£o perdeu peso na √∫ltima pesagem registrada (${lastWeightEntry.weight.toFixed(1)} kg) em compara√ß√£o com a pen√∫ltima (${secondLastWeightEntry.weight.toFixed(1)} kg). Suas atividades principais recentes s√£o '${lastActivities}'. Crie uma mensagem curta, amig√°vel e encorajadora sugerindo uma forma de quebrar o plat√¥. Sugira, por exemplo, aumentar a intensidade, variar o tipo de treino ou uma dica de nutri√ß√£o.`;
                    getAIGeneration(prompt, resultContainer);
                } else {
                    resultContainer.innerHTML = `√ìtimo trabalho! Seu progresso est√° constante (perdeu ${(secondLastWeightEntry.weight - lastWeightEntry.weight).toFixed(1)} kg na √∫ltima pesagem) e n√£o detectamos sinais de estagna√ß√£o. Continue assim!`;
                }
            }
            
            async function getAICoachingTip(participantId) {
                const participant = participants.find(p => p.id == participantId);
                if (!participant) return;

                const tipContainer = document.getElementById('ai-tip-container');
                const activityHistory = participant.semanas_validas.slice(-4).map(week => (Array.isArray(week) ? week.length : 0)).join(', ');
                
                // Usa o peso mais recente para a dica
                const currentWeight = getWeightAtDate(participant, new Date());

                const prompt = `Seja um coach de fitness motivador e amig√°vel, em portugu√™s do Brasil. D√™ uma dica curta e pr√°tica para o participante: Nome: ${participant.name}, Peso Inicial: ${participant.peso_inicial.toFixed(1)} kg, Peso Atual: ${currentWeight.toFixed(1)} kg, Meta: ${participant.target_weight ? participant.target_weight.toFixed(1) : 'N/A'} kg. Atividades nas √∫ltimas 4 semanas: ${activityHistory}. Fale diretamente com o participante (use "voc√™").`;
                
                getAIGeneration(prompt, tipContainer);
            }
            
            async function handleReactionClick(button) {
                const activityId = button.dataset.activityId; // ID pode ser string para entradas de peso
                const reactionType = button.dataset.reactionType;
                const userId = currentUser.participantId;
                
                if (!userId) {
                    showFeedbackMessage('Apenas participantes podem reagir.', true);
                    return;
                }

                // Filtrar rea√ß√µes usando compara√ß√£o frouxa (==) para lidar com strings e n√∫meros se necess√°rio,
                // mas √© melhor garantir que os IDs sejam do mesmo tipo (string ou number) para consist√™ncia.
                // O ideal √© que todos os IDs de atividade/peso sejam strings ou todos n√∫meros.
                const existingReaction = reactions.find(r => r.activity_id == activityId && r.user_id == userId && r.reaction_type === reactionType);

                if (existingReaction) {
                    // User is removing the reaction
                    const { error } = await supabase.from('reactions').delete().match({ id: existingReaction.id });
                    if (error) {
                        showFeedbackMessage(`N√£o foi poss√≠vel remover a rea√ß√£o.`, true);
                        console.error("Error removing reaction:", error);
                    } else {
                        showFeedbackMessage('Rea√ß√£o removida!');
                    }
                } else {
                    // User is adding a new reaction
                    const { data, error } = await supabase.from('reactions').insert([{ activity_id: activityId, user_id: userId, reaction_type: reactionType }]).select();
                    if (error) {
                        showFeedbackMessage(`N√£o foi poss√≠vel adicionar a rea√ß√£o.`, true);
                        console.error("Error adding reaction:", error);
                    } else {
                        showFeedbackMessage('Rea√ß√£o adicionada!');
                    }
                }

                // After attempting the action, refetch all reactions from the database
                // to update the local state and ensure the UI is correct.
                const { data: reactionsData, error: reactionsError } = await supabase.from('reactions').select('*');
                if (!reactionsError) {
                    reactions = reactionsData;
                }
                // Re-render the activity feed with the fresh data
                showSection('activityFeed');
            }

             async function exportDetailsToPDF(participantId) {
                const detailsElement = document.getElementById('profile-content');
                const participant = participants.find(p => p.id == participantId);
                if (!detailsElement || !participant) return;
                
                showFeedbackMessage('Gerando relat√≥rio PDF...', false);
                html2canvas(detailsElement, { scale: 2, useCORS: true, backgroundColor: '#1f2937' }).then(canvas => {
                    const { jsPDF } = window.jspdf;
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF({ orientation: 'portrait', unit: 'px', format: [canvas.width, canvas.height] });
                    pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                    pdf.save(`relatorio_${participant.name.replace(/\s/g, '_')}.pdf`);
                });
            }

            function showFeedbackMessage(message, isError = false) {
                feedbackMessageDiv.textContent = message;
                feedbackMessageDiv.className = `feedback-message show ${isError ? 'error' : ''}`;
                setTimeout(() => feedbackMessageDiv.classList.remove('show'), 4000);
            }
            
            function debounce(func, delay) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            }

            function formatTimeAgo(date) {
                const seconds = Math.floor((new Date() - date) / 1000);
                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + " anos atr√°s";
                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + " meses atr√°s";
                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + " dias atr√°s";
                interval = seconds / 3600;
                if (interval > 1) return Math.floor(interval) + " horas atr√°s";
                interval = seconds / 60;
                if (interval > 1) return Math.floor(interval) + " minutos atr√°s";
                return "agora mesmo";
            }
            
            // --- NEW UTILITY FUNCTION FOR SORTING ---
            function getActivityTimestamp(activity) {
                // Prioriza a data real do registro para ordena√ß√£o
                if (activity && activity.date) {
                    return new Date(activity.date).getTime();
                }
                // Fallback para IDs num√©ricos (usado para pesagens geradas com Date.now())
                if (activity && typeof activity.id === 'number') {
                    return activity.id;
                }
                // Fallback para IDs de string contendo timestamp
                if (activity && typeof activity.id === 'string' && activity.id.includes('-')) {
                    return parseInt(activity.id.split('-').pop() || '0', 10);
                }
                return 0;
            }

            // --- INITIALIZE THE APP ---
            initApp();
        });
    </script>
</body>
</html>