<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIT Challenge PRO</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1f2937"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FIT Challenge PRO">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/1f2937/ffffff?text=FIT">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --font-inter: 'Inter', sans-serif;
            
            /* Minimalist Color Palette */
            --bg-main: #f4f5f7; /* Light Gray */
            --bg-sidebar: #1f2937; /* Dark Slate */
            --bg-header: #ffffff;
            --bg-content: #ffffff;
            --text-dark: #111827;
            --text-muted: #6b7280;
            --border-color: #e5e7eb;

            --primary-color: #4f46e5; /* Indigo */
            --primary-hover: #4338ca;
            --danger-color: #dc2626; /* Red */
            --danger-hover: #b91c1c;
            --success-color: #16a34a; /* Green */
            --success-hover: #15803d;
            --warning-color: #f59e0b; /* Amber */
            --warning-hover: #d97706;

            --leader-row-bg: #eef2ff; /* Indigo Light */
            --leader-row-border: var(--primary-color);
        }
        body { font-family: var(--font-inter); background-color: var(--bg-main); color: var(--text-dark); }
        
        #sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar-link { display: flex; align-items: center; padding: 0.75rem 1.5rem; border-radius: 0.5rem; transition: background-color 0.2s, color 0.2s; }
        .sidebar-link:hover { background-color: #374151; }
        .sidebar-link.active { background-color: var(--primary-color); color: white; font-weight: 600; }
        .sidebar-link svg { width: 1.25rem; height: 1.25rem; margin-right: 0.75rem; flex-shrink: 0; }

        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th, td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
        th { background-color: #f9fafb; font-weight: 600; color: var(--text-muted); position: sticky; top: 0; z-index: 10; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em; }
        th.sortable { cursor: pointer; }
        th.sortable:hover { background-color: #f3f4f6; }
        tr:last-child td { border-bottom: none; }
        .leader-row { background-color: var(--leader-row-bg) !important; border-left: 4px solid var(--leader-row-border); }
        
        .summary-box { background-color: var(--bg-content); border: 1px solid var(--border-color); padding: 1.5rem; border-radius: 0.75rem; font-weight: 600; color: var(--text-dark); text-align: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .feedback-message { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--success-color); color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); opacity: 0; transition: opacity 0.3s; z-index: 1001; }
        .feedback-message.show { opacity: 1; }
        .feedback-message.error { background-color: var(--danger-color); }
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s; }
        .modal.show { opacity: 1; visibility: visible; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 2rem; border-radius: 1rem; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 600px; position: relative; transform: scale(0.95); transition: transform 0.3s; }
        .modal.show .modal-content { transform: scale(1); }
        .close-button { position: absolute; top: 10px; right: 20px; color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .badge { font-size: 1.1rem; margin-left: 0.25rem; }
        .progress-bar-container { width: 100%; background-color: #e5e7eb; border-radius: 9999px; height: 1.25rem; overflow: hidden; position: relative; }
        .progress-bar-fill { height: 100%; background-color: var(--success-color); border-radius: 9999px; transition: width 0.5s ease-in-out; display: flex; align-items: center; justify-content: center; }
        .progress-bar-text { color: white; font-size: 0.75rem; font-weight: 600; }
        
        .axis path, .axis line { fill: none; stroke: transparent; }
        .axis text { font-size: 0.8rem; fill: #6b7280; }
        .grid line { stroke: #e5e7eb; stroke-opacity: 0.7; shape-rendering: crispEdges; }
        .grid path { stroke-width: 0; }
        .tooltip-chart { position: absolute; text-align: center; padding: 8px; font: 12px sans-serif; background: rgba(0, 0, 0, 0.8); color: white; border-radius: 8px; pointer-events: none; opacity: 0; transition: opacity 0.2s; }
        .empty-state-message { text-align: center; padding: 2rem; color: #6b7280; font-style: italic; }

        .loader { border: 8px solid #f3f3f3; border-radius: 50%; border-top: 8px solid var(--primary-color); width: 60px; height: 60px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .ai-tip-loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; margin: 0 auto; }
        
        /* New Button Styles */
        .action-btn {
            font-weight: 600;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            text-align: center;
            font-size: 0.75rem;
            transition: all 0.2s;
            border: 1px solid transparent;
            background-color: #ffffff;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-primary { color: var(--primary-color); border-color: var(--primary-color); }
        .btn-primary:hover { background-color: var(--primary-color); color: white; }
        .btn-warning { color: var(--warning-color); border-color: var(--warning-color); }
        .btn-warning:hover { background-color: var(--warning-color); color: white; }
        .btn-danger { color: var(--danger-color); border-color: var(--danger-color); }
        .btn-danger:hover { background-color: var(--danger-color); color: white; }

        /* Profile Page Specific Styles */
        .profile-card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
        }

        /* Activity Log Styles */
        .activity-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 0.5rem;
        }
        .activity-cell {
            width: 100%;
            padding-bottom: 100%; /* Creates a square aspect ratio */
            border-radius: 0.25rem;
            position: relative;
            transition: transform 0.2s;
        }
        .activity-cell:hover {
            transform: scale(1.1);
        }
        .activity-cell-label {
            position: absolute;
            top: -1.2rem;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.65rem;
            color: var(--text-muted);
        }
        .activity-cell.current-week {
            border: 2px solid var(--primary-color);
        }
        .activity-none { background-color: #e5e7eb; } /* Gray */
        .activity-partial { background-color: #fef3c7; } /* Amber Light */
        .activity-complete { background-color: #dcfce7; } /* Green Light */
    </style>
</head>
<body class="bg-gray-100">

    <div id="loginScreen" class="flex items-center justify-center min-h-screen bg-gray-900 p-4">
        <div class="bg-white p-8 sm:p-10 rounded-2xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-10">
                <h1 class="text-4xl font-extrabold text-gray-800">FIT Challenge <span style="color: var(--primary-color);">PRO</span></h1>
                <p class="text-gray-500 mt-2">Acesse para acompanhar o desafio</p>
            </div>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Usuário</label>
                    <input type="text" id="username" placeholder="Seu usuário" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                    <input type="password" id="password" placeholder="Sua senha" class="shadow-sm appearance-none border rounded-lg w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                </div>
                <p id="loginError" class="text-red-500 text-sm italic mb-4 hidden text-center">Usuário ou senha inválidos.</p>
                <button type="submit" style="background-color: var(--primary-color);" class="hover:opacity-90 text-white font-bold py-3 px-6 rounded-lg shadow-md transition w-full">Entrar</button>
            </form>
        </div>
    </div>
    
    <div id="loadingIndicator" class="hidden fixed inset-0 bg-white bg-opacity-75 flex flex-col items-center justify-center z-50">
        <div class="loader"></div>
        <p class="mt-4 text-lg font-semibold text-gray-700">Carregando dados...</p>
    </div>

    <div id="app" class="hidden flex h-screen bg-gray-100 font-sans">
        <aside id="sidebar" class="w-64 bg-gray-900 text-white flex-shrink-0 flex flex-col fixed lg:relative h-full z-30 transform -translate-x-full lg:translate-x-0">
            <div class="px-6 py-4 border-b border-gray-700">
                <h1 class="text-2xl font-bold text-white">FIT <span style="color: var(--primary-color);">PRO</span></h1>
            </div>
            <nav id="sidebarNav" class="flex-1 px-4 py-4 space-y-2 overflow-y-auto"></nav>
            <div class="px-4 py-4 border-t border-gray-700">
                <div class="relative">
                    <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                        <svg class="w-5 h-5 text-gray-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path></svg>
                    </span>
                    <input type="text" id="searchParticipantInput" placeholder="Buscar participante..." class="bg-gray-700 text-white placeholder-gray-400 rounded-lg w-full py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
            </div>
        </aside>

        <div id="sidebar-overlay" class="hidden lg:hidden fixed inset-0 bg-black opacity-50 z-20"></div>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header id="header" class="bg-white shadow-sm p-4 flex justify-between items-center z-10">
                <button id="mobileMenuBtn" class="lg:hidden text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-16 6h16"></path></svg>
                </button>
                <h2 id="pageTitle" class="text-xl font-semibold text-gray-800"></h2>
                <div class="flex items-center gap-4">
                   <div id="header-action-buttons" class="hidden sm:flex items-center gap-2 flex-wrap"></div>
                   <button id="logoutBtn" style="background-color: var(--danger-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm">Sair</button>
                </div>
            </header>

            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-100 p-6">
                <div id="summary-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div id="leaderBox" class="summary-box"></div>
                    <div id="weeklyHighlightBox" class="summary-box"></div>
                    <div id="monthlyHighlightBox" class="summary-box"></div>
                    <div id="daysRemainingBox" class="summary-box"></div>
                </div>
                
                <div id="dynamic-content">
                </div>
            </main>
        </div>
    </div>

    <div id="feedbackMessage" class="feedback-message"></div>
    <div id="participantModal" class="modal"></div>
    <div id="deleteConfirmModal" class="modal"></div>

    <script>
        // --- PWA Service Worker (Placeholder) ---
        if ('serviceWorker' in navigator) {
            const manifest = {
                "name": "FIT Challenge PRO", "short_name": "FIT PRO", "start_url": ".", "display": "standalone",
                "background_color": "#1f2937", "theme_color": "#4f46e5", "description": "Acompanhamento do FIT Challenge.",
                "icons": [{ "src": "https://placehold.co/192x192/4f46e5/ffffff?text=FIT", "sizes": "192x192", "type": "image/png" }]
            };
            const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(manifestBlob);
            document.querySelector('link[rel="manifest"]').setAttribute('href', manifestURL);
        }
    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURAÇÃO DO SUPABASE ---
            const SUPABASE_URL = 'https://wkvwrtwovcfnvfgleslq.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndrdndydHdvdmNmbnZmZ2xlc2xxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzNTE2MTQsImV4cCI6MjA2NzkyNzYxNH0.osy_C1SsPJ7t8BJlri7DpVDJU64S_IfRzy9KEBP9VMY';
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            // --- CONFIGURAÇÕES E CONSTANTES DO DESAFIO ---
            const ADMIN_USER = { username: 'admin', password: 'admin' }; // Admin credentials
            let CHALLENGE_START_DATE = new Date('2025-07-07T00:00:00');
            let CHALLENGE_END_DATE = new Date('2025-10-07T23:59:59');
            const MAX_WEEKS = 12;
            const MIN_ACTIVITIES_FOR_VALID_WEEK = 3;
            const MAX_ACTIVITY_POINTS = 50;
            const ACTIVITY_TYPES = ['Musculação', 'Corrida', 'Caminhada', 'Natação', 'Yoga', 'Dança', 'Ciclismo', 'Outro'];
            
            // --- NAVIGATION LINKS WITH ROLE-BASED ACCESS ---
            const NAV_LINKS = [
                { id: 'myProfile', text: 'Meu Perfil', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>', roles: ['participant'] },
                { id: 'ranking', text: 'Ranking Geral', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>', roles: ['admin', 'participant'] },
                { id: 'participants', text: 'Participantes', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>', roles: ['admin'] },
                { id: 'weeklySummary', text: 'Resumo Semanal', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>', roles: ['admin', 'participant'] },
                { id: 'activityLog', text: 'Histórico de Atividades', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>', roles: ['admin', 'participant'] },
                { id: 'coachVirtual', text: 'Coach Virtual', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>', roles: ['admin', 'participant'] },
                { id: 'individualEvolution', text: 'Evolução Individual', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"></path></svg>', roles: ['admin', 'participant'] },
                { id: 'groupEvolution', text: 'Evolução do Grupo', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>', roles: ['admin', 'participant']},
                { id: 'comparison', text: 'Comparativo', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>', roles: ['admin', 'participant'] },
                { id: 'rules', text: 'Regras', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>', roles: ['admin', 'participant'] },
                { id: 'configuracoes', text: 'Configurações', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>', roles: ['admin'] },
                { id: 'participantProfile', text: 'Perfil do Participante', icon: '', hidden: true, roles: ['admin'] } // Hidden route for admin access
            ];
            
            // --- APPLICATION STATE ---
            let currentUser = null; // Will be an object: { username, role, participantId }
            let participants = [];
            let weeklyPointsWinnerName = null;
            let rankingSortConfig = { key: 'totalPoints', direction: 'desc' };
            let currentProfileParticipantId = null;
            let currentViewId = null; // State to track the current view

            // --- DOM ELEMENTS ---
            const loginScreen = document.getElementById('loginScreen');
            const appContainer = document.getElementById('app');
            const feedbackMessageDiv = document.getElementById('feedbackMessage');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const dynamicContentContainer = document.getElementById('dynamic-content');
            const pageTitle = document.getElementById('pageTitle');
            const headerActionButtons = document.getElementById('header-action-buttons');
            
            // --- INITIALIZATION AND AUTH ---
            function initApp() {
                loadChallengeConfig();
                setupEventListeners();
                checkLoginState();
            }

            function loadChallengeConfig() {
                const config = localStorage.getItem('challengeConfig');
                if (config) {
                    const { start, end } = JSON.parse(config);
                    CHALLENGE_START_DATE = new Date(start);
                    CHALLENGE_END_DATE = new Date(end);
                }
            }

            function saveChallengeConfig() {
                localStorage.setItem('challengeConfig', JSON.stringify({
                    start: CHALLENGE_START_DATE.toISOString(),
                    end: CHALLENGE_END_DATE.toISOString()
                }));
            }

            async function loadDataAndLogin(user) {
                loadingIndicator.classList.remove('hidden');
                appContainer.classList.add('opacity-50', 'pointer-events-none');

                const { data, error } = await supabase.from('participants').select('*').order('name');
                
                loadingIndicator.classList.add('hidden');
                appContainer.classList.remove('opacity-50', 'pointer-events-none');

                if (error) {
                    console.error('Error loading data:', error);
                    showFeedbackMessage('Erro ao carregar dados do banco.', true);
                    handleLogout();
                } else {
                    participants = data.map(p => ({
                        ...p,
                        semanas_validas: (p.semanas_validas && Array.isArray(p.semanas_validas)) ? p.semanas_validas : Array(12).fill([]),
                        weight_history: p.weight_history || [],
                        measurements_history: p.measurements_history || [],
                    }));
                    
                    currentUser = user;
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                    loginScreen.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    appContainer.classList.add('flex');
                    renderSidebarNav();
                    
                    calculateWeeklyWinners();
                    updateSummaryBoxes();
                    
                    if (currentUser.role === 'admin') {
                        showSection('ranking');
                    } else {
                        currentProfileParticipantId = currentUser.participantId;
                        showSection('myProfile');
                    }
                }
            }

            function checkLoginState() {
                const storedUser = sessionStorage.getItem('currentUser');
                if (storedUser) {
                    const user = JSON.parse(storedUser);
                    loadDataAndLogin(user);
                } else {
                    loginScreen.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    appContainer.classList.remove('flex');
                    loadingIndicator.classList.add('hidden');
                }
            }

            async function handleLogin(e) {
                e.preventDefault();
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;
                const loginError = document.getElementById('loginError');
                loginError.classList.add('hidden');

                if (username === ADMIN_USER.username && password === ADMIN_USER.password) {
                    const user = { username: ADMIN_USER.username, role: 'admin', participantId: null };
                    await loadDataAndLogin(user);
                    return;
                }

                const { data, error } = await supabase.from('participants').select('*').eq('username', username);

                if (error || !data || data.length === 0) {
                    loginError.classList.remove('hidden');
                    return;
                }
                
                const participant = data[0];
                if (participant.password === password) {
                    const user = { username: participant.username, role: 'participant', participantId: participant.id };
                    await loadDataAndLogin(user);
                } else {
                    loginError.classList.remove('hidden');
                }
            }

            function handleLogout() {
                currentUser = null;
                sessionStorage.removeItem('currentUser');
                participants = [];
                loginScreen.classList.remove('hidden');
                appContainer.classList.add('hidden');
                appContainer.classList.remove('flex');
            }

            // --- EVENT LISTENERS SETUP ---
            function setupEventListeners() {
                document.getElementById('loginForm').addEventListener('submit', handleLogin);
                document.getElementById('logoutBtn').addEventListener('click', handleLogout);
                document.getElementById('searchParticipantInput').addEventListener('keyup', debounce(updateCurrentView, 300));
                
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                document.getElementById('mobileMenuBtn').addEventListener('click', () => {
                    sidebar.classList.remove('-translate-x-full');
                    overlay.classList.remove('hidden');
                });
                overlay.addEventListener('click', () => {
                    sidebar.classList.add('-translate-x-full');
                    overlay.classList.add('hidden');
                });

                appContainer.addEventListener('click', handleMainContentClick);
                
                dynamicContentContainer.addEventListener('change', e => {
                    if (e.target.matches('.comparison-checkbox') || e.target.matches('input[name="comparisonMetric"]')) {
                        updateComparisonChart();
                    }
                });
            }
            
            function renderSidebarNav() {
                const navContainer = document.getElementById('sidebarNav');
                navContainer.innerHTML = '';

                NAV_LINKS.forEach(link => {
                    if (link.hidden || !currentUser || !link.roles.includes(currentUser.role)) return;

                    const navItem = document.createElement('a');
                    navItem.href = '#';
                    navItem.className = 'sidebar-link text-gray-300';
                    navItem.dataset.section = link.id;
                    navItem.innerHTML = `${link.icon}<span>${link.text}</span>`;
                    
                    navItem.addEventListener('click', e => {
                        e.preventDefault();
                        if (link.id === 'myProfile') {
                            currentProfileParticipantId = currentUser.participantId;
                        }
                        showSection(link.id);
                        if (window.innerWidth < 1024) {
                            document.getElementById('sidebar').classList.add('-translate-x-full');
                            document.getElementById('sidebar-overlay').classList.add('hidden');
                        }
                    });
                    navContainer.appendChild(navItem);
                });
            }

            function handleMainContentClick(e) {
                const button = e.target.closest('button');
                const link = e.target.closest('a');
                const th = e.target.closest('th.sortable');

                if (th) {
                    const sortKey = th.dataset.sortKey;
                    if (rankingSortConfig.key === sortKey) {
                        rankingSortConfig.direction = rankingSortConfig.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        rankingSortConfig.key = sortKey;
                        rankingSortConfig.direction = 'desc';
                    }
                    showSection('ranking');
                    return;
                }

                if (!button && !link) return;

                const target = button || link;
                const action = target.dataset.action;
                const id = target.dataset.id;
                const name = target.dataset.name;

                switch(action) {
                    case 'open-add-modal': openParticipantModal(); break;
                    case 'open-edit-modal': openParticipantModal(id); break;
                    case 'open-delete-modal': openDeleteModal(id, name); break;
                    case 'view-profile': e.preventDefault(); currentProfileParticipantId = id; showSection('participantProfile'); break;
                    case 'go-to-participants': e.preventDefault(); showSection('participants'); break;
                    case 'generate-report': exportDetailsToPDF(id); break;
                    case 'ai-coach': getAICoachingTip(id); break;
                    case 'update-weight': handleUpdateWeight(id); break;
                    case 'delete-weight-entry': handleDeleteWeightEntry(id, target.dataset.entryDate); break;
                    case 'add-activity': handleAddActivity(id); break;
                    case 'delete-activity': handleDeleteActivity(id, target.dataset.week, target.dataset.activityId); break;
                    case 'update-measurements': handleUpdateMeasurements(id); break;
                }
            }
            
            // --- DATA & VIEW MANAGEMENT ---
            function calculateMetrics(p, referenceDate = new Date()) {
                const pesoNaData = getWeightAtDate(p, referenceDate);
                const pesoPerdido = p.peso_inicial - pesoNaData;
                const percentLoss = p.peso_inicial > 0 ? (pesoPerdido / p.peso_inicial) * 100 : 0;
                let weightPoints = 0;
                if (percentLoss >= 15) weightPoints = 50; else if (percentLoss >= 12) weightPoints = 40;
                else if (percentLoss >= 10) weightPoints = 35; else if (percentLoss >= 8) weightPoints = 30;
                else if (percentLoss >= 6) weightPoints = 20; else if (percentLoss >= 4) weightPoints = 15;
                else if (percentLoss >= 2) weightPoints = 10; else if (percentLoss > 0) weightPoints = 5;
                
                const semanasConsideradas = p.semanas_validas || [];
                const validWeeksCount = semanasConsideradas.filter(week => Array.isArray(week) && week.length >= MIN_ACTIVITIES_FOR_VALID_WEEK).length;
                const totalActivities = semanasConsideradas.reduce((sum, week) => sum + (Array.isArray(week) ? week.length : 0), 0);
                const activityPoints = (validWeeksCount / MAX_WEEKS) * MAX_ACTIVITY_POINTS;
                
                let progressToTarget = null;
                if (p.target_weight && p.peso_inicial > p.target_weight) {
                    const totalNeeded = p.peso_inicial - p.target_weight;
                    const currentLoss = p.peso_inicial - p.peso_atual;
                    progressToTarget = Math.max(0, Math.min(100, (currentLoss / totalNeeded) * 100));
                }
                return { ...p, name: p.name, percentLoss: Math.max(0, percentLoss), weightPoints, validWeeksCount, totalActivities, activityPoints, totalPoints: weightPoints + activityPoints, progressToTarget };
            }

            function getBadges(p) {
                let badges = '';
                if (p.target_weight && p.peso_atual <= p.target_weight) badges += `<span class="badge" title="Meta Atingida!">🎯</span>`;
                const pesoPerdido = p.peso_inicial - p.peso_atual;
                if (pesoPerdido >= 10) badges += `<span class="badge" title="Clube dos 10kg!">🔟</span>`;
                else if (pesoPerdido >= 5) badges += `<span class="badge" title="Clube dos 5kg!">5️⃣</span>`;
                const consecutive = (p.semanas_validas || []).map(w => (Array.isArray(w) && w.length >= MIN_ACTIVITIES_FOR_VALID_WEEK) ? '1' : '0').join('').split('0').reduce((max, s) => Math.max(max, s.length), 0);
                if (consecutive >= 4) badges += `<span class="badge" title="${consecutive} Semanas em Chamas!">🔥</span>`;
                if (p.name === weeklyPointsWinnerName) badges += `<span class="badge" title="Rei/Rainha da Semana!">👑</span>`;
                return badges;
            }

            function getWeightAtDate(participant, targetDate) {
                const history = participant.weight_history || [];
                if (history.length === 0) return participant.peso_inicial;
                const relevantHistory = history.filter(entry => new Date(entry.date) <= targetDate).sort((a, b) => new Date(b.date) - new Date(a.date)); 
                return relevantHistory.length > 0 ? relevantHistory[0].weight : participant.peso_inicial;
            }

            function calculateWeeklyWinners() {
                const today = new Date();
                const oneWeekAgo = new Date(); oneWeekAgo.setDate(today.getDate() - 7);
                let weeklyWinner = { name: null, pointsGained: -1 };
                participants.forEach(p => {
                    const pointsNow = calculateMetrics(p, today).totalPoints;
                    const pointsThen = calculateMetrics(p, oneWeekAgo).totalPoints;
                    const pointsGained = pointsNow - pointsThen;
                    if (pointsGained > weeklyWinner.pointsGained) weeklyWinner = { name: p.name, pointsGained };
                });
                weeklyPointsWinnerName = weeklyWinner.pointsGained > 0 ? weeklyWinner.name : null;
            }

            function updateCurrentView() {
                if (!currentUser) return;
                calculateWeeklyWinners();
                
                if (currentViewId) {
                    showSection(currentViewId);
                } else {
                    const initialSection = currentUser.role === 'admin' ? 'ranking' : 'myProfile';
                    showSection(initialSection);
                }
                updateSummaryBoxes();
            }

            function showSection(sectionId) {
                currentViewId = sectionId;
                const link = NAV_LINKS.find(l => l.id === sectionId);
                if (!link || !currentUser || !link.roles.includes(currentUser.role)) {
                    return showSection(currentUser.role === 'admin' ? 'ranking' : 'myProfile');
                }
                
                pageTitle.textContent = link.text;
                if (sectionId === 'myProfile') {
                    pageTitle.textContent = 'Meu Perfil';
                }
                
                const allMetrics = participants.map(p => calculateMetrics(p));
                const searchTerm = document.getElementById('searchParticipantInput').value.toLowerCase();
                const filteredMetrics = allMetrics.filter(p => p.name.toLowerCase().includes(searchTerm));

                dynamicContentContainer.innerHTML = '<div class="bg-white p-4 sm:p-6 rounded-lg shadow-md"></div>';
                const contentWrapper = dynamicContentContainer.firstChild;
                headerActionButtons.innerHTML = '';
                document.getElementById('summary-grid').style.display = 'grid';

                switch(sectionId) {
                    case 'ranking': renderRankingTable(sortData(filteredMetrics, rankingSortConfig), contentWrapper); break;
                    case 'participants': renderParticipantsPage(filteredMetrics, contentWrapper); break;
                    case 'participantProfile':
                    case 'myProfile':
                        renderParticipantProfilePage(dynamicContentContainer);
                        document.getElementById('summary-grid').style.display = 'none';
                        break;
                    case 'weeklySummary': renderWeeklySummaryPage(allMetrics, contentWrapper); break;
                    case 'activityLog': renderActivityLogPage(filteredMetrics, contentWrapper); break;
                    case 'coachVirtual': renderCoachVirtualPage(contentWrapper); break;
                    case 'individualEvolution': renderIndividualEvolutionPage(allMetrics, contentWrapper); break;
                    case 'groupEvolution': renderGroupEvolutionChart(allMetrics, contentWrapper); break;
                    case 'comparison': renderComparisonChart(allMetrics, contentWrapper); break;
                    case 'rules': renderRulesPage(contentWrapper); break;
                    case 'configuracoes': renderSettingsPage(contentWrapper); break;
                }
                
                document.querySelectorAll('.sidebar-link').forEach(item => item.classList.toggle('active', item.dataset.section === sectionId));
            }
            
            function sortData(data, config) {
                return [...data].sort((a, b) => {
                    if (a[config.key] < b[config.key]) return config.direction === 'asc' ? -1 : 1;
                    if (a[config.key] > b[config.key]) return config.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            // --- PAGE RENDERERS ---

            function renderRankingTable(data, container) {
                const pointRanked = [...participants.map(p => calculateMetrics(p))].sort((a, b) => b.totalPoints - a.totalPoints);
                const sortArrow = (key) => rankingSortConfig.key === key ? (rankingSortConfig.direction === 'asc' ? ' ▲' : ' ▼') : '';
                
                let tableHTML = `<div class="overflow-x-auto"><table class="w-full"><thead><tr>
                    <th class="sortable" data-sort-key="totalPoints">Rank${sortArrow('totalPoints')}</th>
                    <th class="sortable" data-sort-key="name">Nome${sortArrow('name')}</th>
                    <th>Progresso Meta</th>
                    <th class="sortable" data-sort-key="percentLoss">% Perda${sortArrow('percentLoss')}</th>
                    <th class="sortable" data-sort-key="weightPoints">Pts. Peso${sortArrow('weightPoints')}</th>
                    <th class="sortable" data-sort-key="activityPoints">Pts. Ativ.${sortArrow('activityPoints')}</th>
                    <th class="sortable" data-sort-key="totalPoints">Total${sortArrow('totalPoints')}</th>
                </tr></thead><tbody>`;
                
                if (data.length === 0) {
                    tableHTML += `<tr><td colspan="7" class="empty-state-message">Nenhum participante encontrado.</td></tr>`;
                } else {
                    data.forEach(p => {
                        const pointRankIndex = pointRanked.findIndex(rankedP => rankedP.name === p.name);
                        const medal = ['🏆', '🥈', '🥉'][pointRankIndex] || '';
                        const progress = p.progressToTarget !== null ? `<div class="progress-bar-container" title="${p.progressToTarget.toFixed(1)}%"><div class="progress-bar-fill" style="width: ${p.progressToTarget}%;"><span class="progress-bar-text">${p.progressToTarget.toFixed(0)}%</span></div></div>` : 'N/A';
                        const avatarSrc = p.avatar_url || `https://placehold.co/40x40/E2E8F0/4A5568?text=${p.name.charAt(0)}`;
                        
                        let nameHTML = p.name;
                        if (currentUser.role === 'admin') {
                             nameHTML = `<a href="#" style="color: var(--primary-color);" class="hover:underline font-semibold" data-action="view-profile" data-id="${p.id}">${p.name}</a>`;
                        }

                        tableHTML += `<tr class="${pointRankIndex === 0 ? 'leader-row' : ''}">
                            <td class="font-semibold">${pointRankIndex + 1}</td>
                            <td class="py-2">
                                <div class="flex items-center">
                                    <img src="${avatarSrc}" alt="Avatar de ${p.name}" class="w-8 h-8 rounded-full mr-3 object-cover flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/40x40/E2E8F0/4A5568?text=${p.name.charAt(0)}';">
                                    <div>
                                        ${nameHTML}
                                        <span class="ml-1">${medal} ${getBadges(p)}</span>
                                    </div>
                                </div>
                            </td>
                            <td>${progress}</td>
                            <td>${p.percentLoss.toFixed(2)}%</td>
                            <td>${p.weightPoints.toFixed(2)}</td>
                            <td>${p.activityPoints.toFixed(2)}</td>
                            <td class="font-bold">${p.totalPoints.toFixed(2)}</td>
                        </tr>`;
                    });
                }
                tableHTML += `</tbody></table></div>`;
                container.innerHTML = tableHTML;
            }

            function renderParticipantsPage(data, container) {
                if (currentUser.role !== 'admin') return;
                
                headerActionButtons.innerHTML = `<button data-action="open-add-modal" style="background-color: var(--success-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm">Adicionar Participante</button>`;

                if (data.length === 0) {
                    container.innerHTML = `<div class="empty-state-message">Nenhum participante encontrado. Clique em "Adicionar Participante" para começar.</div>`;
                    return;
                }

                let cardsHTML = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">';
                data.sort((a,b) => a.name.localeCompare(b.name)).forEach(p => {
                    const avatarSrc = p.avatar_url || `https://placehold.co/80x80/E2E8F0/4A5568?text=${p.name.charAt(0)}`;
                    const pesoPerdido = p.peso_inicial - p.peso_atual;
                    cardsHTML += `
                        <div class="bg-white rounded-xl shadow-md overflow-hidden transform hover:scale-105 transition-transform duration-300 flex flex-col">
                            <div class="p-5 flex-grow">
                                <div class="flex items-center gap-4 mb-4">
                                    <img src="${avatarSrc}" alt="Avatar de ${p.name}" class="w-16 h-16 rounded-full object-cover border-2 border-gray-200" onerror="this.onerror=null;this.src='https://placehold.co/80x80/E2E8F0/4A5568?text=${p.name.charAt(0)}';">
                                    <div>
                                        <h3 class="text-lg font-bold text-gray-800">${p.name}</h3>
                                        <p class="text-sm text-gray-500">Total: ${p.totalPoints.toFixed(1)} pts</p>
                                    </div>
                                </div>
                                <div class="text-sm space-y-1">
                                    <p><strong>Peso Atual:</strong> ${p.peso_atual.toFixed(1)} kg</p>
                                    <p><strong>Perda Total:</strong> <span class="${pesoPerdido >= 0 ? 'text-green-600' : 'text-red-500'} font-semibold">${pesoPerdido.toFixed(1)} kg</span></p>
                                </div>
                            </div>
                            <div class="bg-gray-50 p-3 grid grid-cols-3 gap-2">
                                <button data-action="view-profile" data-id="${p.id}" class="action-btn btn-primary">Ver Perfil</button>
                                <button data-action="open-edit-modal" data-id="${p.id}" class="action-btn btn-warning">Editar</button>
                                <button data-action="open-delete-modal" data-id="${p.id}" data-name="${p.name}" class="action-btn btn-danger">Excluir</button>
                            </div>
                        </div>
                    `;
                });
                cardsHTML += '</div>';
                container.innerHTML = cardsHTML;
            }

            function renderParticipantProfilePage(container) {
                const pMetric = calculateMetrics(participants.find(p => p.id == currentProfileParticipantId));
                if (!pMetric) {
                    container.innerHTML = `<div class="bg-white p-4 sm:p-6 rounded-lg shadow-md"><div class="empty-state-message">Participante não encontrado.</div></div>`;
                    return;
                }
                
                const isOwnProfile = currentUser.participantId == pMetric.id;
                const canEditProfile = currentUser.role === 'admin' || isOwnProfile;

                const avatarSrc = pMetric.avatar_url || `https://placehold.co/100x100/E2E8F0/4A5568?text=${pMetric.name.charAt(0)}`;
                const todayStr = new Date().toISOString().split('T')[0];
                const lastM = pMetric.measurements_history && pMetric.measurements_history.length > 0 ? pMetric.measurements_history[pMetric.measurements_history.length - 1] : {};

                let backButtonHTML = '';
                if (currentUser.role === 'admin' && !isOwnProfile) {
                    backButtonHTML = `<a href="#" data-action="go-to-participants" style="color: var(--primary-color);" class="hover:underline mb-4 inline-block">&larr; Voltar para todos os participantes</a>`;
                }
                
                const pesoPerdido = pMetric.peso_inicial - pMetric.peso_atual;

                container.innerHTML = `
                    <div id="profile-content" class="max-w-4xl mx-auto space-y-6">
                        <!-- Botão de Voltar e PDF -->
                        <div class="flex justify-between items-start mb-2">
                            ${backButtonHTML}
                            ${currentUser.role === 'admin' ? `<div><button data-action="generate-report" data-id="${pMetric.id}" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded-lg text-sm">Gerar PDF</button></div>` : '<div></div>'}
                        </div>

                        <!-- Cabeçalho do Perfil -->
                        <div class="profile-card flex flex-col sm:flex-row items-center gap-6">
                            <img src="${avatarSrc}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/E2E8F0/4A5568?text=${pMetric.name.charAt(0)}';" class="rounded-full w-24 h-24 object-cover border-4 border-indigo-200">
                            <div class="flex-grow text-center sm:text-left">
                                <h3 class="text-3xl font-bold">${pMetric.name} <span class="text-2xl">${getBadges(pMetric)}</span></h3>
                                <p class="text-gray-500">Altura: ${pMetric.altura ? pMetric.altura.toFixed(2) + 'm' : 'N/A'}</p>
                            </div>
                            <div class="grid grid-cols-3 gap-4 text-center w-full sm:w-auto mt-4 sm:mt-0">
                                <div>
                                    <p class="text-2xl font-bold text-indigo-600">${pMetric.totalPoints.toFixed(1)}</p>
                                    <p class="text-xs text-gray-500 uppercase">Pontos</p>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold ${pesoPerdido >= 0 ? 'text-green-600' : 'text-red-500'}">${pesoPerdido.toFixed(1)}</p>
                                    <p class="text-xs text-gray-500 uppercase">Kg Perdidos</p>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-indigo-600">${pMetric.progressToTarget ? pMetric.progressToTarget.toFixed(0) : '0'}%</p>
                                    <p class="text-xs text-gray-500 uppercase">Meta</p>
                                </div>
                            </div>
                        </div>

                        <!-- Formulários e Históricos -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Coluna da Esquerda: Ações -->
                            <div class="space-y-6">
                                ${canEditProfile ? `
                                <div class="profile-card">
                                    <h4 class="font-bold text-lg mb-4">Registrar Peso</h4>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="text-sm font-medium text-gray-700">Novo Peso (kg)</label>
                                            <input id="profile-weight-input" type="number" step="any" class="mt-1 shadow-sm border rounded-md w-full p-2" placeholder="${pMetric.peso_atual.toFixed(2)}">
                                        </div>
                                        <div>
                                            <label class="text-sm font-medium text-gray-700">Data do Registro</label>
                                            <input id="profile-weight-date" type="date" class="mt-1 shadow-sm border rounded-md w-full p-2" value="${todayStr}" max="${todayStr}">
                                        </div>
                                        <button data-action="update-weight" data-id="${pMetric.id}" style="background-color: var(--primary-color);" class="w-full hover:opacity-90 text-white font-bold py-2.5 px-4 rounded-md">Salvar Peso</button>
                                    </div>
                                </div>
                                <div class="profile-card">
                                    <h4 class="font-bold text-lg mb-4">Registrar Atividade</h4>
                                    <div class="space-y-4">
                                        <div><label class="text-sm font-medium">Semana</label><select id="profile-activity-week" class="mt-1 w-full border rounded-md p-2">${Array.from({length:MAX_WEEKS}, (_,i) => `<option value="${i}">Semana ${i+1}</option>`).join('')}</select></div>
                                        <div><label class="text-sm font-medium">Tipo</label><select id="profile-activity-type" class="mt-1 w-full border rounded-md p-2">${ACTIVITY_TYPES.map(t => `<option value="${t}">${t}</option>`).join('')}</select></div>
                                        <div><label class="text-sm font-medium">Duração (min)</label><input type="number" id="profile-activity-duration" class="mt-1 w-full border rounded-md p-2"></div>
                                        <button data-action="add-activity" data-id="${pMetric.id}" style="background-color: var(--success-color);" class="w-full hover:opacity-90 text-white font-bold py-2.5 px-4 rounded-md">Adicionar Atividade</button>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            <!-- Coluna da Direita: Históricos e Dicas -->
                            <div class="space-y-6">
                                <div class="profile-card"><h4 class="font-bold text-lg mb-3">Histórico de Pesagem</h4><div id="profile-weight-history-list" class="max-h-60 overflow-y-auto pr-2 space-y-2"></div></div>
                                <div class="profile-card"><h4 class="font-bold text-lg mb-3">Histórico de Atividades</h4><div id="profile-activity-history-list" class="max-h-60 overflow-y-auto pr-2 space-y-2"></div></div>
                                <div class="profile-card">
                                    <h4 class="font-bold text-lg mb-3">Medidas Corporais (cm)</h4>
                                    ${canEditProfile ? `
                                    <div class="grid grid-cols-1 sm:grid-cols-4 gap-3 items-end">
                                        <div><label class="text-xs font-medium">Cintura</label><input type="number" step="any" id="profile-cintura" class="shadow-sm border rounded-md w-full p-2" value="${lastM.cintura || ''}"></div>
                                        <div><label class="text-xs font-medium">Quadril</label><input type="number" step="any" id="profile-quadril" class="shadow-sm border rounded-md w-full p-2" value="${lastM.quadril || ''}"></div>
                                        <div><label class="text-xs font-medium">Abdômen</label><input type="number" step="any" id="profile-abdomen" class="shadow-sm border rounded-md w-full p-2" value="${lastM.abdomen || ''}"></div>
                                        <button data-action="update-measurements" data-id="${pMetric.id}" style="background-color: var(--primary-color);" class="w-full hover:opacity-90 text-white font-bold py-2 px-4 rounded-md h-10">Salvar</button>
                                    </div>
                                    ` : `
                                    <div class="grid grid-cols-3 gap-4 text-center">
                                        <div><p class="text-sm text-gray-500">Cintura</p><p class="font-bold text-lg">${lastM.cintura || 'N/A'}</p></div>
                                        <div><p class="text-sm text-gray-500">Quadril</p><p class="font-bold text-lg">${lastM.quadril || 'N/A'}</p></div>
                                        <div><p class="text-sm text-gray-500">Abdômen</p><p class="font-bold text-lg">${lastM.abdomen || 'N/A'}</p></div>
                                    </div>
                                    `}
                                </div>
                                <div class="profile-card">
                                    <div class="flex justify-between items-center mb-3">
                                        <h4 class="text-lg font-semibold text-gray-700">🤖 Dica do Coach</h4>
                                        <button data-action="ai-coach" data-id="${pMetric.id}" style="background-color: var(--primary-color);" class="hover:opacity-90 text-white font-bold py-2 px-3 rounded-lg text-sm">Gerar Dica</button>
                                    </div>
                                    <div id="ai-tip-container" class="p-4 bg-gray-50 rounded-lg text-gray-600 min-h-[80px]">Clique no botão para receber uma dica personalizada.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                updateProfileWeightList(pMetric);
                updateProfileActivityList(pMetric);
            }
            
            function updateProfileWeightList(participant) {
                const listContainer = document.getElementById('profile-weight-history-list');
                if (!listContainer) return;
                listContainer.innerHTML = '';
                const isOwnProfile = currentUser.participantId == participant.id;
                const canEditProfile = currentUser.role === 'admin' || isOwnProfile;
                
                const history = [...(participant.weight_history || [])].sort((a,b) => new Date(b.date) - new Date(a.date));

                if (history.length === 0) {
                    listContainer.innerHTML = `<p class="text-center text-gray-500 py-4">Nenhum registro de peso.</p>`;
                    return;
                }

                history.forEach((entry, index) => {
                    const formattedDate = new Date(entry.date).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                    let changeHTML = '';
                    const previousEntry = history[index + 1];
                    if (previousEntry) {
                        const change = entry.weight - previousEntry.weight;
                        const changeColor = change < 0 ? 'text-green-600' : (change > 0 ? 'text-red-500' : 'text-gray-500');
                        const sign = change > 0 ? '+' : '';
                        changeHTML = `<span class="font-semibold w-20 text-right ${changeColor}">${sign}${change.toFixed(2)}</span>`;
                    } else {
                        changeHTML = `<span class="w-20 text-right text-gray-400 text-xs">INÍCIO</span>`;
                    }

                    listContainer.innerHTML += `
                        <div class="flex justify-between items-center text-sm p-2 bg-gray-50 rounded-lg hover:bg-gray-100">
                            <div class="flex items-center gap-3">
                                <span class="font-bold text-gray-800 w-20">${parseFloat(entry.weight).toFixed(2)} kg</span>
                                <span class="text-gray-500">${formattedDate}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                ${changeHTML}
                                ${canEditProfile && history.length > 1 ? `<button data-action="delete-weight-entry" data-id="${participant.id}" data-entry-date="${entry.date}" class="text-gray-400 hover:text-red-600 p-1" title="Excluir">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                                </button>` : `<div class="w-6"></div>`}
                            </div>
                        </div>`;
                });
            }

            function updateProfileActivityList(participant) {
                const listContainer = document.getElementById('profile-activity-history-list');
                if (!listContainer) return;
                listContainer.innerHTML = '';
                const isOwnProfile = currentUser.participantId == participant.id;
                const canEditProfile = currentUser.role === 'admin' || isOwnProfile;

                const allActivities = participant.semanas_validas.flatMap((week, weekIndex) => 
                    (Array.isArray(week) ? week : []).map(activity => ({...activity, weekIndex}))
                ).sort((a,b) => b.id - a.id);

                if (allActivities.length === 0) {
                    listContainer.innerHTML = `<p class="text-center text-gray-500 py-4">Nenhuma atividade registrada.</p>`;
                    return;
                }

                allActivities.forEach(act => {
                    listContainer.innerHTML += `
                        <div class="flex justify-between items-center text-sm p-2 bg-gray-50 rounded-lg hover:bg-gray-100">
                            <div>
                                <span class="font-bold text-gray-800">${act.type}</span> - 
                                <span class="text-gray-600">${act.duration} min</span>
                                <span class="text-gray-500 text-xs italic">(Sem. ${act.weekIndex + 1})</span>
                            </div>
                            ${canEditProfile ? `
                            <button data-action="delete-activity" data-id="${participant.id}" data-week="${act.weekIndex}" data-activity-id="${act.id}" class="text-gray-400 hover:text-red-600 p-1" title="Apagar Atividade">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                            </button>` : ''}
                        </div>
                    `;
                });
            }

            function renderActivityLogPage(data, container) {
                const today = new Date();
                const currentWeekIndex = Math.floor((today - CHALLENGE_START_DATE) / (1000 * 60 * 60 * 24 * 7));
                
                let legendHTML = `
                    <div class="flex justify-center items-center gap-4 mb-6 text-xs text-gray-600">
                        <div class="flex items-center gap-2"><div class="w-4 h-4 rounded activity-none"></div><span>Nenhuma atividade</span></div>
                        <div class="flex items-center gap-2"><div class="w-4 h-4 rounded activity-partial"></div><span>1-2 atividades</span></div>
                        <div class="flex items-center gap-2"><div class="w-4 h-4 rounded activity-complete"></div><span>Semana validada (3+)</span></div>
                    </div>
                `;

                let cardsHTML = '<div class="space-y-6">';
                if (data.length > 0) {
                    data.sort((a,b) => a.name.localeCompare(b.name)).forEach(p => {
                        const avatarSrc = p.avatar_url || `https://placehold.co/48x48/E2E8F0/4A5568?text=${p.name.charAt(0)}`;
                        let gridHTML = '<div class="activity-grid mt-4">';
                        for (let i = 0; i < MAX_WEEKS; i++) {
                            const weekActivities = p.semanas_validas[i] || [];
                            const activityCount = Array.isArray(weekActivities) ? weekActivities.length : 0;
                            let cellClass = 'activity-none';
                            if (activityCount >= MIN_ACTIVITIES_FOR_VALID_WEEK) {
                                cellClass = 'activity-complete';
                            } else if (activityCount > 0) {
                                cellClass = 'activity-partial';
                            }
                            const isCurrentWeek = i === currentWeekIndex ? 'current-week' : '';
                            gridHTML += `
                                <div class="relative">
                                    <div class="activity-cell-label">${i + 1}</div>
                                    <div class="activity-cell ${cellClass} ${isCurrentWeek}" title="Semana ${i + 1}: ${activityCount} atividades"></div>
                                </div>
                            `;
                        }
                        gridHTML += '</div>';

                        cardsHTML += `
                            <div class="profile-card">
                                <div class="flex items-center gap-4">
                                    <img src="${avatarSrc}" alt="Avatar de ${p.name}" class="w-12 h-12 rounded-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/48x48/E2E8F0/4A5568?text=${p.name.charAt(0)}';">
                                    <h3 class="text-lg font-bold text-gray-800">${p.name}</h3>
                                </div>
                                ${gridHTML}
                            </div>
                        `;
                    });
                } else {
                    cardsHTML += `<div class="empty-state-message">Nenhum participante para exibir.</div>`;
                }
                cardsHTML += '</div>';

                container.innerHTML = legendHTML + cardsHTML;
            }

            function renderWeeklySummaryPage(data, container) {
                const today = new Date();
                const dayOfWeek = today.getDay(); // Sunday = 0, Monday = 1...
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
                startOfWeek.setHours(0, 0, 0, 0);
                
                const beforeStartOfWeek = new Date(startOfWeek);
                beforeStartOfWeek.setDate(beforeStartOfWeek.getDate() - 1);

                const currentWeekIndex = Math.floor((startOfWeek - CHALLENGE_START_DATE) / (1000 * 60 * 60 * 24 * 7));

                let weeklyData = data.map(p => {
                    const weightThen = getWeightAtDate(p, beforeStartOfWeek);
                    const weightNow = p.peso_atual;
                    const weightChange = weightNow - weightThen;
                    
                    const activitiesThisWeek = (p.semanas_validas[currentWeekIndex] || []).length;
                    
                    const lastWeightEntry = p.weight_history && p.weight_history.length > 0 ? new Date(Math.max(...p.weight_history.map(e => new Date(e.date)))) : new Date(0);
                    const isWeightUpdated = lastWeightEntry >= startOfWeek;

                    return { ...p, weightChange, activitiesThisWeek, isWeightUpdated };
                });

                let weightLossLeader = { name: 'N/A', change: Infinity };
                let activityLeader = { name: 'N/A', count: -1 };
                let totalLoss = 0;

                weeklyData.forEach(p => {
                    if (p.weightChange < weightLossLeader.change) {
                        weightLossLeader = { name: p.name, change: p.weightChange };
                    }
                    if (p.activitiesThisWeek > activityLeader.count) {
                        activityLeader = { name: p.name, count: p.activitiesThisWeek };
                    }
                    if (p.weightChange < 0) {
                        totalLoss += -p.weightChange;
                    }
                });
                
                const notUpdated = weeklyData.filter(p => !p.isWeightUpdated);

                container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="summary-box"><div class="text-sm font-medium text-gray-500">Maior Perda de Peso (Semana)</div><div class="text-2xl font-bold" style="color: var(--success-color);">${weightLossLeader.change < 0 ? weightLossLeader.name : 'N/A'}</div><div class="text-sm text-gray-600">${weightLossLeader.change < 0 ? (-weightLossLeader.change).toFixed(2) + ' kg' : 'Nenhuma'}</div></div>
                        <div class="summary-box"><div class="text-sm font-medium text-gray-500">Mais Atividades (Semana)</div><div class="text-2xl font-bold" style="color: var(--warning-color);">${activityLeader.count > 0 ? activityLeader.name : 'N/A'}</div><div class="text-sm text-gray-600">${activityLeader.count > 0 ? activityLeader.count + ' atividades' : 'Nenhuma'}</div></div>
                        <div class="summary-box"><div class="text-sm font-medium text-gray-500">Total Perdido (Semana)</div><div class="text-3xl font-bold" style="color: var(--primary-color);">${totalLoss.toFixed(2)}</div><div class="text-sm text-gray-600">kg pelo grupo</div></div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2">
                             <h3 class="text-lg font-semibold mb-2">Progresso da Semana</h3>
                             <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead><tr><th>Nome</th><th>Variação de Peso</th><th>Atividades</th></tr></thead>
                                    <tbody>
                                        ${weeklyData.map(p => {
                                            const avatarSrc = p.avatar_url || `https://placehold.co/40x40/E2E8F0/4A5568?text=${p.name.charAt(0)}`;
                                            return `
                                            <tr>
                                                <td>
                                                    <div class="flex items-center">
                                                        <img src="${avatarSrc}" alt="Avatar de ${p.name}" class="w-8 h-8 rounded-full mr-3 object-cover flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/40x40/E2E8F0/4A5568?text=${p.name.charAt(0)}';">
                                                        <span>${p.name}</span>
                                                    </div>
                                                </td>
                                                <td><span class="font-semibold ${p.weightChange < 0 ? 'text-green-600' : (p.weightChange > 0 ? 'text-red-500' : '')}">${p.weightChange > 0 ? '+' : ''}${p.weightChange.toFixed(2)} kg</span></td>
                                                <td class="text-center">${p.activitiesThisWeek}</td>
                                            </tr>
                                        `}).join('')}
                                    </tbody>
                                </table>
                             </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Peso Desatualizado</h3>
                            ${notUpdated.length > 0 ? `
                            <ul class="space-y-2">
                                ${notUpdated.map(p => `<li class="p-3 bg-red-50 border-l-4 border-red-400 rounded-r-lg">${p.name}</li>`).join('')}
                            </ul>
                            ` : `<div class="p-4 text-center bg-green-50 border-l-4 border-green-400 rounded-r-lg">Todos os pesos estão atualizados! 🎉</div>`}
                        </div>
                    </div>
                `;
            }

            function renderCoachVirtualPage(container) {
                if (currentUser.role === 'admin') {
                    if (participants.length === 0) {
                        container.innerHTML = `<div class="empty-state-message">Adicione participantes primeiro para usar o Coach Virtual.</div>`;
                        return;
                    }
                    const options = participants.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                    container.innerHTML = `
                        <div class="max-w-2xl mx-auto text-center">
                            <h3 class="text-2xl font-bold mb-2">Coach Virtual</h3>
                            <p class="text-gray-600 mb-6">Selecione um participante para receber uma dica personalizada baseada em seu progresso.</p>
                            <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-6">
                                <select id="coach-participant-selector" class="border rounded-lg w-full sm:w-auto py-2 px-3">${options}</select>
                                <button id="generate-coach-tip-admin" style="background-color: var(--primary-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg w-full sm:w-auto">Gerar Dica</button>
                            </div>
                            <div id="ai-tip-container" class="p-6 bg-gray-50 rounded-lg text-gray-600 min-h-[120px] text-left">
                                Selecione um participante e clique no botão para começar.
                            </div>
                        </div>`;

                    document.getElementById('generate-coach-tip-admin').addEventListener('click', () => {
                        const selectedId = document.getElementById('coach-participant-selector').value;
                        getAICoachingTip(selectedId);
                    });

                } else {
                    container.innerHTML = `
                        <div class="max-w-2xl mx-auto text-center">
                            <h3 class="text-2xl font-bold mb-2">Seu Coach Virtual</h3>
                            <p class="text-gray-600 mb-6">Clique no botão abaixo para receber uma dica personalizada baseada no seu progresso.</p>
                            <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-6">
                                <button data-action="ai-coach" data-id="${currentUser.participantId}" style="background-color: var(--primary-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg w-full sm:w-auto">Gerar Minha Dica do Coach</button>
                            </div>
                            <div id="ai-tip-container" class="p-6 bg-gray-50 rounded-lg text-gray-600 min-h-[120px] text-left">
                                Pronto para uma dica?
                            </div>
                        </div>`;
                }
            }

            function renderIndividualEvolutionPage(data, container) {
                container.innerHTML = `
                    <div id="all-charts-wrapper">
                        <div id="mainWeightChartWrapper" class="mb-8 bg-white p-4 rounded-lg shadow"></div>
                        <div id="trendChartWrapper" class="mb-8 bg-white p-4 rounded-lg shadow"></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-8">
                            <div id="percentageLossChartContainer" class="bg-white p-4 rounded-lg shadow"></div>
                            <div id="totalActivityChartContainer" class="bg-white p-4 rounded-lg shadow"></div>
                        </div>
                    </div>`;
                
                renderMainWeightChart(data);
                renderTrendChart(data);
                renderPercentageLossChart(data);
                renderTotalActivityChart(data);
            }

            function renderMainWeightChart(data) {
                const chartContainer = document.getElementById('mainWeightChartWrapper');
                chartContainer.innerHTML = `<h3 class="text-xl font-semibold text-center mb-2">Evolução do Peso</h3>`;
                const participantsWithHistory = data.filter(p => p.weight_history && p.weight_history.length > 0);
                if (participantsWithHistory.length === 0) return chartContainer.innerHTML += `<div class="empty-state-message">Não há histórico de peso para exibir.</div>`;

                const margin = {top: 20, right: 120, bottom: 30, left: 40}, width = (chartContainer.clientWidth || 800) - margin.left - margin.right, height = 350 - margin.top - margin.bottom;
                const svg = d3.select(chartContainer).append("svg").attr("width", "100%").attr("height", "100%").attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
                
                let allChartWeights = [];
                participantsWithHistory.forEach(p => { p.weight_history.forEach(d => allChartWeights.push(d.weight)); if (p.target_weight) allChartWeights.push(p.target_weight); });

                const xScale = d3.scaleTime().domain([CHALLENGE_START_DATE, CHALLENGE_END_DATE]).range([0, width]);
                const yScale = d3.scaleLinear().domain([d3.min(allChartWeights) - 2, d3.max(allChartWeights) + 2]).range([height, 0]);
                const colors = d3.scaleOrdinal(d3.schemeTableau10);
                
                svg.append("g").attr("class", "grid").call(d3.axisLeft(yScale).tickSize(-width).tickFormat("")).selectAll("line").attr("stroke", "#e5e7eb");
                svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(xScale).tickFormat(d3.timeFormat("%d/%m")));
                svg.append("g").call(d3.axisLeft(yScale).tickFormat(d => `${d}kg`));

                participantsWithHistory.forEach(p => {
                    const line = d3.line().curve(d3.curveMonotoneX).x(d => xScale(new Date(d.date))).y(d => yScale(d.weight));
                    svg.append("path").datum(p.weight_history).attr("fill", "none").attr("stroke", colors(p.name)).attr("stroke-width", 2.5).attr("d", line);
                    svg.append("text").attr("transform", `translate(${width+5},${yScale(p.weight_history[p.weight_history.length-1].weight)})`).attr("dy", ".35em").attr("text-anchor", "start").style("fill", colors(p.name)).text(p.name);
                });
            }

            function renderTrendChart(data) {
                const chartContainer = document.getElementById('trendChartWrapper');
                chartContainer.innerHTML = `<h3 class="text-xl font-semibold text-center mb-2">Projeção de Tendência</h3>`;
                const participantsWithHistory = data.filter(p => p.weight_history && p.weight_history.length > 1);
                if (participantsWithHistory.length === 0) return chartContainer.innerHTML += `<div class="empty-state-message">Dados insuficientes para projeção.</div>`;
                
                const margin = {top: 20, right: 120, bottom: 30, left: 40}, width = (chartContainer.clientWidth || 800) - margin.left - margin.right, height = 350 - margin.top - margin.bottom;
                const svg = d3.select(chartContainer).append("svg").attr("width", "100%").attr("height", "100%").attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
                
                let allChartWeights = [];
                participantsWithHistory.forEach(p => {
                    p.weight_history.forEach(d => allChartWeights.push(d.weight));
                    const trend = calculateTrendLine(p.weight_history);
                    if (trend) allChartWeights.push(trend.start.weight, trend.end.weight);
                });
                
                const xScale = d3.scaleTime().domain([CHALLENGE_START_DATE, CHALLENGE_END_DATE]).range([0, width]);
                const yScale = d3.scaleLinear().domain([d3.min(allChartWeights) - 2, d3.max(allChartWeights) + 2]).range([height, 0]);
                const colors = d3.scaleOrdinal(d3.schemeTableau10);

                svg.append("g").attr("class", "grid").call(d3.axisLeft(yScale).tickSize(-width).tickFormat("")).selectAll("line").attr("stroke", "#e5e7eb");
                svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(xScale).tickFormat(d3.timeFormat("%d/%m")));
                svg.append("g").call(d3.axisLeft(yScale).tickFormat(d => `${d}kg`));

                participantsWithHistory.forEach(p => {
                    const trend = calculateTrendLine(p.weight_history);
                    if (trend) {
                        svg.append("line").attr("x1", xScale(trend.start.date)).attr("y1", yScale(trend.start.weight)).attr("x2", xScale(trend.end.date)).attr("y2", yScale(trend.end.weight)).attr("stroke", colors(p.name)).attr("stroke-width", 2.5).attr("stroke-dasharray", "6,6");
                        svg.append("text").attr("transform", "translate(" + (width + 5) + "," + yScale(trend.end.weight) + ")").attr("dy", ".35em").attr("text-anchor", "start").style("fill", colors(p.name)).text(p.name);
                    }
                });
            }

            function renderPercentageLossChart(data) {
                const chartContainer = document.getElementById('percentageLossChartContainer');
                chartContainer.innerHTML = `<h3 class="text-xl font-semibold text-center mb-2">Ranking de % de Perda</h3>`;
                const chartData = data.map(p => ({ name: p.name, percentLoss: p.percentLoss })).sort((a, b) => b.percentLoss - a.percentLoss);
                const margin = {top: 20, right: 50, bottom: 30, left: 120}, height = chartData.length * 40, width = (chartContainer.clientWidth || 400) - margin.left - margin.right;
                const svg = d3.select(chartContainer).append("svg").attr("width", "100%").attr("height", height + margin.top + margin.bottom).attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
                const xScale = d3.scaleLinear().domain([0, d3.max(chartData, d => d.percentLoss) * 1.1 || 10]).range([0, width]);
                const yScale = d3.scaleBand().domain(chartData.map(d => d.name)).range([0, height]).padding(0.2);

                svg.append("g").call(d3.axisLeft(yScale).tickSize(0)).select(".domain").remove();
                svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(xScale).ticks(5).tickFormat(d => `${d.toFixed(1)}%`));
                const colors = d3.scaleOrdinal(d3.schemeTableau10).domain(chartData.map(d => d.name));

                svg.selectAll(".bar").data(chartData).enter().append("rect").attr("class", "bar").attr("y", d => yScale(d.name)).attr("x", 0).attr("height", yScale.bandwidth()).attr("width", 0).attr("fill", d => colors(d.name)).transition().duration(800).attr("width", d => xScale(d.percentLoss));
                svg.selectAll(".bar-label").data(chartData).enter().append("text").attr("class", "bar-label").attr("y", d => yScale(d.name) + yScale.bandwidth() / 2).attr("x", d => xScale(d.percentLoss) + 5).attr("dy", ".35em").style("fill", "#333").style("font-weight", "bold").text(d => `${d.percentLoss.toFixed(2)}%`);
            }

            function renderTotalActivityChart(data) {
                const chartContainer = document.getElementById('totalActivityChartContainer');
                chartContainer.innerHTML = `<h3 class="text-xl font-semibold text-center mb-2">Ranking de Atividades Totais</h3>`;
                const chartData = data.map(p => ({ name: p.name, totalActivities: p.totalActivities })).sort((a, b) => b.totalActivities - a.totalActivities);
                const margin = {top: 20, right: 50, bottom: 30, left: 120}, height = chartData.length * 40, width = (chartContainer.clientWidth || 400) - margin.left - margin.right;
                const svg = d3.select(chartContainer).append("svg").attr("width", "100%").attr("height", height + margin.top + margin.bottom).attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
                const xScale = d3.scaleLinear().domain([0, d3.max(chartData, d => d.totalActivities) * 1.1 || 10]).range([0, width]);
                const yScale = d3.scaleBand().domain(chartData.map(d => d.name)).range([0, height]).padding(0.2);

                svg.append("g").call(d3.axisLeft(yScale).tickSize(0)).select(".domain").remove();
                svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(xScale).ticks(5));
                const colors = d3.scaleOrdinal(d3.schemeTableau10).domain(chartData.map(d => d.name));

                svg.selectAll(".bar").data(chartData).enter().append("rect").attr("class", "bar").attr("y", d => yScale(d.name)).attr("x", 0).attr("height", yScale.bandwidth()).attr("width", 0).attr("fill", d => colors(d.name)).transition().duration(800).attr("width", d => xScale(d.totalActivities));
                svg.selectAll(".bar-label").data(chartData).enter().append("text").attr("class", "bar-label").attr("y", d => yScale(d.name) + yScale.bandwidth() / 2).attr("x", d => xScale(d.totalActivities) + 5).attr("dy", ".35em").style("fill", "#333").style("font-weight", "bold").text(d => d.totalActivities);
            }

            function renderGroupEvolutionChart(data, container) {
                container.innerHTML = `
                    <div id="group-evolution-wrapper">
                        <h3 class="text-xl font-semibold text-center mb-2">Evolução da Perda de Peso do Grupo</h3>
                        <div id="groupEvolutionChartContainer" class="w-full h-96 mb-8"></div>
                        <div id="groupPieChartContainer" class="w-full mt-8"></div>
                    </div>`;
                const chartContainer = document.getElementById('groupEvolutionChartContainer');
                const pieContainer = document.getElementById('groupPieChartContainer');

                setTimeout(() => {
                    const weeklyLossData = [];
                    for (let i = 0; i < MAX_WEEKS; i++) {
                        const weekStartDate = new Date(CHALLENGE_START_DATE); weekStartDate.setDate(weekStartDate.getDate() + i * 7);
                        const weekEndDate = new Date(CHALLENGE_START_DATE); weekEndDate.setDate(weekEndDate.getDate() + (i + 1) * 7);
                        let totalWeeklyLoss = 0;
                        participants.forEach(p => { 
                            const lossThisWeek = getWeightAtDate(p, weekStartDate) - getWeightAtDate(p, weekEndDate);
                            if (lossThisWeek > 0) {
                                totalWeeklyLoss += lossThisWeek;
                            }
                        });
                        weeklyLossData.push({ week: i + 1, totalLoss: totalWeeklyLoss });
                    }

                    if (weeklyLossData.every(d => d.totalLoss === 0)) {
                        chartContainer.innerHTML = `<div class="empty-state-message">Nenhuma perda de peso registrada para o grupo.</div>`;
                    } else {
                        const margin = {top: 20, right: 30, bottom: 40, left: 70}, width = chartContainer.clientWidth - margin.left - margin.right, height = chartContainer.clientHeight - margin.top - margin.bottom;
                        const svg = d3.select(chartContainer).append("svg").attr("width", "100%").attr("height", "100%").attr("viewBox", `0 0 ${chartContainer.clientWidth} ${chartContainer.clientHeight}`).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
                        const xScale = d3.scaleBand().domain(weeklyLossData.map(d => d.week)).range([0, width]).padding(0.2);
                        const yScale = d3.scaleLinear().domain([0, d3.max(weeklyLossData, d => d.totalLoss) * 1.1 || 1]).range([height, 0]);
                        svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(xScale)).append("text").attr("y", 35).attr("x", width / 2).attr("text-anchor", "middle").attr("fill", "var(--text-dark)").text("Semana");
                        svg.append("g").call(d3.axisLeft(yScale).tickFormat(d => `${d.toFixed(1)}kg`)).append("text").attr("transform", "rotate(-90)").attr("y", -margin.left + 20).attr("x", -height / 2).attr("text-anchor", "middle").attr("fill", "var(--text-dark)").text("Perda Total (kg)");
                        svg.selectAll(".bar").data(weeklyLossData).enter().append("rect").attr("class", "bar").attr("x", d => xScale(d.week)).attr("y", d => yScale(Math.max(0, d.totalLoss))).attr("width", xScale.bandwidth()).attr("height", d => Math.abs(yScale(0) - yScale(d.totalLoss))).attr("fill", "var(--primary-color)");
                    }
                    
                    const pieData = participants.map(p => ({ name: p.name, value: Math.max(0, p.peso_inicial - p.peso_atual) })).filter(p => p.value > 0);
                    const totalLoss = d3.sum(pieData, d => d.value);

                    if (pieData.length > 0) {
                        pieContainer.innerHTML = `<h3 class="text-xl font-semibold text-center mb-4">Contribuição Individual para Perda Total</h3><div id="pie-chart-wrapper" class="grid grid-cols-1 md:grid-cols-3 items-center justify-center gap-8"></div>`;
                        const wrapper = d3.select("#pie-chart-wrapper");
                        wrapper.append("div").attr("class", "flex flex-col items-center justify-center text-center bg-gradient-to-br from-indigo-50 to-indigo-100 p-6 rounded-2xl shadow-lg h-full").html(`<h4 class="text-lg font-bold text-indigo-800 mb-2">PERDA TOTAL DO GRUPO</h4><p class="text-6xl font-extrabold text-indigo-600">${totalLoss.toFixed(2)}</p><p class="text-2xl font-semibold text-indigo-800">kg</p>`);
                        const svgContainer = wrapper.append("div").attr("class", "flex items-center justify-center");
                        const legendContainer = wrapper.append("div").attr("class", "flex flex-col justify-center");
                        const pieWidth = 300, pieHeight = 300, radius = Math.min(pieWidth, pieHeight) / 2 - 10;
                        const pieSvg = svgContainer.append("svg").attr("width", pieWidth).attr("height", pieHeight).append("g").attr("transform", `translate(${pieWidth / 2},${pieHeight / 2})`);
                        const colors = d3.scaleOrdinal(d3.schemeTableau10);
                        const pie = d3.pie().value(d => d.value);
                        const arc = d3.arc().innerRadius(radius * 0.5).outerRadius(radius);
                        pieSvg.selectAll('slices').data(pie(pieData)).enter().append('path').attr('d', arc).attr('fill', d => colors(d.data.name)).attr("stroke", "white").style("stroke-width", "2px");
                        const legend = legendContainer.selectAll(".legend-item").data(pieData).enter().append("div").attr("class", "legend-item flex items-center mb-2 text-sm");
                        legend.append("div").style("width", "18px").style("height", "18px").style("background-color", d => colors(d.name)).attr("class", "mr-2 rounded-sm flex-shrink-0");
                        legend.append("span").text(d => `${d.name}: ${d.value.toFixed(2)}kg (${(d.value / totalLoss * 100).toFixed(1)}%)`);
                    }
                }, 0);
            }
            
            function renderComparisonChart(data, container) {
                let checkboxesHTML = data.map(p => `<label class="inline-flex items-center mr-4 mb-2"><input type="checkbox" class="comparison-checkbox form-checkbox h-5 w-5 text-indigo-600" value="${p.name}"><span class="ml-2">${p.name}</span></label>`).join('');
                let metricsHTML = `<div id="comparison-metrics" class="flex flex-wrap gap-4 mb-4 pb-4 border-b">
                        <label class="inline-flex items-center"><input type="radio" name="comparisonMetric" value="weight" class="form-radio text-indigo-600" checked><span class="ml-2">Peso (kg)</span></label>
                        <label class="inline-flex items-center"><input type="radio" name="comparisonMetric" value="percentLoss" class="form-radio text-indigo-600"><span class="ml-2">% Perda de Peso</span></label>
                        <label class="inline-flex items-center"><input type="radio" name="comparisonMetric" value="activities" class="form-radio text-indigo-600"><span class="ml-2">Total de Atividades</span></label>
                    </div>`;
                container.innerHTML = `<div id="comparison-content">${metricsHTML}<div id="comparison-checkboxes" class="p-4 rounded-lg mb-4">${checkboxesHTML}</div><div id="comparisonChartContainer" class="w-full h-96"></div></div>`;
                updateComparisonChart();
            }

            function updateComparisonChart() {
                const chartContainer = document.getElementById('comparisonChartContainer');
                const selectedMetric = document.querySelector('input[name="comparisonMetric"]:checked')?.value || 'weight';
                const selectedNames = Array.from(document.querySelectorAll('.comparison-checkbox:checked')).map(cb => cb.value);
                const selectedParticipants = participants.filter(p => selectedNames.includes(p.name));
                chartContainer.innerHTML = '';

                if (selectedParticipants.length === 0) {
                    return chartContainer.innerHTML = `<div class="empty-state-message">Selecione um ou mais participantes para comparar.</div>`;
                }

                const colors = d3.scaleOrdinal(d3.schemeTableau10);
                const margin = {top: 20, right: 160, bottom: 40, left: 50}, width = chartContainer.clientWidth - margin.left - margin.right, height = chartContainer.clientHeight - margin.top - margin.bottom;
                const svg = d3.select(chartContainer).append("svg").attr("width", "100%").attr("height", "100%").attr("viewBox", `0 0 ${chartContainer.clientWidth} ${chartContainer.clientHeight}`).append("g").attr("transform", `translate(${margin.left},${margin.top})`);

                if (selectedMetric === 'weight' || selectedMetric === 'percentLoss') {
                    const participantsWithHistory = selectedParticipants.filter(p => p.weight_history && p.weight_history.length > 0);
                    if (participantsWithHistory.length === 0) return chartContainer.innerHTML = `<div class="empty-state-message">Nenhum histórico de peso para os selecionados.</div>`;

                    let allChartDates = [], allChartValues = [];
                    const chartData = participantsWithHistory.map(p => {
                        const history = p.weight_history.map(entry => {
                            const value = selectedMetric === 'weight' ? entry.weight : ((p.peso_inicial - entry.weight) / p.peso_inicial) * 100;
                            allChartDates.push(new Date(entry.date)); allChartValues.push(value);
                            return { date: entry.date, value: value };
                        });
                        return { name: p.name, history };
                    });

                    const xScale = d3.scaleTime().domain(d3.extent(allChartDates)).range([0, width]);
                    const yScale = d3.scaleLinear().domain([d3.min(allChartValues) - 1, d3.max(allChartValues) + 1]).range([height, 0]);
                    const line = d3.line().x(d => xScale(new Date(d.date))).y(d => yScale(d.value));

                    svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(xScale).tickFormat(d3.timeFormat("%d/%m")));
                    svg.append("g").call(d3.axisLeft(yScale).tickFormat(d => selectedMetric === 'weight' ? `${d}kg` : `${d.toFixed(1)}%`));

                    chartData.forEach(p => { svg.append("path").datum(p.history).attr("fill", "none").attr("stroke", colors(p.name)).attr("stroke-width", 2).attr("d", line); });
                    const legend = svg.selectAll(".legend").data(chartData).enter().append("g").attr("class", "legend").attr("transform", (d, i) => `translate(${width + 20},${i * 20})`);
                    legend.append("rect").attr("width", 18).attr("height", 18).style("fill", d => colors(d.name));
                    legend.append("text").attr("x", 24).attr("y", 9).attr("dy", ".35em").style("text-anchor", "start").text(d => d.name);

                } else if (selectedMetric === 'activities') {
                    const weeks = Array.from({length: MAX_WEEKS}, (_, i) => i + 1);
                    const maxActivities = d3.max(selectedParticipants, p => d3.max(p.semanas_validas, w => w.length));

                    const xScale = d3.scaleBand().domain(weeks).range([0, width]).padding(0.2);
                    const xSubgroup = d3.scaleBand().domain(selectedNames).range([0, xScale.bandwidth()]).padding([0.05]);
                    const yScale = d3.scaleLinear().domain([0, maxActivities > 0 ? maxActivities : 5]).range([height, 0]);

                    svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(xScale)).append("text").attr("x", width / 2).attr("y", margin.bottom - 5).attr("fill", "currentColor").text("Semana");
                    svg.append("g").call(d3.axisLeft(yScale));

                    svg.append("g").selectAll("g").data(selectedParticipants).enter().append("g")
                        .attr("transform", d => `translate(${xSubgroup(d.name)},0)`)
                        .selectAll("rect").data(d => weeks.map(w => ({ key: d.name, week: w, value: (d.semanas_validas[w-1] || []).length })))
                        .enter().append("rect")
                            .attr("x", d => xScale(d.week)).attr("y", d => yScale(d.value))
                            .attr("width", xSubgroup.bandwidth()).attr("height", d => height - yScale(d.value))
                            .attr("fill", d => colors(d.key));
                    
                    const legend = svg.selectAll(".legend").data(selectedParticipants).enter().append("g").attr("class", "legend").attr("transform", (d, i) => `translate(${width + 20},${i * 20})`);
                    legend.append("rect").attr("width", 18).attr("height", 18).style("fill", d => colors(d.name));
                    legend.append("text").attr("x", 24).attr("y", 9).attr("dy", ".35em").style("text-anchor", "start").text(d => d.name);
                }
            }
            
            function renderSettingsPage(container) {
                if (currentUser.role !== 'admin') return;
                const startDate = CHALLENGE_START_DATE.toISOString().split('T')[0];
                const endDate = CHALLENGE_END_DATE.toISOString().split('T')[0];
                
                container.innerHTML = `<div class="space-y-8">
                        <div>
                            <h3 class="text-lg font-semibold mb-2">Gerenciamento de Participantes</h3>
                            <div class="bg-gray-50 p-6 rounded-xl border">
                                <p class="mb-4">Adicione, edite ou remova participantes e suas credenciais de login.</p>
                                <button data-action="go-to-participants" style="background-color: var(--primary-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg">Gerenciar Participantes</button>
                            </div>
                        </div>
                        <div>
                             <h3 class="text-lg font-semibold mb-2">Configurações do Desafio</h3>
                             <form id="challengeConfigForm" class="bg-gray-50 p-6 rounded-xl border">
                                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                     <div><label for="startDate" class="block font-bold">Data de Início:</label><input type="date" id="startDate" class="border rounded w-full py-2 px-3" value="${startDate}" required></div>
                                     <div><label for="endDate" class="block font-bold">Data de Fim:</label><input type="date" id="endDate" class="border rounded w-full py-2 px-3" value="${endDate}" required></div>
                                 </div>
                                 <button type="submit" style="background-color: var(--success-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded w-full">Salvar Datas</button>
                             </form>
                        </div>
                    </div>`;

                document.getElementById('challengeConfigForm').addEventListener('submit', e => {
                    e.preventDefault();
                    CHALLENGE_START_DATE = new Date(document.getElementById('startDate').value + 'T00:00:00');
                    CHALLENGE_END_DATE = new Date(document.getElementById('endDate').value + 'T23:59:59');
                    saveChallengeConfig(); showFeedbackMessage('Datas do desafio atualizadas!'); updateCurrentView();
                });
            }
            
            function renderRulesPage(container) {
                container.innerHTML = `
                    <div class="max-w-4xl mx-auto space-y-8">
                        <div class="text-center">
                            <h2 class="text-3xl font-extrabold text-gray-900">Regras do Desafio FIT PRO</h2>
                            <p class="mt-2 text-lg text-gray-600">Entenda como funciona a pontuação e conquiste a vitória!</p>
                        </div>

                        <!-- Seção de Pontuação -->
                        <div class="profile-card">
                            <h3 class="text-xl font-bold text-indigo-600 mb-4 flex items-center">
                                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                                Sistema de Pontuação (Máximo 100 Pontos)
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-indigo-50 p-6 rounded-lg">
                                    <h4 class="font-bold text-lg">Pontos por Perda de Peso (até 50 pts)</h4>
                                    <p class="text-sm text-gray-600 mt-1">Os pontos são baseados no **percentual de peso perdido** em relação ao seu peso inicial. Quanto maior o percentual, mais pontos você ganha!</p>
                                    <ul class="mt-4 space-y-2 text-sm">
                                        <li class="flex items-start"><span class="font-bold text-indigo-500 mr-2">►</span> 2% de perda = 10 pts</li>
                                        <li class="flex items-start"><span class="font-bold text-indigo-500 mr-2">►</span> 4% de perda = 15 pts</li>
                                        <li class="flex items-start"><span class="font-bold text-indigo-500 mr-2">►</span> 6% de perda = 20 pts</li>
                                        <li class="flex items-start"><span class="font-bold text-indigo-500 mr-2">►</span> 8% de perda = 30 pts</li>
                                        <li class="flex items-start"><span class="font-bold text-indigo-500 mr-2">►</span> 10% de perda = 35 pts</li>
                                        <li class="flex items-start"><span class="font-bold text-indigo-500 mr-2">►</span> 12% de perda = 40 pts</li>
                                        <li class="flex items-start"><span class="font-bold text-indigo-500 mr-2">►</span> 15% de perda = 50 pts</li>
                                    </ul>
                                </div>
                                <div class="bg-green-50 p-6 rounded-lg">
                                    <h4 class="font-bold text-lg">Pontos por Atividades (até 50 pts)</h4>
                                    <p class="text-sm text-gray-600 mt-1">Para validar uma semana, você precisa registrar pelo menos **3 atividades físicas**.</p>
                                    <p class="text-sm text-gray-600 mt-2">A pontuação é calculada com base no número de semanas que você validou. Se validar todas as 12 semanas, você ganha os 50 pontos!</p>
                                </div>
                            </div>
                        </div>

                        <!-- Seção de Emblemas -->
                        <div class="profile-card">
                            <h3 class="text-xl font-bold text-amber-600 mb-4 flex items-center">
                                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-12v4m-2-2h4m5 10v4m-2-2h4M5 3a2 2 0 00-2 2v1m14 0V5a2 2 0 00-2-2h-1m-4 18a2 2 0 002-2v-1m-4 0v1a2 2 0 002 2h1M5 21a2 2 0 012-2h1m4 0h1a2 2 0 012 2v0M3 17a2 2 0 012-2h1m4 0h1a2 2 0 012 2v0m6-14a2 2 0 00-2-2h-1m-4 0h-1a2 2 0 00-2 2v1"></path></svg>
                                Emblemas e Conquistas
                            </h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                <div class="bg-gray-100 p-4 rounded-lg">
                                    <p class="text-4xl">🎯</p>
                                    <p class="font-semibold mt-2">Meta Atingida</p>
                                    <p class="text-xs text-gray-600">Alcance o seu peso meta.</p>
                                </div>
                                <div class="bg-gray-100 p-4 rounded-lg">
                                    <p class="text-4xl">5️⃣</p>
                                    <p class="font-semibold mt-2">Clube dos 5kg</p>
                                    <p class="text-xs text-gray-600">Perca 5kg no total.</p>
                                </div>
                                <div class="bg-gray-100 p-4 rounded-lg">
                                    <p class="text-4xl">🔟</p>
                                    <p class="font-semibold mt-2">Clube dos 10kg</p>
                                    <p class="text-xs text-gray-600">Perca 10kg no total.</p>
                                </div>
                                <div class="bg-gray-100 p-4 rounded-lg">
                                    <p class="text-4xl">🔥</p>
                                    <p class="font-semibold mt-2">Em Chamas!</p>
                                    <p class="text-xs text-gray-600">Valide 4 semanas seguidas.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // --- ACTION HANDLERS ---
            async function handleUpdateWeight(participantId) {
                const weightInput = document.getElementById('profile-weight-input');
                const dateInput = document.getElementById('profile-weight-date');
                const newWeight = parseFloat(weightInput.value);
                const dateValue = dateInput.value;

                if (isNaN(newWeight) || newWeight <= 0) return showFeedbackMessage("Peso inválido.", true);
                if (!dateValue) return showFeedbackMessage("Selecione uma data.", true);
                
                const participant = participants.find(p => p.id == participantId);
                if (participant) {
                    const newEntry = { date: new Date(dateValue + 'T00:00:00').toISOString(), weight: newWeight };
                    const filteredHistory = (participant.weight_history || []).filter(entry => new Date(entry.date).toDateString() !== new Date(newEntry.date).toDateString());
                    const newHistory = [...filteredHistory, newEntry];
                    newHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
                    
                    const { error } = await supabase.from('participants').update({ peso_atual: newWeight, weight_history: newHistory }).eq('id', participantId);
                    if (error) showFeedbackMessage('Erro ao atualizar peso.', true);
                    else { 
                        showFeedbackMessage(`Peso de ${participant.name} atualizado!`); 
                        participant.peso_atual = newWeight;
                        participant.weight_history = newHistory;
                        updateCurrentView();
                    }
                }
            }

            async function handleDeleteWeightEntry(participantId, entryDateISO) {
                const participant = participants.find(p => p.id == participantId);
                if (!participant || (participant.weight_history && participant.weight_history.length <= 1)) {
                    return showFeedbackMessage("Não é possível excluir o único registro de peso.", true);
                }
                const newHistory = participant.weight_history.filter(entry => entry.date !== entryDateISO);
                newHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
                const newCurrentWeight = newHistory.length > 0 ? newHistory[newHistory.length - 1].weight : participant.peso_inicial;

                const { error } = await supabase.from('participants').update({ weight_history: newHistory, peso_atual: newCurrentWeight }).eq('id', participant.id);
                if (error) showFeedbackMessage('Erro ao excluir registro de peso.', true);
                else { 
                    showFeedbackMessage("Registro de peso excluído!"); 
                    participant.weight_history = newHistory;
                    participant.peso_atual = newCurrentWeight;
                    updateCurrentView();
                }
            }
            
            async function handleAddActivity(participantId) {
                const weekIndex = parseInt(document.getElementById('profile-activity-week').value);
                const type = document.getElementById('profile-activity-type').value;
                const duration = parseInt(document.getElementById('profile-activity-duration').value);

                if (!type || !duration || duration <= 0) return showFeedbackMessage('Preencha todos os campos da atividade.', true);
                
                const participant = participants.find(p => p.id == participantId);
                if (participant) {
                    const newActivity = { id: Date.now(), type, duration };
                    const newSemanasValidas = JSON.parse(JSON.stringify(participant.semanas_validas));
                    if (!Array.isArray(newSemanasValidas[weekIndex])) newSemanasValidas[weekIndex] = [];
                    newSemanasValidas[weekIndex].push(newActivity);

                    const { error } = await supabase.from('participants').update({ semanas_validas: newSemanasValidas }).eq('id', participantId);
                    if (error) showFeedbackMessage('Erro ao adicionar atividade.', true);
                    else { 
                        showFeedbackMessage('Atividade adicionada!'); 
                        participant.semanas_validas = newSemanasValidas;
                        updateCurrentView();
                    }
                }
            }

            async function handleDeleteActivity(participantId, weekIndex, activityId) {
                const participant = participants.find(p => p.id == participantId);
                if (participant) {
                    const newSemanasValidas = JSON.parse(JSON.stringify(participant.semanas_validas));
                    if (newSemanasValidas[weekIndex]) {
                        newSemanasValidas[weekIndex] = newSemanasValidas[weekIndex].filter(act => act.id != activityId);
                        const { error } = await supabase.from('participants').update({ semanas_validas: newSemanasValidas }).eq('id', participantId);
                        if (error) showFeedbackMessage('Erro ao apagar atividade.', true);
                        else { 
                            showFeedbackMessage('Atividade apagada.'); 
                            participant.semanas_validas = newSemanasValidas;
                            updateCurrentView();
                        }
                    }
                }
            }
            
            async function handleUpdateMeasurements(participantId) {
                const cintura = parseFloat(document.getElementById('profile-cintura').value);
                const quadril = parseFloat(document.getElementById('profile-quadril').value);
                const abdomen = parseFloat(document.getElementById('profile-abdomen').value);

                const participant = participants.find(p => p.id == participantId);
                if (participant) {
                    const newEntry = {
                        date: new Date().toISOString(),
                        cintura: !isNaN(cintura) ? cintura : null,
                        quadril: !isNaN(quadril) ? quadril : null,
                        abdomen: !isNaN(abdomen) ? abdomen : null,
                    };

                    const newHistory = [...(participant.measurements_history || []), newEntry];
                    const { error } = await supabase.from('participants').update({ measurements_history: newHistory }).eq('id', participantId);

                    if (error) showFeedbackMessage('Erro ao atualizar medidas.', true);
                    else { 
                        showFeedbackMessage(`Medidas de ${participant.name} atualizadas!`); 
                        participant.measurements_history = newHistory;
                        updateCurrentView();
                    }
                }
            }

            // --- MODALS ---
            function openParticipantModal(id = null) {
                if (currentUser.role !== 'admin') return;
                const modal = document.getElementById('participantModal');
                const isEdit = id !== null;
                const p = isEdit ? participants.find(p => p.id == id) : {};
                const avatarSrc = p.avatar_url || `https://placehold.co/100x100/E2E8F0/4A5568?text=?`;

                modal.innerHTML = `<div class="modal-content">
                        <span class="close-button">&times;</span>
                        <h3 class="text-2xl font-bold mb-6">${isEdit ? 'Editar' : 'Adicionar'} Participante</h3>
                        <form id="participantForm">
                            <input type="hidden" id="participantId" value="${isEdit ? p.id : ''}">
                            <input type="hidden" id="existingAvatarUrl" value="${p.avatar_url || ''}">
                            <div class="flex flex-col items-center mb-4">
                                <img id="avatarPreview" src="${avatarSrc}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/E2E8F0/4A5568?text=?';" class="rounded-full w-24 h-24 object-cover mb-2 border-2 border-gray-300">
                                <label for="pAvatarFile" class="cursor-pointer bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg text-sm">Selecionar Foto</label>
                                <input type="file" id="pAvatarFile" class="hidden" accept="image/*">
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                <div><label class="block font-bold mb-1">Nome:</label><input type="text" id="pName" class="border rounded-lg w-full py-2 px-3" value="${p.name || ''}" required></div>
                                <div><label class="block font-bold mb-1">Sexo:</label><select id="pSexo" class="border rounded-lg w-full py-2 px-3"><option value="M" ${p.sexo === 'M' ? 'selected' : ''}>Masculino</option><option value="F" ${p.sexo === 'F' ? 'selected' : ''}>Feminino</option></select></div>
                                <div><label class="block font-bold mb-1">Peso Inicial (kg):</label><input type="number" step="any" id="pInitial" class="border rounded-lg w-full py-2 px-3" value="${p.peso_inicial || ''}" ${isEdit ? 'readonly' : ''} required></div>
                                <div><label class="block font-bold mb-1">Peso Atual (kg):</label><input type="number" step="any" id="pCurrent" class="border rounded-lg w-full py-2 px-3" value="${p.peso_atual || ''}" required></div>
                                <div><label class="block font-bold mb-1">Altura (m):</label><input type="number" step="any" id="pHeight" class="border rounded-lg w-full py-2 px-3" value="${p.altura || ''}" placeholder="Ex: 1.75" required></div>
                                <div><label class="block font-bold mb-1">Meta de Peso (kg):</label><input type="number" step="any" id="pTarget" class="border rounded-lg w-full py-2 px-3" value="${p.target_weight || ''}"></div>
                            </div>
                            <hr class="my-4">
                            <h4 class="font-bold mb-2">Credenciais de Acesso</h4>
                            <p class="text-sm text-gray-500 mb-4">Crie um login para o participante acessar o próprio perfil.</p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                <div><label class="block font-bold mb-1">Usuário:</label><input type="text" id="pUsername" class="border rounded-lg w-full py-2 px-3" value="${p.username || ''}" required></div>
                                <div><label class="block font-bold mb-1">Senha:</label><input type="password" id="pPassword" class="border rounded-lg w-full py-2 px-3" placeholder="${isEdit ? 'Deixe em branco para não alterar' : ''}" ${isEdit ? '' : 'required'}></div>
                            </div>
                            <div class="flex justify-end gap-4 mt-8"><button type="button" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg close-button-action">Cancelar</button><button type="submit" style="background-color: var(--primary-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg">Salvar</button></div>
                        </form>
                    </div>`;
                
                modal.querySelector('.close-button').onclick = () => modal.classList.remove('show');
                modal.querySelector('.close-button-action').onclick = () => modal.classList.remove('show');
                modal.querySelector('#participantForm').onsubmit = handleParticipantFormSubmit;
                modal.querySelector('#pAvatarFile').onchange = (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => { document.getElementById('avatarPreview').src = e.target.result; }
                        reader.readAsDataURL(file);
                    }
                };
                modal.classList.add('show');
            }
            
            async function handleParticipantFormSubmit(e) {
                e.preventDefault();
                if (currentUser.role !== 'admin') return;
                const form = e.target;
                const id = form.querySelector('#participantId').value;
                const newUsername = document.getElementById('pUsername').value.trim();

                let query = supabase.from('participants').select('id').eq('username', newUsername);
                if (id) {
                    query = query.not('id', 'eq', id);
                }
                const { data: existingUser, error: validationError } = await query;

                if (validationError) {
                    showFeedbackMessage('Erro ao validar usuário.', true);
                    console.error("Supabase validation error:", JSON.stringify(validationError, null, 2));
                    return;
                }

                if (existingUser && existingUser.length > 0) {
                    showFeedbackMessage('Erro ao salvar: este nome de usuário já está em uso por outro participante.', true);
                    return;
                }

                let avatarUrl = form.querySelector('#existingAvatarUrl').value;
                const avatarFile = form.querySelector('#pAvatarFile').files[0];
                if (avatarFile) {
                    showFeedbackMessage('Enviando imagem...', false);
                    const fileName = `${Date.now()}-${avatarFile.name}`;
                    const { error: uploadError } = await supabase.storage.from('avatars').upload(`public/${fileName}`, avatarFile);
                    if (uploadError) { return showFeedbackMessage('Erro ao enviar o avatar.', true); }
                    const { data: urlData } = supabase.storage.from('avatars').getPublicUrl(`public/${fileName}`);
                    avatarUrl = urlData.publicUrl;
                }

                const pesoAtual = parseFloat(document.getElementById('pCurrent').value);
                const passwordValue = document.getElementById('pPassword').value;

                const participantData = {
                    name: document.getElementById('pName').value.trim(),
                    username: newUsername,
                    sexo: document.getElementById('pSexo').value,
                    peso_inicial: parseFloat(document.getElementById('pInitial').value),
                    peso_atual: pesoAtual,
                    altura: parseFloat(document.getElementById('pHeight').value),
                    target_weight: parseFloat(document.getElementById('pTarget').value) || null,
                    avatar_url: avatarUrl,
                };

                if (passwordValue) {
                    participantData.password = passwordValue;
                }

                let dbError;
                if (id) {
                    delete participantData.peso_inicial;
                    const { error: updateError } = await supabase.from('participants').update(participantData).eq('id', id);
                    dbError = updateError;
                } else {
                    participantData.semanas_validas = Array(12).fill([]);
                    participantData.weight_history = [{ date: new Date().toISOString(), weight: pesoAtual }];
                    const { error: insertError } = await supabase.from('participants').insert([participantData]);
                    dbError = insertError;
                }
                
                if (dbError) {
                    showFeedbackMessage('Erro ao salvar participante. Verifique o console para mais detalhes.', true);
                    console.error("Erro detalhado do Supabase:", JSON.stringify(dbError, null, 2));
                } else {
                    document.getElementById('participantModal').classList.remove('show');
                    showFeedbackMessage(`Participante ${id ? 'atualizado' : 'adicionado'}!`);
                    loadDataAndLogin(currentUser);
                }
            }
            
            async function openDeleteModal(id, name) {
                if (currentUser.role !== 'admin') return;
                const modal = document.getElementById('deleteConfirmModal');
                modal.innerHTML = `<div class="modal-content text-center">
                        <h3 class="text-2xl font-bold mb-4">Confirmar Exclusão</h3>
                        <p class="mb-6">Tem certeza que deseja excluir <strong>${name}</strong>? Esta ação não pode ser desfeita.</p>
                        <div class="flex justify-center gap-4">
                            <button class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg" id="cancelDelete">Cancelar</button>
                            <button style="background-color: var(--danger-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg" id="confirmDelete">Confirmar</button>
                        </div>
                    </div>`;
                
                modal.querySelector('#cancelDelete').onclick = () => modal.classList.remove('show');
                modal.querySelector('#confirmDelete').onclick = async () => {
                    const { error } = await supabase.from('participants').delete().eq('id', id);
                    if (error) showFeedbackMessage('Erro ao excluir.', true);
                    else { showFeedbackMessage("Excluído com sucesso!"); loadDataAndLogin(currentUser); }
                    modal.classList.remove('show');
                };
                modal.classList.add('show');
            }

            // --- UTILITY FUNCTIONS ---
            function updateSummaryBoxes() {
                const leaderBox = document.getElementById('leaderBox');
                const weeklyBox = document.getElementById('weeklyHighlightBox');
                const monthlyBox = document.getElementById('monthlyHighlightBox');
                const daysBox = document.getElementById('daysRemainingBox');

                const ranked = participants.map(p => calculateMetrics(p)).sort((a, b) => b.totalPoints - a.totalPoints);
                if (ranked.length > 0) {
                    const leader = ranked[0];
                    leaderBox.innerHTML = `<div class="text-sm font-medium text-gray-500">👑 Líder Atual</div><div class="text-2xl font-bold" style="color: var(--success-color);">${leader.name}</div><div class="text-sm text-gray-600">${leader.totalPoints.toFixed(2)} pts</div>`;
                } else {
                    leaderBox.innerHTML = `<div class="text-sm font-medium text-gray-500">👑 Líder Atual</div><div class="text-2xl font-bold">N/A</div>`;
                }
                
                let weeklyWinner = { name: 'N/A', loss: Number.NEGATIVE_INFINITY };
                const oneWeekAgo = new Date(); oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                participants.forEach(p => {
                    const loss = getWeightAtDate(p, oneWeekAgo) - p.peso_atual;
                    if (loss > weeklyWinner.loss) weeklyWinner = { name: p.name, loss };
                });
                weeklyBox.innerHTML = `<div class="text-sm font-medium text-gray-500">🔥 Destaque da Semana</div><div class="text-2xl font-bold" style="color: var(--warning-color);">${weeklyWinner.loss > 0 ? weeklyWinner.name : 'N/A'}</div><div class="text-sm text-gray-600">${weeklyWinner.loss > 0 ? weeklyWinner.loss.toFixed(2) : '0.00'} kg</div>`;

                let monthlyWinner = { name: 'N/A', loss: Number.NEGATIVE_INFINITY };
                const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
                participants.forEach(p => {
                    const loss = getWeightAtDate(p, firstDayOfMonth) - p.peso_atual;
                    if (loss > monthlyWinner.loss) monthlyWinner = { name: p.name, loss };
                });
                monthlyBox.innerHTML = `<div class="text-sm font-medium text-gray-500">🌟 Destaque do Mês</div><div class="text-2xl font-bold" style="color: var(--primary-color);">${monthlyWinner.loss > 0 ? monthlyWinner.name : 'N/A'}</div><div class="text-sm text-gray-600">Perdeu ${monthlyWinner.loss > 0 ? monthlyWinner.loss.toFixed(2) : '0.00'} kg</div>`;

                const daysRemaining = Math.max(0, Math.ceil((CHALLENGE_END_DATE - new Date()) / (1000 * 60 * 60 * 24)));
                daysBox.innerHTML = `<div class="text-sm font-medium text-gray-500">⏳ Dias Restantes</div><div class="text-3xl font-bold text-gray-700">${daysRemaining}</div>`;
            }
            
            function calculateTrendLine(data) {
                if (data.length < 2) return null;
                const n = data.length;
                const firstDay = new Date(data[0].date).getTime();
                const x = data.map(d => (new Date(d.date).getTime() - firstDay) / (1000 * 60 * 60 * 24));
                const y = data.map(d => d.weight);
                const sumX = d3.sum(x), sumY = d3.sum(y), sumXY = d3.sum(x.map((xi,i) => xi * y[i])), sumXX = d3.sum(x.map(xi => xi*xi));
                const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
                const intercept = (sumY - slope * sumX) / n;
                const predict = (day) => slope * day + intercept;
                const startDay = (new Date(data[0].date).getTime() - firstDay) / (1000 * 60 * 60 * 24);
                const endDay = (CHALLENGE_END_DATE.getTime() - firstDay) / (1000 * 60 * 60 * 24);
                return { start: { date: new Date(data[0].date), weight: predict(startDay) }, end: { date: CHALLENGE_END_DATE, weight: predict(endDay) } };
            }

            async function getAICoachingTip(participantId) {
                const participant = participants.find(p => p.id == participantId);
                if (!participant) return;

                const tipContainer = document.getElementById('ai-tip-container');
                tipContainer.innerHTML = '<div class="ai-tip-loader"></div>';

                const activityHistory = participant.semanas_validas.slice(-4).map(week => (Array.isArray(week) ? week.length : 0)).join(', ');
                const prompt = `Seja um coach de fitness motivador e amigável, em português do Brasil. Dê uma dica curta e prática para o participante: Nome: ${participant.name}, Peso Inicial: ${participant.peso_inicial} kg, Peso Atual: ${participant.peso_atual} kg, Meta: ${participant.target_weight || 'N/A'} kg. Atividades nas últimas 4 semanas: ${activityHistory}. Fale diretamente com o participante (use "você").`;

                try {
                    const { data, error } = await supabase.functions.invoke('get-ai-tip', {
                        body: { prompt: prompt },
                    });

                    if (error) throw error;

                    if (data && data.tip) {
                        tipContainer.innerHTML = data.tip.replace(/\n/g, '<br>');
                    } else {
                        throw new Error("Resposta da IA inválida.");
                    }
                } catch (error) {
                    console.error("Erro ao invocar a Supabase Function:", error);
                    tipContainer.innerHTML = 'Ocorreu um erro ao falar com o nosso coach. Tente novamente mais tarde.';
                }
            }

             async function exportDetailsToPDF(participantId) {
                const detailsElement = document.getElementById('profile-content');
                const participant = participants.find(p => p.id == participantId);
                if (!detailsElement || !participant) return;
                
                showFeedbackMessage('Gerando relatório PDF...', false);
                html2canvas(detailsElement, { scale: 2, useCORS: true, backgroundColor: '#f4f5f7' }).then(canvas => {
                    const { jsPDF } = window.jspdf;
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF({ orientation: 'portrait', unit: 'px', format: [canvas.width, canvas.height] });
                    pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                    pdf.save(`relatorio_${participant.name.replace(/\s/g, '_')}.pdf`);
                });
            }

            function showFeedbackMessage(message, isError = false) {
                feedbackMessageDiv.textContent = message;
                feedbackMessageDiv.className = `feedback-message show ${isError ? 'error' : ''}`;
                setTimeout(() => feedbackMessageDiv.classList.remove('show'), 3000);
            }
            
            function debounce(func, delay) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            }

            // --- INITIALIZE THE APP ---
            initApp();
        });
    </script>
</body>
</html>
