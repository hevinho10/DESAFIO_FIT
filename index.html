<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desafio Fam√≠lia FIT 90 DIAS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Vari√°veis CSS para cores e tamanhos comuns */
        :root {
            --font-inter: 'Inter', sans-serif;
            --background-light-gray: #f3f4f6;
            --text-dark: #333;
            --container-bg: #ffffff;
            --border-light: #e5e7eb;
            --header-bg-light-blue: #e0f2f7;
            --header-text-dark-blue: #2c5282;
            --checkbox-border-gray: #9ca3af;
            --checkbox-checked-green: #34d399;
            --missed-week-bg-red: #fee2e2;
            --missed-week-border-red: #dc2626;
            --leader-row-bg-orange: #ffedd5;
            --leader-row-border-orange: #f97316;
            --feedback-success-bg: #10b981;
            --feedback-error-bg: #ef4444;
            --modal-bg-overlay: rgba(0,0,0,0.4);
            --error-red: #ef4444;
            --blue-600: #2563eb;
            --yellow-600: #ca8a04;
            --red-600: #dc2626;
            --gray-800: #1f2937;
        }

        body {
            font-family: var(--font-inter);
            background-color: var(--background-light-gray);
            color: var(--text-dark);
        }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: var(--container-bg);
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        /* Estilo espec√≠fico para o container mobile */
        .container-mobile-view {
            max-width: 600px; /* Mais estreito para mobile */
            margin: 1rem auto;
            padding: 1rem;
            background-color: var(--container-bg);
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 2rem;
            border-radius: 0.75rem;
            overflow: hidden;
        }
        th, td {
            padding: 0.5rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-light);
        }
        th {
            background-color: var(--header-bg-light-blue);
            font-weight: 600;
            color: var(--header-text-dark-blue);
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }
        /* Specific styles for weekly participation table to make it more compact */
        #weeklyParticipationTable th,
        #weeklyParticipationTable td {
            padding: 0.2rem 0.3rem;
            white-space: nowrap;
        }
        #weeklyParticipationTable td:first-child {
            min-width: 60px;
            padding-right: 0.1rem;
        }
        #weeklyParticipationTable th:not(:first-child),
        #weeklyParticipationTable td:not(:first-child) {
            text-align: center;
        }
        /* Style for missed week cells - now only for the checkbox itself */
        .missed-week-cell {
            background-color: transparent;
        }

        /* Custom checkbox styling */
        input[type="checkbox"] {
            transform: scale(1.2);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 1.2em;
            height: 1.2em;
            border: 2px solid var(--checkbox-border-gray);
            border-radius: 0.25em;
            cursor: pointer;
            vertical-align: middle;
            display: inline-block;
            position: relative;
            transition: background-color 0.2s, border-color 0.2s;
        }

        /* Checked state (green) */
        input[type="checkbox"]:checked {
            background-color: var(--checkbox-checked-green);
            border-color: var(--checkbox-checked-green);
        }

        /* Checkmark for checked state */
        input[type="checkbox"]:checked::after {
            content: '‚úî';
            font-size: 0.8em;
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            line-height: 1;
        }

        /* Missed week, unchecked state (red checkbox) */
        .missed-week-cell input[type="checkbox"]:not(:checked) {
            background-color: var(--missed-week-bg-red);
            border-color: var(--missed-week-border-red);
        }
        /* No checkmark for unchecked missed boxes */
        .missed-week-cell input[type="checkbox"]:not(:checked)::after {
            content: '';
        }

        /* If a missed-week-cell checkbox is *then* checked, it becomes green */
        .missed-week-cell input[type="checkbox"]:checked {
            background-color: var(--checkbox-checked-green);
            border-color: var(--checkbox-checked-green);
        }

        tr:last-child td {
            border-bottom: none;
        }
        tr:nth-child(even) {
            background-color: #f9fafb;
        }

        /* Agrupamento de estilos para leader-box e days-remaining-box */
        .leader-box, .days-remaining-box {
            background-color: var(--container-bg);
            border: 1px solid var(--border-light);
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            font-weight: 600;
            color: var(--text-dark);
            text-align: center;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .days-remaining-box .date-info {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: #4a5568;
        }
        .days-remaining-box .countdown-message {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--header-text-dark-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            white-space: nowrap;
        }
        .days-remaining-box .countdown-message .days-value {
            font-size: 2rem;
            color: #3182ce;
        }
        .days-remaining-box .duration-info {
            font-size: 0.9rem;
            color: #6b7280;
            margin-top: 0.75rem;
        }

        .checkbox-cell {
            text-align: center;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 180px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -90px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #555 transparent transparent transparent;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .leader-row {
            background-color: var(--leader-row-bg-orange) !important;
            border-left: 4px solid var(--leader-row-border-orange);
        }
        /* Novo estilo para o card do l√≠der em mobile */
        .leader-row-card {
            background-color: var(--leader-row-bg-orange); /* Usa a cor de destaque do l√≠der */
            border: 1px solid var(--leader-row-border-orange);
        }
        .feedback-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--feedback-success-bg);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 1000;
        }
        .feedback-message.show {
            opacity: 1;
        }
        .feedback-message.error {
            background-color: var(--feedback-error-bg);
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: var(--modal-bg-overlay);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 500px;
            position: relative;
            transform: translateY(-50px);
            transition: transform 0.3s ease-in-out;
        }
        .modal.show .modal-content {
            transform: translateY(0);
        }
        .close-button {
            position: absolute;
            top: 10px;
            right: 20px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .input-error {
            border-color: var(--error-red);
        }
        .error-message {
            color: var(--error-red);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        /* Style for empty table message */
        .empty-table-message {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
            font-style: italic;
        }
        /* CSS for activity bar SVG fill animation */
        #activityChart svg g rect,
        #activityChart svg g circle {
            transition: fill 0.5s ease-out; /* Smooth transition for fill color */
        }
        /* Estilo para a semana atual */
        .current-week {
            background-color: #dbeafe !important; /* Light blue for current week header */
            border-bottom: 2px solid #60a5fa !important; /* Blue border for current week */
            color: #1e40af !important;
        }
        .current-week-cell {
            background-color: #eff6ff; /* Very light blue for current week cells */
        }

        /* Styles for the new navigation menu */
        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-light);
            overflow-x: auto; /* Allow horizontal scrolling on small screens */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        .nav-tab-item {
            padding: 0.75rem 1.25rem;
            cursor: pointer;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease-in-out;
            white-space: nowrap; /* Prevent wrapping */
        }
        .nav-tab-item:hover {
            color: var(--header-text-dark-blue);
            border-color: #a7d9f2;
        }
        .nav-tab-item.active {
            color: var(--header-text-dark-blue);
            border-color: var(--blue-600);
        }

        /* Mobile menu button */
        .mobile-menu-button {
            display: none; /* Hidden by default, shown on small screens */
            background-color: var(--blue-600);
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            width: 100%;
            text-align: center;
            margin-bottom: 1rem;
            transition: background-color 0.2s;
        }
        .mobile-menu-button:hover {
            background-color: var(--blue-700);
        }

        /* Mobile menu dropdown */
        .mobile-menu-dropdown {
            display: none; /* Hidden by default */
            flex-direction: column;
            background-color: var(--container-bg);
            border-radius: 0.5rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            margin-bottom: 1rem;
            overflow: hidden;
        }
        .mobile-menu-dropdown.open {
            display: flex;
        }
        .mobile-menu-dropdown .nav-tab-item {
            padding: 1rem;
            border-bottom: 1px solid var(--border-light);
            text-align: left;
        }
        .mobile-menu-dropdown .nav-tab-item:last-child {
            border-bottom: none;
        }
        .mobile-menu-dropdown .nav-tab-item.active {
            background-color: #e0f2f7;
        }

        @media (min-width: 768px) { /* md breakpoint */
            .nav-tabs {
                display: flex; /* Show tabs on desktop */
            }
            .mobile-menu-button,
            .mobile-menu-dropdown {
                display: none !important; /* Hide mobile menu elements on desktop */
            }
        }
        @media (max-width: 767px) { /* Below md breakpoint */
            .nav-tabs {
                display: none; /* Hide tabs on mobile */
            }
            .mobile-menu-button {
                display: block; /* Show mobile menu button */
            }
        }
    </style>
</head>
<body class="p-4">

    <!-- Tela de Login -->
    <div id="loginScreen" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-200 via-green-200 to-blue-300 p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md border border-blue-300">
            <h2 class="text-4xl font-extrabold text-center mb-10 text-gray-900 flex items-center justify-center gap-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="currentColor" class="text-blue-700"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                Acesso ao Desafio FIT
            </h2>
            <form id="loginForm">
                <div class="mb-4 relative">
                    <label for="username" class="block text-gray-700 text-sm font-bold mb-2 sr-only">Usu√°rio:</label>
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    </div>
                    <input type="text" id="username" placeholder="Usu√°rio" class="shadow appearance-none border rounded w-full py-3 pl-10 pr-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <div class="mb-6 relative">
                    <label for="password" class="block text-gray-700 text-sm font-bold mb-2 sr-only">Senha:</label>
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                    </div>
                    <input type="password" id="password" placeholder="Senha" class="shadow appearance-none border rounded w-full py-3 pl-10 pr-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
                </div>
                <p id="loginError" class="text-red-500 text-sm italic mb-4 hidden text-center">Usu√°rio ou senha inv√°lidos.</p>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-xl shadow-md transition duration-300 ease-in-out transform hover:scale-105 w-full">
                    Entrar
                </button>
            </form>
        </div>
    </div>

    <!-- Nova Tela Principal Mobile (vis√≠vel apenas em telas pequenas por padr√£o) -->
    <div id="mobileDashboard" class="container-mobile-view md:hidden">
        <h1 class="text-2xl sm:text-3xl font-bold text-center mb-6 text-gray-800">üí™üçé Desafio Fam√≠lia FIT 90 DIAS! üèÜ</h1>
        <h2 class="text-xl font-bold text-center mb-4 text-gray-800">üìä Ranking Geral</h2>

        <div id="leaderHighlightCard" class="bg-gradient-to-r from-yellow-100 to-orange-100 p-4 rounded-lg shadow-lg border-2 border-orange-300 mb-6 text-center">
            <!-- Conte√∫do do l√≠der ser√° injetado aqui via JS -->
            <p class="text-lg font-semibold text-orange-700">L√≠der Atual: <span class="text-xl font-bold text-orange-900" id="mobileLeaderName">Carregando...</span> üëë</p>
            <p class="text-md text-gray-700">Pontua√ß√£o Total: <span class="font-bold text-orange-800" id="mobileLeaderPoints">Carregando...</span> pts</p>
        </div>

        <div id="mobileRankingList" class="space-y-3">
            <!-- Lista de participantes simplificada ser√° injetada aqui via JS -->
            <p class="text-center text-gray-500">Nenhum participante para exibir.</p>
        </div>

        <div class="flex justify-center mt-6">
            <button id="viewFullDashboardBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-xl shadow-md transition duration-300 ease-in-out transform hover:scale-105 w-full">
                Ver Planilha Completa
            </button>
        </div>
    </div>

    <!-- Conte√∫do Principal do Desafio (inicialmente oculto, vis√≠vel em telas maiores) -->
    <div class="container hidden md:block">
        <h1 class="text-2xl sm:text-3xl font-bold text-center mb-6 text-gray-800">üí™üçé Desafio Fam√≠lia FIT 90 DIAS! üèÜ</h1>

        <!-- Bot√£o para menu mobile (vis√≠vel apenas em telas pequenas) -->
        <button id="mobileMenuToggleButton" class="mobile-menu-button md:hidden">
            Menu <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block ml-2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </button>

        <!-- Menu de navega√ß√£o (abas para desktop, dropdown para mobile) -->
        <nav id="mainNavTabs" class="nav-tabs">
            <a href="#" class="nav-tab-item active" data-section="ranking">üèÜ Ranking e Pontua√ß√£o</a>
            <a href="#" class="nav-tab-item" data-section="weekly">üóìÔ∏è Registro Semanal de Participa√ß√£o</a>
            <a href="#" class="nav-tab-item" data-section="activity">üìà Participa√ß√£o nas Atividades (%)</a>
        </nav>

        <!-- Dropdown do menu para mobile -->
        <div id="mobileMenuDropdown" class="mobile-menu-dropdown">
            <a href="#" class="nav-tab-item" data-section="ranking">üèÜ Ranking e Pontua√ß√£o</a>
            <a href="#" class="nav-tab-item" data-section="weekly">üóìÔ∏è Registro Semanal de Participa√ß√£o</a>
            <a href="#" class="nav-tab-item" data-section="activity">üìà Participa√ß√£o nas Atividades (%)</a>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div id="leaderBox" class="leader-box">
                L√≠der Atual: Carregando...
            </div>
            <div id="daysRemainingBox" class="days-remaining-box">
                Dias Restantes: Carregando...
            </div>
        </div>

        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
            <button id="addParticipantBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 w-full sm:w-auto">
                Adicionar Participante
            </button>
            <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                <button id="exportDataBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 w-full sm:w-auto">
                    Exportar Dados
                </button>
                <input type="file" id="importDataInput" accept=".json" class="hidden">
                <button id="importDataBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 w-full sm:w-auto">
                    Importar Dados
                </button>
                <button id="resetDataBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 w-full sm:w-auto">
                    Resetar Dados
                </button>
            </div>
            <div class="relative w-full sm:w-1/2">
                <input type="text" id="searchParticipantInput" placeholder="Buscar participante..." class="p-2 border border-gray-300 rounded-md w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                <svg class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            </div>
        </div>

        <!-- Se√ß√µes de Conte√∫do (agora com IDs para controle de visibilidade) -->
        <div id="sectionRanking" class="content-section">
            <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-700 hidden">üèÜ Ranking e Pontua√ß√£o</h2> <!-- Hidden as title is in nav -->
            <!-- Tabela para telas maiores (md e acima) -->
            <div id="rankingTableContainer" class="overflow-x-auto rounded-xl shadow-md hidden md:block">
                <table id="rankingTable">
                    <thead>
                        <tr>
                            <th class="rounded-tl-xl">Ranking</th>
                            <th>Nome</th>
                            <th>
                                Peso Inicial
                                <span class="tooltip">
                                    <span class="tooltiptext">O peso do participante no in√≠cio do desafio (kg). Clique no nome para editar.</span>
                                </span>
                            </th>
                            <th>
                                Peso Final
                                <span class="tooltip">
                                    <span class="tooltiptext">O peso atual ou final do participante (kg). Clique no nome para editar.</span>
                                </span>
                            </th>
                            <th>
                                % Perda
                                <span class="tooltip">
                                    <span class="tooltiptext">Porcentagem de peso perdido em rela√ß√£o ao peso inicial.</span>
                                </span>
                            </th>
                            <th>
                                Pts Peso
                                <span class="tooltip">
                                    <span class="tooltiptext">Pontos de peso baseados na % de perda. M√°ximo de 50 pontos.</span>
                                </span>
                            </th>
                            <th>
                                Sem. V√°lidas
                                <span class="tooltip">
                                    <span class="tooltiptext">N√∫mero de semanas com 3 ou mais treinos registrados.</span>
                                </span>
                            </th>
                            <th>
                                Pts Ativ.
                                <span class="tooltip">
                                    <span class="tooltiptext">Pontos de atividade baseados nas semanas v√°lidas. M√°ximo de 50 pontos.</span>
                                </span>
                            </th>
                            <th>
                                Total
                                <span class="tooltip">
                                    <span class="tooltiptext">Soma dos pontos de peso e atividade.</span>
                                </span>
                            </th>
                            <th class="rounded-tr-xl"></th> <!-- Coluna para o bot√£o de edi√ß√£o/exclus√£o -->
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
                <div id="noRankingData" class="empty-table-message hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-2 text-gray-400"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><path d="M14 2v6h6"></path><path d="M10 9H8"></path><path d="M16 13H8"></path><path d="M16 17H8"></path></svg>
                    Nenhum participante encontrado no ranking.
                </div>
            </div>

            <!-- Cards para telas menores (abaixo de md) - Vis√≠vel apenas em telas maiores agora, pois o mobileDashboard assume o lugar -->
            <div id="rankingCardsContainer" class="grid grid-cols-1 gap-4 hidden">
                <div id="noRankingCardsData" class="empty-table-message hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-2 text-gray-400"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><path d="M14 2v6h6"></path><path d="M10 9H8"></path><path d="M16 13H8"></path><path d="M16 17H8"></path></svg>
                    Nenhum participante encontrado no ranking.
                </div>
                <!-- Cards will be populated by JavaScript -->
            </div>
        </div>

        <div id="sectionWeekly" class="content-section hidden">
            <h2 class="text-xl sm:text-2xl font-semibold mt-8 mb-4 text-gray-700 hidden">üóìÔ∏è Registro Semanal de Participa√ß√£o</h2> <!-- Hidden as title is in nav -->
            <div class="overflow-x-auto rounded-xl shadow-md">
                <table id="weeklyParticipationTable">
                    <thead>
                        <tr>
                            <th class="rounded-tl-xl">
                                Nome
                                <span class="tooltip">
                                    <span class="tooltiptext">Semanas de 1 a 12. Marque a caixa se a semana for v√°lida (3+ treinos).</span>
                                </span>
                            </th>
                            <!-- Semanas ser√£o geradas dinamicamente pelo JavaScript para aplicar a classe 'current-week' -->
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be populated by JavaScript -->
                    </tbody>
                </table>
                <div id="noWeeklyData" class="empty-table-message hidden">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-2 text-gray-400"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><path d="M14 2v6h6"></path><path d="M10 9H8"></path><path d="M16 13H8"></path><path d="M16 17H8"></path></svg>
                    Nenhum participante para o registro semanal.
                </div>
            </div>
        </div>

        <div id="sectionActivity" class="content-section hidden">
            <h2 class="text-xl sm:text-2xl font-semibold mt-8 mb-4 text-gray-700 hidden">üìà Participa√ß√£o nas Atividades (%)</h2> <!-- Hidden as title is in nav -->
            <!-- Adjusted grid gap for closer spacing -->
            <div id="activityChart" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-4 gap-x-4 gap-y-6 min-h-[100px] justify-items-center">
                <!-- Chart icons will be populated by JavaScript -->
                <div id="noChartData" class="empty-table-message hidden col-span-full">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-2 text-gray-400"><path d="M21.2 15.6l-3.24-3.24A7 7 0 1 0 12 2v10h8.9z"></path><path d="M22 22L15.6 15.6"></path></svg>
                    Nenhum participante para o gr√°fico de atividades.
                </div>
            </div>
        </div>

        <div class="flex justify-center mt-6">
            <button id="saveDataBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                Salvar Dados
            </button>
        </div>

        <div class="flex justify-center mt-6">
            <button id="backToMobileRankingBtn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 hidden md:hidden">
                Voltar ao Ranking Mobile
            </button>
        </div>
    </div>

    <div id="feedbackMessage" class="feedback-message">
        Dados salvos com sucesso!
    </div>

    <!-- Modal para Adicionar/Editar Participante -->
    <div id="participantModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeModalBtn">&times;</span>
            <h3 class="text-2xl font-bold mb-4" id="modalTitle">Adicionar Novo Participante</h3>
            <form id="participantForm">
                <input type="hidden" id="participantIndex">
                <div class="mb-4">
                    <label for="participantName" class="block text-gray-700 text-sm font-bold mb-2">Nome:</label>
                    <input type="text" id="participantName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    <p class="error-message hidden" id="nameError">O nome √© obrigat√≥rio.</p>
                </div>
                <div class="mb-4">
                    <label for="participantInitialWeight" class="block text-gray-700 text-sm font-bold mb-2">Peso Inicial (kg):</label>
                    <input type="number" step="any" id="participantInitialWeight" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    <p class="error-message hidden" id="initialWeightError">Peso inicial deve ser um n√∫mero positivo.</p>
                </div>
                <div class="mb-4">
                    <label for="participantFinalWeight" class="block text-gray-700 text-sm font-bold mb-2">Peso Final (kg):</label>
                    <input type="number" step="any" id="participantFinalWeight" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    <p class="error-message hidden" id="finalWeightError">Peso final deve ser um n√∫mero positivo.</p>
                </div>
                <div class="mb-6">
                    <label for="participantTargetWeight" class="block text-gray-700 text-sm font-bold mb-2">Meta de Peso (kg):</label>
                    <input type="number" step="any" id="participantTargetWeight" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <p class="error-message hidden" id="targetWeightError">Meta de peso deve ser um n√∫mero positivo (opcional).</p>
                </div>
                <div class="flex items-center justify-between">
                    <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        Salvar
                    </button>
                    <button type="button" id="cancelModalBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o de Exclus√£o -->
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeDeleteModalBtn">&times;</span>
            <h3 class="text-2xl font-bold mb-4">Confirmar Exclus√£o</h3>
            <p class="mb-6">Tem certeza que deseja excluir <span id="participantNameToDelete" class="font-semibold text-red-600"></span> do desafio?</p>
            <div class="flex justify-end gap-4">
                <button id="confirmDeleteBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Excluir
                </button>
                <button type="button" id="cancelDeleteBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Credenciais de login e permiss√µes
        const USERS = {
            admin: { password: 'admin', canEdit: true },
            root: { password: '1', canEdit: false }
        };

        let currentUser = null; // Para armazenar o usu√°rio logado atualmente
        let currentViewIsMobile = false; // Flag para controlar a view atual

        // Refer√™ncias aos novos elementos do DOM para login
        const loginScreen = document.getElementById('loginScreen');
        const loginForm = document.getElementById('loginForm');
        const usernameInput = document.getElementById('username');
        const passwordInput = document.getElementById('password');
        const loginError = document.getElementById('loginError');
        const mainContent = document.querySelector('.container'); // O container principal da sua aplica√ß√£o

        // Novas refer√™ncias de DOM para o dashboard mobile
        const mobileDashboard = document.getElementById('mobileDashboard');
        const viewFullDashboardBtn = document.getElementById('viewFullDashboardBtn');
        const mobileLeaderName = document.getElementById('mobileLeaderName');
        const mobileLeaderPoints = document.getElementById('mobileLeaderPoints');
        const mobileRankingList = document.getElementById('mobileRankingList');
        const backToMobileRankingBtn = document.getElementById('backToMobileRankingBtn');

        // Novas refer√™ncias de DOM para o menu de navega√ß√£o
        const mobileMenuToggleButton = document.getElementById('mobileMenuToggleButton');
        const mobileMenuDropdown = document.getElementById('mobileMenuDropdown');
        const mainNavTabs = document.getElementById('mainNavTabs');
        const contentSections = document.querySelectorAll('.content-section');

        // Constantes para chaves do localStorage e classes CSS
        const LOCAL_STORAGE_KEY = 'challengeParticipants';
        const HIDDEN_CLASS = 'hidden';
        const INPUT_ERROR_CLASS = 'input-error';
        const SHOW_CLASS = 'show';
        const MILLISECONDS_PER_WEEK = 1000 * 60 * 60 * 24 * 7;

        // Dados iniciais dos participantes (baseado na imagem e nas regras)
        // A propriedade 'semanasValidas' √© um array de booleanos para cada uma das 12 semanas.
        // true = semana v√°lida (3+ treinos), false = semana n√£o v√°lida.
        // Adicionado 'targetWeight' para metas de peso e 'weightHistory' para futuros gr√°ficos.
        const defaultParticipants = [
            { name: "Amanda", pesoInicial: 69.1, pesoFinal: 69.1, targetWeight: null, semanasValidas: Array(12).fill(false) },
            { name: "Hevinho", pesoInicial: 85.3, pesoFinal: 85.3, targetWeight: 75.0, semanasValidas: [true, false, false, false, false, false, false, false, false, false, false, false] },
            { name: "Junior", pesoInicial: 113.9, pesoFinal: 113.9, targetWeight: 100.0, semanasValidas: Array(12).fill(false) },
            { name: "Midian Diniz", pesoInicial: 89.85, pesoFinal: 89.85, targetWeight: null, semanasValidas: Array(12).fill(false) },
            { name: "Midian Fernandes", pesoInicial: 65.15, pesoFinal: 65.15, targetWeight: 60.0, semanasValidas: [true, false, false, false, false, false, false, false, false, false, false, false] },
            { name: "Paulinha", pesoInicial: 75.9, pesoFinal: 75.9, targetWeight: 70.0, semanasValidas: Array(12).fill(false) },
            { name: "Rayanne", pesoInicial: 86.4, pesoFinal: 86.4, targetWeight: null, semanasValidas: Array(12).fill(false) },
            { name: "Wellington", pesoInicial: 117.7, pesoFinal: 117.7, targetWeight: 110.0, semanasValidas: Array(12).fill(false) },
        ];

        // Tenta carregar os dados do localStorage, se n√£o houver, usa os dados padr√£o
        let participants = [];
        try {
            const storedParticipants = localStorage.getItem(LOCAL_STORAGE_KEY);
            participants = storedParticipants ? JSON.parse(storedParticipants) : defaultParticipants;
            // Garante que os novos campos (targetWeight, etc.) existam em dados antigos
            participants = participants.map(p => ({
                ...p,
                targetWeight: p.targetWeight !== undefined ? p.targetWeight : null,
                // weightHistory: p.weightHistory !== undefined ? p.weightHistory : [], // Manter para futura implementa√ß√£o de hist√≥rico
                semanasValidas: p.semanasValidas || Array(12).fill(false) // Garante que semanasValidas exista
            }));
            console.log("Dados carregados. Participantes:", participants); // Log de depura√ß√£o
        } catch (e) {
            console.error("Erro ao carregar dados do localStorage:", e);
            participants = defaultParticipants; // Fallback para dados padr√£o em caso de erro
            console.log("Fallback para dados padr√£o. Participantes:", participants); // Log de depura√ß√£o
        }

        // Data de in√≠cio do desafio: 07/07/2025
        const CHALLENGE_START_DATE = new Date('2025-07-07T00:00:00');
        // Data final do desafio: 07/10/2025 (90 dias a partir de 07/07/2025)
        const CHALLENGE_END_DATE = new Date('2025-10-07T23:59:59');
        const MAX_WEEKS = 12; // N√∫mero total de semanas no desafio
        const MAX_ACTIVITY_POINTS = 50; // Pontua√ß√£o m√°xima para atividade

        // Refer√™ncias aos elementos do DOM (do conte√∫do principal)
        const participantModal = document.getElementById('participantModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelModalBtn = document.getElementById('cancelModalBtn');
        const addParticipantBtn = document.getElementById('addParticipantBtn');
        const participantForm = document.getElementById('participantForm');
        const modalTitle = document.getElementById('modalTitle');
        const participantIndexInput = document.getElementById('participantIndex');
        const participantNameInput = document.getElementById('participantName');
        const participantInitialWeightInput = document.getElementById('participantInitialWeight');
        const participantFinalWeightInput = document.getElementById('participantFinalWeight');
        const participantTargetWeightInput = document.getElementById('participantTargetWeight'); // Novo input para meta de peso
        const searchParticipantInput = document.getElementById('searchParticipantInput');
        const feedbackMessageDiv = document.getElementById('feedbackMessage');
        const rankingTableBody = document.querySelector('#rankingTable tbody');
        const weeklyParticipationTableHead = document.querySelector('#weeklyParticipationTable thead tr'); // Para adicionar as semanas
        const weeklyParticipationTableBody = document.querySelector('#weeklyParticipationTable tbody');
        const activityChartDiv = document.getElementById('activityChart');
        const noRankingData = document.getElementById('noRankingData');
        const noWeeklyData = document.getElementById('noWeeklyData');
        const noChartData = document.getElementById('noChartData');
        const rankingCardsContainer = document.getElementById('rankingCardsContainer'); // Novo container para cards
        const noRankingCardsData = document.getElementById('noRankingCardsData'); // Nova mensagem para cards

        // Refer√™ncias para mensagens de erro
        const nameError = document.getElementById('nameError');
        const initialWeightError = document.getElementById('initialWeightError');
        const finalWeightError = document.getElementById('finalWeightError');
        const targetWeightError = document.getElementById('targetWeightError'); // Nova mensagem de erro para meta de peso

        // Refer√™ncias para o modal de exclus√£o
        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const closeDeleteModalBtn = document.getElementById('closeDeleteModalBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const participantNameToDeleteSpan = document.getElementById('participantNameToDelete');
        let participantToDeleteName = null; // Vari√°vel para armazenar o nome do participante a ser exclu√≠do

        // Bot√µes de exportar/importar/resetar
        const exportDataBtn = document.getElementById('exportDataBtn');
        const importDataInput = document.getElementById('importDataInput');
        const importDataBtn = document.getElementById('importDataBtn');
        const resetDataBtn = document.getElementById('resetDataBtn');
        const saveDataBtn = document.getElementById('saveDataBtn'); // Adicionado para desabilitar/habilitar

        /**
         * Fun√ß√£o utilit√°ria para debounce.
         * @param {Function} func A fun√ß√£o a ser debounced.
         * @param {number} delay O atraso em milissegundos.
         * @returns {Function} A fun√ß√£o debounced.
         */
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        /**
         * Lida com o envio do formul√°rio de login.
         * @param {Event} event O evento de envio.
         */
        function handleLogin(event) {
            event.preventDefault();

            const username = usernameInput.value.trim();
            const password = passwordInput.value.trim();

            loginError.classList.add(HIDDEN_CLASS); // Esconde qualquer erro anterior

            if (USERS[username] && USERS[username].password === password) {
                currentUser = username; // Define o usu√°rio logado
                loginScreen.classList.add(HIDDEN_CLASS); // Esconde a tela de login
                console.log("Login bem-sucedido. Chamando checkScreenWidth."); // Log de depura√ß√£o
                checkScreenWidth(); // Verifica a largura da tela para mostrar o dashboard correto
            } else {
                loginError.classList.remove(HIDDEN_CLASS); // Mostra mensagem de erro
                console.log("Falha no login."); // Log de depura√ß√£o
            }
        }

        /**
         * Alterna a visibilidade entre o dashboard mobile e a planilha completa.
         * @param {boolean} showMobile If true, shows the mobile dashboard; if false, shows the full spreadsheet.
         */
        function toggleView(showMobile) {
            if (showMobile) {
                // Se j√° estiver na view mobile, n√£o faz nada para evitar re-render desnecess√°rio
                if (currentViewIsMobile && mobileDashboard.classList.contains(SHOW_CLASS)) return;

                mobileDashboard.classList.remove(HIDDEN_CLASS);
                mainContent.classList.add(HIDDEN_CLASS);
                backToMobileRankingBtn.classList.add(HIDDEN_CLASS); // Oculta em mobile dashboard
                console.log("Exibindo dashboard mobile."); // Log de depura√ß√£o
                renderMobileDashboard(); // Atualiza o conte√∫do do dashboard mobile
                currentViewIsMobile = true;
            } else {
                // Se j√° estiver na view completa, n√£o faz nada para evitar re-render desnecess√°rio
                if (!currentViewIsMobile && mainContent.classList.contains(SHOW_CLASS)) return;

                mobileDashboard.classList.add(HIDDEN_CLASS);
                mainContent.classList.remove(HIDDEN_CLASS);
                
                // Mostra o bot√£o "Voltar ao Ranking Mobile" apenas em mobile
                if (window.innerWidth < 768) {
                    backToMobileRankingBtn.classList.remove(HIDDEN_CLASS);
                } else {
                    backToMobileRankingBtn.classList.add(HIDDEN_CLASS); // Oculta em desktop
                }
                console.log("Exibindo planilha completa."); // Log de depura√ß√£o
                updatePlanilha(); // Garante que a planilha completa esteja atualizada
                currentViewIsMobile = false;
            }
        }

        /**
         * Verifica a largura da tela e alterna a visualiza√ß√£o apropriada.
         */
        function checkScreenWidth() {
            // Se o usu√°rio estiver logado, gerencia a exibi√ß√£o
            if (currentUser) {
                if (window.innerWidth < 768) { // Exemplo: 768px para mobile (md breakpoint do Tailwind)
                    toggleView(true); // Mostra o dashboard mobile
                } else {
                    toggleView(false); // Mostra a planilha completa
                }
            }
        }

        /**
         * Aplica as permiss√µes do usu√°rio logado, desabilitando elementos conforme necess√°rio.
         */
        function applyPermissions() {
            const canEdit = USERS[currentUser] ? USERS[currentUser].canEdit : false;
            console.log("Aplicando permiss√µes. Pode editar:", canEdit); // Log de depura√ß√£o

            // Desabilita bot√µes de a√ß√£o no mainContent
            const mainActionButtons = [addParticipantBtn, exportDataBtn, importDataBtn, resetDataBtn, saveDataBtn];
            mainActionButtons.forEach(btn => {
                if (!canEdit) {
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    btn.setAttribute('disabled', 'true');
                } else {
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    btn.removeAttribute('disabled');
                }
            });

            // Ajusta visibilidade do bot√£o 'Adicionar Participante'
            if (!canEdit) {
                addParticipantBtn.classList.add(HIDDEN_CLASS);
            } else {
                addParticipantBtn.classList.remove(HIDDEN_CLASS);
            }

            // Desabilita/habilita edi√ß√£o na tabela de ranking e cards (links e bot√µes)
            const editableElements = document.querySelectorAll(
                '#rankingTable .edit-participant, #rankingTable .edit-participant-icon, #rankingTable .delete-participant-icon, ' +
                '#rankingCardsContainer .edit-participant-icon, #rankingCardsContainer .delete-participant-icon, ' +
                '#mobileRankingList .view-details-btn' // Adicionado para desabilitar o bot√£o de detalhes se n√£o puder editar
            );
            editableElements.forEach(element => {
                if (canEdit) {
                    element.classList.remove('opacity-50', 'cursor-not-allowed', 'pointer-events-none');
                    element.removeAttribute('disabled');
                } else {
                    element.classList.add('opacity-50', 'cursor-not-allowed', 'pointer-events-none');
                    element.setAttribute('disabled', 'true');
                }
            });

            // Desabilita/habilita checkboxes na tabela de participa√ß√£o semanal
            const weeklyCheckboxes = document.querySelectorAll('#weeklyParticipationTable input[type="checkbox"]');
            weeklyCheckboxes.forEach(checkbox => {
                checkbox.disabled = !canEdit;
            });

            // Desabilita/habilita inputs no modal de participante
            participantNameInput.disabled = !canEdit;
            participantInitialWeightInput.disabled = !canEdit;
            participantFinalWeightInput.disabled = !canEdit;
            participantTargetWeightInput.disabled = !canEdit; // Desabilita o novo input de meta de peso
        }


        /**
         * Salva os dados dos participantes no localStorage.
         */
        function saveData() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(participants));
                showFeedbackMessage("Dados salvos com sucesso!");
                console.log("Dados salvos no localStorage."); // Log de depura√ß√£o
            } catch (e) {
                console.error("Erro ao salvar dados no localStorage:", e);
                showFeedbackMessage("Erro ao salvar dados!", true); // Exibe mensagem de erro
            }
        }

        /**
         * Exibe uma mensagem de feedback tempor√°ria.
         * @param {string} message A mensagem a ser exibida.
         * @param {boolean} isError Se a mensagem √© de erro (opcional, padr√£o: false).
         */
        function showFeedbackMessage(message, isError = false) {
            feedbackMessageDiv.textContent = message;
            feedbackMessageDiv.classList.remove('bg-green-500', 'bg-red-500', 'error'); // Limpa classes anteriores
            feedbackMessageDiv.classList.add(isError ? 'bg-red-500' : 'bg-green-500'); // Adiciona cor correta
            if (isError) {
                feedbackMessageDiv.classList.add('error'); // Adiciona classe 'error' para estilos espec√≠ficos de erro
            }
            feedbackMessageDiv.classList.add(SHOW_CLASS);
            setTimeout(() => {
                feedbackMessageDiv.classList.remove(SHOW_CLASS);
                feedbackMessageDiv.classList.remove('error'); // Remove a classe 'error' ap√≥s a transi√ß√£o
            }, 3000); // Mensagem desaparece ap√≥s 3 segundos
        }

        /**
         * Exibe uma mensagem de erro para um input espec√≠fico.
         * @param {HTMLElement} inputElement O elemento input.
         * @param {HTMLElement} errorElement O elemento onde a mensagem de erro ser√° exibida.
         * @param {string} message A mensagem de erro.
         */
        function displayError(inputElement, errorElement, message) {
            errorElement.textContent = message;
            errorElement.classList.remove(HIDDEN_CLASS);
            inputElement.classList.add(INPUT_ERROR_CLASS);
        }

        /**
         * Esconde a mensagem de erro para um input espec√≠fico.
         * @param {HTMLElement} inputElement O elemento input.
         * @param {HTMLElement} errorElement O elemento onde a mensagem de erro √© exibida.
         */
        function hideError(inputElement, errorElement) {
            errorElement.classList.add(HIDDEN_CLASS);
            inputElement.classList.remove(INPUT_ERROR_CLASS);
        }

        /**
         * Limpa todas as mensagens de erro e estilos de erro dos inputs.
         */
        function clearErrorMessages() {
            hideError(participantNameInput, nameError);
            hideError(participantInitialWeightInput, initialWeightError);
            hideError(participantFinalWeightInput, finalWeightError);
            hideError(participantTargetWeightInput, targetWeightError); // Limpa erro da meta de peso
        }

        /**
         * Abre o modal para adicionar ou editar um participante.
         * @param {number|null} index O √≠ndice do participante a ser editado, ou null para adicionar.
         */
        function openModal(index = null) {
            // Limpa os campos e mensagens de erro
            participantForm.reset();
            clearErrorMessages();

            if (index !== null) {
                // Modo de edi√ß√£o
                modalTitle.textContent = 'Editar Participante';
                const p = participants[index];
                participantIndexInput.value = index;
                participantNameInput.value = p.name;
                participantInitialWeightInput.value = p.pesoInicial;
                participantFinalWeightInput.value = p.pesoFinal;
                participantTargetWeightInput.value = p.targetWeight !== null ? p.targetWeight : ''; // Preenche meta de peso
            } else {
                // Modo de adi√ß√£o
                modalTitle.textContent = 'Adicionar Novo Participante';
                participantIndexInput.value = ''; // Limpa o √≠ndice para indicar nova adi√ß√£o
                participantTargetWeightInput.value = ''; // Garante que a meta de peso esteja vazia para novos
            }
            participantModal.classList.add(SHOW_CLASS); // Adiciona a classe 'show' para exibir e aplicar transi√ß√£o
            applyPermissions(); // Reaplicar permiss√µes para os inputs do modal
        }

        /**
         * Fecha o modal.
         */
        function closeModal() {
            participantModal.classList.remove(SHOW_CLASS); // Remove a classe 'show' para esconder e aplicar transi√ß√£o
        }

        /**
         * Abre o modal de confirma√ß√£o de exclus√£o.
         * @param {string} name O nome do participante a ser exclu√≠do.
         */
        function openDeleteModal(name) {
            participantNameToDeleteSpan.textContent = name;
            participantToDeleteName = name; // Armazena o nome para uso na exclus√£o
            deleteConfirmModal.classList.add(SHOW_CLASS);
        }

        /**
         * Fecha o modal de confirma√ß√£o de exclus√£o.
         */
        function closeDeleteModal() {
            deleteConfirmModal.classList.remove(SHOW_CLASS);
            participantToDeleteName = null; // Limpa o nome armazenado
        }

        /**
         * Lida com a exclus√£o de um participante.
         */
        function deleteParticipant() {
            if (participantToDeleteName) {
                const indexToDelete = participants.findIndex(p => p.name === participantToDeleteName);
                if (indexToDelete !== -1) {
                    participants.splice(indexToDelete, 1); // Remove o participante do array
                    saveData(); // Salva os dados atualizados
                    updatePlanilha(); // Atualiza a UI da planilha completa
                    renderMobileDashboard(); // Atualiza a UI do dashboard mobile
                    showFeedbackMessage(`Participante "${participantToDeleteName}" exclu√≠do com sucesso!`);
                } else {
                    showFeedbackMessage(`Erro: Participante "${participantToDeleteName}" n√£o encontrado.`, true);
                }
            }
            closeDeleteModal(); // Fecha o modal de confirma√ß√£o
        }

        /**
         * Valida os campos do formul√°rio do modal.
         * @returns {boolean} True se os campos s√£o v√°lidos, false caso contr√°rio.
         */
        function validateForm() {
            clearErrorMessages();
            let isValid = true;

            const name = participantNameInput.value.trim();
            const initialWeight = parseFloat(participantInitialWeightInput.value);
            const finalWeight = parseFloat(participantFinalWeightInput.value);
            const targetWeight = participantTargetWeightInput.value.trim() === '' ? null : parseFloat(participantTargetWeightInput.value); // Meta de peso pode ser nula

            const index = participantIndexInput.value;

            if (name === '') {
                displayError(participantNameInput, nameError, "O nome √© obrigat√≥rio.");
                isValid = false;
            } else {
                // Valida√ß√£o de nome duplicado
                const isEditing = index !== '';
                const isNameTaken = participants.some((p, i) =>
                    p.name.toLowerCase() === name.toLowerCase() && (!isEditing || i !== parseInt(index))
                );
                if (isNameTaken) {
                    displayError(participantNameInput, nameError, "J√° existe um participante com este nome.");
                    isValid = false;
                }
            }

            if (isNaN(initialWeight) || initialWeight <= 0) {
                displayError(participantInitialWeightInput, initialWeightError, "Peso inicial deve ser um n√∫mero positivo.");
                isValid = false;
            }

            if (isNaN(finalWeight) || finalWeight <= 0) {
                displayError(participantFinalWeightInput, finalWeightError, "Peso final deve ser um n√∫mero positivo.");
                isValid = false;
            }

            if (targetWeight !== null && (isNaN(targetWeight) || targetWeight <= 0)) {
                displayError(participantTargetWeightInput, targetWeightError, "Meta de peso deve ser um n√∫mero positivo ou vazio.");
                isValid = false;
            }

            return isValid;
        }

        /**
         * Lida com o envio do formul√°rio do modal (adicionar/editar participante).
         * @param {Event} event O evento de envio.
         */
        function handleParticipantFormSubmit(event) {
            event.preventDefault(); // Impede o recarregamento da p√°gina

            if (!validateForm()) {
                return; // Se a valida√ß√£o falhar, n√£o prossegue
            }

            const name = participantNameInput.value.trim();
            const initialWeight = parseFloat(participantInitialWeightInput.value);
            const finalWeight = parseFloat(participantFinalWeightInput.value);
            const targetWeight = participantTargetWeightInput.value.trim() === '' ? null : parseFloat(participantTargetWeightInput.value);
            const index = participantIndexInput.value;

            if (index !== '') {
                // Edi√ß√£o de participante existente
                const existingParticipant = participants[parseInt(index)];
                existingParticipant.name = name;
                existingParticipant.pesoInicial = initialWeight;
                existingParticipant.pesoFinal = finalWeight;
                existingParticipant.targetWeight = targetWeight;
            } else {
                // Adi√ß√£o de novo participante
                const newParticipant = {
                    name: name,
                    pesoInicial: initialWeight,
                    pesoFinal: finalWeight,
                    targetWeight: targetWeight,
                    semanasValidas: Array(MAX_WEEKS).fill(false) // Novas semanas vazias
                };
                participants.push(newParticipant);
            }

            saveData(); // Salva os dados no localStorage
            updatePlanilha(); // Recalcula e atualiza a UI da planilha completa
            renderMobileDashboard(); // Recalcula e atualiza a UI do dashboard mobile
            closeModal(); // Fecha o modal
        }

        /**
         * Calcula a pontua√ß√£o de peso com base na porcentagem de perda.
         * @param {number} initialWeight Peso inicial do participante.
         * @param {number} finalWeight Peso final do participante.
         * @returns {object} Um objeto contendo a porcentagem de perda e os pontos de peso.
         */
        function calculateWeightLossPoints(initialWeight, finalWeight) {
            const pesoPerdido = initialWeight - finalWeight;
            let percentLoss = (pesoPerdido / initialWeight) * 100;

            if (isNaN(percentLoss) || percentLoss < 0) {
                percentLoss = 0; // Se ganhou peso ou c√°lculo inv√°lido, % perda √© 0
            }

            let points = 0;
            if (percentLoss >= 10) {
                points = 50;
            } else if (percentLoss >= 8) {
                points = 45;
            } else if (percentLoss >= 6) {
                points = 40;
            } else if (percentLoss >= 4) {
                points = 35;
            } else if (percentLoss >= 2) {
                points = 30;
            } else if (percentLoss >= 1) {
                points = 20;
            } else if (percentLoss > 0 && percentLoss < 1) {
                points = 10;
            } else {
                points = 0;
            }

            return { percentLoss: percentLoss, points: points };
        }

        /**
         * Calcula a pontua√ß√£o de atividade com base no n√∫mero de semanas v√°lidas.
         * @param {number} validWeeks N√∫mero de semanas em que o participante fez 3+ treinos.
         * @returns {number} Pontos de atividade.
         */
        function calculateActivityPoints(validWeeks) {
            return (validWeeks / MAX_WEEKS) * MAX_ACTIVITY_POINTS;
        }

        /**
         * Calcula todas as m√©tricas para um participante.
         * @param {object} participant O objeto participante.
         * @returns {object} O objeto participante com m√©tricas calculadas.
         */
        function calculateParticipantMetrics(participant) {
            const { percentLoss, points: weightPoints } = calculateWeightLossPoints(participant.pesoInicial, participant.pesoFinal);
            const validWeeksCount = participant.semanasValidas.filter(s => s).length; // Conta as semanas marcadas como true
            const activityPoints = calculateActivityPoints(validWeeksCount);
            const totalPoints = weightPoints + activityPoints;
            const percentActivities = (activityPoints / MAX_ACTIVITY_POINTS) * 100;

            let progressToTarget = null;
            if (participant.targetWeight !== null && participant.pesoInicial !== null && participant.pesoInicial > participant.targetWeight) {
                // Calcula o quanto do caminho at√© a meta foi percorrido
                const totalReductionNeeded = participant.pesoInicial - participant.targetWeight;
                const currentReduction = participant.pesoInicial - participant.pesoFinal;
                progressToTarget = (currentReduction / totalReductionNeeded) * 100;
                if (progressToTarget < 0) progressToTarget = 0; // Se ganhou peso
                if (progressToTarget > 100) progressToTarget = 100; // Se passou da meta
            }

            return {
                ...participant, // Retorna todas as propriedades originais
                percentLoss: parseFloat(percentLoss.toFixed(2)),
                weightPoints: parseFloat(weightPoints.toFixed(2)),
                validWeeksCount: validWeeksCount,
                activityPoints: parseFloat(activityPoints.toFixed(2)),
                totalPoints: parseFloat(totalPoints.toFixed(2)),
                percentActivities: parseFloat(percentActivities.toFixed(1)),
                progressToTarget: progressToTarget !== null ? parseFloat(progressToTarget.toFixed(1)) : null
            };
        }

        /**
         * Atualiza as tabelas e o gr√°fico da planilha com os dados dos participantes (visualiza√ß√£o completa).
         */
        function updatePlanilha() {
            console.log("Atualizando planilha completa..."); // Log de depura√ß√£o
            rankingTableBody.innerHTML = ''; // Limpa as linhas existentes da tabela
            rankingCardsContainer.innerHTML = ''; // Limpa os cards existentes (mantidos ocultos)
            weeklyParticipationTableBody.innerHTML = '';
            activityChartDiv.innerHTML = '';

            // Filtrar participantes com base na busca
            const searchTerm = searchParticipantInput.value.toLowerCase().trim();
            const filteredParticipants = participants.filter(p =>
                p.name.toLowerCase().includes(searchTerm)
            );

            // Calcular todos os dados para cada participante filtrado
            const calculatedParticipants = filteredParticipants.map(calculateParticipantMetrics);

            // Ordenar participantes por pontua√ß√£o total para o ranking
            const rankedParticipants = [...calculatedParticipants].sort((a, b) => b.totalPoints - a.totalPoints);
            console.log("Participantes ranqueados para planilha completa:", rankedParticipants); // Log de depura√ß√£o

            // Preencher a tabela de Ranking (para telas maiores)
            if (rankedParticipants.length === 0) {
                noRankingData.classList.remove(HIDDEN_CLASS); // Mensagem para a tabela
                noWeeklyData.classList.remove(HIDDEN_CLASS); // Mensagem para tabela semanal
                noChartData.classList.remove(HIDDEN_CLASS); // Mensagem para o gr√°fico
            } else {
                noRankingData.classList.add(HIDDEN_CLASS);
                noWeeklyData.classList.add(HIDDEN_CLASS);
                noChartData.classList.add(HIDDEN_CLASS);

                rankedParticipants.forEach((p, index) => {
                    let crownEmoji = '';
                    if (index === 0) {
                        crownEmoji = 'üëë'; // Ouro
                    } else if (index === 1) {
                        crownEmoji = '&#129352;'; // Prata - CORRIGIDO PARA ENTIDADE HTML
                    } else if (index === 2) {
                        crownEmoji = 'ü•â'; // Bronze
                    }

                    const targetWeightDisplay = p.targetWeight !== null ? `${p.targetWeight.toFixed(1)} kg` : 'N/A';
                    const progressToTargetDisplay = p.progressToTarget !== null ? `(${p.progressToTarget}% da meta)` : '';

                    // Preencher a tabela de Ranking (para telas maiores)
                    const row = rankingTableBody.insertRow();
                    if (index === 0) { // Destaca o l√≠der
                        row.classList.add('leader-row');
                    }
                    row.innerHTML = `
                        <td class="font-semibold">${index + 1} ${crownEmoji}</td>
                        <td><a href="#" class="text-blue-600 hover:underline edit-participant" data-name="${p.name}">${p.name}</a></td>
                        <td>${p.pesoInicial.toFixed(2)}</td>
                        <td>${p.pesoFinal.toFixed(2)}</td>
                        <td>${p.percentLoss.toFixed(2)}%</td>
                        <td>${p.weightPoints.toFixed(2)}</td>
                        <td>${p.validWeeksCount}</td>
                        <td>${p.activityPoints.toFixed(2)}</td>
                        <td class="font-bold">${p.totalPoints.toFixed(2)}</td>
                        <td class="flex items-center space-x-2">
                            <button class="text-blue-500 hover:text-blue-700 edit-participant-icon" data-name="${p.name}" aria-label="Editar participante ${p.name}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                            </button>
                            <button class="text-red-500 hover:text-red-700 delete-participant-icon" data-name="${p.name}" aria-label="Excluir participante ${p.name}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            </button>
                        </td>
                    `;
                });
            }

            // 1. Determine which weeks are "active" (at least one participant completed it)
            const activeWeeksStatus = Array(MAX_WEEKS).fill(false);
            participants.forEach(p => {
                p.semanasValidas.forEach((isValid, weekIndex) => {
                    if (isValid) {
                        activeWeeksStatus[weekIndex] = true;
                    }
                });
            });

            // Calcular a semana atual
            const today = new Date();
            const diffTime = today.getTime() - CHALLENGE_START_DATE.getTime();
            // Adiciona 1 para que a primeira semana seja a semana 1, n√£o a semana 0
            const currentWeek = Math.floor(diffTime / MILLISECONDS_PER_WEEK) + 1;

            // Preencher o cabe√ßalho da tabela de Participa√ß√£o Semanal com as semanas
            let weekHeaders = `<th class="rounded-tl-xl">Nome
                                    <span class="tooltip">
                                        <span class="tooltiptext">Semanas de 1 a 12. Marque a caixa se a semana for v√°lida (3+ treinos).</span>
                                    </span>
                                </th>`;
            for (let i = 1; i <= MAX_WEEKS; i++) {
                const isCurrentWeek = i === currentWeek;
                weekHeaders += `<th class="${isCurrentWeek ? 'current-week' : ''}">${i}</th>`;
            }
            // Adiciona rounded-tr-xl ao √∫ltimo th gerado
            weekHeaders = weekHeaders.replace(/<th class="([^"]*)">12<\/th>/, `<th class="$1 rounded-tr-xl">12</th>`);
            weeklyParticipationTableHead.innerHTML = weekHeaders;


            // Criar uma c√≥pia dos participantes filtrados e ordenar alfabeticamente para a tabela semanal
            const alphabeticalFilteredParticipants = [...filteredParticipants].sort((a, b) => a.name.localeCompare(b.name));

            // Preencher a tabela de Participa√ß√£o Semanal
            if (alphabeticalFilteredParticipants.length === 0) {
                noWeeklyData.classList.remove(HIDDEN_CLASS);
            } else {
                noWeeklyData.classList.add(HIDDEN_CLASS);
                alphabeticalFilteredParticipants.forEach(p => {
                    const row = weeklyParticipationTableBody.insertRow();
                    let weeklyCells = `<td class="font-medium">${p.name}</td>`;
                    p.semanasValidas.forEach((isValid, weekIndex) => {
                        let cellClasses = 'checkbox-cell';
                        // Aplica fundo vermelho se n√£o for v√°lido E algu√©m mais completou esta semana
                        if (!isValid && activeWeeksStatus[weekIndex]) {
                            cellClasses += ' missed-week-cell';
                        }
                        // Adiciona classe para a semana atual
                        if (weekIndex + 1 === currentWeek) {
                            cellClasses += ' current-week-cell';
                        }
                        weeklyCells += `
                            <td class="${cellClasses}">
                                <input type="checkbox" ${isValid ? 'checked' : ''} data-name="${p.name}" data-week="${weekIndex}">
                            </td>
                        `;
                    });
                    row.innerHTML = weeklyCells;
                });
            }

            // Ordenar participantes para o gr√°fico de atividades por percentual (do maior para o menor)
            const chartSortedParticipants = [...calculatedParticipants].sort((a, b) => b.percentActivities - a.percentActivities);

            // Preencher o gr√°fico de Participa√ß√£o nas Atividades
            if (chartSortedParticipants.length === 0) {
                noChartData.classList.remove(HIDDEN_CLASS);
            } else {
                noChartData.classList.add(HIDDEN_CLASS);
                chartSortedParticipants.forEach(p => {
                    const chartItem = document.createElement('div');
                    // Adjusted classes for closer spacing and centered content
                    chartItem.className = 'flex flex-col items-center justify-center text-center';
                    chartItem.innerHTML = `
                        <div class="relative w-16 h-16 mb-1"> <!-- Increased container size for larger SVG -->
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <defs>
                                    <clipPath id="fillClip-${p.name.replace(/\s/g, '')}">
                                        <!-- The person's total height in the viewBox is from y=2 (top of head) to y=22 (bottom of feet), so 20 units. -->
                                        <!-- The fill should start from the bottom (y=22) and go upwards. -->
                                        <rect x="0"
                                            y="${22 - (20 * (p.percentActivities / 100))}"
                                            width="24"
                                            height="${20 * (p.percentActivities / 100)}"></rect>
                                    </clipPath>
                                </defs>

                                <!-- Base (empty) person - light gray -->
                                <circle cx="12" cy="5" r="3" fill="#d1d5db"/> <!-- Head -->
                                <rect x="10" y="8" width="4" height="8" fill="#d1d5db"/> <!-- Torso -->
                                <rect x="6" y="9" width="4" height="2" fill="#d1d5db"/> <!-- Left Arm -->
                                <rect x="14" y="9" width="4" height="2" fill="#d1d5db"/> <!-- Right Arm -->
                                <rect x="9" y="16" width="2" height="6" fill="#d1d5db"/> <!-- Left Leg -->
                                <rect x="13" y="16" width="2" height="6" fill="#d1d3db"/> <!-- Right Leg -->

                                <!-- Filled person - green, clipped by the dynamic rectangle -->
                                <g clip-path="url(#fillClip-${p.name.replace(/\s/g, '')})">
                                    <circle cx="12" cy="5" r="3" fill="#34d399" class="activity-fill"/> <!-- Head -->
                                    <rect x="10" y="8" width="4" height="8" fill="#34d399" class="activity-fill"/> <!-- Torso -->
                                    <rect x="6" y="9" width="4" height="2" fill="#34d399" class="activity-fill"/> <!-- Left Arm -->
                                    <rect x="14" y="9" width="4" height="2" fill="#34d399" class="activity-fill"/> <!-- Right Arm -->
                                    <rect x="9" y="16" width="2" height="6" fill="#34d399" class="activity-fill"/> <!-- Left Leg -->
                                    <rect x="13" y="16" width="2" height="6" fill="#34d399" class="activity-fill"/> <!-- Right Leg -->
                                </g>
                            </svg>
                        </div>
                        <div class="text-center text-sm font-medium leading-tight">${p.name} - <span class="font-bold">${p.percentActivities.toFixed(1)}%</span></div>
                    `;
                    activityChartDiv.appendChild(chartItem);
                });
            }

            // Atualizar os boxes de l√≠der e dias restantes
            updateSummaryBoxes(rankedParticipants);

            // Aplicar permiss√µes ap√≥s a renderiza√ß√£o dos elementos
            applyPermissions();
        }

        /**
         * Renderiza o dashboard mobile simplificado.
         */
        function renderMobileDashboard() {
            console.log("Renderizando dashboard mobile..."); // Log de depura√ß√£o
            mobileRankingList.innerHTML = ''; // Limpa a lista existente
            mobileLeaderName.textContent = 'Carregando...'; // Reset leader info
            mobileLeaderPoints.textContent = 'Carregando...';

            // Garante que o array de participantes n√£o esteja vazio antes de prosseguir
            if (participants.length === 0) {
                mobileRankingList.innerHTML = '<p class="text-center text-gray-500">Nenhum participante para exibir.</p>';
                mobileLeaderName.textContent = 'N/A';
                mobileLeaderPoints.textContent = '0.00';
                console.log("Nenhum participante para exibir no dashboard mobile."); // Log de depura√ß√£o
                return; // Sai se n√£o houver participantes
            }

            const searchTerm = searchParticipantInput.value.toLowerCase().trim();
            const filteredParticipants = participants.filter(p =>
                p.name.toLowerCase().includes(searchTerm)
            ).map(calculateParticipantMetrics); // Calcula as m√©tricas

            const rankedParticipants = [...filteredParticipants].sort((a, b) => b.totalPoints - a.totalPoints);
            console.log("Participantes ranqueados para dashboard mobile:", rankedParticipants); // Log de depura√ß√£o

            // Atualiza o card de destaque do l√≠der
            if (rankedParticipants.length > 0) {
                const leader = rankedParticipants[0];
                mobileLeaderName.textContent = leader.name;
                mobileLeaderPoints.textContent = leader.totalPoints.toFixed(2);
            } else {
                mobileLeaderName.textContent = 'N/A';
                mobileLeaderPoints.textContent = '0.00';
            }

            // Preenche a lista de ranking mobile
            if (rankedParticipants.length === 0) {
                mobileRankingList.innerHTML = '<p class="text-center text-gray-500">Nenhum participante encontrado.</p>';
            } else {
                rankedParticipants.forEach((p, index) => {
                    let crownEmoji = '';
                    if (index === 0) crownEmoji = 'üëë';
                    else if (index === 1) crownEmoji = '&#129352;'; // Prata - CORRIGIDO PARA ENTIDADE HTML
                    else if (index === 2) crownEmoji = 'ü•â';

                    const listItem = document.createElement('div');
                    listItem.className = `bg-white p-3 rounded-md shadow-sm border border-gray-200 flex justify-between items-center ${index === 0 ? 'bg-yellow-50 border-orange-300' : ''}`;
                    listItem.innerHTML = `
                        <div>
                            <span class="font-bold text-gray-800">${index + 1}. ${p.name} ${crownEmoji}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-lg font-bold text-blue-700">${p.totalPoints.toFixed(2)} pts</span>
                            <button class="text-blue-500 hover:text-blue-700 view-details-btn" data-name="${p.name}" aria-label="Ver detalhes de ${p.name}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 11V3H7v8"></path><path d="M12 21h9"></path><path d="M7 3h14v18H7z"></path></svg>
                            </button>
                        </div>
                    `;
                    mobileRankingList.appendChild(listItem);
                });

                // Adiciona listener para os bot√µes "Ver Detalhes"
                mobileRankingList.querySelectorAll('.view-details-btn').forEach(button => {
                    button.addEventListener('click', (event) => {
                        const participantName = event.currentTarget.dataset.name;
                        searchParticipantInput.value = participantName; // Preenche o campo de busca
                        toggleView(false); // Alterna para a visualiza√ß√£o completa
                        // Esconde o dropdown do menu mobile se estiver aberto
                        mobileMenuDropdown.classList.remove('open');
                    });
                });
            }

            applyPermissions(); // Reaplica as permiss√µes, caso existam bot√µes aqui
        }


        /**
         * Lida com a mudan√ßa nos checkboxes de semanas v√°lidas.
         * @param {Event} event O evento de mudan√ßa.
         */
        function handleCheckboxChange(event) {
            const name = event.target.dataset.name;
            const weekIndex = parseInt(event.target.dataset.week);
            const isChecked = event.target.checked;

            const participant = participants.find(p => p.name === name);
            if (participant) {
                participant.semanasValidas[weekIndex] = isChecked;
                saveData(); // Salva os dados
                updatePlanilha(); // Recalcula e atualiza a UI da planilha completa
                renderMobileDashboard(); // Recalcula e atualiza a UI do dashboard mobile
            }
        }

        /**
         * Atualiza os boxes de l√≠der atual e dias restantes.
         * @param {Array} rankedParticipants O array de participantes j√° ordenado por pontua√ß√£o.
         * @returns {void}
         */
        function updateSummaryBoxes(rankedParticipants) {
            const leaderBox = document.getElementById('leaderBox');
            const daysRemainingBox = document.getElementById('daysRemainingBox');

            // L√≠der Atual: Pega o primeiro participante do array j√° ordenado por pontua√ß√£o
            const currentLeader = rankedParticipants[0];
            if (currentLeader) {
                leaderBox.innerHTML = `
                    <div class="text-xl font-bold text-gray-800 mb-2">üëë L√≠der: <span class="text-green-700">${currentLeader.name}</span></div>
                    <div class="text-lg text-gray-700">Total: <span class="font-bold">${currentLeader.totalPoints.toFixed(2)} pts</span></div>
                    <div class="text-sm text-gray-600">
                        (Peso: ${currentLeader.weightPoints.toFixed(2)} pts | Atividade: ${currentLeader.activityPoints.toFixed(2)} pts)
                    </div>
                `;
            } else {
                leaderBox.innerHTML = `L√≠der Atual: N/A`;
            }

            // Datas do desafio
            const today = new Date();
            const startDate = CHALLENGE_START_DATE;
            const endDate = CHALLENGE_END_DATE;

            // Calcula dias restantes
            let daysRemaining = Math.ceil((endDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
            if (daysRemaining < 0) daysRemaining = 0; // Se o desafio j√° terminou

            // Formata as datas de in√≠cio e fim
            const startDateFormatted = startDate.toLocaleDateString('pt-BR');
            const endDateFormatted = endDate.toLocaleDateString('pt-BR');

            let countdownMessage = '';
            let countdownColorClass = '';

            if (daysRemaining > 0) {
                countdownMessage = `Faltam <span class="days-value">${daysRemaining}</span> dias para o final do desafio!`;
                countdownColorClass = 'text-blue-600'; // Azul para dias restantes
            } else if (daysRemaining === 0) {
                countdownMessage = `O desafio termina <span class="font-bold">hoje!</span>`;
                countdownColorClass = 'text-yellow-600'; // Amarelo para hoje
            } else {
                countdownMessage = `O desafio <span class="font-bold">j√° terminou!</span>`;
                countdownColorClass = 'text-red-600'; // Vermelho para terminado
            }

            daysRemainingBox.innerHTML = `
                <div class="flex justify-around mb-2 text-gray-700">
                    <div>
                        <span class="date-label">üèÅ In√≠cio:</span> <span class="date-value">${startDateFormatted}</span>
                    </div>
                    <div>
                        <span class="date-label">üèÜ Fim:</span> <span class="date-value">${endDateFormatted}</span>
                    </div>
                </div>
                <div class="countdown-message ${countdownColorClass}">
                    ${countdownMessage}
                </div>
            `;
        }

        /**
         * Exibe a se√ß√£o de conte√∫do especificada e oculta as outras.
         * Atualiza o estado ativo dos itens do menu.
         * @param {string} sectionId O ID da se√ß√£o a ser exibida (ex: 'ranking', 'weekly', 'activity').
         */
        function showSection(sectionId) {
            contentSections.forEach(section => {
                if (section.id === `section${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}`) {
                    section.classList.remove(HIDDEN_CLASS);
                } else {
                    section.classList.add(HIDDEN_CLASS);
                }
            });

            // Atualiza a classe 'active' nos itens do menu de abas
            mainNavTabs.querySelectorAll('.nav-tab-item').forEach(item => {
                if (item.dataset.section === sectionId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });

            // Atualiza a classe 'active' nos itens do menu dropdown mobile
            mobileMenuDropdown.querySelectorAll('.nav-tab-item').forEach(item => {
                if (item.dataset.section === sectionId) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
            console.log(`Exibindo se√ß√£o: ${sectionId}`);
        }

        // Inicializa a planilha ao carregar a p√°gina
        window.onload = () => {
            // Esconde o conte√∫do principal e o dashboard mobile por padr√£o
            // As classes Tailwind no HTML j√° devem cuidar da visibilidade inicial,
            // mas mantemos hidden aqui para garantir que o JS controle ap√≥s o login.
            mainContent.classList.add(HIDDEN_CLASS);
            mobileDashboard.classList.add(HIDDEN_CLASS);

            // Listener para o formul√°rio de login
            loginForm.addEventListener('submit', handleLogin);

            // Adiciona listener para o bot√£o de salvar
            document.getElementById('saveDataBtn').addEventListener('click', saveData);

            // Listeners para o modal de adicionar/editar
            addParticipantBtn.addEventListener('click', () => openModal());
            closeModalBtn.addEventListener('click', closeModal);
            cancelModalBtn.addEventListener('click', closeModal);
            participantModal.addEventListener('click', (e) => {
                if (e.target === participantModal) {
                    closeModal(); // Fecha o modal se clicar fora do conte√∫do
                }
            });
            participantForm.addEventListener('submit', handleParticipantFormSubmit);

            // Listeners para o modal de exclus√£o
            closeDeleteModalBtn.addEventListener('click', closeDeleteModal);
            cancelDeleteBtn.addEventListener('click', closeDeleteModal);
            confirmDeleteBtn.addEventListener('click', deleteParticipant);
            deleteConfirmModal.addEventListener('click', (e) => {
                if (e.target === deleteConfirmModal) {
                    closeDeleteModal(); // Fecha o modal se clicar fora do conte√∫do
                }
            });

            // Listener para o campo de busca com debounce
            searchParticipantInput.addEventListener('keyup', debounce(() => {
                // Atualiza apenas a view que est√° ativa no momento da busca
                if (currentViewIsMobile) {
                    renderMobileDashboard();
                } else {
                    updatePlanilha();
                }
            }, 300)); // Debounce de 300ms

            // Event delegation para a tabela de ranking (edi√ß√£o e exclus√£o)
            rankingTableBody.addEventListener('click', function(event) {
                const target = event.target.closest('.edit-participant, .edit-participant-icon, .delete-participant-icon');
                if (!target) return; // Se o clique n√£o foi em um dos bot√µes/links

                // Verifica se o elemento est√° desabilitado pela permiss√£o
                if (target.hasAttribute('disabled')) {
                    showFeedbackMessage("Voc√™ n√£o tem permiss√£o para realizar esta a√ß√£o.", true);
                    return;
                }

                event.preventDefault(); // Evita o comportamento padr√£o do link/bot√£o

                const participantName = target.dataset.name;

                if (target.classList.contains('edit-participant') || target.classList.contains('edit-participant-icon')) {
                    const indexToEdit = participants.findIndex(p => p.name === participantName);
                    if (indexToEdit !== -1) {
                        openModal(indexToEdit);
                    }
                } else if (target.classList.contains('delete-participant-icon')) {
                    openDeleteModal(participantName);
                }
            });

            // Event delegation para os cards de ranking (edi√ß√£o e exclus√£o) - AGORA OCULTOS POR PADR√ÉO EM MOBILE
            rankingCardsContainer.addEventListener('click', function(event) {
                const target = event.target.closest('.edit-participant-icon, .delete-participant-icon');
                if (!target) return;

                if (target.hasAttribute('disabled')) {
                    showFeedbackMessage("Voc√™ n√£o tem permiss√£o para realizar esta a√ß√£o.", true);
                    return;
                }

                event.preventDefault();

                const participantName = target.dataset.name;
                if (target.classList.contains('edit-participant-icon')) {
                    const indexToEdit = participants.findIndex(p => p.name === participantName);
                    if (indexToEdit !== -1) {
                        openModal(indexToEdit);
                    }
                } else if (target.classList.contains('delete-participant-icon')) {
                    openDeleteModal(participantName);
                }
            });


            // Event delegation para checkboxes na tabela de participa√ß√£o semanal
            weeklyParticipationTableBody.addEventListener('change', function(event) {
                if (event.target.type === 'checkbox') {
                    // Verifica se o checkbox est√° desabilitado pela permiss√£o
                    if (event.target.disabled) {
                        showFeedbackMessage("Voc√™ n√£o tem permiss√£o para alterar os dados.", true);
                        // Reverte o estado do checkbox se tentar alterar sem permiss√£o
                        event.target.checked = !event.target.checked;
                        return;
                    }
                    handleCheckboxChange(event);
                }
            });

            // Listeners para exportar, importar e resetar dados
            exportDataBtn.addEventListener('click', () => {
                if (exportDataBtn.disabled) {
                    showFeedbackMessage("Voc√™ n√£o tem permiss√£o para exportar dados.", true);
                    return;
                }
                const dataStr = JSON.stringify(participants, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'desafio_fit_data.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showFeedbackMessage("Dados exportados como desafio_fit_data.json!");
            });

            importDataBtn.addEventListener('click', () => {
                if (importDataBtn.disabled) {
                    showFeedbackMessage("Voc√™ n√£o tem permiss√£o para importar dados.", true);
                    return;
                }
                importDataInput.click(); // Simula o clique no input de arquivo
            });

            importDataInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            // Valida√ß√£o b√°sica para garantir que os dados importados s√£o v√°lidos
                            if (Array.isArray(importedData) && importedData.every(p =>
                                typeof p.name === 'string' && p.name.trim() !== '' &&
                                typeof p.pesoInicial === 'number' && p.pesoInicial > 0 &&
                                typeof p.pesoFinal === 'number' && p.pesoFinal > 0 &&
                                (p.targetWeight === null || (typeof p.targetWeight === 'number' && p.targetWeight > 0)) && // Valida meta de peso
                                Array.isArray(p.semanasValidas) && p.semanasValidas.length === MAX_WEEKS &&
                                p.semanasValidas.every(s => typeof s === 'boolean')
                            )) {
                                participants = importedData;
                                saveData();
                                updatePlanilha(); // Atualiza a planilha completa
                                renderMobileDashboard(); // Atualiza o dashboard mobile
                                showFeedbackMessage("Dados importados com sucesso!");
                            } else {
                                showFeedbackMessage("Formato de arquivo JSON inv√°lido. Verifique a estrutura dos dados.", true);
                            }
                        } catch (error) {
                            console.error("Erro ao ler ou parsear arquivo JSON:", error);
                            showFeedbackMessage("Erro ao importar dados. Verifique o arquivo.", true);
                        }
                    };
                    reader.readAsText(file);
                }
                // Limpa o valor do input de arquivo para permitir a importa√ß√£o do mesmo arquivo novamente
                event.target.value = '';
            });

            resetDataBtn.addEventListener('click', () => {
                if (resetDataBtn.disabled) {
                    showFeedbackMessage("Voc√™ n√£o tem permiss√£o para resetar dados.", true);
                    return;
                }
                // Usar um modal de confirma√ß√£o customizado em vez de `confirm()`
                openConfirmResetModal();
            });

            // Fun√ß√µes para o modal de confirma√ß√£o de reset
            function openConfirmResetModal() {
                // Reutilizar o modal de exclus√£o, mas com texto diferente
                participantNameToDeleteSpan.textContent = "todos os dados"; // Altera o texto para o reset
                deleteConfirmModal.querySelector('h3').textContent = "Confirmar Resetar Dados";
                deleteConfirmModal.querySelector('p').innerHTML = "Tem certeza que deseja <span class='font-semibold text-red-600'>resetar todos os dados</span>? Isso ir√° APAGAR tudo e carregar os participantes padr√£o.";
                confirmDeleteBtn.textContent = "Resetar";
                confirmDeleteBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                confirmDeleteBtn.classList.add('bg-orange-500', 'hover:bg-orange-600'); // Cor diferente para reset

                // Adiciona um listener tempor√°rio para a a√ß√£o de reset
                confirmDeleteBtn.onclick = () => {
                    participants = JSON.parse(JSON.stringify(defaultParticipants)); // Deep copy para n√£o referenciar o default
                    saveData();
                    updatePlanilha();
                    renderMobileDashboard();
                    showFeedbackMessage("Dados resetados para o padr√£o com sucesso!");
                    closeDeleteModal();
                    // Restaura os textos e classes originais do modal de exclus√£o
                    restoreDeleteModalDefaults();
                };
                cancelDeleteBtn.onclick = () => {
                    closeDeleteModal();
                    restoreDeleteModalDefaults();
                };

                deleteConfirmModal.classList.add(SHOW_CLASS);
            }

            function restoreDeleteModalDefaults() {
                deleteConfirmModal.querySelector('h3').textContent = "Confirmar Exclus√£o";
                deleteConfirmModal.querySelector('p').innerHTML = "Tem certeza que deseja excluir <span id='participantNameToDelete' class='font-semibold text-red-600'></span> do desafio?";
                confirmDeleteBtn.textContent = "Excluir";
                confirmDeleteBtn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
                confirmDeleteBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                // Restaura os listeners originais
                confirmDeleteBtn.onclick = deleteParticipant;
                cancelDeleteBtn.onclick = closeDeleteModal;
            }

            // Listeners para alternar as visualiza√ß√µes
            viewFullDashboardBtn.addEventListener('click', () => {
                toggleView(false); // Mostra a planilha completa
                showSection('ranking'); // Garante que a se√ß√£o de ranking seja a primeira a ser exibida
            });

            backToMobileRankingBtn.addEventListener('click', () => {
                toggleView(true); // Volta ao ranking mobile
            });

            // Listeners para o novo menu de navega√ß√£o (abas/bot√µes)
            mainNavTabs.querySelectorAll('.nav-tab-item').forEach(item => {
                item.addEventListener('click', (event) => {
                    event.preventDefault();
                    const sectionId = event.target.dataset.section;
                    showSection(sectionId);
                });
            });

            // Listener para o bot√£o de alternar o menu mobile
            mobileMenuToggleButton.addEventListener('click', () => {
                mobileMenuDropdown.classList.toggle('open');
            });

            // Listeners para os itens do menu dropdown mobile
            mobileMenuDropdown.querySelectorAll('.nav-tab-item').forEach(item => {
                item.addEventListener('click', (event) => {
                    event.preventDefault();
                    const sectionId = event.target.dataset.section;
                    showSection(sectionId);
                    mobileMenuDropdown.classList.remove('open'); // Fecha o dropdown ap√≥s a sele√ß√£o
                });
            });

            // Chama a fun√ß√£o de verifica√ß√£o de largura da tela ao carregar a p√°gina
            // para exibir a tela correta (mobile ou desktop) ap√≥s o login.
            // Isso ser√° feito ap√≥s o login, dentro de handleLogin.
        };
    </script>
</body>
</html>