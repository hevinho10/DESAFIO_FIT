<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desafio Fam√≠lia FIT 90 DIAS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <!-- Bibliotecas para exportar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --font-inter: 'Inter', sans-serif;
            --background-light-gray: #f3f4f6;
            --text-dark: #333;
            --container-bg: #ffffff;
            --border-light: #e5e7eb;
            --header-bg-light-blue: #e0f2f7;
            --header-text-dark-blue: #2c5282;
            --input-valid-green: #34d399;
            --input-missed-red: #dc2626;
            --missed-week-bg-red: #fee2e2;
            --leader-row-bg-orange: #ffedd5;
            --leader-row-border-orange: #f97316;
            --feedback-success-bg: #10b981;
            --feedback-error-bg: #ef4444;
            --modal-bg-overlay: rgba(0,0,0,0.4);
            --blue-600: #2563eb;
            --progress-bar-bg: #e5e7eb;
            --progress-bar-fill: #22c55e;
        }
        body { font-family: var(--font-inter); background-color: var(--background-light-gray); color: var(--text-dark); }
        .container { max-width: 1200px; margin: 2rem auto; padding: 1.5rem; background-color: var(--container-bg); border-radius: 1rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); }
        .container-mobile-view { max-width: 600px; margin: 1rem auto; padding: 1rem; background-color: var(--container-bg); border-radius: 1rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); }
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-bottom: 2rem; border-radius: 0.75rem; overflow: hidden; }
        th, td { padding: 0.5rem 0.75rem; text-align: left; border-bottom: 1px solid var(--border-light); vertical-align: middle; }
        th { background-color: var(--header-bg-light-blue); font-weight: 600; color: var(--header-text-dark-blue); position: sticky; top: 0; z-index: 10; white-space: nowrap; }
        #weeklyParticipationTable th, #weeklyParticipationTable td { padding: 0.2rem 0.3rem; white-space: nowrap; }
        #weeklyParticipationTable td:first-child { min-width: 60px; padding-right: 0.1rem; }
        #weeklyParticipationTable th:not(:first-child), #weeklyParticipationTable td:not(:first-child) { text-align: center; }
        #weeklyParticipationTable input[type="number"] { width: 40px; height: 28px; padding: 0.2rem 0.1rem; text-align: center; border-radius: 0.25em; font-size: 0.9em; -moz-appearance: textfield; background-color: white; border: 1px solid var(--input-border-gray); }
        #weeklyParticipationTable input[type="number"]::-webkit-outer-spin-button, #weeklyParticipationTable input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .activity-content { display: flex; justify-content: center; align-items: center; gap: 0.25rem; height: 100%; width: 100%; }
        #weeklyParticipationTable td.valid-week input[type="number"] { background-color: var(--input-valid-green); border-color: var(--input-valid-green); color: white; }
        #weeklyParticipationTable td.valid-week .checkmark-icon { color: white; visibility: visible; opacity: 1; }
        #weeklyParticipationTable td.missed-week input[type="number"] { background-color: var(--missed-week-bg-red); border-color: var(--input-missed-red); color: var(--input-missed-red); }
        #weeklyParticipationTable td.missed-week .checkmark-icon { visibility: hidden; opacity: 0; }
        .checkmark-icon { width: 16px; height: 16px; flex-shrink: 0; visibility: hidden; opacity: 0; transition: opacity 0.2s; }
        tr:last-child td { border-bottom: none; }
        tr:nth-child(even) { background-color: #f9fafb; }
        .summary-box { background-color: var(--container-bg); border: 1px solid var(--border-light); padding: 1.5rem; border-radius: 0.75rem; font-weight: 600; color: var(--text-dark); text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .tooltip { position: relative; display: inline-block; cursor: help; }
        .tooltip .tooltiptext { visibility: hidden; width: 180px; background-color: #555; color: #fff; text-align: center; border-radius: 6px; padding: 5px 0; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -90px; opacity: 0; transition: opacity 0.3s; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .leader-row { background-color: var(--leader-row-bg-orange) !important; border-left: 4px solid var(--leader-row-border-orange); }
        .feedback-message { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--feedback-success-bg); color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); opacity: 0; transition: opacity 0.3s; z-index: 1001; }
        .feedback-message.show { opacity: 1; }
        .feedback-message.error { background-color: var(--feedback-error-bg); }
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: var(--modal-bg-overlay); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s; }
        .modal.show { opacity: 1; visibility: visible; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 2rem; border-radius: 1rem; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 500px; position: relative; transform: scale(0.95); transition: transform 0.3s; }
        .modal.show .modal-content { transform: scale(1); }
        .close-button { position: absolute; top: 10px; right: 20px; color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .input-error { border-color: var(--error-red); }
        .error-message { color: var(--error-red); font-size: 0.875rem; margin-top: 0.25rem; }
        .empty-table-message { text-align: center; padding: 2rem; color: #6b7280; font-style: italic; }
        .current-week { background-color: #dbeafe !important; border-bottom: 2px solid #60a5fa !important; color: #1e40af !important; }
        .current-week-cell { background-color: #eff6ff; }
        .nav-tabs { display: flex; justify-content: center; margin-bottom: 1.5rem; border-bottom: 2px solid var(--border-light); overflow-x: auto; }
        .nav-tab-item { padding: 0.75rem 1.25rem; cursor: pointer; font-weight: 600; color: #6b7280; border-bottom: 2px solid transparent; transition: all 0.2s; white-space: nowrap; }
        .nav-tab-item:hover { color: var(--header-text-dark-blue); }
        .nav-tab-item.active { color: var(--header-text-dark-blue); border-color: var(--blue-600); }
        #weightHistoryChart svg, #details-chart svg, #groupEvolutionChartContainer svg, #comparisonChartContainer svg { display: block; margin: auto; background-color: #fefefe; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); overflow: visible; }
        .axis path, .axis line { fill: none; stroke: #d1d5db; shape-rendering: crispEdges; }
        .axis text { font-size: 0.8rem; fill: #6b7280; }
        .line { fill: none; stroke-width: 2px; }
        .dot { fill: white; stroke-width: 1.5px; }
        .tooltip-chart { position: absolute; text-align: center; padding: 8px; font: 12px sans-serif; background: rgba(0, 0, 0, 0.7); color: white; border-radius: 8px; pointer-events: none; opacity: 0; transition: opacity 0.2s; }
        .progress-bar-container { width: 100%; background-color: var(--progress-bar-bg); border-radius: 9999px; height: 1.25rem; overflow: hidden; position: relative; }
        .progress-bar-fill { height: 100%; background-color: var(--progress-bar-fill); border-radius: 9999px; transition: width 0.5s ease-in-out; display: flex; align-items: center; justify-content: center; }
        .progress-bar-text { color: white; font-size: 0.75rem; font-weight: 600; }
        .badge { font-size: 1.1rem; margin-left: 0.25rem; }
        .mobile-menu-button { display: none; background-color: var(--blue-600); color: white; padding: 0.75rem 1rem; border-radius: 0.5rem; font-weight: 600; width: 100%; text-align: center; margin-bottom: 1rem; }
        .mobile-menu-dropdown { display: none; flex-direction: column; background-color: var(--container-bg); border-radius: 0.5rem; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 1rem; overflow: hidden; }
        .mobile-menu-dropdown.open { display: flex; }
        .mobile-menu-dropdown .nav-tab-item { padding: 1rem; border-bottom: 1px solid var(--border-light); }
        @media (min-width: 768px) { .nav-tabs { display: flex; } .mobile-menu-button, .mobile-menu-dropdown { display: none !important; } }
        @media (max-width: 767px) {
            .nav-tabs { display: none; }
            .mobile-menu-button { display: block; }
            .hide-on-mobile { display: none !important; }
        }
    </style>
</head>
<body class="p-4">

    <!-- Tela de Login -->
    <div id="loginScreen" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-100 via-green-100 to-blue-200 p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <h2 class="text-4xl font-extrabold text-center mb-10 text-gray-800">Acesso ao Desafio FIT</h2>
            <form id="loginForm">
                <div class="mb-4"><input type="text" id="username" placeholder="Usu√°rio" class="shadow-sm appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required></div>
                <div class="mb-6"><input type="password" id="password" placeholder="Senha" class="shadow-sm appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required></div>
                <p id="loginError" class="text-red-500 text-sm italic mb-4 hidden text-center">Usu√°rio ou senha inv√°lidos.</p>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition w-full">Entrar</button>
            </form>
        </div>
    </div>

    <!-- Dashboard Mobile -->
    <div id="mobileDashboard" class="container-mobile-view hidden">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold text-gray-800">Ranking Geral</h1>
            <button id="logoutBtnMobile" class="text-red-500 font-semibold">Sair</button>
        </div>
        <div id="leaderHighlightCard" class="bg-gradient-to-r from-yellow-100 to-orange-100 p-4 rounded-lg shadow-lg border-2 border-orange-300 mb-6 text-center"></div>
        <div id="mobileRankingList" class="space-y-3"></div>
        <button id="viewFullDashboardBtn" class="mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md w-full">Ver Planilha Completa</button>
    </div>

    <!-- Conte√∫do Principal (Desktop) -->
    <div class="container hidden">
        <div class="mb-4 pb-4 border-b">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 text-center mb-4">üí™üçé Desafio Fam√≠lia FIT 90 DIAS! üèÜ</h1>
            <div class="flex justify-between items-center">
                <div id="main-action-buttons" class="flex items-center gap-2 flex-wrap">
                   <button id="addParticipantBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Adicionar</button>
                   <button id="exportDataBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Exportar</button>
                   <input type="file" id="importDataInput" accept=".json" class="hidden">
                   <button id="importDataBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Importar</button>
                   <button id="resetDataBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md">Resetar</button>
                </div>
                <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Sair</button>
            </div>
        </div>

        <button id="mobileMenuToggleButton" class="mobile-menu-button">Menu</button>
        <nav id="mainNavTabs" class="nav-tabs"></nav>
        <div id="mobileMenuDropdown" class="mobile-menu-dropdown"></div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
            <div id="leaderBox" class="summary-box"></div>
            <div id="weeklyHighlightBox" class="summary-box"></div>
            <div id="monthlyHighlightBox" class="summary-box"></div>
            <div id="daysRemainingBox" class="summary-box"></div>
        </div>

        <div class="flex justify-end mb-6">
            <div class="relative w-full sm:w-1/3">
                <input type="text" id="searchParticipantInput" placeholder="Buscar participante..." class="p-2 border rounded-md w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
        </div>

        <!-- Se√ß√µes de Conte√∫do -->
        <div id="sectionRanking" class="content-section"></div>
        <div id="sectionWeekly" class="content-section hidden"></div>
        <div id="sectionActivity" class="content-section hidden"></div>
        <div id="sectionCurrentWeight" class="content-section hidden"></div>
        <div id="sectionWeightHistory" class="content-section hidden"></div>
        <div id="sectionGroupEvolution" class="content-section hidden"></div>
        <div id="sectionComparison" class="content-section hidden"></div>

        <button id="backToMobileRankingBtn" class="mt-6 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hidden md:hidden">Voltar ao Ranking</button>
    </div>

    <!-- Modais e Feedback -->
    <div id="feedbackMessage" class="feedback-message"></div>
    <div id="participantModal" class="modal"></div>
    <div id="deleteConfirmModal" class="modal"></div>
    <div id="participantDetailsModal" class="modal"></div>
    <div id="resetPasswordModal" class="modal"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURA√á√ÉO DO SUPABASE ---
            const SUPABASE_URL = 'https://wkvwrtwovcfnvfgleslq.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndrdndydHdvdmNmbnZmZ2xlc2xxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzNTE2MTQsImV4cCI6MjA2NzkyNzYxNH0.osy_C1SsPJ7t8BJlri7DpVDJU64S_IfRzy9KEBP9VMY';
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            // --- CONFIGURA√á√ïES E CONSTANTES DO DESAFIO ---
            const CHALLENGE_START_DATE = new Date('2025-07-07T00:00:00');
            const CHALLENGE_END_DATE = new Date('2025-10-07T23:59:59');
            const MAX_WEEKS = 12;
            const MIN_ACTIVITIES_FOR_VALID_WEEK = 3;
            const MAX_ACTIVITY_POINTS = 50;
            const NAV_LINKS = [
                { id: 'ranking', text: 'üèÜ Ranking' },
                { id: 'weekly', text: 'üóìÔ∏è Semanas' },
                { id: 'activity', text: 'üìà Atividades' },
                { id: 'currentWeight', text: '‚öñÔ∏è Registrar Peso' },
                { id: 'weightHistory', text: 'üìä Evolu√ß√£o Ind.' },
                { id: 'groupEvolution', text: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Evolu√ß√£o Grupo' },
                { id: 'comparison', text: 'üÜö Comparativo' }
            ];
            
            // ESTADO DA APLICA√á√ÉO
            let currentUser = null;
            let participants = [];
            let currentViewIsMobile = window.innerWidth < 768;

            // ELEMENTOS DO DOM
            const loginScreen = document.getElementById('loginScreen');
            const mainContent = document.querySelector('.container');
            const mobileDashboard = document.getElementById('mobileDashboard');
            const feedbackMessageDiv = document.getElementById('feedbackMessage');
            
            // FUN√á√ïES DE INICIALIZA√á√ÉO E AUTENTICA√á√ÉO
            async function initApp() {
                setupEventListeners();
                const { data: { session } } = await supabase.auth.getSession();
                currentUser = session ? session.user : null;
                checkLoginState();

                supabase.auth.onAuthStateChange((_event, session) => {
                    currentUser = session ? session.user : null;
                    checkLoginState();
                });
            }

            async function loadData() {
                const { data, error } = await supabase.from('participants').select('*').order('name');
                if (error) {
                    console.error('Error loading data:', error);
                    showFeedbackMessage('Erro ao carregar dados do banco.', true);
                } else {
                    participants = data;
                    updateAllViews();
                }
            }

            function checkLoginState() {
                if (currentUser) {
                    loginScreen.classList.add('hidden');
                    mainContent.classList.remove('hidden');
                    loadData(); 
                } else {
                    loginScreen.classList.remove('hidden');
                    mainContent.classList.add('hidden');
                    mobileDashboard.classList.add('hidden');
                }
                applyPermissions();
            }

            async function handleLogin(e) {
                e.preventDefault();
                const username = document.getElementById('username').value.trim().toLowerCase();
                const password = document.getElementById('password').value;
                
                // Converte o nome de usu√°rio para o formato de e-mail esperado pelo Supabase
                const email = `${username}@desafio.fit`;

                const { error } = await supabase.auth.signInWithPassword({ email, password });

                if (error) {
                    document.getElementById('loginError').textContent = 'Usu√°rio ou senha inv√°lidos.';
                    document.getElementById('loginError').classList.remove('hidden');
                    console.error('Login error:', error.message);
                } else {
                    document.getElementById('loginError').classList.add('hidden');
                }
            }

            async function handleLogout() {
                await supabase.auth.signOut();
            }

            // SETUP DE EVENTOS
            function setupEventListeners() {
                document.getElementById('loginForm').addEventListener('submit', handleLogin);
                document.getElementById('logoutBtn').addEventListener('click', handleLogout);
                document.getElementById('logoutBtnMobile').addEventListener('click', handleLogout);
                document.getElementById('viewFullDashboardBtn').addEventListener('click', () => toggleView(false));
                document.getElementById('backToMobileRankingBtn').addEventListener('click', () => toggleView(true));
                document.getElementById('addParticipantBtn').addEventListener('click', () => openModal());
                document.getElementById('exportDataBtn').addEventListener('click', exportData);
                document.getElementById('importDataBtn').addEventListener('click', () => document.getElementById('importDataInput').click());
                document.getElementById('importDataInput').addEventListener('change', importData);
                document.getElementById('resetDataBtn').addEventListener('click', () => openDeleteModal(null, true));
                document.getElementById('searchParticipantInput').addEventListener('keyup', debounce(updateAllViews, 300));
                
                const navContainer = document.getElementById('mainNavTabs');
                const mobileNavContainer = document.getElementById('mobileMenuDropdown');
                navContainer.innerHTML = '';
                mobileNavContainer.innerHTML = '';
                NAV_LINKS.forEach(link => {
                    navContainer.innerHTML += `<a href="#" class="nav-tab-item" data-section="${link.id}">${link.text}</a>`;
                    mobileNavContainer.innerHTML += `<a href="#" class="nav-tab-item" data-section="${link.id}">${link.text}</a>`;
                });

                document.querySelectorAll('.nav-tab-item').forEach(item => {
                    item.addEventListener('click', e => {
                        e.preventDefault();
                        showSection(e.currentTarget.dataset.section);
                        mobileNavContainer.classList.remove('open');
                    });
                });
                
                document.getElementById('mobileMenuToggleButton').addEventListener('click', () => mobileNavContainer.classList.toggle('open'));
                mainContent.addEventListener('click', handleMainContentClick);
                mainContent.addEventListener('input', debounce(e => {
                    if (e.target.matches('.activity-input')) {
                        handleActivityInputChange(e.target);
                    }
                }, 400));
                mainContent.addEventListener('change', e => {
                    if (e.target.matches('.comparison-checkbox')) {
                        updateComparisonChart();
                    }
                });
                
                window.addEventListener('resize', debounce(() => {
                    const isNowMobile = window.innerWidth < 768;
                    if(isNowMobile !== currentViewIsMobile) {
                        currentViewIsMobile = isNowMobile;
                        updateAllViews();
                    }
                }, 200));
            }

            async function handleDeleteWeightEntry(button) {
                const participantName = button.dataset.participantName;
                const entryDateISO = button.dataset.entryDate;
                const participant = participants.find(p => p.name === participantName);

                if (!participant) return;
                
                if (participant.weight_history.length <= 1) {
                    showFeedbackMessage("N√£o √© poss√≠vel excluir o √∫nico registro de peso.", true);
                    return;
                }

                const newHistory = participant.weight_history.filter(entry => entry.date !== entryDateISO);
                newHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                const newCurrentWeight = newHistory.length > 0 ? newHistory[newHistory.length - 1].weight : participant.peso_inicial;

                const { error } = await supabase
                    .from('participants')
                    .update({ weight_history: newHistory, peso_atual: newCurrentWeight })
                    .eq('id', participant.id);

                if (error) {
                    showFeedbackMessage('Erro ao excluir registro de peso.', true);
                    console.error(error);
                } else {
                    showFeedbackMessage("Registro de peso exclu√≠do com sucesso!");
                    loadData();
                }
            }

            function handleMainContentClick(e) {
                const button = e.target.closest('button');
                const link = e.target.closest('a.participant-name-link');

                if (link) {
                    e.preventDefault();
                    const name = link.dataset.name;
                    openDetailsModal(name);
                    return;
                }

                if (!button) return;
                
                const participantId = button.dataset.id;
                if (button.matches('.edit-participant-icon')) {
                    const index = participants.findIndex(p => p.id == participantId);
                    if (index !== -1) openModal(index);
                } else if (button.matches('.delete-participant-icon')) {
                    const name = button.dataset.name;
                    openDeleteModal(participantId, false, name);
                } else if (button.matches('.update-weight-btn')) {
                    handleUpdateWeight(button);
                } else if (button.matches('.delete-weight-entry-btn')) {
                    handleDeleteWeightEntry(button);
                } else if (button.matches('.export-pdf-btn')) {
                    const chartId = button.dataset.chartId;
                    const filename = button.dataset.filename;
                    const title = button.dataset.title;
                    exportChartToPDF(chartId, filename, title);
                }
            }

            async function handleActivityInputChange(input) {
                if (input.disabled) return;
                const participantId = input.dataset.id;
                const weekIndex = parseInt(input.dataset.week);
                let numActivities = parseInt(input.value);
                if (isNaN(numActivities) || numActivities < 0) numActivities = 0;
                
                const participant = participants.find(p => p.id == participantId);
                if (participant) {
                    const newSemanasValidas = [...participant.semanas_validas];
                    newSemanasValidas[weekIndex] = numActivities;

                    const { error } = await supabase
                        .from('participants')
                        .update({ semanas_validas: newSemanasValidas })
                        .eq('id', participantId);

                    if (error) {
                        console.error('Error updating activities:', error);
                    } else {
                        loadData(); // Recarrega para garantir consist√™ncia
                    }
                }
            }

            async function handleUpdateWeight(button) {
                if (button.disabled) return;
                const participantId = button.dataset.id;
                const row = button.closest('tr');
                const weightInput = row.querySelector('input[type="number"]');
                const dateInput = row.querySelector('input[type="date"]');
                const newWeight = parseFloat(weightInput.value);
                const dateValue = dateInput.value;

                if (isNaN(newWeight) || newWeight <= 0) return showFeedbackMessage("Peso inv√°lido.", true);
                if (!dateValue) return showFeedbackMessage("Selecione uma data.", true);
                if (new Date(dateValue) > new Date()) return showFeedbackMessage("N√£o √© poss√≠vel registrar datas futuras.", true);

                const participant = participants.find(p => p.id == participantId);
                if (participant) {
                    const newEntry = { date: new Date(dateValue + 'T00:00:00').toISOString(), weight: newWeight };
                    const newHistory = [...participant.weight_history, newEntry];
                    newHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
                    
                    const { error } = await supabase
                        .from('participants')
                        .update({ peso_atual: newWeight, weight_history: newHistory })
                        .eq('id', participantId);
                    
                    if (error) {
                        showFeedbackMessage('Erro ao atualizar peso.', true);
                        console.error(error);
                    } else {
                        showFeedbackMessage(`Peso de ${participant.name} atualizado!`);
                        loadData();
                    }
                }
            }
            
            // L√ìGICA DE DADOS E C√ÅLCULOS
            function calculateMetrics(p) {
                const pesoPerdido = p.peso_inicial - p.peso_atual;
                const percentLoss = p.peso_inicial > 0 ? (pesoPerdido / p.peso_inicial) * 100 : 0;
                let weightPoints = 0;
                if (percentLoss >= 10) weightPoints = 50;
                else if (percentLoss >= 8) weightPoints = 45;
                else if (percentLoss >= 6) weightPoints = 40;
                else if (percentLoss >= 4) weightPoints = 35;
                else if (percentLoss >= 2) weightPoints = 30;
                else if (percentLoss > 0) weightPoints = 10;
                
                const validWeeksCount = p.semanas_validas.filter(num => num >= MIN_ACTIVITIES_FOR_VALID_WEEK).length;
                const activityPoints = (validWeeksCount / MAX_WEEKS) * MAX_ACTIVITY_POINTS;
                
                let progressToTarget = null;
                if (p.target_weight && p.peso_inicial > p.target_weight) {
                    const totalNeeded = p.peso_inicial - p.target_weight;
                    const currentLoss = p.peso_inicial - p.peso_atual;
                    progressToTarget = Math.max(0, Math.min(100, (currentLoss / totalNeeded) * 100));
                }
                return { ...p, percentLoss: Math.max(0, percentLoss), weightPoints, validWeeksCount, activityPoints, totalPoints: weightPoints + activityPoints, progressToTarget };
            }

            function getBadges(p) {
                let badges = '';
                
                if (p.target_weight && p.peso_atual <= p.target_weight) {
                    badges += `<span class="badge tooltip"><span class="tooltiptext">Meta Atingida! Parab√©ns!</span>üéØ</span>`;
                }

                const pesoPerdido = p.peso_inicial - p.peso_atual;
                if (pesoPerdido >= 10) {
                    badges += `<span class="badge tooltip"><span class="tooltiptext">Marco de 10kg Atingido!</span>‚öñÔ∏è</span>`;
                } else if (pesoPerdido >= 5) {
                    badges += `<span class="badge tooltip"><span class="tooltiptext">Marco de 5kg Atingido!</span>‚öñÔ∏è</span>`;
                }

                const consecutive = p.semanas_validas.map(w => w >= MIN_ACTIVITIES_FOR_VALID_WEEK ? '1' : '0').join('').split('0').reduce((max, s) => Math.max(max, s.length), 0);
                if (consecutive >= 8) {
                    badges += `<span class="badge tooltip"><span class="tooltiptext">${consecutive} Semanas em Chamas!</span>üî•üî•</span>`;
                } else if (consecutive >= 4) {
                    badges += `<span class="badge tooltip"><span class="tooltiptext">${consecutive} Semanas em Chamas!</span>üî•</span>`;
                }

                if (p.semanas_validas[0] >= MIN_ACTIVITIES_FOR_VALID_WEEK) {
                    badges += `<span class="badge tooltip"><span class="tooltiptext">Primeira Semana Completa!</span>ü•á</span>`;
                }

                return badges;
            }

            function getWeightAtDate(participant, targetDate) {
                const relevantHistory = participant.weight_history
                    .filter(entry => new Date(entry.date) <= targetDate)
                    .sort((a, b) => new Date(b.date) - new Date(a.date)); 

                if (relevantHistory.length > 0) {
                    return relevantHistory[0].weight;
                }
                return participant.peso_inicial;
            }

            function calculateIMC(weight, height) {
                if (!weight || !height || height <= 0) {
                    return { value: null, classification: 'N/A', color: 'text-gray-500' };
                }
                const imc = weight / (height * height);
                let classification = '';
                let color = '';

                if (imc < 18.5) {
                    classification = 'Abaixo do Peso';
                    color = 'text-blue-500';
                } else if (imc < 24.9) {
                    classification = 'Peso Normal';
                    color = 'text-green-600';
                } else if (imc < 29.9) {
                    classification = 'Sobrepeso';
                    color = 'text-yellow-600';
                } else if (imc < 34.9) {
                    classification = 'Obesidade Grau I';
                    color = 'text-orange-600';
                } else if (imc < 39.9) {
                    classification = 'Obesidade Grau II';
                    color = 'text-red-600';
                } else {
                    classification = 'Obesidade Grau III';
                    color = 'text-red-800';
                }
                return { value: imc.toFixed(2), classification, color };
            }

            // L√ìGICA DE RENDERIZA√á√ÉO E UI
            function updateAllViews() {
                if (!currentUser) return; // N√£o renderiza nada se n√£o estiver logado
                
                if (currentViewIsMobile) {
                    mainContent.classList.add('hidden');
                    mobileDashboard.classList.remove('hidden');
                    renderMobileDashboard();
                } else {
                    mainContent.classList.remove('hidden');
                    mobileDashboard.classList.add('hidden');
                    updatePlanilha();
                }
                applyPermissions();
            }

            function toggleView(showMobile) {
                currentViewIsMobile = showMobile;
                updateAllViews();
            }

            function updatePlanilha() {
                const activeSectionId = document.querySelector('.nav-tab-item.active')?.dataset.section || 'ranking';
                showSection(activeSectionId);
                updateSummaryBoxes();
            }

            function showSection(sectionId) {
                document.querySelectorAll('.content-section').forEach(s => s.classList.add('hidden'));
                const activeSection = document.getElementById(`section${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}`);
                if (activeSection) {
                    activeSection.classList.remove('hidden');
                    const title = NAV_LINKS.find(l => l.id === sectionId)?.text || 'Se√ß√£o';
                    
                    const allMetrics = participants.map(calculateMetrics);
                    const searchTerm = document.getElementById('searchParticipantInput').value.toLowerCase();
                    const filteredMetrics = allMetrics.filter(p => p.name.toLowerCase().includes(searchTerm));
                    const ranked = [...filteredMetrics].sort((a, b) => b.totalPoints - a.totalPoints);

                    if (sectionId === 'ranking') renderRankingTable(ranked, activeSection, title);
                    else if (sectionId === 'weekly') renderWeeklyTable(filteredMetrics, activeSection, title);
                    else if (sectionId === 'activity') renderActivityChart(ranked, activeSection, title);
                    else if (sectionId === 'currentWeight') renderCurrentWeightTable(filteredMetrics, activeSection, title);
                    else if (sectionId === 'weightHistory') renderWeightHistoryChart(filteredMetrics, activeSection, title);
                    else if (sectionId === 'groupEvolution') renderGroupEvolutionChart(allMetrics, activeSection, title);
                    else if (sectionId === 'comparison') renderComparisonChart(allMetrics, activeSection, title);
                }
                document.querySelectorAll('.nav-tab-item').forEach(item => item.classList.toggle('active', item.dataset.section === sectionId));
            }

            function renderRankingTable(data, container, title) {
                const canEdit = !!currentUser;
                let tableHTML = `
                    <h2 class="text-xl sm:text-2xl font-semibold mb-4">${title}</h2>
                    <div class="overflow-x-auto rounded-xl shadow-md">
                        <table class="w-full">
                            <thead><tr>
                                <th class="rounded-tl-xl">Rank</th>
                                <th>Nome</th>
                                <th>Progresso Meta</th>
                                <th>% Perda</th>
                                <th>Pts Peso</th>
                                <th>Sem. V√°lidas</th>
                                <th>Pts Ativ.</th>
                                <th>Total</th>
                                <th class="rounded-tr-xl"></th>
                            </tr></thead>
                            <tbody>`;
                
                if (data.length === 0) {
                    tableHTML += `<tr><td colspan="9" class="text-center p-4">Nenhum participante encontrado.</td></tr>`;
                } else {
                    data.forEach((p, index) => {
                        const crown = ['üëë', 'ü•à', 'ü•â'][index] || '';
                        const badges = getBadges(p);
                        const progress = p.progressToTarget !== null ? `
                            <div class="progress-bar-container tooltip"><span class="tooltiptext">${p.progressToTarget.toFixed(1)}% da meta</span>
                                <div class="progress-bar-fill" style="width: ${p.progressToTarget}%;"><span class="progress-bar-text">${p.progressToTarget.toFixed(0)}%</span></div>
                            </div>` : 'N/A';
                        
                        tableHTML += `
                            <tr class="${index === 0 ? 'leader-row' : ''}">
                                <td class="font-semibold">${index + 1} ${crown}</td>
                                <td><a href="#" class="participant-name-link text-blue-600 hover:underline" data-name="${p.name}">${p.name}</a> ${badges}</td>
                                <td>${progress}</td>
                                <td>${p.percentLoss.toFixed(2)}%</td>
                                <td>${p.weightPoints.toFixed(2)}</td>
                                <td>${p.validWeeksCount}</td>
                                <td>${p.activityPoints.toFixed(2)}</td>
                                <td class="font-bold">${p.totalPoints.toFixed(2)}</td>
                                <td class="flex items-center space-x-2">
                                    ${canEdit ? `
                                    <button class="text-blue-500 hover:text-blue-700 edit-participant-icon" data-id="${p.id}">‚úèÔ∏è</button>
                                    <button class="text-red-500 hover:text-red-700 delete-participant-icon" data-id="${p.id}" data-name="${p.name}">üóëÔ∏è</button>
                                    ` : ''}
                                </td>
                            </tr>`;
                    });
                }
                tableHTML += `</tbody></table></div>`;
                container.innerHTML = tableHTML;
            }

            function renderWeeklyTable(data, container, title) {
                const canEdit = !!currentUser;
                const today = new Date();
                const currentWeek = Math.floor((today - CHALLENGE_START_DATE) / (1000 * 60 * 60 * 24 * 7)) + 1;
                
                let headers = `<th>Nome</th>`;
                for (let i = 1; i <= MAX_WEEKS; i++) {
                    headers += `<th class="${i === currentWeek ? 'current-week' : ''}">${i}</th>`;
                }

                let bodyHTML = '';
                if (data.length > 0) {
                    data.sort((a,b) => a.name.localeCompare(b.name)).forEach(p => {
                        bodyHTML += `<tr><td class="font-medium">${p.name}</td>`;
                        p.semanas_validas.forEach((num, weekIndex) => {
                            const isPastOrCurrent = (weekIndex + 1) <= currentWeek;
                            let tdClasses = weekIndex + 1 === currentWeek ? 'current-week-cell' : '';
                            if (isPastOrCurrent) tdClasses += num >= MIN_ACTIVITIES_FOR_VALID_WEEK ? ' valid-week' : ' missed-week';
                            
                            bodyHTML += `
                                <td class="${tdClasses}">
                                    <div class="activity-content">
                                        <input type="number" class="activity-input" min="0" value="${num}" data-id="${p.id}" data-week="${weekIndex}" ${!canEdit ? 'disabled' : ''}>
                                        <span class="checkmark-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></span>
                                    </div>
                                </td>`;
                        });
                        bodyHTML += `</tr>`;
                    });
                } else {
                    bodyHTML = `<tr><td colspan="${MAX_WEEKS + 1}" class="text-center p-4">Nenhum participante.</td></tr>`;
                }

                container.innerHTML = `
                    <h2 class="text-xl sm:text-2xl font-semibold mb-4">${title}</h2>
                    <div class="overflow-x-auto rounded-xl shadow-md">
                        <table id="weeklyParticipationTable" class="w-full">
                            <thead><tr>${headers}</tr></thead>
                            <tbody>${bodyHTML}</tbody>
                        </table>
                    </div>`;
            }

            function renderCurrentWeightTable(data, container, title) {
                const canEdit = !!currentUser;
                const todayStr = new Date().toISOString().split('T')[0];
                let bodyHTML = '';

                if (data.length > 0) {
                    data.sort((a, b) => a.name.localeCompare(b.name)).forEach(p => {
                        bodyHTML += `
                            <tr>
                                <td class="font-medium">${p.name}</td>
                                <td><input type="number" step="any" class="shadow-sm border rounded w-full py-2 px-3" value="${p.peso_atual.toFixed(2)}" ${!canEdit ? 'disabled' : ''}></td>
                                <td><input type="date" class="shadow-sm border rounded w-full py-2 px-3" value="${todayStr}" max="${todayStr}" ${!canEdit ? 'disabled' : ''}></td>
                                <td class="text-center"><button class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg update-weight-btn" data-id="${p.id}" ${!canEdit ? 'disabled' : ''}>Salvar</button></td>
                            </tr>`;

                        if (p.weight_history && p.weight_history.length > 0) {
                            bodyHTML += `
                                <tr>
                                    <td colspan="4" class="p-3 bg-gray-50 border-t">
                                        <h4 class="text-xs font-bold text-gray-500 mb-2">HIST√ìRICO DE PESAGEM:</h4>
                                        <ul class="space-y-1 max-h-32 overflow-y-auto pr-2">`;
                            
                            [...p.weight_history].sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(entry => {
                                const formattedDate = new Date(entry.date).toLocaleDateString('pt-BR', { timeZone: 'UTC' });
                                bodyHTML += `
                                    <li class="flex justify-between items-center text-sm p-1.5 bg-white rounded shadow-sm">
                                        <span>
                                            üóìÔ∏è <span class="font-mono">${formattedDate}</span> &nbsp;
                                            ‚öñÔ∏è <strong>${parseFloat(entry.weight).toFixed(2)} kg</strong>
                                        </span>
                                        ${canEdit ? `<button class="text-red-400 hover:text-red-600 delete-weight-entry-btn p-1 rounded-full" title="Excluir este registro" data-participant-name="${p.name}" data-entry-date="${entry.date}">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                                <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                                <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                            </svg>
                                        </button>` : ''}
                                    </li>`;
                            });

                            bodyHTML += `</ul></td></tr>`;
                        }
                    });
                } else {
                    bodyHTML = `<tr><td colspan="4" class="text-center p-4">Nenhum participante.</td></tr>`;
                }

                container.innerHTML = `
                    <h2 class="text-xl sm:text-2xl font-semibold mb-4">${title}</h2>
                    <div class="overflow-x-auto rounded-xl shadow-md">
                        <table class="w-full">
                            <thead><tr>
                                <th class="rounded-tl-xl w-1/4">Nome</th><th class="w-1/4">Peso (kg)</th><th class="w-1/4">Data</th><th class="rounded-tr-xl w-1/4">A√ß√£o</th>
                            </tr></thead>
                            <tbody>${bodyHTML}</tbody>
                        </table>
                    </div>`;
            }
            
            function renderActivityChart(data, container, title) {
                let contentHTML = `<h2 class="text-xl sm:text-2xl font-semibold mb-4">${title}</h2><div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">`;
                if (data.length > 0) {
                    const percentActivities = (p) => (p.activityPoints / MAX_ACTIVITY_POINTS) * 100;
                    data.forEach(p => {
                        const pA = percentActivities(p);
                        let fillColor = '#34d399'; // Verde
                        if (pA < 50) fillColor = '#f59e0b'; // Amarelo
                        if (pA < 25) fillColor = '#ef4444'; // Vermelho
                        
                        const sanitizedName = p.name.replace(/[^a-zA-Z0-9]/g, '');

                        contentHTML += `
                            <div class="flex flex-col items-center text-center">
                                <div class="relative w-16 h-16 mb-1">
                                    <svg width="64" height="64" viewBox="0 0 24 24">
                                        <defs>
                                            <clipPath id="clip-${sanitizedName}">
                                                <rect x="0" y="${24 - (24 * pA / 100)}" width="24" height="${24 * pA / 100}"></rect>
                                            </clipPath>
                                        </defs>
                                        <g fill="#e5e7eb">
                                            <circle cx="12" cy="5" r="3"/><rect x="10" y="8" width="4" height="8"/><rect x="6" y="9" width="4" height="2"/><rect x="14" y="9" width="4" height="2"/><rect x="9" y="16" width="2" height="6"/><rect x="13" y="16" width="2" height="6"/>
                                        </g>
                                        <g clip-path="url(#clip-${sanitizedName})" fill="${fillColor}">
                                            <circle cx="12" cy="5" r="3"/><rect x="10" y="8" width="4" height="8"/><rect x="6" y="9" width="4" height="2"/><rect x="14" y="9" width="4" height="2"/><rect x="9" y="16" width="2" height="6"/><rect x="13" y="16" width="2" height="6"/>
                                        </g>
                                    </svg>
                                </div>
                                <div class="text-sm font-medium">${p.name} - ${pA.toFixed(1)}%</div>
                            </div>`;
                    });
                } else {
                    contentHTML += `<div class="col-span-full text-center p-4">Nenhum participante.</div>`;
                }
                contentHTML += `</div>`;
                container.innerHTML = contentHTML;
            }
            
            function renderWeightHistoryChart(data, container, title) {
                container.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl sm:text-2xl font-semibold">${title}</h2>
                        <button class="export-pdf-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-lg shadow-md text-sm" data-chart-id="weightHistoryChartContainer" data-filename="evolucao_individual.pdf" data-title="${title}">Exportar PDF</button>
                    </div>
                    <div id="weightHistoryChartContainer" class="w-full"></div>`;
                const chartContainer = document.getElementById('weightHistoryChartContainer');
                
                const participantsWithHistory = data.filter(p => p.weight_history && p.weight_history.length > 0);
                if (participantsWithHistory.length === 0) {
                    chartContainer.innerHTML = `<div class="empty-table-message">N√£o h√° hist√≥rico de peso para exibir.</div>`;
                    return;
                }

                let allDates = [];
                participantsWithHistory.forEach(p => {
                    p.weight_history.forEach(entry => allDates.push(new Date(entry.date)));
                });
                const latestDate = d3.max(allDates);

                if (!latestDate) {
                    chartContainer.innerHTML = `<div class="empty-table-message">N√£o h√° hist√≥rico de peso para exibir.</div>`;
                    return;
                }

                const chartData = participantsWithHistory.map(p => {
                    const historyCopy = JSON.parse(JSON.stringify(p.weight_history));
                    historyCopy.sort((a, b) => new Date(a.date) - new Date(b.date));

                    const lastEntry = historyCopy[historyCopy.length - 1];
                    const lastEntryDate = new Date(lastEntry.date);

                    if (lastEntryDate < latestDate) {
                        historyCopy.push({
                            date: latestDate.toISOString(),
                            weight: lastEntry.weight
                        });
                    }
                    
                    return {
                        ...p, // Pass all participant data through
                        weightHistory: historyCopy
                    };
                });
                
                const margin = {top: 20, right: 160, bottom: 30, left: 40},
                      containerWidth = chartContainer.clientWidth || 800,
                      width = containerWidth - margin.left - margin.right,
                      height = 350 - margin.top - margin.bottom;

                const svg = d3.select(chartContainer).append("svg")
                    .attr("width", "100%")
                    .attr("height", "100%")
                    .attr("viewBox", `0 0 ${containerWidth} ${height + margin.top + margin.bottom}`)
                    .append("g").attr("transform", `translate(${margin.left},${margin.top})`);

                let allChartDates = [], allChartWeights = [];
                chartData.forEach(p => {
                    p.weightHistory.forEach(d => {
                        allChartDates.push(new Date(d.date));
                        allChartWeights.push(d.weight);
                    });
                    if (p.target_weight) {
                        allChartWeights.push(p.target_weight);
                    }
                });

                const xScale = d3.scaleTime().domain([CHALLENGE_START_DATE, CHALLENGE_END_DATE]).range([0, width]);
                const yScale = d3.scaleLinear().domain([d3.min(allChartWeights) - 2, d3.max(allChartWeights) + 2]).range([height, 0]);
                const line = d3.line().x(d => xScale(new Date(d.date))).y(d => yScale(d.weight));
                const colors = d3.scaleOrdinal(d3.schemeCategory10);

                svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(xScale).tickFormat(d3.timeFormat("%d/%m")));
                svg.append("g").call(d3.axisLeft(yScale).tickFormat(d => `${d}kg`));

                chartData.forEach(p => {
                    // Draw main weight line
                    svg.append("path").datum(p.weightHistory).attr("fill", "none").attr("stroke", colors(p.name)).attr("stroke-width", 2).attr("d", line);
                    
                    // Draw goal projection line
                    if (p.target_weight) {
                        const projectionData = [
                            { date: CHALLENGE_START_DATE, weight: p.peso_inicial },
                            { date: CHALLENGE_END_DATE, weight: p.target_weight }
                        ];
                        svg.append("path")
                            .datum(projectionData)
                            .attr("fill", "none")
                            .attr("stroke", colors(p.name))
                            .attr("stroke-width", 1.5)
                            .attr("stroke-dasharray", "5,5")
                            .attr("d", line);
                    }
                });
                
                const legend = svg.selectAll(".legend").data(chartData).enter().append("g")
                    .attr("class", "legend").attr("transform", (d, i) => `translate(${width + 20},${i * 20})`);
                legend.append("rect").attr("width", 18).attr("height", 18).style("fill", d => colors(d.name));
                legend.append("text").attr("x", 24).attr("y", 9).attr("dy", ".35em").style("text-anchor", "start").text(d => d.name);
            }

            function renderGroupEvolutionChart(data, container, title) {
                container.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl sm:text-2xl font-semibold">${title}</h2>
                        <button class="export-pdf-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-lg shadow-md text-sm" data-chart-id="groupEvolutionChartContainer" data-filename="evolucao_grupo.pdf" data-title="${title}">Exportar PDF</button>
                    </div>
                    <div id="groupEvolutionChartContainer" class="w-full"></div>`;
                const chartContainer = document.getElementById('groupEvolutionChartContainer');

                const weeklyLossData = [];
                for (let i = 0; i < MAX_WEEKS; i++) {
                    const weekStartDate = new Date(CHALLENGE_START_DATE);
                    weekStartDate.setDate(weekStartDate.getDate() + i * 7);

                    const weekEndDate = new Date(CHALLENGE_START_DATE);
                    weekEndDate.setDate(weekEndDate.getDate() + (i + 1) * 7);

                    let totalWeeklyLoss = 0;
                    participants.forEach(p => {
                        const weightAtStartOfWeek = getWeightAtDate(p, weekStartDate);
                        const weightAtEndOfWeek = getWeightAtDate(p, weekEndDate);
                        const loss = weightAtStartOfWeek - weightAtEndOfWeek;
                        totalWeeklyLoss += loss;
                    });

                    weeklyLossData.push({ week: i + 1, totalLoss: totalWeeklyLoss });
                }

                if (weeklyLossData.every(d => d.totalLoss === 0)) {
                    chartContainer.innerHTML = `<div class="empty-table-message">Nenhuma perda de peso registrada ainda para o grupo.</div>`;
                    return;
                }

                const margin = {top: 20, right: 30, bottom: 40, left: 70},
                      containerWidth = chartContainer.clientWidth || 800,
                      width = containerWidth - margin.left - margin.right,
                      height = 350 - margin.top - margin.bottom;

                const svg = d3.select(chartContainer).append("svg")
                    .attr("width", "100%")
                    .attr("height", "100%")
                    .attr("viewBox", `0 0 ${containerWidth} ${height + margin.top + margin.bottom}`)
                    .append("g").attr("transform", `translate(${margin.left},${margin.top})`);

                const xScale = d3.scaleBand()
                    .domain(weeklyLossData.map(d => d.week))
                    .range([0, width])
                    .padding(0.2);

                const yScale = d3.scaleLinear()
                    .domain([0, d3.max(weeklyLossData, d => d.totalLoss) * 1.1 || 1])
                    .range([height, 0]);

                svg.append("g")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(xScale))
                    .append("text")
                    .attr("y", 35)
                    .attr("x", width / 2)
                    .attr("text-anchor", "middle")
                    .attr("fill", "var(--text-primary)")
                    .text("Semana do Desafio");

                svg.append("g")
                    .call(d3.axisLeft(yScale).tickFormat(d => `${d.toFixed(1)}kg`))
                    .append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", -margin.left + 20)
                    .attr("x", -height / 2)
                    .attr("text-anchor", "middle")
                    .attr("fill", "var(--text-primary)")
                    .text("Perda de Peso Total do Grupo (kg)");

                const tooltip = d3.select("body").append("div")
                    .attr("class", "tooltip-chart")
                    .style("opacity", 0);

                svg.selectAll(".bar")
                    .data(weeklyLossData)
                    .enter().append("rect")
                    .attr("class", "bar")
                    .attr("x", d => xScale(d.week))
                    .attr("y", d => yScale(Math.max(0, d.totalLoss)))
                    .attr("width", xScale.bandwidth())
                    .attr("height", d => Math.abs(yScale(0) - yScale(d.totalLoss)))
                    .attr("fill", "#2563eb")
                    .on("mouseover", (event, d) => {
                        tooltip.transition().duration(200).style("opacity", .9);
                        tooltip.html(`Semana ${d.week}<br/>Perda Total: <strong>${d.totalLoss.toFixed(2)} kg</strong>`)
                            .style("left", (event.pageX + 5) + "px")
                            .style("top", (event.pageY - 28) + "px");
                    })
                    .on("mouseout", () => {
                        tooltip.transition().duration(500).style("opacity", 0);
                    });
            }

            function renderComparisonChart(data, container, title) {
                let checkboxesHTML = data.map(p => `
                    <label class="inline-flex items-center mr-4 mb-2">
                        <input type="checkbox" class="comparison-checkbox form-checkbox h-5 w-5 text-blue-600" value="${p.name}">
                        <span class="ml-2">${p.name}</span>
                    </label>
                `).join('');

                container.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl sm:text-2xl font-semibold">${title}</h2>
                        <button class="export-pdf-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-lg shadow-md text-sm" data-chart-id="comparisonChartContainer" data-filename="comparativo.pdf" data-title="${title}">Exportar PDF</button>
                    </div>
                    <div id="comparison-checkboxes" class="p-4 rounded-lg mb-4">${checkboxesHTML}</div>
                    <div id="comparisonChartContainer" class="w-full"></div>`;
                
                updateComparisonChart();
            }

            function updateComparisonChart() {
                const chartContainer = document.getElementById('comparisonChartContainer');
                const selectedNames = Array.from(document.querySelectorAll('.comparison-checkbox:checked')).map(cb => cb.value);
                const selectedParticipants = participants.filter(p => selectedNames.includes(p.name));

                chartContainer.innerHTML = '';

                if (selectedParticipants.length === 0) {
                    chartContainer.innerHTML = `<div class="empty-table-message">Selecione um ou mais participantes para comparar.</div>`;
                    return;
                }

                const participantsWithHistory = selectedParticipants.filter(p => p.weight_history && p.weight_history.length > 0);
                if (participantsWithHistory.length === 0) {
                    chartContainer.innerHTML = `<div class="empty-table-message">Nenhum hist√≥rico de peso para os participantes selecionados.</div>`;
                    return;
                }

                let allDates = [];
                participantsWithHistory.forEach(p => {
                    p.weight_history.forEach(entry => allDates.push(new Date(entry.date)));
                });
                const latestDate = d3.max(allDates);
                if (!latestDate) return;

                const chartData = participantsWithHistory.map(p => {
                    const historyCopy = JSON.parse(JSON.stringify(p.weight_history));
                    historyCopy.sort((a, b) => new Date(a.date) - new Date(b.date));
                    const lastEntry = historyCopy[historyCopy.length - 1];
                    if (new Date(lastEntry.date) < latestDate) {
                        historyCopy.push({ date: latestDate.toISOString(), weight: lastEntry.weight });
                    }
                    return { name: p.name, weightHistory: historyCopy };
                });

                const margin = {top: 20, right: 160, bottom: 30, left: 40},
                      containerWidth = chartContainer.clientWidth || 800,
                      width = containerWidth - margin.left - margin.right,
                      height = 350 - margin.top - margin.bottom;

                const svg = d3.select(chartContainer).append("svg")
                    .attr("width", "100%").attr("height", "100%")
                    .attr("viewBox", `0 0 ${containerWidth} ${height + margin.top + margin.bottom}`)
                    .append("g").attr("transform", `translate(${margin.left},${margin.top})`);

                let allChartDates = [], allChartWeights = [];
                chartData.forEach(p => p.weightHistory.forEach(d => {
                    allChartDates.push(new Date(d.date));
                    allChartWeights.push(d.weight);
                }));

                const xScale = d3.scaleTime().domain(d3.extent(allChartDates)).range([0, width]);
                const yScale = d3.scaleLinear().domain([d3.min(allChartWeights) - 2, d3.max(allChartWeights) + 2]).range([height, 0]);
                const line = d3.line().x(d => xScale(new Date(d.date))).y(d => yScale(d.weight));
                const colors = d3.scaleOrdinal(d3.schemeCategory10);

                svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(xScale).tickFormat(d3.timeFormat("%d/%m")));
                svg.append("g").call(d3.axisLeft(yScale).tickFormat(d => `${d}kg`));

                chartData.forEach(p => {
                    svg.append("path").datum(p.weightHistory).attr("fill", "none").attr("stroke", colors(p.name)).attr("stroke-width", 2).attr("d", line);
                });
                
                const legend = svg.selectAll(".legend").data(chartData).enter().append("g")
                    .attr("class", "legend").attr("transform", (d, i) => `translate(${width + 20},${i * 20})`);
                legend.append("rect").attr("width", 18).attr("height", 18).style("fill", d => colors(d.name));
                legend.append("text").attr("x", 24).attr("y", 9).attr("dy", ".35em").style("text-anchor", "start").text(d => d.name);
            }

            function renderMobileDashboard() {
                const card = document.getElementById('leaderHighlightCard');
                const list = document.getElementById('mobileRankingList');
                const allMetrics = participants.map(calculateMetrics);
                const ranked = [...allMetrics].sort((a, b) => b.totalPoints - a.totalPoints);
                
                if (ranked.length > 0) {
                    const leader = ranked[0];
                    card.innerHTML = `
                        <p class="text-lg font-semibold text-orange-700">L√≠der Atual: <span class="text-xl font-bold text-orange-900">${leader.name}</span> üëë</p>
                        <p class="text-md text-gray-700">Pontua√ß√£o: <span class="font-bold text-orange-800">${leader.totalPoints.toFixed(2)}</span> pts</p>`;
                } else {
                    card.innerHTML = `<p>Nenhum l√≠der ainda.</p>`;
                }

                list.innerHTML = '';
                ranked.forEach((p, index) => {
                    const crown = ['üëë', 'ü•à', 'ü•â'][index] || '';
                    list.innerHTML += `
                        <div class="bg-white p-3 rounded-md shadow-sm border flex justify-between items-center ${index === 0 ? 'bg-yellow-50 border-orange-300' : 'border-gray-200'}">
                            <div><span class="font-bold text-gray-800">${index + 1}. ${p.name} ${crown}</span></div>
                            <span class="text-lg font-bold text-blue-700">${p.totalPoints.toFixed(2)} pts</span>
                        </div>`;
                });
            }

            function updateSummaryBoxes() {
                const leaderBox = document.getElementById('leaderBox');
                const weeklyBox = document.getElementById('weeklyHighlightBox');
                const monthlyBox = document.getElementById('monthlyHighlightBox');
                const daysBox = document.getElementById('daysRemainingBox');

                // Box 1: Leader
                const ranked = participants.map(calculateMetrics).sort((a, b) => b.totalPoints - a.totalPoints);
                if (ranked.length > 0) {
                    const leader = ranked[0];
                    leaderBox.innerHTML = `<div>üëë L√≠der Atual</div><div class="text-xl font-bold text-green-700">${leader.name}</div><div>${leader.totalPoints.toFixed(2)} pts</div>`;
                } else {
                    leaderBox.innerHTML = `<div>üëë L√≠der Atual</div><div class="text-xl">N/A</div>`;
                }

                // Box 2: Weekly Highlight
                let weeklyWinner = { name: 'N/A', loss: Number.NEGATIVE_INFINITY };
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                
                participants.forEach(p => {
                    const weightAtStartOfWeek = getWeightAtDate(p, oneWeekAgo);
                    const loss = weightAtStartOfWeek - p.peso_atual;
                    if (loss > weeklyWinner.loss) {
                        weeklyWinner = { name: p.name, loss };
                    }
                });
                weeklyBox.innerHTML = `<div>üî• Destaque da Semana</div><div class="text-xl font-bold text-purple-700">${weeklyWinner.name}</div><div>Perdeu ${weeklyWinner.loss > 0 ? weeklyWinner.loss.toFixed(2) : '0.00'} kg</div>`;

                // Box 3: Monthly Highlight
                let monthlyWeightLossWinner = { name: 'N/A', loss: Number.NEGATIVE_INFINITY };
                const now = new Date();
                const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                participants.forEach(p => {
                    const weightAtStartOfMonth = getWeightAtDate(p, firstDayOfMonth);
                    const lossThisMonth = weightAtStartOfMonth - p.peso_atual;
                    if (lossThisMonth > monthlyWeightLossWinner.loss) {
                        monthlyWeightLossWinner = { name: p.name, loss: lossThisMonth };
                    }
                });

                const calculateStreak = (p) => p.semanas_validas.map(w => w >= MIN_ACTIVITIES_FOR_VALID_WEEK ? '1' : '0').join('').split('0').reduce((max, s) => Math.max(max, s.length), 0);
                let streakWinner = { name: 'N/A', streak: 0 };
                participants.forEach(p => {
                    const streak = calculateStreak(p);
                    if (streak > streakWinner.streak) {
                        streakWinner = { name: p.name, streak };
                    }
                });

                monthlyBox.innerHTML = `
                    <div class="text-base font-bold">üèÜ Destaque do M√™s</div>
                    <div class="text-sm mt-2">
                        <p>üî• Maior Sequ√™ncia:</p>
                        <p class="font-bold text-indigo-700">${streakWinner.name} (${streakWinner.streak} sem.)</p>
                    </div>
                    <div class="text-sm mt-1">
                        <p>‚öñÔ∏è Maior Perda no M√™s:</p>
                        <p class="font-bold text-cyan-700">${monthlyWeightLossWinner.name} (${monthlyWeightLossWinner.loss > 0 ? monthlyWeightLossWinner.loss.toFixed(2) : '0.00'} kg)</p>
                    </div>
                `;

                // Box 4: Days Remaining
                const daysRemaining = Math.max(0, Math.ceil((CHALLENGE_END_DATE - new Date()) / (1000 * 60 * 60 * 24)));
                daysBox.innerHTML = `<div>‚è≥ Dias Restantes</div><div class="text-3xl font-bold text-blue-700">${daysRemaining}</div><div>T√©rmino em ${CHALLENGE_END_DATE.toLocaleDateString('pt-BR')}</div>`;
            }

            function applyPermissions() {
                const canEdit = !!currentUser;
                document.querySelectorAll('button, input').forEach(el => {
                    const noDisable = ['logoutBtn', 'logoutBtnMobile', 'viewFullDashboardBtn', 'backToMobileRankingBtn', 'username', 'password'].includes(el.id) || el.closest('.nav-tab-item');
                    if (!noDisable) {
                         el.disabled = !canEdit;
                    }
                });
                document.querySelectorAll('.edit-participant-icon, .delete-participant-icon, #addParticipantBtn, #resetDataBtn, #importDataBtn').forEach(el => el.classList.toggle('hidden', !canEdit));
            }
            
            function openModal(index = null) {
                const modal = document.getElementById('participantModal');
                const isEdit = index !== null;
                const p = isEdit ? participants[index] : {};

                modal.innerHTML = `
                    <div class="modal-content">
                        <span class="close-button">&times;</span>
                        <h3 class="text-2xl font-bold mb-4">${isEdit ? 'Editar' : 'Adicionar'} Participante</h3>
                        <form id="participantForm">
                            <input type="hidden" id="participantId" value="${isEdit ? p.id : ''}">
                            <div class="mb-4">
                                <label for="pName" class="block font-bold">Nome:</label>
                                <input type="text" id="pName" class="border rounded w-full py-2 px-3" value="${p.name || ''}" required>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div><label for="pInitial" class="block font-bold">Peso Inicial (kg):</label><input type="number" step="any" id="pInitial" class="border rounded w-full py-2 px-3" value="${p.peso_inicial || ''}" required></div>
                                <div><label for="pCurrent" class="block font-bold">Peso Atual (kg):</label><input type="number" step="any" id="pCurrent" class="border rounded w-full py-2 px-3" value="${p.peso_atual || ''}" required></div>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-6">
                                <div><label for="pHeight" class="block font-bold">Altura (m):</label><input type="number" step="any" id="pHeight" class="border rounded w-full py-2 px-3" value="${p.altura || ''}" placeholder="Ex: 1.75" required></div>
                                <div><label for="pTarget" class="block font-bold">Meta de Peso (kg):</label><input type="number" step="any" id="pTarget" class="border rounded w-full py-2 px-3" value="${p.target_weight || ''}"></div>
                            </div>
                            <div class="flex justify-end gap-4">
                                <button type="button" class="bg-gray-500 text-white font-bold py-2 px-4 rounded close-button-action">Cancelar</button>
                                <button type="submit" class="bg-blue-500 text-white font-bold py-2 px-4 rounded">Salvar</button>
                            </div>
                        </form>
                    </div>`;
                
                modal.querySelector('.close-button').onclick = () => modal.classList.remove('show');
                modal.querySelector('.close-button-action').onclick = () => modal.classList.remove('show');
                modal.querySelector('#participantForm').onsubmit = handleParticipantFormSubmit;
                modal.classList.add('show');
            }

            async function handleParticipantFormSubmit(e) {
                e.preventDefault();
                const id = e.target.querySelector('#participantId').value;
                const participantData = {
                    name: document.getElementById('pName').value.trim(),
                    peso_inicial: parseFloat(document.getElementById('pInitial').value),
                    peso_atual: parseFloat(document.getElementById('pCurrent').value),
                    altura: parseFloat(document.getElementById('pHeight').value),
                    target_weight: parseFloat(document.getElementById('pTarget').value) || null,
                };

                if (!participantData.name || !participantData.peso_inicial || !participantData.peso_atual || !participantData.altura) {
                    return showFeedbackMessage("Preencha todos os campos obrigat√≥rios, incluindo a altura.", true);
                }

                if (participantData.altura > 3 || participantData.altura < 1) {
                    return showFeedbackMessage("Altura inv√°lida. Por favor, insira a altura em metros (ex: 1.75).", true);
                }

                let error;
                if (id) { // Edit
                    const { error: updateError } = await supabase.from('participants').update(participantData).eq('id', id);
                    error = updateError;
                } else { // Add
                    participantData.semanas_validas = Array(12).fill(0);
                    participantData.weight_history = [{ date: new Date().toISOString(), weight: participantData.peso_atual }];
                    const { error: insertError } = await supabase.from('participants').insert([participantData]);
                    error = insertError;
                }
                
                if (error) {
                    showFeedbackMessage('Erro ao salvar participante.', true);
                    console.error(error);
                } else {
                    document.getElementById('participantModal').classList.remove('show');
                    showFeedbackMessage(`Participante ${id ? 'atualizado' : 'adicionado'}!`);
                    loadData();
                }
            }

            async function openDeleteModal(id, isReset = false, name = '') {
                const modal = document.getElementById('deleteConfirmModal');
                modal.innerHTML = `
                    <div class="modal-content text-center">
                        <h3 class="text-2xl font-bold mb-4">Confirmar A√ß√£o</h3>
                        <p class="mb-6">Tem certeza que deseja ${isReset ? 'resetar todos os dados para o padr√£o?' : `excluir <strong>${name}</strong>?`}</p>
                        <div class="flex justify-center gap-4">
                            <button class="bg-gray-500 text-white font-bold py-2 px-4 rounded" id="cancelDelete">Cancelar</button>
                            <button class="bg-red-500 text-white font-bold py-2 px-4 rounded" id="confirmDelete">Confirmar</button>
                        </div>
                    </div>`;
                
                modal.querySelector('#cancelDelete').onclick = () => modal.classList.remove('show');
                modal.querySelector('#confirmDelete').onclick = async () => {
                    let error;
                    if (isReset) {
                        // Implementar RPC no Supabase para resetar seria o ideal
                        showFeedbackMessage("Funcionalidade de Reset n√£o implementada com Supabase.", true);
                    } else {
                        const { error: deleteError } = await supabase.from('participants').delete().eq('id', id);
                        error = deleteError;
                    }

                    if (error) {
                        showFeedbackMessage('Erro ao excluir.', true);
                        console.error(error);
                    } else {
                        showFeedbackMessage("A√ß√£o conclu√≠da com sucesso!");
                        loadData();
                    }
                    modal.classList.remove('show');
                };
                modal.classList.add('show');
            }

            function openDetailsModal(name) {
                const p = calculateMetrics(participants.find(p => p.name === name));
                const modal = document.getElementById('participantDetailsModal');
                
                const initialIMC = calculateIMC(p.peso_inicial, p.altura);
                const currentIMC = calculateIMC(p.peso_atual, p.altura);

                const progress = p.progressToTarget !== null ? `
                    <div class="progress-bar-container tooltip"><span class="tooltiptext">${p.progressToTarget.toFixed(1)}% da meta</span>
                        <div class="progress-bar-fill" style="width: ${p.progressToTarget}%;"><span class="progress-bar-text">${p.progressToTarget.toFixed(0)}%</span></div>
                    </div>` : 'N/A';
                
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px;">
                        <span class="close-button">&times;</span>
                        <div class="flex items-center gap-4 mb-4">
                            <img src="https://placehold.co/100x100/E2E8F0/4A5568?text=${p.name.charAt(0)}" class="rounded-full">
                            <div>
                                <h3 class="text-3xl font-bold">${p.name}</h3>
                                <div class="text-2xl">${getBadges(p)}</div>
                                <div class="text-sm text-gray-600">Altura: ${p.altura ? p.altura.toFixed(2) + 'm' : 'N/A'}</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-center mb-4">
                            <div class="bg-gray-100 p-2 rounded-lg">
                                <div class="text-sm font-bold text-gray-500">PESO INICIAL</div>
                                <div class="text-2xl font-bold">${p.peso_inicial.toFixed(2)}kg</div>
                            </div>
                            <div class="bg-gray-100 p-2 rounded-lg">
                                <div class="text-sm font-bold text-gray-500">PESO ATUAL</div>
                                <div class="text-2xl font-bold text-blue-600">${p.peso_atual.toFixed(2)}kg</div>
                            </div>
                            <div class="bg-gray-100 p-2 rounded-lg">
                                <div class="text-sm font-bold text-gray-500">META</div>
                                <div class="text-2xl font-bold text-green-600">${p.target_weight ? p.target_weight.toFixed(2) + 'kg' : 'N/A'}</div>
                            </div>
                        </div>

                        <div class="border-t pt-4 mt-4">
                            <h4 class="text-md font-bold text-center mb-2">√çndice de Massa Corporal (IMC)</h4>
                            <div class="grid grid-cols-2 gap-4 text-center">
                                <div class="bg-gray-50 p-2 rounded-lg">
                                    <div class="text-sm font-bold text-gray-500">IMC Inicial</div>
                                    <div class="text-xl font-bold">${initialIMC.value || 'N/A'}</div>
                                    <div class="text-sm font-semibold ${initialIMC.color}">${initialIMC.classification}</div>
                                </div>
                                <div class="bg-gray-50 p-2 rounded-lg">
                                    <div class="text-sm font-bold text-gray-500">IMC Atual</div>
                                    <div class="text-xl font-bold ${currentIMC.color}">${currentIMC.value || 'N/A'}</div>
                                    <div class="text-sm font-semibold ${currentIMC.color}">${currentIMC.classification}</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4 mt-4">
                            <div class="text-sm font-bold text-gray-500 mb-1">PROGRESSO PARA META</div>
                            ${progress}
                        </div>
                        <div class="hide-on-mobile">
                            <div class="text-sm font-bold text-gray-500 mb-1">HIST√ìRICO DE PESO</div>
                            <div id="details-chart"></div>
                        </div>
                    </div>`;
                
                modal.querySelector('.close-button').onclick = () => modal.classList.remove('show');
                modal.classList.add('show');
                
                if (p.weight_history.length > 1) {
                    renderMiniChart(p.weight_history, '#details-chart');
                } else {
                    const chartDiv = document.getElementById('details-chart');
                    if(chartDiv) chartDiv.innerHTML = `<div class="text-center p-4 text-gray-500">N√£o h√° dados suficientes para o gr√°fico.</div>`;
                }
            }
            
            function renderMiniChart(data, containerSelector) {
                const container = d3.select(containerSelector);
                if(!container.node()) return;
                container.select("svg").remove();
                
                const margin = {top: 10, right: 10, bottom: 20, left: 30},
                      width = 500 - margin.left - margin.right,
                      height = 200 - margin.top - margin.bottom;

                const svg = container.append("svg")
                    .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
                    .append("g").attr("transform", `translate(${margin.left},${margin.top})`);
                
                const xScale = d3.scaleTime().domain(d3.extent(data, d => new Date(d.date))).range([0, width]);
                const yScale = d3.scaleLinear().domain([d3.min(data, d => d.weight) - 1, d3.max(data, d => d.weight) + 1]).range([height, 0]);
                
                svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(xScale).ticks(5).tickFormat(d3.timeFormat("%d/%m")));
                svg.append("g").call(d3.axisLeft(yScale).ticks(5));
                
                svg.append("path").datum(data).attr("fill", "none").attr("stroke", "steelblue").attr("stroke-width", 2)
                   .attr("d", d3.line().x(d => xScale(new Date(d.date))).y(d => yScale(d.weight)));
            }

            function exportData() {
                const dataStr = JSON.stringify(participants, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'desafio_fit_data.json';
                a.click();
                URL.revokeObjectURL(url);
                showFeedbackMessage("Dados exportados!");
            }

            function importData(event) {
                showFeedbackMessage("Importa√ß√£o desativada com o uso do banco de dados.", true);
            }

            function showFeedbackMessage(message, isError = false) {
                feedbackMessageDiv.textContent = message;
                feedbackMessageDiv.className = `feedback-message show ${isError ? 'error' : ''}`;
                setTimeout(() => feedbackMessageDiv.classList.remove('show'), 3000);
            }
            
            function debounce(func, delay) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            }

            function exportChartToPDF(chartId, filename, title) {
                const { jsPDF } = window.jspdf;
                const chartElement = document.getElementById(chartId);

                if (!chartElement || (!chartElement.querySelector('svg') && !chartElement.querySelector('canvas'))) {
                    showFeedbackMessage('Gr√°fico n√£o encontrado ou vazio.', true);
                    return;
                }
                
                showFeedbackMessage('Gerando PDF, por favor aguarde...', false);

                // Criar elemento de t√≠tulo tempor√°rio
                const titleElement = document.createElement('h2');
                titleElement.innerText = title.replace(/^[^\w\s]+/, ''); // Remove emoji do in√≠cio
                titleElement.style.textAlign = 'center';
                titleElement.style.fontSize = '24px';
                titleElement.style.fontWeight = 'bold';
                titleElement.style.marginBottom = '20px';
                titleElement.style.color = '#333';
                titleElement.style.fontFamily = 'Inter, sans-serif';
                
                // Adicionar t√≠tulo ao container do gr√°fico antes de capturar
                chartElement.prepend(titleElement);

                html2canvas(chartElement, {
                    scale: 3,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    // Remover t√≠tulo tempor√°rio ap√≥s a captura
                    chartElement.removeChild(titleElement);

                    try {
                        const imgData = canvas.toDataURL('image/png');
                        const pdf = new jsPDF({
                            orientation: 'landscape',
                            unit: 'px',
                            format: [canvas.width, canvas.height]
                        });
                        pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                        pdf.save(filename);
                    } catch(e) {
                        console.error("Erro ao gerar PDF:", e);
                        showFeedbackMessage('Erro ao gerar o PDF.', true);
                    }
                }).catch(err => {
                    // Garantir que o t√≠tulo seja removido mesmo em caso de erro
                    if (chartElement.contains(titleElement)) {
                        chartElement.removeChild(titleElement);
                    }
                    console.error("Erro no html2canvas:", err);
                    showFeedbackMessage('Erro ao capturar o gr√°fico.', true);
                });
            }

            // Chamar a inicializa√ß√£o
            initApp();
        });
    </script>
</body>
</html>