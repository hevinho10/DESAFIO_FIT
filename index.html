<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIT Challenge PRO</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#111827"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FIT Challenge PRO">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/111827/ffffff?text=FIT">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --font-inter: 'Inter', sans-serif;
            
            /* Dark Theme Color Palette */
            --bg-main: #111827; /* Very Dark Blue/Gray */
            --bg-sidebar: #1f2937; /* Dark Slate */
            --bg-card: #1f2937; /* Dark Slate for cards */
            --bg-header: #1f2937;
            --text-light: #f9fafb; /* Almost white */
            --text-dark: #e5e7eb; /* Light Gray */
            --text-muted: #9ca3af; /* Muted Gray */
            --border-color: #374151; /* Darker border */

            --primary-color: #6366f1; /* Indigo */
            --primary-hover: #4f46e5;
            --danger-color: #ef4444; /* Red */
            --danger-hover: #dc2626;
            --success-color: #22c55e; /* Green */
            --success-hover: #16a34a;
            --warning-color: #f59e0b; /* Amber */
            --warning-hover: #d97706;
        }
        html, body { 
            font-family: var(--font-inter); 
            background-color: var(--bg-main); 
            color: var(--text-dark); 
        }
        
        #sidebar { 
            background-color: var(--bg-sidebar);
            transition: transform 0.3s ease-in-out; 
        }
        .sidebar-link { 
            display: flex;
            align-items: center;
            color: var(--text-muted);
            transition: all 0.2s;
        }
        .sidebar-link:hover { 
            background-color: #374151;
            color: var(--text-light);
        }
        .sidebar-link.active { 
            background-color: var(--primary-color); 
            color: white; 
            font-weight: 600; 
        }
        .sidebar-link svg { 
            width: 1.25rem; height: 1.25rem; margin-right: 0.75rem; flex-shrink: 0; 
        }

        /* Modern Table Style */
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th, td { 
            padding: 0.75rem;
            text-align: left; 
            border-bottom: 1px solid var(--border-color); 
            vertical-align: middle; 
        }
        th { 
            background-color: #374151;
            font-weight: 600; 
            color: var(--text-muted); 
            position: sticky; top: 0; z-index: 10; 
            font-size: 0.75rem; 
            text-transform: uppercase; 
            letter-spacing: 0.05em; 
        }
        th:first-child { border-top-left-radius: 0.5rem; }
        th:last-child { border-top-right-radius: 0.5rem; }
        tr:last-child td:first-child { border-bottom-left-radius: 0.5rem; }
        tr:last-child td:last-child { border-bottom-right-radius: 0.5rem; }
        tr:last-child td { border-bottom: none; }
        .leader-row { 
            background-color: rgba(99, 102, 241, 0.1) !important; 
            border-left: 4px solid var(--primary-color); 
        }
        
        .card {
            background-color: var(--bg-card);
            border-radius: 0.75rem;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }
        .feedback-message { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--success-color); color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); opacity: 0; transition: opacity 0.3s; z-index: 1001; }
        .feedback-message.show { opacity: 1; }
        .feedback-message.error { background-color: var(--danger-color); }
        
        .modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease-in-out;
        }
        .modal.show {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content { 
            background-color: #1f2937;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 0.75rem;
            padding: 2rem;
        }
        .close-button { color: #9ca3af; }

        /* Modern Form Elements */
        input, select, textarea {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: var(--text-light);
            border-radius: 0.5rem;
            padding: 0.75rem;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5);
        }
        
        .loader { border: 8px solid #374151; border-top: 8px solid var(--primary-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; }
        .ai-tip-loader { border: 4px solid #374151; border-top: 4px solid var(--primary-color); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .profile-card {
            background-color: var(--bg-card);
            border-radius: 0.75rem;
            border: 1px solid var(--border-color);
            padding: 1.5rem;
        }
        
        .activity-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 0.5rem;
        }
        .activity-cell {
            width: 100%;
            padding-bottom: 100%;
            border-radius: 0.25rem;
            position: relative;
            transition: transform 0.2s;
        }
        .activity-cell:hover {
            transform: scale(1.1);
        }
        .activity-cell-label {
            position: absolute;
            top: -1.2rem;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.65rem;
            color: var(--text-muted);
        }
        .activity-cell.current-week {
            border: 2px solid var(--primary-color);
        }
        .activity-none { background-color: #374151; }
        .activity-partial { background-color: var(--warning-color); }
        .activity-complete { background-color: var(--success-color); }

        .action-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            color: var(--text-dark);
            font-weight: 600;
            background-color: #374151;
            transition: background-color 0.2s ease-in-out;
            border: none;
            cursor: pointer;
            text-align: center;
        }
        
        .action-btn:hover {
            background-color: #4b5563;
        }

        .imc-badge {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            color: white;
        }
        .imc-normal { background-color: var(--success-color); }
        .imc-sobrepeso { background-color: var(--warning-color); }
        .imc-obesidade { background-color: var(--danger-color); }
        .imc-abaixo { background-color: var(--primary-color); }

        .ai-result-box {
            background-color: var(--bg-main);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            min-height: 100px;
            border: 1px solid var(--border-color);
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        /* --- REACTION BUTTON STYLES --- */
        .reaction-btn {
            background-color: #374151;
            border: 1px solid #4b5563;
            border-radius: 9999px;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
            color: var(--text-muted);
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .reaction-btn:hover {
            transform: scale(1.05);
            border-color: var(--primary-color);
        }
        .reaction-btn svg path {
            fill: none;
            stroke: var(--text-muted);
            transition: all 0.2s;
        }
        .reaction-btn:hover svg path {
            stroke: var(--text-light);
        }
        .reaction-btn.reacted {
            background-color: rgba(239, 68, 68, 0.1);
            border-color: var(--danger-color);
            color: var(--danger-color);
        }
        .reaction-btn.reacted svg path {
            fill: var(--danger-color);
            stroke: var(--danger-color);
        }
        .reacted-animation {
            animation: popReaction 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        @keyframes popReaction {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        /* Modal de Visualização de Imagem */
        #imageViewerModal .modal-content {
            background-color: transparent;
            padding: 0;
            width: 90%;
            max-width: 900px;
        }
        #imageViewerModal img {
            max-height: 80vh;
            max-width: 100%;
            object-fit: contain;
        }
        
    
/* --- Enhanced summary cards (leader / weekly / monthly / days) --- */
#leaderBox, #weeklyHighlightBox, #monthlyHighlightBox, #daysRemainingBox{
  background-image: linear-gradient(145deg, rgba(255,255,255,.02), rgba(0,0,0,.12));
}
#leaderBox{ box-shadow: inset 0 0 0 1px rgba(34,197,94,.25); }         /* green */
#weeklyHighlightBox{ box-shadow: inset 0 0 0 1px rgba(245,158,11,.25); }/* amber */
#monthlyHighlightBox{ box-shadow: inset 0 0 0 1px rgba(234,179,8,.25); }/* yellow */
#daysRemainingBox{ box-shadow: inset 0 0 0 1px rgba(59,130,246,.25); }  /* blue */

/* Table zebra & borders */
.table-zebra tbody tr:nth-child(odd){ background-color:#1f2937; }  /* gray-800 */
.table-zebra tbody tr:nth-child(even){ background-color:#111827; } /* gray-900 */
.table-zebra tbody tr td{ border-bottom:1px solid #374151; }       /* gray-700 */
.table-zebra thead th{ background-color:#0f172a; }                 /* slate-900 */

/* Progress bar with label */
.progress-track{ background-color:#4b5563; border-radius:9999px; height:10px; position:relative; }
.progress-fill{ height:10px; border-radius:9999px;  background: linear-gradient(90deg, #6a5acd, #00cfff); box-shadow: none; }

.progress-label{
  position:absolute; right:6px; top:50%; transform:translateY(-50%);
  font-size:10px; font-weight:700; color:white; text-shadow: 0 1px 2px rgba(0,0,0,.45);
}


/* --- Ranking table spacing & responsive columns --- */
.rank-table thead th, .rank-table tbody td { padding: .55rem .75rem; }
@media (min-width: 1024px){ /* lg+ desktop: mais respiro */
  .rank-table thead th, .rank-table tbody td { padding: .9rem .9rem; }
}
/* Mobile: esconder colunas pesadas e deixar layout leve */
@media (max-width: 767px){
  .rank-table .col-progress,
  .rank-table .col-percent,
  .rank-table .col-weightpts,
  .rank-table .col-activitypts { display: none; }
  .rank-table .col-name img { width: 2rem; height: 2rem; }    /* 32px no mobile */
  .rank-table .col-total { text-align: right; }
}
/* Mantém a zebra mesmo com colunas ocultas */
.rank-table tbody tr:nth-child(odd){ background-color:#1f2937; }
.rank-table tbody tr:nth-child(even){ background-color:#111827; }
.rank-table tbody tr td{ border-bottom:1px solid #374151; }
.rank-table thead th{ background-color:#0f172a; }


/* Top-3 badge next to name */
.top-badge{ font-size:1rem; line-height:1; vertical-align:middle; margin-left:.35rem; }
@media (max-width: 767px){ .top-badge{ font-size:.95rem; } }


/* --- Reports tabs --- */
.reports-tabs{ display:flex; gap:.5rem; flex-wrap:wrap; }
.reports-tabs button{
  padding:.5rem .9rem; border:1px solid #374151; border-radius:9999px;
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.06));
  color:var(--text-light); font-weight:600;
}
.reports-tabs button.active{ border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(99,102,241,.15) inset; }

/* --- Sparkline list (mobile) --- */
.sparkline-row{ display:flex; align-items:center; gap:.75rem; padding:.5rem .25rem; }
.sparkline-row .name{ min-width:120px; color: var(--text-light); font-weight:600; }
.sparkline{ width: 100%; height: 42px; }
@media (max-width: 767px){
  #mainWeightChartWrapper, #trendChartWrapper, #percentageLossChartContainer, #totalActivityChartContainer { display:none; }
  #mobileSparklines{ display:block; }
}
@media (min-width: 768px){
  #mobileSparklines{ display:none; }
}

</style>

<style>
:root{
  --bg-card:#0f172a; --bg-elev:#111827; --line:#26324a; --txt:#e5e7eb; --txt-dim:#9ca3af;
  --brand:#6366f1; --brand-2:#22d3ee; --focus:#7dd3fc; --danger:#ef4444; --ok:#22c55e;
  --ring-shadow: 0 0 0 4px rgba(125,211,252,.20); --radius:14px;
}
.card-modern{background:linear-gradient(180deg,rgba(17,24,39,.9),rgba(15,23,42,.9));
  border:1px solid var(--line);border-radius:var(--radius);
  box-shadow:0 10px 30px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.03);
}
.ui-label{display:block;font-size:.9rem;color:var(--txt);margin:0 0 .35rem 2px;letter-spacing:.2px;}
.ui-input,.ui-select,.ui-textarea{width:100%;color:var(--txt);background:rgba(255,255,255,.03);
  border:1px solid var(--line);border-radius:12px;padding:.70rem .9rem;outline:none;
  transition:border-color .2s,box-shadow .2s,background .2s,transform .06s;
  box-shadow:inset 0 1px 0 rgba(255,255,255,.02);
}
.ui-input::placeholder,.ui-textarea::placeholder{color:var(--txt-dim);}
.ui-input:hover,.ui-select:hover,.ui-textarea:hover{border-color:#2f3d5c;background:rgba(255,255,255,.05);}
.ui-input:focus,.ui-select:focus,.ui-textarea:focus{border-color:var(--focus);box-shadow:var(--ring-shadow);}
.ui-input:disabled,.ui-select:disabled,.ui-textarea:disabled{opacity:.6;cursor:not-allowed;}
.ui-select{appearance:none;
  background-image:linear-gradient(45deg,transparent 50%,var(--txt) 50%),
                   linear-gradient(135deg,var(--txt) 50%,transparent 50%);
  background-position:calc(100% - 18px) calc(1rem),calc(100% - 13px) calc(1rem);
  background-size:5px 5px,5px 5px;background-repeat:no-repeat;padding-right:2rem;
}
.ui-textarea{min-height:110px;resize:vertical;}
.is-invalid{border-color:var(--danger)!important;}
.is-invalid:focus{box-shadow:0 0 0 4px rgba(239,68,68,.18)!important;}
.ui-check{--size:18px;appearance:none;width:var(--size);height:var(--size);
  border:1px solid var(--line);border-radius:6px;background:rgba(255,255,255,.03);
  display:inline-grid;place-content:center;transition:.2s;border-color,.2s box-shadow,.2s background;
  cursor:pointer;position:relative;
}
.ui-check:focus{box-shadow:var(--ring-shadow);}
.ui-check:checked{border-color:var(--brand);
  background:radial-gradient(100% 100% at 100% 0%,var(--brand) 0%,var(--brand-2) 100%);
}
.ui-check:checked::after{content:"";width:10px;height:10px;border-radius:3px;background:rgba(255,255,255,.95);}
.ui-radio{--size:18px;appearance:none;width:var(--size);height:var(--size);border:1px solid var(--line);
  border-radius:999px;background:rgba(255,255,255,.03);display:inline-grid;place-content:center;
  transition:.2s;cursor:pointer;
}
.ui-radio:focus{box-shadow:var(--ring-shadow);}
.ui-radio:checked{border-color:var(--brand);background:rgba(99,102,241,.15);}
.ui-radio:checked::after{content:"";width:10px;height:10px;border-radius:999px;background:var(--brand);}
.btn{--btn-bg:rgba(255,255,255,.04);--btn-brd:var(--line);--btn-txt:var(--txt);
  display:inline-flex;align-items:center;gap:.55rem;border:1px solid var(--btn-brd);
  border-radius:12px;padding:.70rem 1rem;font-weight:600;color:var(--btn-txt);
  background:var(--btn-bg);transition:transform .06s,box-shadow .2s,background .2s,border-color .2s;
  box-shadow:0 6px 20px rgba(0,0,0,.25),inset 0 1px 0 rgba(255,255,255,.03);
}
.btn:hover{transform:translateY(-1px);border-color:#3a4a6b;background:rgba(255,255,255,.06);}
.btn:active{transform:translateY(1px);} .btn:focus{outline:none;box-shadow:var(--ring-shadow);}
.btn-primary{--btn-bg:linear-gradient(135deg,var(--brand),var(--brand-2));--btn-brd:transparent;color:#0b1220;
  box-shadow:0 10px 25px rgba(99,102,241,.25);
}
.btn-primary:hover{filter:saturate(1.05) brightness(1.02);}
.btn-secondary{--btn-bg:rgba(99,102,241,.10);--btn-brd:rgba(99,102,241,.35);color:var(--txt);}
.btn-ghost{--btn-bg:transparent;--btn-brd:transparent;color:var(--txt-dim);}
.btn-danger{--btn-bg:rgba(239,68,68,.14);--btn-brd:rgba(239,68,68,.5);color:#fecaca;}
.btn-sm{padding:.55rem .8rem;border-radius:10px;font-size:.92rem;}
.btn-lg{padding:.9rem 1.2rem;border-radius:14px;font-size:1.05rem;}
.btn .icon{width:18px;height:18px;display:inline-block;}
.alert{border:1px solid var(--line);
  background:linear-gradient(180deg,rgba(34,197,94,.08),rgba(34,197,94,.04));
  color:#86efac;border-radius:12px;padding:.8rem 1rem;
}
.alert-info{background:linear-gradient(180deg,rgba(99,102,241,.10),rgba(99,102,241,.04));color:#c7d2fe;}
.alert-warn{background:linear-gradient(180deg,rgba(245,158,11,.12),rgba(245,158,11,.05));color:#fcd34d;}
</style>


<style>

/* ====== Paleta e tokens ====== */
:root{
  --bg:#0b1220;
  --bg-2:#0f172a;
  --ink:#e5e7eb;
  --ink-dim:#a3aab7;
  --muted:#2a3446;
  --accent-1:#7c3aed;
  --accent-2:#06b6d4;
  --success:#22c55e;
  --danger:#ef4444;
  --radius:14px;
  --gap:14px;
}

/* ====== Base ====== */
html,body{height:100%}
body{
  margin:0;
  color:var(--ink);
  background:linear-gradient(180deg, #0b1220, #0a0f1b 35%, #0b1220 100%);
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
}
.container{max-width:980px; margin:32px auto; padding:0 16px}
section, .card{
  background:var(--bg-2);
  border:1px solid rgba(255,255,255,.04);
  border-radius:var(--radius);
  padding:var(--gap);
}
h1,h2,h3{ letter-spacing:.3px; margin:0 0 10px }

/* ====== Botões minimalistas ====== */
button, .btn{
  appearance:none;
  display:inline-flex; align-items:center; justify-content:center;
  gap:8px; padding:10px 16px; border-radius:12px;
  border:1px solid transparent; font-weight:600;
  background:transparent; color:var(--ink);
  transition:transform .15s ease, border-color .15s ease, background .15s ease, opacity .15s ease;
  cursor:pointer;
}
button:active, .btn:active{ transform:translateY(1px) }

.btn-primary, button.primary{
  background:linear-gradient(90deg, var(--accent-1), var(--accent-2));
  color:#0b1220; border:none;
}
.btn-primary:hover, button.primary:hover{ opacity:.9 }
.btn-primary:disabled, button.primary:disabled{ opacity:.6; cursor:not-allowed }

.btn-secondary, button.secondary{
  background:#1a2333; color:var(--ink);
  border:1px solid #253149;
}
.btn-secondary:hover, button.secondary:hover{ border-color:#31405a }

.btn-ghost, button.ghost{
  background:transparent; color:var(--ink);
  border:1px solid #253149;
}
.btn-ghost:hover, button.ghost:hover{ background:#131a29 }

.btn-danger, button.danger{
  background:transparent; color:#fca5a5; border:1px solid rgba(239,68,68,.45);
}
.btn-danger:hover, button.danger:hover{ background:rgba(239,68,68,.08) }

button svg, .btn svg{ width:18px; height:18px }

/* ====== Inputs minimalistas ====== */
input, select, textarea{
  background:#0d1423; color:var(--ink);
  border:1px solid #233047;
  border-radius:12px; padding:10px 12px; outline:none;
  width:100%;
}
input::placeholder, textarea::placeholder{ color:var(--ink-dim) }
input:focus, select:focus, textarea:focus{
  border-color:#33507a;
}

/* ====== Tabelas compactas ====== */
table{ width:100%; border-collapse:collapse }
th, td{ padding:10px 12px }
th{ text-align:left; color:var(--ink-dim); font-weight:600 }
tr + tr td{ border-top:1px solid var(--muted) }

/* ====== Badges ====== */
.badge{
  display:inline-block; padding:6px 10px; border-radius:999px;
  font-weight:600; font-size:.8rem; background:#141c2c; border:1px solid #253149; color:var(--ink);
}
.badge--ok{ background:rgba(34,197,94,.12); border-color:rgba(34,197,94,.35); color:#86efac }
.badge--warn{ background:rgba(234,179,8,.12); border-color:rgba(234,179,8,.35); color:#fde68a }
.badge--err{ background:rgba(239,68,68,.12); border-color:rgba(239,68,68,.35); color:#fca5a5 }

/* ====== Progresso ====== */
.progress{ width:100%; height:10px; position:relative; }
.progress-track{
  width:100%; height:10px; border-radius:9999px;
  background:#2a3444;
}
.progress-fill{
  height:10px; border-radius:9999px;
  background:linear-gradient(90deg, var(--accent-1), var(--accent-2));
  transition:width .35s ease;
}
.progress-label{ font-size:.75rem; font-weight:700; color:#cdd3dd; margin-top:6px }

/* ====== Navegação lateral (exemplo) ====== */
.nav{
  display:flex; gap:10px; flex-wrap:wrap; margin-bottom:16px
}
.nav-item{
  display:flex; align-items:center; gap:10px;
  padding:10px 12px; border-radius:12px; color:var(--ink-dim);
  border:1px solid #253149; background:#0f1626;
}
.nav-item.active{
  background:#111a2a; color:var(--ink);
  border:1px solid #243149;
}

/* ===== demo layout classes ===== */
.grid{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:16px}
@media (max-width:800px){ .grid{grid-template-columns:1fr} }
.footer{opacity:.7; font-size:.85rem; margin-top:18px}

</style>

<style>

/* ====== Melhorias: Histórico de Atividades ====== */
.profile-card{
  background:#0f1626;
  border:1px solid rgba(255,255,255,.05);
  border-radius:16px;
  padding:16px;
  transition:transform .18s ease, box-shadow .18s ease, border-color .18s ease;
}
.profile-card:hover{
  transform: translateY(-2px);
  box-shadow: 0 10px 20px rgba(0,0,0,.25);
  border-color: rgba(255,255,255,.08);
}
.profile-card img{
  border-radius:9999px;
  border:2px solid var(--accent-2);
  box-shadow: 0 0 0 2px rgba(6,182,212,.15);
}

.activity-grid{
  display:grid;
  grid-template-columns: repeat(12, 42px);
  gap:12px;
  margin-top:12px;
}
@media (max-width: 900px){
  .activity-grid{ grid-template-columns: repeat(6, 42px); }
}
@media (max-width: 520px){
  .activity-grid{ grid-template-columns: repeat(4, 42px); }
}

.activity-cell{
  width:42px; height:42px; border-radius:12px;
  background:#1e2535;
  border:1px dashed #2f3547;
  display:flex; align-items:center; justify-content:center;
  position:relative;
  transition: transform .18s ease, box-shadow .18s ease, outline-color .18s ease;
  will-change: transform;
}
.activity-cell:hover{ transform: scale(1.05); box-shadow: 0 6px 14px rgba(0,0,0,.25); }

/* Rótulo do número da semana (pequeno, no topo) */
.activity-cell-label{
  position:absolute; top:-18px; left:0;
  font-size:.65rem; color:#9aa3b2; font-weight:600;
}

/* Estados */
.activity-none{ background:#1e2535; color:#6b7280; }
.activity-partial{ background: linear-gradient(135deg, #facc15, #f59e0b); color:#0b1220; }
.activity-complete{ background: linear-gradient(135deg, #22c55e, #16a34a); color:#0b1220; }

/* Semana atual com destaque discreto */
.current-week{ outline:2px solid var(--accent-2); outline-offset:2px; }

/* Tooltip nativo mais legível em dark (opcional) */
[title] { cursor: help; }

/* Legenda compacta */
.activity-legend{
  display:flex; gap:16px; align-items:center; justify-content:center;
  margin: 0 0 14px 0; font-size:.8rem; color:#a3aab7;
}
.activity-legend .dot{
  width:14px; height:14px; border-radius:4px; display:inline-block; margin-right:6px;
  vertical-align: middle;
}
.activity-legend .none { background:#1e2535; border:1px dashed #2f3547; }
.activity-legend .partial { background: linear-gradient(135deg, #facc15, #f59e0b); }
.activity-legend .complete { background: linear-gradient(135deg, #22c55e, #16a34a); }


</style>

<style>

/* === OVERRIDE: estado vazio sem borda pontilhada, com look futurista/minimalista === */
.activity-none{
  background: linear-gradient(145deg, #1c2333, #111827) !important;
  border: 1px solid rgba(255,255,255,0.05) !important;
  color: #6b7280 !important;
}
.activity-none:hover{
  background: linear-gradient(145deg, #242c3f, #131a2a) !important;
  border-color: rgba(255,255,255,0.08) !important;
}

</style>

<style>

/* === OVERRIDE v3: blocos preenchidos sem borda, com look minimalista === */
.activity-complete {
  background: linear-gradient(135deg, #22c55e, #16a34a) !important;
  border: none !important;
  border-radius: 12px !important;
  box-shadow: inset 0 0 4px rgba(0,0,0,0.25) !important;
}
.activity-partial {
  background: linear-gradient(135deg, #facc15, #f59e0b) !important;
  border: none !important;
  border-radius: 12px !important;
  box-shadow: inset 0 0 4px rgba(0,0,0,0.25) !important;
}

</style>

<style>

/* === LOGIN: visual minimalista com acentos roxo→ciano === */
#loginScreen{
  background:
    radial-gradient(1200px 600px at 10% -10%, rgba(124,58,237,0.12), transparent 60%),
    radial-gradient(1200px 600px at 110% 10%, rgba(6,182,212,0.12), transparent 60%),
    #0b1220 !important;
}
#loginScreen > div{
  background: #0f172a !important;
  border: 1px solid rgba(255,255,255,0.06) !important;
  box-shadow: 0 20px 60px rgba(0,0,0,.45) !important;
}
#loginScreen h1{
  font-weight: 800;
  letter-spacing: .3px;
  margin: 0;
  background: linear-gradient(90deg, #e5e7eb 40%, #9aa3b2);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
}
#loginScreen h1 .brand-accent{
  background: linear-gradient(90deg, #7c3aed, #06b6d4);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
}
#loginScreen p{ color:#a3aab7 !important; }

/* inputs */
#loginScreen input{
  background:#0d1423 !important;
  border:1px solid #233047 !important;
  color:#e5e7eb !important;
  border-radius: 12px !important;
  padding:12px 14px !important;
  box-shadow: none !important;
}
#loginScreen input::placeholder{ color:#7f8796 !important; }
#loginScreen input:focus{
  outline: none !important;
  border-color: #33507a !important;
  box-shadow: 0 0 0 3px rgba(6,182,212,0.22) !important;
}

/* botão entrar */
#loginScreen button[type="submit"]{
  background: linear-gradient(90deg, #7c3aed, #06b6d4) !important;
  color: #0b1220 !important;
  border: none !important;
  border-radius: 12px !important;
  font-weight: 700 !important;
  padding: 12px 16px !important;
  transition: transform .15s ease, opacity .15s ease !important;
}
#loginScreen button[type="submit"]:hover{ opacity:.92 !important; }
#loginScreen button[type="submit"]:active{ transform: translateY(1px) !important; }

</style>
</head>
<body class="bg-gray-900">

    <div id="loginScreen" class="flex items-center justify-center min-h-screen bg-gray-900 p-4">
        <div class="bg-gray-800 p-8 sm:p-10 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700">
            <div class="text-center mb-10">
                <h1 class="text-4xl font-extrabold text-white">FIT Challenge <span class="brand-accent">PRO</span></h1>
                <p class="text-gray-400 mt-2">Acesse para acompanhar o desafio</p>
            </div>
            <form id="loginForm">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-300 mb-1">Usuário</label>
                    <input type="text" id="username" placeholder="Seu usuário" class="w-full" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-300 mb-1">Senha</label>
                    <input type="password" id="password" placeholder="Sua senha" class="w-full" required>
                </div>
                <p id="loginError" class="text-red-500 text-sm italic mb-4 hidden text-center">Usuário ou senha inválidos.</p>
                <button type="submit" style="background-color: var(--primary-color);" class="hover:opacity-90 text-white font-bold py-3 px-6 rounded-lg shadow-md transition w-full">Entrar</button>
            </form>
        </div>
    </div>
    
    <div id="loadingIndicator" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex flex-col items-center justify-center z-50">
        <div class="loader"></div>
        <p class="mt-4 text-lg font-semibold text-gray-300">Carregando dados...</p>
    </div>

    <div id="app" class="hidden flex h-screen font-sans">
        <aside id="sidebar" class="w-64 flex-shrink-0 flex flex-col fixed lg:relative h-full z-30 transform -translate-x-full lg:translate-x-0">
            <div class="px-6 py-4 border-b border-gray-700">
                <h1 class="text-2xl font-bold text-white">FIT <span class="brand-accent">PRO</span></h1>
            </div>
            <nav id="sidebarNav" class="flex-1 px-4 py-4 space-y-2 overflow-y-auto"></nav>
            <div class="px-4 py-4 border-t border-gray-700">
                <input type="text" id="searchParticipantInput" placeholder="Buscar participante..." class="w-full">
            </div>
        </aside>

        <div id="sidebar-overlay" class="hidden lg:hidden fixed inset-0 bg-black opacity-50 z-20"></div>

        <div class="flex-1 flex flex-col overflow-hidden">
            <header id="header" class="bg-gray-800 border-b border-gray-700 p-4 flex justify-between items-center z-10">
                <button id="mobileMenuBtn" class="lg:hidden text-gray-400">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-16 6h16"></path></svg>
                </button>
                <h2 id="pageTitle" class="text-xl font-semibold text-white"></h2>
                <div class="flex items-center gap-4">
                   <div id="header-action-buttons" class="hidden sm:flex items-center gap-2 flex-wrap"></div>
                   <button id="logoutBtn" style="background-color: var(--danger-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm">Sair</button>
                </div>
            </header>

            <main class="flex-1 overflow-x-hidden overflow-y-auto bg-gray-900 p-6">
                <div id="summary-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
                    <div id="leaderBox" class="card"></div>
                    <div id="weeklyHighlightBox" class="card"></div>
                    <div id="monthlyHighlightBox" class="card"></div>
                    <div id="daysRemainingBox" class="card"></div>
                </div>
                
                <div id="dynamic-content">
                </div>
            </main>
        </div>
    </div>

    <div id="feedbackMessage" class="feedback-message"></div>
    <div id="participantModal" class="modal"></div>
    <div id="deleteConfirmModal" class="modal"></div>
    <div id="imageViewerModal" class="modal">
        <div class="modal-content text-center flex flex-col items-center">
            <div class="flex justify-end w-full mb-2">
                <button type="button" class="close-button text-white" onclick="closeModal(document.getElementById('imageViewerModal'))">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
                </button>
            </div>
            <img id="modalImage" src="" alt="Imagem em tela cheia">
        </div>
    </div>

    <script>
        // --- PWA Service Worker (Placeholder) ---
        if ('serviceWorker' in navigator) {
            const manifest = {
                "name": "FIT Challenge PRO", "short_name": "FIT PRO", "start_url": ".", "display": "standalone",
                "background_color": "#111827", "theme_color": "#4f46e5", "description": "Acompanhamento do FIT Challenge.",
                "icons": [{ "src": "https://placehold.co/192x192/4f46e5/ffffff?text=FIT", "sizes": "192x192", "type": "image/png" }]
            };
            const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(manifestBlob);
            document.querySelector('link[rel="manifest"]').setAttribute('href', manifestURL);
        }

        // Esta função agora está no escopo global para que o onclick no HTML possa acessá-la.
        function closeModal(modalElement) {
            modalElement.classList.remove('show');
            document.body.style.overflow = 'auto';
        }

    </script>
    
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- CONFIGURAÇÃO DO SUPABASE ---
            const SUPABASE_URL = 'https://wkvwrtwovcfnvfgleslq.supabase.co';
            const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndrdndydHdvdmNmbnZmZ2xlc2xxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzNTE2MTQsImV4cCI6MjA2NzkyNzYxNH0.osy_C1SsPJ7t8BJlri7DpVDJU64S_IfRzy9KEBP9VMY';
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

            // --- CONFIGURAÇÕES E CONSTANTES DO DESAFIO ---
            const ADMIN_USER = { username: 'admin', password: 'admin' };
            let CHALLENGE_START_DATE = new Date('2025-07-07T00:00:00');
            let CHALLENGE_END_DATE = new Date('2025-10-07T23:59:59');
            const MAX_WEEKS = 12;
            const MIN_ACTIVITIES_FOR_VALID_WEEK = 3;
            const MAX_ACTIVITY_POINTS = 50;
            const ACTIVITY_TYPES = ['Musculação', 'Corrida', 'Caminhada', 'Natação', 'Yoga', 'Dança', 'Ciclismo', 'Outro'];
            
            // --- LINKS DE NAVEGAÇÃO COM ACESSO BASEADO EM FUNÇÕES ---
            const NAV_LINKS = [
    { id: 'dailyLog', text: 'Diário de Bordo', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>', roles: ['participant'] },
    { id: 'editProfile', text: 'Editar Perfil', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5h2m-1 14v-7m-7 7a2 2 0 01-2-2V7a2 2 0 012-2h14a2 2 0 012 2v10a2 2 0 01-2 2H5z"></path></svg>', roles: ['participant'] },
    
                { id: 'myProfile', text: 'Meu Perfil', icon: '<svg viewBox="0 0 24 24"></svg>', roles: [] },
                { id: 'ranking', text: 'Ranking Geral', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>', roles: ['admin', 'participant'] },
                { id: 'activityFeed', text: 'Mural', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"></path></svg>', roles: ['admin', 'participant'] },
                { id: 'participants', text: 'Participantes', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>', roles: ['admin'] },
                { id: 'aiCenter', text: 'Central de IA', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>', roles: ['admin', 'participant'] },
                { id: 'healthData', text: 'Ficha de Saúde', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.007 12.007 0 002.944 12a12.007 12.007 0 003.04 8.618A11.955 11.955 0 0112 21.056a11.955 11.955 0 018.618-3.04A12.007 12.007 0 0021.056 12a12.007 12.007 0 00-3.04-8.618z"></path></svg>', roles: ['admin', 'participant'] },
                { id: 'weeklySummary', text: 'Resumo Semanal', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>', roles: ['admin', 'participant'] },
                { id: 'activityLog', text: 'Histórico de Atividades', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>', roles: ['admin', 'participant'] },
                { id: 'coachVirtual', text: 'Coach Virtual', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>', roles: ['admin', 'participant'] },
                { id: 'individualEvolution', text: 'Evolução Individual', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4z"></path></svg>', roles: ['admin', 'participant'] },
                { id: 'groupEvolution', text: 'Evolução do Grupo', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>', roles: ['admin', 'participant']},
                { id: 'comparison', text: 'Comparativo', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>', roles: ['admin', 'participant'] },
                { id: 'rules', text: 'Regras', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>', roles: ['admin', 'participant'] },
                { id: 'configuracoes', text: 'Configurações', icon: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>', roles: ['admin'] },
                { id: 'participantProfile', text: 'Perfil do Participante', icon: '', hidden: true, roles: ['admin'] }
            ];
            
            // --- ESTADO DA APLICAÇÃO ---
            let currentUser = null;
            let participants = [];
            let reactions = [];
            let weeklyPointsWinnerName = null;
            let rankingSortConfig = { key: 'totalPoints', direction: 'desc' };
            let currentProfileParticipantId = null;
            let showTopN = null; // ranking limiter (null = all)
            let currentViewId = null;

            // --- ELEMENTOS DO DOM ---
            const loginScreen = document.getElementById('loginScreen');
            const appContainer = document.getElementById('app');
            const feedbackMessageDiv = document.getElementById('feedbackMessage');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const dynamicContentContainer = document.getElementById('dynamic-content');
            const pageTitle = document.getElementById('pageTitle');
            const headerActionButtons = document.getElementById('header-action-buttons');
            
            // --- INICIALIZAÇÃO E AUTENTICAÇÃO ---
            function initApp() {
                loadChallengeConfig();
                setupEventListeners();
                checkLoginState();
            }

            async function reloadData() {
                loadingIndicator.classList.remove('hidden');

                const { data: participantsData, error: pError } = await supabase.from('participants').select('*').order('name');
                const { data: reactionsData, error: rError } = await supabase.from('reactions').select('*');

                if (pError || rError) {
                    showFeedbackMessage('Erro ao recarregar os dados.', true);
                    loadingIndicator.classList.add('hidden');
                    return;
                }
                
                participants = participantsData.map(p => ({
                    ...p,
                    semanas_validas: (p.semanas_validas && Array.isArray(p.semanas_validas)) ? p.semanas_validas : Array.from({ length: 12 }, () => []),
                    weight_history: (p.weight_history || []).map(entry => ({ ...entry, is_public: entry.is_public !== undefined ? entry.is_public : true })),
                    measurements_history: p.measurements_history || [],
                    health_data: p.health_data || {},
                }));
                reactions = reactionsData;
                
                loadingIndicator.classList.add('hidden');
                updateCurrentView();
            }

            function loadChallengeConfig() {
                const config = localStorage.getItem('challengeConfig');
                if (config) {
                    const { start, end } = JSON.parse(config);
                    CHALLENGE_START_DATE = new Date(start);
                    CHALLENGE_END_DATE = new Date(end);
                }
            }

            function saveChallengeConfig() {
                localStorage.setItem('challengeConfig', JSON.stringify({
                    start: CHALLENGE_START_DATE.toISOString(),
                    end: CHALLENGE_END_DATE.toISOString()
                }));
            }

            async function loadDataAndLogin(user) {
                loadingIndicator.classList.remove('hidden');
                appContainer.classList.add('opacity-50', 'pointer-events-none');

                const { data: participantsData, error: participantsError } = await supabase.from('participants').select('*').order('name');
                
                if (participantsError) {
                    console.error('Error loading participants data:', participantsError);
                    showFeedbackMessage('Erro ao carregar dados do banco.', true);
                    handleLogout();
                    return;
                }

                participants = participantsData.map(p => ({
                    ...p,
                    semanas_validas: (p.semanas_validas && Array.isArray(p.semanas_validas)) ? p.semanas_validas : Array.from({ length: 12 }, () => []),
                    weight_history: (p.weight_history || []).map(entry => ({ ...entry, is_public: entry.is_public !== undefined ? entry.is_public : true })),
                    measurements_history: p.measurements_history || [],
                    health_data: p.health_data || {},
                }));

                const { data: reactionsData, error: reactionsError } = await supabase.from('reactions').select('*');
                if (reactionsError) {
                    console.warn("Não foi possível carregar as reações. Isso é normal se a tabela ainda não existir.", reactionsError.message);
                    reactions = []; 
                } else {
                    reactions = reactionsData;
                }

                loadingIndicator.classList.add('hidden');
                appContainer.classList.remove('opacity-50', 'pointer-events-none');
                
                currentUser = user;
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                loginScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
                appContainer.classList.add('flex');
                renderSidebarNav();
                
                calculateWeeklyWinners();
                updateSummaryBoxes();
                
                if (currentUser.role === 'admin') { showSection('ranking'); } else { currentProfileParticipantId = currentUser.participantId; showSection('dailyLog'); }
            }

            function checkLoginState() {
                const storedUser = sessionStorage.getItem('currentUser');
                if (storedUser) {
                    const user = JSON.parse(storedUser);
                    loadDataAndLogin(user);
                } else {
                    loginScreen.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                    appContainer.classList.remove('flex');
                    loadingIndicator.classList.add('hidden');
                }
            }

            async function handleLogin(e) {
                e.preventDefault();
                const username = document.getElementById('username').value.trim();
                const password = document.getElementById('password').value;
                const loginError = document.getElementById('loginError');
                loginError.classList.add('hidden');

                if (username === ADMIN_USER.username && password === ADMIN_USER.password) {
                    const user = { username: ADMIN_USER.username, role: 'admin', participantId: null };
                    await loadDataAndLogin(user);
                    return;
                }

                const { data, error } = await supabase.from('participants').select('*').eq('username', username);

                if (error || !data || data.length === 0) {
                    loginError.classList.remove('hidden');
                    return;
                }
                
                const participant = data[0];
                if (participant.password === password) {
                    const user = { username: participant.username, role: 'participant', participantId: participant.id };
                    await loadDataAndLogin(user);
                } else {
                    loginError.classList.remove('hidden');
                }
            }

            function handleLogout() {
                currentUser = null;
                sessionStorage.removeItem('currentUser');
                participants = [];
                loginScreen.classList.remove('hidden');
                appContainer.classList.add('hidden');
                appContainer.classList.remove('flex');
            }

            // --- CONFIGURAÇÃO DE LISTENERS DE EVENTOS ---
            function setupEventListeners() {
                document.getElementById('loginForm').addEventListener('submit', handleLogin);
                document.getElementById('logoutBtn').addEventListener('click', handleLogout);
                document.getElementById('searchParticipantInput').addEventListener('keyup', debounce(updateCurrentView, 300));
                
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');
                document.getElementById('mobileMenuBtn').addEventListener('click', () => {
                    sidebar.classList.remove('-translate-x-full');
                    overlay.classList.remove('hidden');
                });
                overlay.addEventListener('click', () => {
                    sidebar.classList.add('-translate-x-full');
                    overlay.classList.add('hidden');
                });

                appContainer.addEventListener('click', handleMainContentClick);
                
                dynamicContentContainer.addEventListener('change', e => {
                    if (e.target.matches('.comparison-checkbox') || e.target.matches('input[name="comparisonMetric"]')) {
                        updateComparisonChart();
                    }
                });
            }
            
            function renderSidebarNav() {
                const navContainer = document.getElementById('sidebarNav');
                navContainer.innerHTML = '';

                NAV_LINKS.forEach(link => {
                    if (link.hidden || !currentUser || !link.roles.includes(currentUser.role)) return;

                    const navItem = document.createElement('a');
                    navItem.href = '#';
                    navItem.className = 'sidebar-link text-gray-300';
                    navItem.dataset.section = link.id;
                    navItem.innerHTML = `${link.icon}<span>${link.text}</span>`;
                    
                    navItem.addEventListener('click', e => {
                        e.preventDefault();
                        if (link.id === 'myProfile') {
                            currentProfileParticipantId = currentUser.participantId;
                        }
                        showSection(link.id);
                        if (window.innerWidth < 1024) {
                            document.getElementById('sidebar').classList.add('-translate-x-full');
                            document.getElementById('sidebar-overlay').classList.add('hidden');
                        }
                    });
                    navContainer.appendChild(navItem);
                });
            }

            function handleMainContentClick(e) {
                const targetElement = e.target;
                const button = targetElement.closest('button[data-action]');
                const link = targetElement.closest('a[data-action]');
                const th = targetElement.closest('th.sortable');
                const image = targetElement.closest('[data-action="view-image"]');
            
                if (th) {
                    const sortKey = th.dataset.sortKey;
                    if (rankingSortConfig.key === sortKey) {
                        rankingSortConfig.direction = rankingSortConfig.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        rankingSortConfig.key = sortKey;
                        rankingSortConfig.direction = 'desc';
                    }
                    showSection('ranking');
                    return;
                }
                
                if (image) {
                    const imageUrl = image.dataset.url;
                    if (imageUrl) {
                        openImageViewerModal(imageUrl);
                    }
                    return;
                }

                const interactiveTarget = button || link;
                if (!interactiveTarget) return;

                const action = interactiveTarget.dataset.action;
                const id = interactiveTarget.dataset.id;
                const name = interactiveTarget.dataset.name;

                switch(action) {
        case 'view-daily-log':
            e.preventDefault();
            currentProfileParticipantId = id;
            showSection(currentUser.role === 'admin' ? 'adminViewDailyLog' : 'dailyLog');
            break;
        case 'edit-profile':
            e.preventDefault();
            currentProfileParticipantId = id;
            showSection(currentUser.role === 'admin' ? 'adminViewEditProfile' : 'editProfile');
            break;
        case 'save-profile':
            handleSaveProfile(id);
            break;
        case 'go-to-participants':
            showSection('participants');
            break;
    
                    case 'open-add-modal': openParticipantModal(); break;
                    case 'open-edit-modal': openParticipantModal(id); break;
                    case 'open-delete-modal': 
                        openConfirmModal(`Tem certeza que deseja excluir <strong>${name}</strong>? Esta ação não pode ser desfeita.`, () => {
                            supabase.from('participants').delete().eq('id', id)
                                .then(({ error }) => {
                                    if (error) showFeedbackMessage('Erro ao excluir participante.', true);
                                    else { showFeedbackMessage("Participante excluído com sucesso!"); loadDataAndLogin(currentUser); }
                                    closeModal(document.getElementById('deleteConfirmModal'));
                                });
                        });
                        break;
                    case 'view-profile': e.preventDefault(); currentProfileParticipantId = id; showSection('participantProfile'); break;
                    case 'go-to-participants': e.preventDefault(); showSection('participants'); break;
                    case 'generate-report': exportDetailsToPDF(id); break;
                    case 'ai-coach': getAICoachingTip(id); break;
                    case 'update-weight': handleUpdateWeight(id); break;
                    case 'detect-weight-ai': detectWeightFromImage(id); break;
                    case 'delete-weight-entry': 
                        const entryDate = interactiveTarget.dataset.entryDate;
                        openConfirmModal(`Tem certeza que deseja excluir este registro de peso de ${name} (${new Date(entryDate).toLocaleDateString('pt-BR')})?`, () => handleDeleteWeightEntryConfirmed(id, entryDate));
                        break;
                    case 'add-activity': handleAddActivity(id); break;
                    case 'delete-activity': 
                        const week = interactiveTarget.dataset.week;
                        const activityId = interactiveTarget.dataset.activityId;
                        openConfirmModal(`Tem certeza que deseja excluir esta atividade de ${name} (Semana ${parseInt(week) + 1})?`, () => handleDeleteActivityConfirmed(id, week, activityId));
                        break;
                    case 'update-measurements': handleUpdateMeasurements(id); break;
                    case 'generate-meal-plan': handleGenerateMealPlan(); break;
                    case 'generate-workout': handleGenerateWorkout(); break;
                    case 'generate-motivation': handleGenerateMotivation(); break;
                    case 'generate-group-analysis': handleGenerateGroupAnalysis(); break;
                    case 'generate-stagnation-tip': handleGenerateStagnationTip(); break;
                    case 'react': handleReactionClick(interactiveTarget); break;
                    case 'save-health-data': handleSaveHealthData(id); break;
					case 'save-profile-changes': handleSaveProfile(id); break;
                }
            }
            
            // --- GERENCIAMENTO DE DADOS E VISUALIZAÇÃO ---
            
            // --- DATA HELPERS (timezone-safe) ---
            function getTodayStrLocal(){
                const d = new Date();
                const y = d.getFullYear();
                const m = String(d.getMonth()+1).padStart(2,'0');
                const day = String(d.getDate()).padStart(2,'0');
                return y + '-' + m + '-' + day; // yyyy-mm-dd
            }
            // Parse 'YYYY-MM-DD' as local time (avoid UTC shift)
            function parseDateLocal(ymd){
                if (!ymd) return new Date(NaN);
                const parts = String(ymd).split('-');
                if (parts.length < 3) return new Date(ymd); // fallback
                const y = parseInt(parts[0],10);
                const m = parseInt(parts[1],10)-1;
                const d = parseInt(parts[2],10);
                return new Date(y, m, d);
            }

function calculateIMC(weight, height) {
                if (!weight || !height || height <= 0) {
                    return { value: 'N/A', classification: 'Dados incompletos', className: '' };
                }
                const imc = weight / (height * height);
                let classification = '';
                let className = '';
                if (imc < 18.5) {
                    classification = 'Abaixo do peso';
                    className = 'imc-abaixo';
                } else if (imc < 24.9) {
                    classification = 'Peso Normal';
                    className = 'imc-normal';
                } else if (imc < 29.9) {
                    classification = 'Sobrepeso';
                    className = 'imc-sobrepeso';
                } else {
                    classification = 'Obesidade';
                    className = 'imc-obesidade';
                }
                return { value: imc.toFixed(1), classification, className };
            }

            function calculateMetrics(p, referenceDate = new Date()) {
                const pesoNaData = getWeightAtDate(p, referenceDate);
                
                const pesoPerdido = p.peso_inicial - pesoNaData;
                const percentLoss = p.peso_inicial > 0 ? (pesoPerdido / p.peso_inicial) * 100 : 0;
                let weightPoints = 0;
                if (percentLoss >= 15) weightPoints = 50; else if (percentLoss >= 12) weightPoints = 40;
                else if (percentLoss >= 10) weightPoints = 35; else if (percentLoss >= 8) weightPoints = 30;
                else if (percentLoss >= 6) weightPoints = 20; else if (percentLoss >= 4) weightPoints = 15;
                else if (percentLoss >= 2) weightPoints = 10; else if (percentLoss > 0) weightPoints = 5;
                
                const semanasConsideradas = p.semanas_validas || [];
                const validWeeksCount = semanasConsideradas.filter(week => Array.isArray(week) && week.length >= MIN_ACTIVITIES_FOR_VALID_WEEK).length;
                const totalActivities = semanasConsideradas.reduce((sum, week) => sum + (Array.isArray(week) ? week.length : 0), 0);
                const activityPoints = (validWeeksCount / MAX_WEEKS) * MAX_ACTIVITY_POINTS;
                
                let progressToTarget = null;
                if (p.target_weight && p.peso_inicial > p.target_weight) {
                    const totalNeeded = p.peso_inicial - p.target_weight;
                    const currentLossToTarget = p.peso_inicial - pesoNaData;
                    progressToTarget = Math.max(0, Math.min(100, (currentLossToTarget / totalNeeded) * 100));
                }
                
                const imcData = calculateIMC(pesoNaData, p.altura);

                return { 
                    ...p, 
                    name: p.name, 
                    peso_atual: pesoNaData,
                    pesoPerdidoTotal: pesoPerdido, 
                    percentLoss: Math.max(0, percentLoss), 
                    weightPoints, 
                    validWeeksCount, 
                    totalActivities, 
                    activityPoints, 
                    totalPoints: weightPoints + activityPoints, 
                    progressToTarget, 
                    imc: imcData.value, 
                    imcClassification: imcData.classification, 
                    imcClassName: imcData.className 
                };
            }

            function getBadges(p) {
                let badges = '';
                if (p.target_weight && p.peso_atual <= p.target_weight) badges += `<span class="badge" title="Meta Atingida!">🎯</span>`;
                const pesoPerdido = p.peso_inicial - p.peso_atual;
                if (pesoPerdido >= 10) badges += `<span class="badge" title="Clube dos 10kg!">🔟</span>`;
                else if (pesoPerdido >= 5) badges += `<span class="badge" title="Clube dos 5kg!">5️⃣</span>`;
                const consecutive = (p.semanas_validas || []).map(w => (Array.isArray(w) && w.length >= MIN_ACTIVITIES_FOR_VALID_WEEK) ? '1' : '0').join('').split('0').reduce((max, s) => Math.max(max, s.length), 0);
                if (consecutive >= 4) badges += `<span class="badge" title="${consecutive} Semanas em Chamas!">🔥</span>`;
                if (p.name === weeklyPointsWinnerName) badges += `<span class="badge" title="Rei/Rainha da Semana!">👑</span>`;
                return badges;
            }

            function getWeightAtDate(participant, targetDate) {
                const history = participant.weight_history || [];
                const relevantHistory = history.filter(entry => parseDateLocal(entry.date) <= targetDate); 
                
                if (relevantHistory.length === 0) {
                    if ((participant.weight_history||[]).length > 0) {
                        const sortedAll = [...participant.weight_history].sort((a,b)=> parseDateLocal(a.date) - parseDateLocal(b.date));
                        return sortedAll[0].weight;
                    }
                    return participant.peso_inicial;
                }
                relevantHistory.sort((a, b) => parseDateLocal(b.date) - parseDateLocal(a.date));
                return relevantHistory[0].weight;
            }

            function calculateWeeklyWinners() {
                const today = new Date();
                const oneWeekAgo = new Date(); oneWeekAgo.setDate(today.getDate() - 7);
                let weeklyWinner = { name: null, pointsGained: -1 };
                participants.forEach(p => {
                    const pointsNow = calculateMetrics(p, today).totalPoints; 
                    const pointsThen = calculateMetrics(p, oneWeekAgo).totalPoints;
                    const pointsGained = pointsNow - pointsThen;
                    if (pointsGained > weeklyWinner.pointsGained) weeklyWinner = { name: p.name, pointsGained };
                });
                weeklyPointsWinnerName = weeklyWinner.pointsGained > 0 ? weeklyWinner.name : null;
            }

            function updateCurrentView() {
                if (!currentUser) return;
                calculateWeeklyWinners();
                
                if (currentViewId) {
                    showSection(currentViewId);
                } else {
                    const initialSection = currentUser.role === 'admin' ? 'ranking' : 'dailyLog';
                    showSection(initialSection);
                }
                updateSummaryBoxes();
            }

            function showSection(sectionId) {
                currentViewId = sectionId;
                // Allow internal admin views that are not in NAV_LINKS
                const isAdminInternal = (sectionId === 'adminViewDailyLog' || sectionId === 'adminViewEditProfile');
                let link = NAV_LINKS.find(l => l.id === sectionId);
                if (!isAdminInternal) {
                    if (!link || !currentUser || !link.roles.includes(currentUser.role)) {
                        return showSection(currentUser.role === 'admin' ? 'ranking' : 'myProfile');
                    }
                    pageTitle.textContent = link.text;
                    if (sectionId === 'myProfile') {
                        pageTitle.textContent = 'Meu Perfil';
                    }
                }
                
                const allMetrics = participants.map(p => calculateMetrics(p, new Date())); 
                const searchTerm = document.getElementById('searchParticipantInput').value.toLowerCase();
                const filteredMetrics = allMetrics.filter(p => p.name.toLowerCase().includes(searchTerm));

                dynamicContentContainer.innerHTML = '';
                const contentWrapper = document.createElement('div');
                contentWrapper.className = 'card';
                dynamicContentContainer.appendChild(contentWrapper);
                
                headerActionButtons.innerHTML = '';
                
                // CORREÇÃO: Esconde o summary-grid para todas as páginas que não são o dashboard principal
                const isDashboardView = ['ranking', 'weeklySummary', 'monthlySummary'].includes(sectionId);
                document.getElementById('summary-grid').style.display = isDashboardView ? 'grid' : 'none';
                
                if (!isDashboardView) {
                    contentWrapper.classList.remove('card'); // Remove a classe 'card' para que o conteúdo dinâmico não fique dentro de um único card
                } else {
                    contentWrapper.classList.add('card');
                }

                switch(sectionId) {
        case 'dailyLog':
            renderDailyLogPage(dynamicContentContainer);
            break;
        case 'adminViewDailyLog':
            renderDailyLogPage(dynamicContentContainer, true);
            break;
        case 'editProfile':
            renderEditProfilePage(dynamicContentContainer);
            break;
        case 'adminViewEditProfile':
            renderEditProfilePage(dynamicContentContainer, true);
            break;
    
                    case 'ranking': renderRankingTable(sortData(filteredMetrics, rankingSortConfig), contentWrapper); break;
                    case 'participants': renderParticipantsPage(filteredMetrics, dynamicContentContainer); break;
                    case 'participantProfile':
                    case 'myProfile':
                        renderParticipantProfilePage(dynamicContentContainer);
                        break;
                    case 'aiCenter':
                        renderAiCenterPage(dynamicContentContainer);
                        break;
                    case 'activityFeed':
                        renderActivityFeedPage(dynamicContentContainer);
                        break;
                    case 'healthData':
                        renderHealthDataPage(dynamicContentContainer);
                        break;
                    case 'weeklySummary': renderWeeklySummaryPage(allMetrics, contentWrapper); break;
                    case 'activityLog': renderActivityLogPage(filteredMetrics, dynamicContentContainer); break;
                    case 'coachVirtual': renderCoachVirtualPage(contentWrapper); break;
                    case 'individualEvolution': renderIndividualEvolutionPage(allMetrics, contentWrapper); break;
                    case 'groupEvolution': renderGroupEvolutionChart(allMetrics, contentWrapper); break;
                    case 'comparison': renderComparisonChart(allMetrics, contentWrapper); break;
                    case 'rules': renderRulesPage(contentWrapper); break;
                    case 'configuracoes': renderSettingsPage(contentWrapper); break;
                }
                
                document.querySelectorAll('.sidebar-link').forEach(item => item.classList.toggle('active', item.dataset.section === sectionId));
            }
            
            function sortData(data, config) {
                return [...data].sort((a, b) => {
                    if (a[config.key] < b[config.key]) return config.direction === 'asc' ? -1 : 1;
                    if (a[config.key] > b[config.key]) return config.direction === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            // --- RENDERIZADORES DE PÁGINAS ---

            
function renderRankingTable(data, container) {
    const pointRanked = [].concat(participants.map(function(p){ return calculateMetrics(p); })).sort(function(a,b){ return b.totalPoints - a.totalPoints; });
    const sortArrow = function(key){ return rankingSortConfig.key === key ? (rankingSortConfig.direction === 'asc' ? ' ▲' : ' ▼') : ''; };

    var rows = (typeof showTopN !== 'undefined' && showTopN) ? data.slice(0, showTopN) : data;

    var tableHTML = ''
      + '<div class="overflow-x-auto">'
      +   '<table class="w-full table-zebra">'
      +     '<thead><tr>'
      +       '<th class="sortable" data-sort-key="totalPoints">Rank' + sortArrow('totalPoints') + '</th>'
      +       '<th class="sortable" data-sort-key="name">Nome' + sortArrow('name') + '</th>'
      +       '<th>Progresso Meta</th>'
      +       '<th class="sortable" data-sort-key="percentLoss">% Perda' + sortArrow('percentLoss') + '</th>'
      +       '<th class="sortable" data-sort-key="weightPoints">Pts. Peso' + sortArrow('weightPoints') + '</th>'
      +       '<th class="sortable" data-sort-key="activityPoints">Pts. Ativ.' + sortArrow('activityPoints') + '</th>'
      +       '<th class="sortable" data-sort-key="totalPoints">Total' + sortArrow('totalPoints') + '</th>'
      +     '</tr></thead><tbody>';

    if (!rows || rows.length === 0) {
        tableHTML += '<tr><td colspan="7" class="text-center py-4 text-gray-500">Nenhum participante encontrado.</td></tr>';
    } else {
        rows.forEach(function(p){
            var pointRankIndex = pointRanked.findIndex(function(rp){ return rp.name === p.name; });
            var topBadge = (pointRankIndex === 0) ? ' <span class="top-badge" title="1º lugar">🏆</span>' :
                           (pointRankIndex === 1) ? ' <span class="top-badge" title="2º lugar">🥈</span>' :
                           (pointRankIndex === 2) ? ' <span class="top-badge" title="3º lugar">🥉</span>' : '';


            var progressColor = (p.progressToTarget == null) ? '#6b7280'
                              : (p.progressToTarget >= 80 ? '#22c55e' : (p.progressToTarget >= 40 ? '#f59e0b' : '#ef4444'));
            var progressHTML = (p.progressToTarget != null)
              ? '<div class="progress-track"><div class="progress-fill" style="width:' + p.progressToTarget + '%"></div><span class="progress-label">' + Math.round(p.progressToTarget) + '%</span></div>'
              : 'N/A';

            var avatarSrc = p.avatar_url || ('https://placehold.co/48x48/E2E8F0/4A5568?text=' + p.name.charAt(0));
            var nameHTML = p.name;
            if (currentUser.role === 'admin') {
                nameHTML = '<a href="#" style="color: var(--primary-color);" class="hover:underline font-semibold" data-action="view-daily-log" data-id="' + p.id + '">' + p.name + '</a>';
            }

            var tooltip = 'Inicial: ' + (p.peso_inicial && p.peso_inicial.toFixed ? p.peso_inicial.toFixed(1) : (p.peso_inicial||'N/A'))
                        + ' kg | Atual: ' + p.peso_atual.toFixed(1) + ' kg | Perdido: ' + (p.pesoPerdidoTotal).toFixed(1) + ' kg';

            tableHTML += ''
              + '<tr class="' + (pointRankIndex === 0 ? 'leader-row' : '') + '">'
              +   '<td class="font-semibold">' + (pointRankIndex + 1) + '</td>'
              +   '<td class="py-2">'
              +     '<div class="flex items-center">'
              +       '<img src="' + avatarSrc + '" alt="Avatar de ' + p.name.replace(/"/g,'&quot;') + '"'
              +            ' class="w-12 h-12 rounded-full mr-3 object-cover flex-shrink-0"'
              +            ' onerror="this.onerror=null;this.src=\'https://placehold.co/48x48/E2E8F0/4A5568?text=' + p.name.charAt(0) + '\';">'
              +       '<div>' + nameHTML + topBadge + ' <span class="ml-1">' + getBadges(p) + '</span></div>'
              +     '</div>'
              +   '</td>'
              +   '<td>' + progressHTML + '</td>'
              +   '<td title="' + tooltip.replace(/"/g,'&quot;') + '">' + p.percentLoss.toFixed(2) + '%</td>'
              +   '<td>' + p.weightPoints.toFixed(2) + '</td>'
              +   '<td>' + p.activityPoints.toFixed(2) + '</td>'
              +   '<td class="font-extrabold text-indigo-300">' + p.totalPoints.toFixed(2) + '</td>'
              + '</tr>';
        });
    }
    tableHTML += '</tbody></table></div>';
    container.innerHTML = tableHTML;
}


            function renderParticipantsPage(data, container) {
                if (currentUser.role !== 'admin') return;
                
                headerActionButtons.innerHTML = `<button data-action="open-add-modal" style="background-color: var(--success-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg shadow-md text-sm">Adicionar Participante</button>`;

                if (data.length === 0) {
                    container.innerHTML = `<div class="card"><div class="text-center py-10 text-gray-500">Nenhum participante encontrado. Clique em "Adicionar Participante" para começar.</div></div>`;
                    return;
                }

                let cardsHTML = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">';
                const participantsToRender = participants.map(p => calculateMetrics(p, new Date()));

                participantsToRender.sort((a,b) => a.name.localeCompare(b.name)).forEach(p => {
                    const avatarSrc = p.avatar_url || `https://placehold.co/80x80/E2E8F0/4A5568?text=${p.name.charAt(0)}`;
                    const pesoPerdido = p.pesoPerdidoTotal; 
                    cardsHTML += `
                        <div class="card transform hover:bg-gray-700 transition-colors duration-300 flex flex-col">
                            <div class="p-5 flex-grow">
                                <div class="flex items-center gap-4 mb-4">
                                    <img src="${avatarSrc}" alt="Avatar de ${p.name}" class="w-16 h-16 rounded-full mr-3 object-cover border-2 border-gray-700" onerror="this.onerror=null;this.src='https://placehold.co/80x80/E2E8F0/4A5568?text=${p.name.charAt(0)}';">
                                    <div>
                                        <h3 class="text-lg font-bold text-white">${p.name}</h3>
                                        <p class="text-sm text-gray-400">Total: ${p.totalPoints.toFixed(1)} pts</p>
                                    </div>
                                </div>
                                <div class="text-sm space-y-1">
                                    <p><strong>Peso Atual:</strong> ${p.peso_atual.toFixed(1)} kg</p>
                                    <p><strong>Perda Total:</strong> <span class="${pesoPerdido >= 0 ? 'text-green-400' : 'text-red-400'} font-semibold">${pesoPerdido.toFixed(1)} kg</span></p>
                                </div>
                            </div>
                            <div class="bg-gray-800 p-3 grid grid-cols-3 gap-2 rounded-b-lg">
                                <button data-action="view-daily-log" data-id="${p.id}" class="action-btn" data-action=\"view-daily-log\">Diário</button>
                                <button data-action="edit-profile" data-id="${p.id}" class="action-btn" data-action=\"edit-profile\">Editar Perfil</button>
                                <button data-action="open-delete-modal" data-id="${p.id}" data-name="${p.name}" class="action-btn">Excluir</button>
                            </div>
                        </div>
                    `;
                });
                cardsHTML += '</div>';
                container.innerHTML = cardsHTML;
            }

            function renderParticipantProfilePage(container) {
                const pMetric = calculateMetrics(participants.find(p => p.id == currentProfileParticipantId), new Date()); 
                if (!pMetric) {
                    container.innerHTML = `<div class="card"><div class="text-center py-10 text-gray-500">Participante não encontrado.</div></div>`;
                    return;
                }
                
                const isOwnProfile = currentUser.participantId == pMetric.id;
                const canEditProfile = currentUser.role === 'admin' || isOwnProfile;
                const canEditDate = currentUser.role === 'admin';

                const avatarSrc = pMetric.avatar_url || `https://placehold.co/100x100/E2E8F0/4A5568?text=${pMetric.name.charAt(0)}`;
                const todayStr = getTodayStrLocal();
                const lastM = pMetric.measurements_history && pMetric.measurements_history.length > 0 ? pMetric.measurements_history[pMetric.measurements_history.length - 1] : {};

                let backButtonHTML = '';
                if (currentUser.role === 'admin' && !isOwnProfile) {
                    backButtonHTML = `<a href="#" data-action="go-to-participants" style="color: var(--primary-color);" class="hover:underline mb-4 inline-block">&larr; Voltar para todos os participantes</a>`;
                }
                
                const pesoPerdido = pMetric.pesoPerdidoTotal; 

                container.innerHTML = `
                    <div id="profile-content" class="max-w-4xl mx-auto space-y-6">
                        <div class="flex justify-between items-start mb-2">
                            ${backButtonHTML}
                            ${currentUser.role === 'admin' ? `<div><button data-action="generate-report" data-id="${pMetric.id}" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded-lg text-sm">Gerar PDF</button></div>` : '<div></div>'}
                        </div>

                        <div class="profile-card flex flex-col sm:flex-row items-center gap-6">
                            <img src="${avatarSrc}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/E2E8F0/4A5568?text=${pMetric.name.charAt(0)}';" class="rounded-full w-24 h-24 object-cover border-4 border-indigo-500">
                            <div class="flex-grow text-center sm:text-left">
                                <h3 class="text-3xl font-bold text-white">${pMetric.name} <span class="text-2xl">${getBadges(pMetric)}</span></h3>
                                <div class="flex items-center gap-4 mt-1 justify-center sm:justify-start flex-wrap">
                                    <p class="text-gray-400">Altura: ${pMetric.altura ? pMetric.altura.toFixed(2) + 'm' : 'N/A'}</p>
                                    <p class="text-gray-400 flex items-center gap-2">IMC: <strong>${pMetric.imc}</strong> <span class="imc-badge ${pMetric.imcClassName}">${pMetric.imcClassification}</span></p>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-4 text-center w-full sm:w-auto mt-4 sm:mt-0">
                                <div>
                                    <p class="text-2xl font-bold text-indigo-400">${pMetric.totalPoints.toFixed(1)}</p>
                                    <p class="text-xs text-gray-400 uppercase">Pontos</p>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold ${pesoPerdido >= 0 ? 'text-green-400' : 'text-red-400'}">${pesoPerdido.toFixed(1)}</p>
                                    <p class="text-xs text-gray-400 uppercase">Kg Perdidos</p>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-indigo-400">${pMetric.progressToTarget ? pMetric.progressToTarget.toFixed(0) : '0'}%</p>
                                    <p class="text-xs text-gray-400 uppercase">Meta</p>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="space-y-6">
                                ${canEditProfile ? `
                                <div class="profile-card">
                                    <h4 class="font-bold text-lg mb-4 text-white">Registrar Peso</h4>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300">Novo Peso (kg)</label>
                                            <input id="profile-weight-input" type="number" step="any" class="mt-1 w-full p-2" placeholder="${pMetric.peso_atual.toFixed(2)}">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300">Data do Registro</label>
                                            <input id="profile-weight-date" type="date" class="mt-1 w-full p-2" value="${todayStr}" max="${todayStr}" ${currentUser.role !== 'admin' ? 'readonly' : ''}>
                                        </div>
                                        
                                        <div class="border border-gray-700 p-3 rounded-lg bg-gray-800">
                                            <label for="profile-weight-photo" class="block text-sm font-medium text-gray-300 mb-1">Foto da Balança (Opcional)</label>
                                            <input type="file" id="profile-weight-photo" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-200 file:text-indigo-700 hover:file:bg-indigo-300" accept="image/*">
                                            <button data-action="detect-weight-ai" data-id="${pMetric.id}" class="w-full mt-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md text-sm">Detectar Peso (IA)</button>
                                            <p id="ai-weight-feedback" class="text-xs text-gray-400 mt-2 text-center"></p>
                                            <div class="mt-2">
                                                <label for="profile-weight-photo-privacy" class="block text-sm font-medium text-gray-300 mb-1">Privacidade da Foto:</label>
                                                <select id="profile-weight-photo-privacy" class="w-full p-2">
                                                    <option value="public">Público (Visível no Mural)</option>
                                                    <option value="private">Privado (Visível apenas para você e Administrador)</option>
                                                </select>
                                            </div>
                                        </div>

                                        <button data-action="update-weight" data-id="${pMetric.id}" style="background-color: var(--primary-color);" class="w-full hover:opacity-90 text-white font-bold py-2.5 px-4 rounded-md">Salvar Peso</button>
                                    </div>
                                </div>
                                <div class="profile-card">
                                    <h4 class="font-bold text-lg mb-4 text-white">Registrar Atividade</h4>
                                    <div class="space-y-4">
                                        <div><label class="block text-sm font-medium text-gray-300">Tipo</label><select id="profile-activity-type" class="mt-1 w-full p-2">${ACTIVITY_TYPES.map(t => `<option value="${t}">${t}</option>`).join('')}</select></div>
                                        <div><label class="block text-sm font-medium text-gray-300">Duração (min)</label><input type="number" id="profile-activity-duration" class="w-full p-2"></div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300">Data do Registro</label>
                                            <input type="date" id="profile-activity-date" class="mt-1 w-full p-2" value="${todayStr}" max="${todayStr}" ${canEditDate ? '' : 'readonly'}>
                                        </div>
                                        <div>
                                            <label for="profile-activity-photo" class="text-sm font-medium text-gray-300">Foto do Treino (Opcional)</label>
                                            <input type="file" id="profile-activity-photo" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-200 file:text-indigo-700 hover:file:bg-indigo-300" accept="image/*">
                                            <div class="mt-2">
                                                <label for="profile-activity-photo-privacy" class="block text-sm font-medium text-gray-300 mb-1">Privacidade da Foto:</label>
                                                <select id="profile-activity-photo-privacy" class="w-full p-2">
                                                    <option value="public">Público (Visível no Mural)</option>
                                                    <option value="private">Privado (Visível apenas para você e Administrador)</option>
                                                </select>
                                            </div>
                                        </div>
                                        <button data-action="add-activity" data-id="${pMetric.id}" style="background-color: var(--success-color);" class="w-full hover:opacity-90 text-white font-bold py-2.5 px-4 rounded-md">Adicionar Atividade</button>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            <div class="space-y-6">
                                <div class="profile-card"><h4 class="font-bold text-lg mb-3 text-white">Histórico de Pesagem</h4><div id="profile-weight-history-list" class="max-h-60 overflow-y-auto pr-2 space-y-2"></div></div>
                                <div class="profile-card"><h4 class="font-bold text-lg mb-3 text-white">Histórico de Atividades</h4><div id="profile-activity-history-list" class="max-h-60 overflow-y-auto pr-2 space-y-2"></div></div>
                                <div class="profile-card">
                                    <div class="flex justify-between items-center mb-3">
                                        <h4 class="text-lg font-semibold text-white">🤖 Dica do Coach</h4>
                                        <button data-action="ai-coach" data-id="${pMetric.id}" style="background-color: var(--primary-color);" class="hover:opacity-90 text-white font-bold py-2 px-3 rounded-lg text-sm">Gerar Dica</button>
                                    </div>
                                    <div id="ai-tip-container" class="p-4 bg-gray-800 rounded-lg text-gray-300 min-h-[80px]">Clique no botão para receber uma dica personalizada.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                updateProfileWeightList(pMetric);
                updateProfileActivityList(pMetric);
            }
            
            function renderAiCenterPage(container) {
                container.innerHTML = `
                    <div class="space-y-6">
                        <div class="text-center">
                            <h2 class="text-3xl font-extrabold text-white">Central de IA 🤖</h2>
                            <p class="mt-2 text-lg text-gray-400">Ferramentas inteligentes para turbinar seu desafio.</p>
                        </div>
                        
                        ${currentUser.role === 'admin' ? `
                        <div class="card">
                            <h3 class="text-xl font-bold text-red-400 mb-2">Análise de Tendências do Grupo (Admin)</h3>
                            <p class="text-sm text-gray-400 mb-4">Receba uma análise inteligente sobre o desempenho geral do grupo, identificando tendências e sugerindo ações.</p>
                            <button data-action="generate-group-analysis" style="background-color: var(--danger-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg">Analisar Grupo</button>
                            <div id="group-analysis-result" class="ai-result-box">Clique em "Analisar" para receber os insights.</div>
                        </div>

                        <div class="card">
                            <h3 class="text-xl font-bold text-blue-400 mb-2">Dica Anti-Platô (Admin)</h3>
                            <p class="text-sm text-gray-400 mb-4">Verifique se algum participante está estagnado e gere uma dica para ajudá-lo a quebrar o platô.</p>
                            <div class="flex items-center gap-4 mb-4">
                                <select id="stagnation-participant-selector" class="w-full">${participants.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}</select>
                            </div>
                            <button data-action="generate-stagnation-tip" style="background-color: #3b82f6;" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg">Verificar e Gerar Dica</button>
                            <div id="stagnation-tip-result" class="ai-result-box">Selecione um participante e clique para verificar se está em um platô e receber uma dica.</div>
                        </div>
                        ` : ''}

                        <div class="card">
                            <h3 class="text-xl font-bold text-indigo-400 mb-2">Plano de Refeições Sugerido</h3>
                            <p class="text-sm text-gray-400 mb-4">Receba um cardápio diário, gerado por IA, com base no seu perfil e metas.</p>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                <div>
                                    <label for="liked-foods" class="block text-sm font-medium text-gray-300 mb-1">Meus alimentos preferidos:</label>
                                    <textarea id="liked-foods" rows="2" class="w-full" placeholder="Ex: frango, batata doce, salada"></textarea>
                                </div>
                                <div>
                                    <label for="disliked-foods" class="block text-sm font-medium text-gray-300 mb-1">Alimentos a evitar (restrições, etc.):</label>
                                    <textarea id="disliked-foods" rows="2" class="w-full" placeholder="Ex: brócolis, lactose, glúten"></textarea>
                                </div>
                            </div>
                            <button data-action="generate-meal-plan" style="background-color: var(--primary-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg">Gerar Cardápio do Dia</button>
                            <div id="meal-plan-result" class="ai-result-box">Preencha suas preferências e clique em "Gerar" para receber sua sugestão.</div>
                        </div>

                        <div class="card">
                            <h3 class="text-xl font-bold text-green-400 mb-2">Sugestão de Treino Dinâmica</h3>
                            <p class="text-sm text-gray-400 mb-4">Com base nas suas atividades recentes, a IA sugere treinos complementares para otimizar seus resultados.</p>
                            <button data-action="generate-workout" style="background-color: var(--success-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg">Sugerir Próximo Treino</button>
                            <div id="workout-result" class="ai-result-box">Clique em "Gerar" para receber sua sugestão.</div>
                        </div>

                        <div class="card">
                            <h3 class="text-xl font-bold text-amber-400 mb-2">Resumo Semanal</h3>
                            <p class="text-sm text-gray-400 mb-4">Receba uma análise motivacional do seu progresso na última semana, escrita pela nossa IA.</p>
                            <button data-action="generate-motivation" style="background-color: var(--warning-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg">Gerar Resumo da Semana</button>
                            <div id="motivation-result" class="ai-result-box">Clique em "Gerar" para receber sua análise.</div>
                        </div>
                    </div>
                `;
            }

            function renderActivityFeedPage(container) {
                let allActivities = [];
                const now = new Date();

                participants.forEach(p => {
                    p.weight_history.forEach(wh => {
                        if (parseDateLocal(wh.date) <= now && (wh.imageUrl && (wh.is_public || currentUser.role === 'admin'))) {
                            const weightEntryId = `weight-${p.id}-${parseDateLocal(wh.date).getTime()}`;
                            allActivities.push({
                                id: weightEntryId,
                                participantId: p.id,
                                participantName: p.name,
                                participantAvatar: p.avatar_url || `https://placehold.co/48x48/E2E8F0/4A5568?text=${p.name.charAt(0)}`,
                                type: 'Pesagem',
                                duration: null,
                                date: wh.date,
                                imageUrl: wh.imageUrl,
                                is_public: wh.is_public,
                                description: `pesou ${parseFloat(wh.weight).toFixed(1)} kg.`, 
                                isWeightEntry: true,
                                weight: wh.weight
                            });
                        }
                    });

                    (p.semanas_validas || []).flat().forEach(act => {
                        if (parseDateLocal(act.date) <= now) {
                            if (act.imageUrl) {
                                if (act.is_public || currentUser.role === 'admin') {
                                    allActivities.push({
                                        ...act,
                                        participantId: p.id,
                                        participantName: p.name,
                                        participantAvatar: p.avatar_url || `https://placehold.co/48x48/E2E8F0/4A5568?text=${p.name.charAt(0)}`,
                                        isWeightEntry: false
                                    });
                                }
                            } else {
                                allActivities.push({
                                    ...act,
                                    participantId: p.id,
                                    participantName: p.name,
                                    participantAvatar: p.avatar_url || `https://placehold.co/48x48/E2E8F0/4A5568?text=${p.name.charAt(0)}`,
                                    isWeightEntry: false
                                });
                            }
                        }
                    });
                });

                allActivities.sort((a, b) => parseDateLocal(b.date).getTime() - parseDateLocal(a.date).getTime()); 

                const heartSVG = `<svg class="w-6 h-6" viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>`;
                const privateSVG = `<svg class="w-4 h-4 text-gray-500" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path></svg>`;

                let feedHTML = `
                    <div class="space-y-4 max-w-2xl mx-auto">
                        <div class="text-center mb-6">
                            <h2 class="text-3xl font-extrabold text-white">Mural de Conquistas</h2>
                            <p class="mt-2 text-lg text-gray-400">Veja e reaja às atividades recentes do grupo!</p>
                        </div>
                `;

                if (allActivities.length === 0) {
                    feedHTML += `<div class="card text-center py-10 text-gray-500">Nenhuma atividade registrada ainda. Seja o primeiro!</div>`;
                } else {
                    allActivities.slice(0, 50).forEach(item => {
                        const itemId = item.id; 
                        const itemDate = parseDateLocal(item.date);
                        const timeAgo = formatTimeAgo(itemDate);

                        const itemReactions = reactions.filter(r => String(r.activity_id) === String(itemId));
                        const count = itemReactions.length;
                        
                        const userReacted = reactions.some(r => String(r.activity_id) === String(itemId) && r.user_id === currentUser.participantId);

                        const reactionsHTML = `
                            <button data-action="react" data-activity-id="${itemId}" data-reaction-type="❤️" class="reaction-btn ${userReacted ? 'reacted' : ''}">
                                ${heartSVG}
                                <span class="font-semibold">${count}</span>
                            </button>
                        `;

                        const imageHTML = item.imageUrl ? `
                            <img data-action="view-image" data-url="${item.imageUrl}" src="${item.imageUrl}" alt="Foto da ${item.type} de ${item.participantName}" class="mt-3 rounded-lg w-full object-cover max-h-96 border border-gray-600 cursor-pointer" loading="lazy" onerror="this.style.display='none'">
                        ` : '';

                        const privacyIndicator = item.is_public === false ? `<span class="text-gray-500 text-sm ml-2 flex items-center">${privateSVG} Privado</span>` : '';
                        
                        let activityDescription = '';
                        if (item.isWeightEntry) {
                            activityDescription = `pesou ${parseFloat(item.weight).toFixed(1)} kg.`; 
                        } else {
                            activityDescription = `registrou uma atividade: <span class="text-lg font-semibold text-indigo-300">${item.type} - ${item.duration} min</span>`;
                        }

                        feedHTML += `
                            <div class="card" data-post-id="${itemId}">
                                <div class="flex items-start gap-4">
                                    <img src="${item.participantAvatar}" class="w-12 h-12 rounded-full object-cover" onerror="this.onerror=null;this.src='${item.participantAvatar}';">
                                    <div class="flex-1">
                                        <p>
                                            <strong class="text-white">${item.participantName}</strong>
                                            <span class="text-gray-400">${activityDescription}</span>
                                            ${privacyIndicator}
                                        </p>
                                        
                                        ${imageHTML}

                                        <p class="text-xs text-gray-500 mt-2">${timeAgo}</p>
                                        <div class="flex items-center gap-2 mt-3 flex-wrap">
                                            ${reactionsHTML}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                }

                feedHTML += `</div>`;
                container.innerHTML = feedHTML;
            }

            function renderHealthDataPage(container) {
                const isOwnProfile = currentUser.role === 'participant';
                const participantId = isOwnProfile ? currentUser.participantId : currentProfileParticipantId;
                const p = participants.find(p => p.id == participantId);
                const healthData = p.health_data || {};
                const initialHealthData = p.initial_health_data || {};
                
                if (!p) {
                    container.innerHTML = `<div class="card"><div class="text-center py-10 text-gray-500">Participante não encontrado.</div></div>`;
                    return;
                }

                const riskMessage = calculateHealthRisk(p);
                const isReadOnly = currentUser.role !== 'admin' && !isOwnProfile;
                const getSelectOptions = (options, selectedValue) => options.map(opt => `<option value="${opt}" ${selectedValue === opt ? 'selected' : ''}>${opt}</option>`).join('');
                
                // Opções para os novos campos de seleção
                const lesoesOptions = ['Nenhuma', 'Braço', 'Perna', 'Joelho', 'Coluna', 'Ombro', 'Outro'];
                const motivacaoOptions = ['Vencer o Desafio', 'Perder peso', 'Melhorar a saúde', 'Mudar estilo de vida', 'Aumentar massa muscular', 'Outro'];
                const atividadeAntesOptions = ['Nenhuma', '1 vez na semana', '2 vezes na semana', '3 ou mais vezes na semana', 'Todos os dias'];

                container.innerHTML = `
                    <div class="max-w-4xl mx-auto space-y-6">
                        <div class="text-center">
                            <h2 class="text-3xl font-extrabold text-white">Ficha de Saúde Completa</h2>
                            <p class="mt-2 text-lg text-gray-400">Monitore seu progresso e os benefícios para a sua saúde.</p>
                        </div>
                        
                        <div class="card">
                            <div class="flex flex-col sm:flex-row items-center justify-between">
                                <h3 class="text-xl font-bold text-indigo-400 mb-2 sm:mb-0">Avaliação de Risco</h3>
                                <div class="text-center sm:text-right">
                                    <p class="text-sm text-gray-300">${riskMessage}</p>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <h3 class="text-xl font-bold text-white mb-4">Informações de Saúde e Estilo de Vida</h3>
                            <form id="healthDataForm">
                                <input type="hidden" id="participantId" value="${p.id}">
                                
                                <div class="space-y-6 mb-6">
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <!-- Sub-grupo: Hábitos e Estilo de Vida -->
                                        <div>
                                            <h4 class="font-bold text-lg text-indigo-300 mb-2">Hábitos e Estilo de Vida</h4>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-300">Fuma?</label>
                                                <select id="fuma" class="w-full" ${isReadOnly ? 'disabled' : ''}>
                                                    <option value="" ${!healthData.fuma && healthData.fuma !== false ? 'selected' : ''}>Selecione</option>
                                                    <option value="false" ${healthData.fuma === false ? 'selected' : ''}>Não</option>
                                                    <option value="true" ${healthData.fuma === true ? 'selected' : ''}>Sim</option>
                                                </select>
                                            </div>
                                            <div class="mt-4">
                                                <label class="block text-sm font-medium text-gray-300">Consumo de Álcool</label>
                                                <select id="consumo_alcool" class="w-full" ${isReadOnly ? 'disabled' : ''}>
                                                    <option value="" ${!healthData.consumo_alcool ? 'selected' : ''}>Selecione</option>
                                                    <option value="Nenhum" ${healthData.consumo_alcool === 'Nenhum' ? 'selected' : ''}>Nenhum</option>
                                                    <option value="Social" ${healthData.consumo_alcool === 'Social' ? 'selected' : ''}>Social (1-2x/semana)</option>
                                                    <option value="Regular" ${healthData.consumo_alcool === 'Regular' ? 'selected' : ''}>Regular (3-4x/semana)</option>
                                                    <option value="Diário" ${healthData.consumo_alcool === 'Diário' ? 'selected' : ''}>Diário</option>
                                                </select>
                                            </div>
                                            <div class="mt-4">
                                                <label class="block text-sm font-medium text-gray-300">Consumo de Água (Litros/dia)</label>
                                                <select id="consumo_agua" class="w-full" ${isReadOnly ? 'disabled' : ''}>
                                                    <option value="" ${!healthData.consumo_agua ? 'selected' : ''}>Selecione</option>
                                                    <option value="Menos de 1L" ${healthData.consumo_agua === 'Menos de 1L' ? 'selected' : ''}>Menos de 1L</option>
                                                    <option value="1 a 2L" ${healthData.consumo_agua === '1 a 2L' ? 'selected' : ''}>1 a 2L</option>
                                                    <option value="Mais de 2L" ${healthData.consumo_agua === 'Mais de 2L' ? 'selected' : ''}>Mais de 2L</option>
                                                </select>
                                            </div>
                                            <div class="mt-4">
                                                <label class="block text-sm font-medium text-gray-300">Horas de Sono (por noite)</label>
                                                <select id="horas_sono" class="w-full" ${isReadOnly ? 'disabled' : ''}>
                                                    <option value="" ${!healthData.horas_sono ? 'selected' : ''}>Selecione</option>
                                                    <option value="Menos de 6h" ${healthData.horas_sono === 'Menos de 6h' ? 'selected' : ''}>Menos de 6h</option>
                                                    <option value="6h a 8h" ${healthData.horas_sono === '6h a 8h' ? 'selected' : ''}>6h a 8h</option>
                                                    <option value="Mais de 8h" ${healthData.horas_sono === 'Mais de 8h' ? 'selected' : ''}>Mais de 8h</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <!-- Sub-grupo: Rotina Diária -->
                                        <div>
                                            <h4 class="font-bold text-lg text-indigo-300 mb-2">Rotina Diária</h4>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-300">Nível de Estresse</label>
                                                <select id="nivel_estresse" class="w-full" ${isReadOnly ? 'disabled' : ''}>
                                                    <option value="" ${!healthData.nivel_estresse ? 'selected' : ''}>Selecione</option>
                                                    <option value="Baixo" ${healthData.nivel_estresse === 'Baixo' ? 'selected' : ''}>Baixo</option>
                                                    <option value="Moderado" ${healthData.nivel_estresse === 'Moderado' ? 'selected' : ''}>Moderado</option>
                                                    <option value="Alto" ${healthData.nivel_estresse === 'Alto' ? 'selected' : ''}>Alto</option>
                                                </select>
                                            </div>
                                            <div class="mt-4">
                                                <label class="block text-sm font-medium text-gray-300">Tipo de Trabalho</label>
                                                <select id="tipo_trabalho" class="w-full" ${isReadOnly ? 'disabled' : ''}>
                                                    <option value="" ${!healthData.tipo_trabalho ? 'selected' : ''}>Selecione</option>
                                                    <option value="Sedentário (muito tempo sentado)" ${healthData.tipo_trabalho === 'Sedentário (muito tempo sentado)' ? 'selected' : ''}>Sedentário (muito tempo sentado)</option>
                                                    <option value="Esforço físico moderado" ${healthData.tipo_trabalho === 'Esforço físico moderado' ? 'selected' : ''}>Esforço físico moderado</option>
                                                    <option value="Esforço físico intenso" ${healthData.tipo_trabalho === 'Esforço físico intenso' ? 'selected' : ''}>Esforço físico intenso</option>
                                                    <option value="Muitas horas em pé" ${healthData.tipo_trabalho === 'Muitas horas em pé' ? 'selected' : ''}>Muitas horas em pé</option>
                                                    <option value="Outro" ${healthData.tipo_trabalho === 'Outro' ? 'selected' : ''}>Outro</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
                                        <!-- Sub-grupo: Metas e Histórico -->
                                        <div>
                                            <h4 class="font-bold text-lg text-indigo-300 mb-2">Metas e Histórico</h4>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-300">Objetivo Principal do Desafio</label>
                                                <select id="objetivo_principal" class="w-full" ${isReadOnly ? 'disabled' : ''}>
                                                    <option value="" ${!healthData.objetivo_principal ? 'selected' : ''}>Selecione</option>
                                                    <option value="Vencer o Desafio" ${healthData.objetivo_principal === 'Vencer o Desafio' ? 'selected' : ''}>Vencer o Desafio</option>
                                                    <option value="Perda de peso" ${healthData.objetivo_principal === 'Perda de peso' ? 'selected' : ''}>Perda de peso</option>
                                                    <option value="Ganho de massa muscular" ${healthData.objetivo_principal === 'Ganho de massa muscular' ? 'selected' : ''}>Ganho de massa muscular</option>
                                                    <option value="Melhora na saúde cardiovascular" ${healthData.objetivo_principal === 'Melhora na saúde cardiovascular' ? 'selected' : ''}>Melhora na saúde cardiovascular</option>
                                                    <option value="Aumento de energia" ${healthData.objetivo_principal === 'Aumento de energia' ? 'selected' : ''}>Aumento de energia</option>
                                                    <option value="Redução de estresse" ${healthData.objetivo_principal === 'Redução de estresse' ? 'selected' : ''}>Redução de estresse</option>
                                                </select>
                                            </div>
                                            <div class="mt-4">
                                                <label class="block text-sm font-medium text-gray-300">Principal Obstáculo</label>
                                                <select id="principal_obstaculo" class="w-full" ${isReadOnly ? 'disabled' : ''}>
                                                    <option value="" ${!healthData.principal_obstaculo ? 'selected' : ''}>Selecione</option>
                                                    <option value="Falta de tempo" ${healthData.principal_obstaculo === 'Falta de tempo' ? 'selected' : ''}>Falta de tempo</option>
                                                    <option value="Falta de motivação/estímulo" ${healthData.principal_obstaculo === 'Falta de motivação/estímulo' ? 'selected' : ''}>Falta de motivação/estímulo</option>
                                                    <option value="Alimentação descontrolada" ${healthData.principal_obstaculo === 'Alimentação descontrolada' ? 'selected' : ''}>Alimentação descontrolada</option>
                                                    <option value="Problemas de saúde" ${healthData.principal_obstaculo === 'Problemas de saúde' ? 'selected' : ''}>Problemas de saúde</option>
                                                    <option value="Lesões" ${healthData.principal_obstaculo === 'Lesões' ? 'selected' : ''}>Lesões</option>
                                                    <option value="Outro" ${healthData.principal_obstaculo === 'Outro' ? 'selected' : ''}>Outro</option>
                                                </select>
                                            </div>
                                            <div class="mt-4">
                                                <label class="block text-sm font-medium text-gray-300">Fator de Motivação</label>
                                                <select id="fator_motivacao" class="w-full" ${isReadOnly ? 'disabled' : ''}>
                                                    <option value="" ${!healthData.fator_motivacao ? 'selected' : ''}>Selecione</option>
                                                    <option value="Vencer o Desafio" ${healthData.fator_motivacao === 'Vencer o Desafio' ? 'selected' : ''}>Vencer o Desafio</option>
                                                    <option value="Perder peso" ${healthData.fator_motivacao === 'Perder peso' ? 'selected' : ''}>Perder peso</option>
                                                    <option value="Melhorar saúde" ${healthData.fator_motivacao === 'Melhorar saúde' ? 'selected' : ''}>Melhorar a saúde</option>
                                                    <option value="Mudar estilo de vida" ${healthData.fator_motivacao === 'Mudar estilo de vida' ? 'selected' : ''}>Mudar estilo de vida</option>
                                                    <option value="Outro" ${healthData.fator_motivacao === 'Outro' ? 'selected' : ''}>Outro</option>
                                                </select>
                                            </div>
                                            <div class="mt-4">
                                                <label class="block text-sm font-medium text-gray-300">Atividade Antes do Desafio</label>
                                                <select id="atividade_antes_desafio" class="w-full" ${isReadOnly ? 'disabled' : ''}>
                                                    <option value="" ${!healthData.atividade_antes_desafio ? 'selected' : ''}>Selecione</option>
                                                    <option value="Nenhuma" ${healthData.atividade_antes_desafio === 'Nenhuma' ? 'selected' : ''}>Nenhuma</option>
                                                    <option value="1 vez na semana" ${healthData.atividade_antes_desafio === '1 vez na semana' ? 'selected' : ''}>1 vez na semana</option>
                                                    <option value="2 vezes na semana" ${healthData.atividade_antes_desafio === '2 vezes na semana' ? 'selected' : ''}>2 vezes na semana</option>
                                                    <option value="3 ou mais vezes na semana" ${healthData.atividade_antes_desafio === '3 ou mais vezes na semana' ? 'selected' : ''}>3 ou mais vezes na semana</option>
                                                    <option value="Todos os dias" ${healthData.atividade_antes_desafio === 'Todos os dias' ? 'selected' : ''}>Todos os dias</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <!-- Sub-grupo: Saúde e Condições Físicas -->
                                        <div>
                                            <h4 class="font-bold text-lg text-indigo-300 mb-2">Saúde e Condições Físicas</h4>
                                            <div>
                                                <label class="block text-sm font-medium text-gray-300">Lesões Atuais</label>
                                                <select id="lesoes_atuais" class="w-full" ${isReadOnly ? 'disabled' : ''}>
                                                    <option value="" ${!healthData.lesoes_atuais ? 'selected' : ''}>Selecione</option>
                                                    ${lesoesOptions.map(opt => `<option value="${opt}" ${healthData.lesoes_atuais === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                                                </select>
                                            </div>
                                            <div class="mt-4">
                                                <label class="block text-sm font-medium text-gray-300">Alergias</label>
                                                <input type="text" id="alergias" class="w-full" value="${healthData.alergias || ''}" placeholder="Ex: Lactose, glúten" ${isReadOnly ? 'readonly' : ''}>
                                            </div>
                                            <div class="mt-4">
                                                <label class="block text-sm font-medium text-gray-300">Força Inicial</label>
                                                <input type="text" id="forca_inicial" class="w-full" value="${healthData.forca_inicial || ''}" ${isReadOnly ? 'readonly' : ''}>
                                            </div>
                                            <div class="mt-4">
                                                <label class="block text-sm font-medium text-gray-300">Performance Cardio</label>
                                                <input type="text" id="performance_cardio" class="w-full" value="${healthData.performance_cardio || ''}" ${isReadOnly ? 'readonly' : ''}>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-6">
                                    <h4 class="font-bold text-lg text-white mb-2">Histórico Familiar</h4>
                                    <p class="text-sm text-gray-400 mb-2">Selecione as condições de saúde que ocorrem em sua família.</p>
                                    <div id="historico-familiar" class="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                        <label class="inline-flex items-center">
                                            <input type="checkbox" id="familia-diabetes" data-field="diabetes" class="form-checkbox h-5 w-5 text-indigo-500 bg-gray-700 border-gray-600" ${healthData.historico_familiar?.diabetes ? 'checked' : ''} ${isReadOnly ? 'disabled' : ''}>
                                            <span class="ml-2">Diabetes</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="checkbox" id="familia-hipertensao" data-field="hipertensao" class="form-checkbox h-5 w-5 text-indigo-500 bg-gray-700 border-gray-600" ${healthData.historico_familiar?.hipertensao ? 'checked' : ''} ${isReadOnly ? 'disabled' : ''}>
                                            <span class="ml-2">Pressão Alta (Hipertensão)</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="checkbox" id="familia-infarto" data-field="infarto" class="form-checkbox h-5 w-5 text-indigo-500 bg-gray-700 border-gray-600" ${healthData.historico_familiar?.infarto ? 'checked' : ''} ${isReadOnly ? 'disabled' : ''}>
                                            <span class="ml-2">Infarto</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="checkbox" id="familia-obesidade" data-field="obesidade" class="form-checkbox h-5 w-5 text-indigo-500 bg-gray-700 border-gray-600" ${healthData.historico_familiar?.obesidade ? 'checked' : ''} ${isReadOnly ? 'disabled' : ''}>
                                            <span class="ml-2">Obesidade</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="checkbox" id="familia-cancer" data-field="cancer" class="form-checkbox h-5 w-5 text-indigo-500 bg-gray-700 border-gray-600" ${healthData.historico_familiar?.cancer ? 'checked' : ''} ${isReadOnly ? 'disabled' : ''}>
                                            <span class="ml-2">Câncer</span>
                                        </label>
                                        <label class="inline-flex items-center">
                                            <input type="checkbox" id="familia-outro" data-field="outro" class="form-checkbox h-5 w-5 text-indigo-500 bg-gray-700 border-gray-600" ${healthData.historico_familiar?.outro ? 'checked' : ''} ${isReadOnly ? 'disabled' : ''}>
                                            <span class="ml-2">Outro</span>
                                        </label>
                                    </div>
                                </div>
                                
                                <h3 class="text-xl font-bold text-white mb-4 mt-8">Medidas Corporais e Bioquímicas</h3>
                                <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                                    <div><label class="block text-sm font-medium text-gray-300">Cintura (cm)</label><input type="number" step="any" id="cintura" class="w-full" value="${healthData.cintura || ''}" ${isReadOnly ? 'readonly' : ''}></div>
                                    <div><label class="block text-sm font-medium text-gray-300">Quadril (cm)</label><input type="number" step="any" id="quadril" class="w-full" value="${healthData.quadril || ''}" ${isReadOnly ? 'readonly' : ''}></div>
                                    <div><label class="block text-sm font-medium text-gray-300">Abdômen (cm)</label><input type="number" step="any" id="abdomen" class="w-full" value="${healthData.abdomen || ''}" ${isReadOnly ? 'readonly' : ''}></div>
                                    <div><label class="block text-sm font-medium text-gray-300">Gordura (%)</label><input type="number" step="any" id="percentual_gordura" class="w-full" value="${healthData.percentual_gordura || ''}" ${isReadOnly ? 'readonly' : ''}></div>
                                    <div><label class="block text-sm font-medium text-gray-300">Pressão Sistólica</label><input type="number" step="any" id="pressao_sistolica" class="w-full" value="${healthData.pressao_sistolica || ''}" ${isReadOnly ? 'readonly' : ''}></div>
                                    <div><label class="block text-sm font-medium text-gray-300">Pressão Diastólica</label><input type="number" step="any" id="pressao_diastolica" class="w-full" value="${healthData.pressao_diastolica || ''}" ${isReadOnly ? 'readonly' : ''}></div>
                                    <div><label class="block text-sm font-medium text-gray-300">Glicemia</label><input type="number" step="any" id="glicemia" class="w-full" value="${healthData.glicemia || ''}" ${isReadOnly ? 'readonly' : ''}></div>
                                    <div><label class="block text-sm font-medium text-gray-300">Colesterol Total</label><input type="number" step="any" id="colesterol_total" class="w-full" value="${healthData.colesterol_total || ''}" ${isReadOnly ? 'readonly' : ''}></div>
                                    <div><label class="block text-sm font-medium text-gray-300">Triglicerídeos</label><input type="number" step="any" id="triglicerideos" class="w-full" value="${healthData.triglicerideos || ''}" ${isReadOnly ? 'readonly' : ''}></div>
                                    <div><label class="block text-sm font-medium text-gray-300">TMB</label><input type="number" step="any" id="tmb" class="w-full" value="${healthData.tmb || ''}" ${isReadOnly ? 'readonly' : ''}></div>
                                </div>
                                <button type="button" data-action="save-health-data" data-id="${p.id}" style="background-color: var(--primary-color);" class="w-full hover:opacity-90 text-white font-bold py-2.5 px-4 rounded-md mt-4" ${isReadOnly ? 'disabled' : ''}>Salvar Ficha de Saúde</button>
                            </form>
                        </div>
                    </div>
                `;
                document.getElementById('healthDataForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    handleSaveHealthData(p.id);
                });
            }

            function updateProfileWeightList(participant) {
                const listContainer = document.getElementById('profile-weight-history-list');
                if (!listContainer) return;
                listContainer.innerHTML = '';
                const isOwnProfile = currentUser.participantId == participant.id;
                const canEditProfile = currentUser.role === 'admin' || isOwnProfile;
                
                const history = [...(participant.weight_history || [])].sort((a,b) => parseDateLocal(b.date) - parseDateLocal(a.date));

                if (history.length === 0) {
                    listContainer.innerHTML = `<p class="text-center text-gray-500 py-4">Nenhum registro de peso.</p>`;
                    return;
                }

                history.forEach((entry, index) => {
                    const formattedDate = parseDateLocal(entry.date).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                    let currentWeightAndChangeHTML = '';
                    const previousEntry = history[index + 1];

                    if (previousEntry) {
                        const change = entry.weight - previousEntry.weight;
                        const changeColor = change < 0 ? 'text-green-400' : (change > 0 ? 'text-red-400' : 'text-gray-400');
                        const sign = change > 0 ? '+' : '';
                        
                        currentWeightAndChangeHTML = `<span class="font-semibold text-white">${parseFloat(entry.weight).toFixed(2)} kg</span> <span class="text-xs ${changeColor}">(${sign}${change.toFixed(2)} kg)</span>`;
                    } else {
                        currentWeightAndChangeHTML = `<span class="font-semibold text-white">${parseFloat(entry.weight).toFixed(2)} kg</span> <span class="text-xs text-gray-500">(INÍCIO)</span>`;
                    }

                    const canDeleteEntry = canEditProfile && history.length > 1; 
                    const imageHTML = entry.imageUrl ? `<img data-action="view-image" data-url="${entry.imageUrl}" src="${entry.imageUrl}" alt="Foto da balança" class="w-8 h-8 object-cover rounded cursor-pointer border border-gray-700">` : '';

                    listContainer.innerHTML += `
                        <div class="flex justify-between items-center text-sm p-2 bg-gray-800 rounded-lg hover:bg-gray-700">
                            <div class="flex items-center gap-3">
                                ${imageHTML}
                                <span class="text-gray-400">${formattedDate}</span>
                            </div>
                            <div class="flex items-center gap-2">
                                ${currentWeightAndChangeHTML}
                                ${canDeleteEntry ? `<button data-action="delete-weight-entry" data-id="${participant.id}" data-entry-date="${entry.date}" class="text-gray-500 hover:text-red-500 p-1" title="Excluir">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                            </button>` : `<div class="w-6"></div>`}
                            </div>
                        </div>`;
                });
            }

            function updateProfileActivityList(participant) {
                const listContainer = document.getElementById('profile-activity-history-list');
                if (!listContainer) return;
                listContainer.innerHTML = '';
                const isOwnProfile = currentUser.participantId == participant.id;
                const canEditProfile = currentUser.role === 'admin' || isOwnProfile;

                const allActivities = participant.semanas_validas.flatMap((week, weekIndex) => 
                    (Array.isArray(week) ? week : []).map(activity => ({...activity, weekIndex}))
                ).sort((a, b) => getActivityTimestamp(b) - getActivityTimestamp(a));

                if (allActivities.length === 0) {
                    listContainer.innerHTML = `<p class="text-center text-gray-500 py-4">Nenhuma atividade registrada.</p>`;
                    return;
                }

                allActivities.forEach(act => {
                    const activityDate = parseDateLocal(act.date);
                    const formattedDate = !isNaN(activityDate.getTime()) 
                        ? activityDate.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' })
                        : 'Data inválida';
                    
                    const imageHTML = act.imageUrl ? `<img data-action="view-image" data-url="${act.imageUrl}" src="${act.imageUrl}" alt="Foto do treino" class="w-8 h-8 object-cover rounded cursor-pointer border border-gray-700">` : '';


                    listContainer.innerHTML += `
                        <div class="flex justify-between items-center text-sm p-2 bg-gray-800 rounded-lg hover:bg-gray-700">
                            <div class="flex items-center gap-3">
                                ${imageHTML}
                                <div>
                                    <span class="font-bold text-white">${act.type}</span> - 
                                    <span class="text-gray-300">${act.duration} min</span>
                                    <span class="text-gray-400 text-xs italic">(Sem. ${act.weekIndex + 1} - ${formattedDate})</span>
                                    ${act.is_public === false ? `<span class="text-gray-500 text-xs ml-2 flex items-center"><svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path></svg>Privado</span>` : ''}
                                </div>
                            </div>
                            ${canEditProfile ? `
                            <button data-action="delete-activity" data-id="${participant.id}" data-week="${act.weekIndex}" data-activity-id="${act.id}" class="text-gray-500 hover:text-red-500 p-1" title="Apagar Atividade">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>
                            </button>` : ''}
                        </div>
                    `;
                });
            }

            function renderActivityLogPage(data, container) {
                const today = new Date();
                const currentWeekIndex = Math.floor((today - CHALLENGE_START_DATE) / (1000 * 60 * 60 * 24 * 7));
                
                let legendHTML = `
                    <div class="flex justify-center items-center gap-4 mb-6 text-xs text-gray-400">
                        <div class="flex items-center gap-2"><div class="w-4 h-4 rounded" style="background-color: #374151;"></div><span>Nenhuma atividade</span></div>
                        <div class="flex items-center gap-2"><div class="w-4 h-4 rounded" style="background-color: var(--warning-color);"></div><span>1-2 atividades</span></div>
                        <div class="flex items-center gap-2"><div class="w-4 h-4 rounded" style="background-color: var(--success-color);"></div><span>Semana validada (3+)</span></div>
                    </div>
                `;

                let cardsHTML = '<div class="space-y-6">';
                if (data.length > 0) {
                    data.sort((a,b) => a.name.localeCompare(b.name)).forEach(p => {
                        const avatarSrc = p.avatar_url || `https://placehold.co/48x48/E2E8F0/4A5568?text=${p.name.charAt(0)}`;
                        let gridHTML = '<div class="activity-grid mt-4">';
                        for (let i = 0; i < MAX_WEEKS; i++) {
                            const weekActivities = p.semanas_validas[i] || [];
                            const activityCount = Array.isArray(weekActivities) ? weekActivities.length : 0;
                            let cellClass = 'activity-none';
                            if (activityCount >= MIN_ACTIVITIES_FOR_VALID_WEEK) {
                                cellClass = 'activity-complete';
                            } else if (activityCount > 0) {
                                cellClass = 'activity-partial';
                            }
                            const isCurrentWeek = i === currentWeekIndex ? 'current-week' : '';
                            gridHTML += `
                                <div class="relative">
                                    <div class="activity-cell-label">${i + 1}</div>
                                    <div class="activity-cell ${cellClass} ${isCurrentWeek}" title="Semana ${i + 1}: ${activityCount} atividades"></div>
                                </div>
                            `;
                        }
                        gridHTML += '</div>';

                        cardsHTML += `
                            <div class="profile-card">
                                <div class="flex items-center gap-4">
                                    <img src="${avatarSrc}" alt="Avatar de ${p.name}" class="w-12 h-12 rounded-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/48x48/E2E8F0/4A5568?text=${p.name.charAt(0)}';">
                                    <h3 class="text-lg font-bold text-white">${p.name}</h3>
                                </div>
                                ${gridHTML}
                            </div>
                        `;
                    });
                } else {
                    cardsHTML += `<div class="text-center py-10 text-gray-500">Nenhum participante para exibir.</div>`;
                }
                cardsHTML += '</div>';

                container.innerHTML = legendHTML + cardsHTML;
            }

            function renderWeeklySummaryPage(data, container) {
                const today = new Date();
                const dayOfWeek = today.getDay();
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
                startOfWeek.setHours(0, 0, 0, 0);
                
                const beforeStartOfWeek = new Date(startOfWeek);
                beforeStartOfWeek.setDate(beforeStartOfWeek.getDate() - 1);
                
                const oneWeekAgo = new Date(); oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

                const currentWeekIndex = Math.floor((startOfWeek - CHALLENGE_START_DATE) / (1000 * 60 * 60 * 24 * 7));

                let weeklyData = data.map(p => {
                    const weightThen = getWeightAtDate(p, beforeStartOfWeek);
                    const weightNow = getWeightAtDate(p, today);
                    const weightChange = weightNow - weightThen;
                    
                    const activitiesThisWeek = (p.semanas_validas[currentWeekIndex] || []).length;
                    
                    const lastWeightEntry = p.weight_history && p.weight_history.length > 0 ? new Date(Math.max(...p.weight_history.map(e => parseDateLocal(e.date)))) : new Date(0);
                    const isWeightUpdated = lastWeightEntry >= startOfWeek;

                    return { ...p, weightChange, activitiesThisWeek, isWeightUpdated };
                });

                let weightLossLeader = { name: 'N/A', loss: Number.NEGATIVE_INFINITY };
                let activityLeader = { name: 'N/A', count: -1 };
                let totalLoss = 0;
                

                weeklyData.forEach(p => {
                    const loss = getWeightAtDate(p, oneWeekAgo) - getWeightAtDate(p, new Date());
                    if (loss > weightLossLeader.loss) {
                        weightLossLeader = { name: p.name, loss };
                    }
                    if (p.activitiesThisWeek > activityLeader.count) {
                        activityLeader = { name: p.name, count: p.activitiesThisWeek };
                    }
                    if (p.weightChange < 0) {
                        totalLoss += -p.weightChange;
                    }
                });
                
                const notUpdated = weeklyData.filter(p => !p.isWeightUpdated);

                container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div class="card"><div class="text-sm font-medium text-gray-400">🔥 Maior Perda de Peso (Semana)</div><div class="text-2xl font-bold" style="color: var(--success-color);">${weightLossLeader.loss > 0 ? weightLossLeader.name : 'N/A'}</div><div class="text-sm text-gray-300">${weightLossLeader.loss > 0 ? weightLossLeader.loss.toFixed(2) : '0.00'} kg</div></div>
                        <div class="card"><div class="text-sm font-medium text-gray-400">🌟 Mais Atividades (Semana)</div><div class="text-2xl font-bold" style="color: var(--warning-color);">${activityLeader.count > 0 ? activityLeader.name : 'N/A'}</div><div class="text-sm text-gray-300">${activityLeader.count > 0 ? activityLeader.count + ' atividades' : 'Nenhuma'}</div></div>
                        <div class="card"><div class="text-sm font-medium text-gray-400">Total Perdido (Semana)</div><div class="text-3xl font-bold" style="color: var(--primary-color);">${totalLoss.toFixed(2)}</div><div class="text-sm text-gray-300">kg pelo grupo</div></div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 card">
                             <h3 class="text-lg font-semibold mb-2 text-white">Progresso da Semana</h3>
                             <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead><tr><th>Nome</th><th>Variação de Peso</th><th>Atividades</th></tr></thead>
                                    <tbody>
                                        ${weeklyData.map(p => {
                                            const avatarSrc = p.avatar_url || `https://placehold.co/40x40/E2E8F0/4A5568?text=${p.name.charAt(0)}`;
                                            return `
                                                <tr>
                                                    <td>
                                                        <div class="flex items-center">
                                                            <img src="${avatarSrc}" alt="Avatar de ${p.name}" class="w-8 h-8 rounded-full mr-3 object-cover flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/40x40/E2E8F0/4A5568?text=${p.name.charAt(0)}';">
                                                            <span>${p.name}</span>
                                                        </div>
                                                    </td>
                                                    <td><span class="font-semibold ${p.weightChange < 0 ? 'text-green-400' : (p.weightChange > 0 ? 'text-red-400' : '')}">${p.weightChange > 0 ? '+' : ''}${p.weightChange.toFixed(2)} kg</span></td>
                                                    <td class="text-center">${p.activitiesThisWeek}</td>
                                                </tr>
                                            `}).join('')}
                                    </tbody>
                                </table>
                             </div>
                        </div>
                        <div class="card">
                            <h3 class="text-lg font-semibold mb-2 text-white">Peso Desatualizado</h3>
                            ${notUpdated.length > 0 ? `
                            <ul class="space-y-2">
                                ${notUpdated.map(p => `<li class="p-3 bg-red-900/50 border-l-4 border-red-500 rounded-r-lg">${p.name}</li>`).join('')}
                            </ul>
                            ` : `<div class="p-4 text-center bg-green-900/50 border-l-4 border-green-500 rounded-r-lg">Todos os pesos estão atualizados! 🎉</div>`}
                        </div>
                    </div>
                `;
            }

            function renderCoachVirtualPage(container) {
                if (currentUser.role === 'admin') {
                    if (participants.length === 0) {
                        container.innerHTML = `<div class="text-center py-10 text-gray-500">Adicione participantes primeiro para usar o Coach Virtual.</div>`;
                        return;
                    }
                    const options = participants.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                    container.innerHTML = `
                        <div class="max-w-2xl mx-auto text-center">
                            <h3 class="text-2xl font-bold mb-2 text-white">Coach Virtual</h3>
                            <p class="text-gray-400 mb-6">Selecione um participante para receber uma dica personalizada baseada em seu progresso.</p>
                            <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-6">
                                <select id="coach-participant-selector" class="w-full sm:w-auto py-2 px-3">${options}</select>
                                <button id="generate-coach-tip-admin" style="background-color: var(--primary-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg w-full sm:w-auto">Gerar Dica</button>
                            </div>
                            <div id="ai-tip-container" class="p-6 bg-gray-800 rounded-lg text-gray-300 min-h-[120px] text-left">
                                Selecione um participante e clique no botão para começar.
                            </div>
                        </div>`;

                    document.getElementById('generate-coach-tip-admin').addEventListener('click', () => {
                        const selectedId = document.getElementById('coach-participant-selector').value;
                        getAICoachingTip(selectedId);
                    });

                } else {
                    container.innerHTML = `
                        <div class="max-w-2xl mx-auto text-center">
                            <h3 class="text-2xl font-bold mb-2 text-white">Seu Coach Virtual</h3>
                            <p class="text-gray-400 mb-6">Clique no botão abaixo para receber uma dica personalizada baseada no seu progresso.</p>
                            <div class="flex flex-col sm:flex-row items-center justify-center gap-4 mb-6">
                                <button data-action="ai-coach" data-id="${currentUser.participantId}" style="background-color: var(--primary-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg w-full sm:w-auto">Gerar Minha Dica do Coach</button>
                            </div>
                            <div id="ai-tip-container" class="p-6 bg-gray-800 rounded-lg text-gray-300 min-h-[120px] text-left">
                                Pronto para uma dica?
                            </div>
                        </div>`;
                }
            }

            
            // --- Chart helpers ---
            const __colorMap = new Map();
            function colorForName(name){
                if (__colorMap.has(name)) return __colorMap.get(name);
                const palette = [
                  '#4e79a7','#f28e2b','#e15759','#76b7b2','#59a14f','#edc949','#af7aa1','#ff9da7','#9c755f','#bab0ab'
                ];
                const idx = __colorMap.size % palette.length;
                __colorMap.set(name, palette[idx]);
                return palette[idx];
            }
            function placeEndLabel(g, name, x, y){
                g.append('text')
                 .attr('x', x + 6)
                 .attr('y', y)
                 .attr('dy','0.32em')
                 .attr('class','text-xs')
                 .style('fill','#fff')
                 .style('font-weight','600')
                 .style('paint-order','stroke')
                 .style('stroke','#0b1220')
                 .style('stroke-width',3)
                 .text(name);
            }
            function drawSparklines(container, participants){
                // container: element; participants with weight_history
                container.innerHTML = '';
                const wrap = document.createElement('div');
                wrap.id = 'sparklinesWrap';
                container.appendChild(wrap);
                const width = container.clientWidth || 360;
                participants.forEach(p => {
                    const row = document.createElement('div'); row.className = 'sparkline-row';
                    const label = document.createElement('div'); label.className = 'name'; label.textContent = p.name;
                    const svg = d3.create('svg').attr('class','sparkline').attr('viewBox','0 0 300 42');
                    const values = (p.weight_history||[]).map(e => ({date: parseDateLocal(e.date), value: e.weight}))
                                      .sort((a,b)=> a.date-b.date);
                    if (values.length >= 1){
                        const x = d3.scaleTime().domain(d3.extent(values, d=>d.date)).range([6, 290]);
                        const y = d3.scaleLinear().domain(d3.extent(values, d=>d.value)).nice().range([36, 6]);
                        const line = d3.line().x(d=>x(d.date)).y(d=>y(d.value));
                        svg.append('path').attr('d', line(values)).attr('fill','none').attr('stroke', colorForName(p.name)).attr('stroke-width',2);
                        const last = values[values.length-1];
                        svg.append('circle').attr('cx', x(last.date)).attr('cy', y(last.value)).attr('r',2.5).attr('fill','#fff').attr('stroke',colorForName(p.name));
                    }
                    row.appendChild(label); row.appendChild(svg.node()); wrap.appendChild(row);
                });
            }

            
function renderIndividualEvolutionPage(data, container) {
    container.innerHTML = `
      <div>
        <div class="reports-tabs mb-3">
          <button class="active" data-tab="evolucao">Evolução (kg)</button>
          <button data-tab="perda">% Perda</button>
          <button data-tab="atividades">Atividades</button>
        </div>
        <div id="reportTabContent"></div>
      </div>`;

    const tabContent = document.getElementById('reportTabContent');
    function renderTab(tab){
        if (tab === 'evolucao'){
            tabContent.innerHTML = `
              <div id="mainWeightChartWrapper" class="card mb-6"></div>
              <div id="mobileSparklines" class="card mb-6"></div>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div id="percentageLossChartContainer" class="card"></div>
                <div id="totalActivityChartContainer" class="card"></div>
              </div>`;
            // Desktop main chart + mobile sparklines
            if (window.innerWidth >= 768) {
                renderMainWeightChart(data);
            } else {
                const people = data.filter(p => p.weight_history && p.weight_history.length>0);
                drawSparklines(document.getElementById('mobileSparklines'), people);
            }
            renderPercentageLossChart(data, document.getElementById('percentageLossChartContainer'));
            renderTotalActivityChart(data, document.getElementById('totalActivityChartContainer'));
        } else if (tab === 'perda'){
            tabContent.innerHTML = `<div id="percentageLossChartContainer" class="card"></div>`;
            renderPercentageLossChart(data, document.getElementById('percentageLossChartContainer'));
        } else if (tab === 'atividades'){
            tabContent.innerHTML = `<div id="totalActivityChartContainer" class="card"></div>`;
            renderTotalActivityChart(data, document.getElementById('totalActivityChartContainer'));
        }
    }
    // tabs
    const tabs = container.querySelectorAll('.reports-tabs button');
    tabs.forEach(b=> b.addEventListener('click', (e)=>{
        tabs.forEach(x=>x.classList.remove('active')); e.currentTarget.classList.add('active');
        renderTab(e.currentTarget.dataset.tab);
    }));
    renderTab('evolucao');
}


            
function renderMainWeightChart(data) {
    const chartContainer = document.getElementById('mainWeightChartWrapper');
    const people = data.filter(p => p.weight_history && p.weight_history.length > 0);
    if (people.length === 0){
        chartContainer.innerHTML = `<div class="text-center py-10 text-gray-500">Não há histórico de peso para exibir.</div>`;
        return;
    }
    const margin = {top: 20, right: 130, bottom: 30, left: 45};
    const width = (chartContainer.clientWidth || 800) - margin.left - margin.right;
    const height = 360 - margin.top - margin.bottom;
    const svg = d3.select(chartContainer).append('svg')
        .attr('width', width + margin.left + margin.right)
        .attr('height', height + margin.top + margin.bottom)
        .append('g').attr('transform', `translate(${margin.left},${margin.top})`);

    // build unified series
    const series = people.map(p => ({
        name: p.name,
        color: colorForName(p.name),
        target: p.target_weight || null,
        values: (p.weight_history||[]).map(e => ({date: parseDateLocal(e.date), value: e.weight})).sort((a,b)=>a.date-b.date)
    })).filter(s => s.values.length);

    const x = d3.scaleTime()
        .domain([d3.min(series, s=> s.values[0].date), d3.max(series, s=> s.values[s.values.length-1].date)])
        .range([0, width]);
    const y = d3.scaleLinear()
        .domain([d3.min(series, s=> d3.min(s.values, v=>v.value)) * 0.98, d3.max(series, s=> d3.max(s.values, v=>v.value)) * 1.02])
        .nice()
        .range([height, 0]);

    // axes
    svg.append('g').attr('transform', `translate(0,${height})`).call(d3.axisBottom(x).ticks(6)).selectAll('text').style('fill','var(--text-muted)');
    svg.append('g').call(d3.axisLeft(y).ticks(6)).selectAll('text').style('fill','var(--text-muted)');
    svg.selectAll('.domain, .tick line').style('stroke','#334155').style('opacity',.4);

    const line = d3.line().x(d=>x(d.date)).y(d=>y(d.value));

    // draw lines
    const gSeries = svg.append('g').attr('class','series');
    series.forEach(s => {
        gSeries.append('path').attr('fill','none').attr('stroke', s.color).attr('stroke-width',2).attr('d', line(s.values));
        // last 2 markers
        const lastTwo = s.values.slice(-2);
        lastTwo.forEach(v => {
            gSeries.append('circle').attr('cx', x(v.date)).attr('cy', y(v.value)).attr('r',3).attr('fill','#fff').attr('stroke',s.color).attr('stroke-width',2);
        });
        // end label
        const last = s.values[s.values.length-1];
        placeEndLabel(gSeries, s.name, x(last.date), y(last.value));
        // target dashed
        if (s.target){
            gSeries.append('line')
              .attr('x1', 0).attr('x2', width)
              .attr('y1', y(s.target)).attr('y2', y(s.target))
              .attr('stroke', '#f59e0b').attr('stroke-dasharray','4,4').attr('opacity', .8);
        }
    });
}


            function renderTrendChart(data) {
                const chartContainer = document.getElementById('trendChartWrapper');
                const participantsWithHistory = data.filter(p => p.weight_history && p.weight_history.length > 1);
                if (participantsWithHistory.length === 0) return chartContainer.innerHTML += `<div class="text-center py-10 text-gray-500">Dados insuficientes para projeção.</div>`;
                
                const margin = {top: 20, right: 120, bottom: 30, left: 40}, width = (chartContainer.clientWidth || 800) - margin.left - margin.right, height = 350 - margin.top - margin.bottom;
                const svg = d3.select(chartContainer).append("svg").attr("width", "100%").attr("height", "100%").attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
                
                let allChartWeights = [];
                participantsWithHistory.forEach(p => {
                    p.weight_history.forEach(d => allChartWeights.push(d.weight));
                    const trend = calculateTrendLine(p.weight_history);
                    if (trend) allChartWeights.push(trend.start.weight, trend.end.weight);
                });
                
                const xScale = d3.scaleTime().domain([CHALLENGE_START_DATE, CHALLENGE_END_DATE]).range([0, width]);
                const yScale = d3.scaleLinear().domain([d3.min(allChartWeights) - 2, d3.max(allChartWeights) + 2]).range([height, 0]);
                const colors = d3.scaleOrdinal(d3.schemeTableau10);
                
                svg.append("g").attr("class", "grid").call(d3.axisLeft(yScale).tickSize(-width).tickFormat("")).selectAll("line").attr("stroke", "#374151");
                svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(xScale).tickFormat(d3.timeFormat("%d/%m"))).selectAll("text").style("fill", "var(--text-muted)");
                svg.append("g").call(d3.axisLeft(yScale).tickFormat(d => `${d}kg`)).selectAll("text").style("fill", "var(--text-muted)");

                participantsWithHistory.forEach(p => {
                    const trend = calculateTrendLine(p.weight_history);
                    if (trend) {
                        svg.append("line").attr("x1", xScale(trend.start.date)).attr("y1", yScale(trend.start.weight)).attr("x2", xScale(trend.end.date)).attr("y2", yScale(trend.end.weight)).attr("stroke", colors(p.name)).attr("stroke-width", 2.5).attr("stroke-dasharray", "6,6");
                        svg.append("text").attr("transform", "translate(" + (width + 5) + "," + yScale(trend.end.weight) + ")").attr("dy", ".35em").attr("text-anchor", "start").style("fill", colors(p.name)).text(p.name);
                    }
                });
            }

            
function renderPercentageLossChart(data, container) {
    container.innerHTML = `<h3 class="text-xl font-semibold text-center mb-2 text-white">Ranking de % de Perda</h3>`;
    const chartData = data.map(p => ({ 
        name: p.name, 
        percentLoss: (p.peso_inicial && p.peso_atual) ? ((p.peso_inicial - p.peso_atual) / p.peso_inicial * 100) : 0,
        totalActivities: (p.activities || []).length || 0
    })).sort((a,b)=> b.percentLoss - a.percentLoss);
    const margin = {top: 20, right: 60, bottom: 30, left: 120};
    const width = (container.clientWidth || 400) - margin.left - margin.right;
    const height = Math.max(180, chartData.length * 28) - margin.top - margin.bottom;
    const svg = d3.select(container).append('svg')
        .attr('width', width + margin.left + margin.right)
        .attr('height', height + margin.top + margin.bottom)
        .append('g').attr('transform', `translate(${margin.left},${margin.top})`);
    const xScale = d3.scaleLinear().domain([0, d3.max(chartData, d => d.percentLoss) * 1.1 || 10]).range([0, width]);
    const yScale = d3.scaleBand().domain(chartData.map(d => d.name)).range([0, height]).padding(0.2);
    svg.append('g').call(d3.axisLeft(yScale).tickSize(0)).select('.domain').remove();
    svg.selectAll('.tick text').style('fill','var(--text-muted)');
    svg.append('g').attr('transform', `translate(0,${height})`).call(d3.axisBottom(xScale).ticks(5)).selectAll('text').style('fill','var(--text-muted)');
    const bars = svg.selectAll('.bar').data(chartData).enter().append('rect').attr('class','bar')
        .attr('x',0).attr('y', d=> yScale(d.name)).attr('height', yScale.bandwidth())
        .attr('width', d=> xScale(d.percentLoss))
        .attr('fill', d=> colorForName(d.name));
    svg.selectAll('.bar-label').data(chartData).enter().append('text').attr('class','bar-label')
        .attr('x', d=> xScale(d.percentLoss) + 6)
        .attr('y', d=> yScale(d.name) + yScale.bandwidth()/2).attr('dy','.32em')
        .style('fill','#fff').style('font-weight','700')
        .text(d => d.percentLoss.toFixed(2) + '%');
}


            
function renderTotalActivityChart(data, container) {
    container.innerHTML = `<h3 class="text-xl font-semibold text-center mb-2 text-white">Ranking de Atividades Totais</h3>`;
    
    const pByName = new Map((participants || []).map(p => [p.name, p]));
    const chartData = data.map(m => {
        const raw = pByName.get(m.name) || m;
        const weeks = Array.isArray(raw.semanas_validas) ? raw.semanas_validas : [];
        let count = weeks.reduce((sum, wk) => sum + (Array.isArray(wk) ? wk.length : 0), 0);
        if ((!count || isNaN(count)) && Array.isArray(raw.activities)) count = raw.activities.length;
        if ((!count || isNaN(count)) && typeof m.totalActivities === 'number') count = m.totalActivities;
        return { name: m.name, totalActivities: count || 0 };
    }).sort((a,b)=> b.totalActivities - a.totalActivities);

    const margin = {top: 20, right: 60, bottom: 30, left: 120};
    const width = (container.clientWidth || 400) - margin.left - margin.right;
    const height = Math.max(180, chartData.length * 28) - margin.top - margin.bottom;
    const svg = d3.select(container).append('svg')
        .attr('width', width + margin.left + margin.right)
        .attr('height', height + margin.top + margin.bottom)
        .append('g').attr('transform', `translate(${margin.left},${margin.top})`);
    const xScale = d3.scaleLinear().domain([0, Math.max(5, (d3.max(chartData, d => d.totalActivities) || 0) * 1.1)]).range([0, width]);
    const yScale = d3.scaleBand().domain(chartData.map(d => d.name)).range([0, height]).padding(0.2);
    svg.append('g').call(d3.axisLeft(yScale).tickSize(0)).select('.domain').remove();
    svg.selectAll('.tick text').style('fill','var(--text-muted)');
    svg.append('g').attr('transform', `translate(0,${height})`).call(d3.axisBottom(xScale).ticks(5)).selectAll('text').style('fill','var(--text-muted)');
    const bars = svg.selectAll('.bar').data(chartData).enter().append('rect').attr('class','bar')
        .attr('x',0).attr('y', d=> yScale(d.name)).attr('height', yScale.bandwidth())
        .attr('width', d=> xScale(d.totalActivities))
        .attr('fill', d=> colorForName(d.name));
    svg.selectAll('.bar-label').data(chartData).enter().append('text').attr('class','bar-label')
        .attr('x', d=> xScale(d.totalActivities) + 6)
        .attr('y', d=> yScale(d.name) + yScale.bandwidth()/2).attr('dy','.32em')
        .style('fill','#fff').style('font-weight','700')
        .text(d => d.totalActivities);
}


            function renderGroupEvolutionChart(data, container) {
                container.innerHTML = `
                    <div id="group-evolution-wrapper">
                        <h3 class="text-xl font-semibold text-center mb-2 text-white">Evolução da Perda de Peso do Grupo</h3>
                        <div id="groupEvolutionChartContainer" class="w-full h-96 mb-8"></div>
                        <div id="groupPieChartContainer" class="w-full mt-8"></div>
                    </div>`;
                const chartContainer = document.getElementById('groupEvolutionChartContainer');
                const pieContainer = document.getElementById('groupPieChartContainer');

                setTimeout(() => {
                    const weeklyLossData = [];
                    for (let i = 0; i < MAX_WEEKS; i++) {
                        const weekStartDate = new Date(CHALLENGE_START_DATE); weekStartDate.setDate(weekStartDate.getDate() + i * 7);
                        const weekEndDate = new Date(weekStartDate); weekEndDate.setDate(weekEndDate.getDate() + 7);
                        let totalWeeklyLoss = 0;
                        participants.forEach(p => { 
                            const lossThisWeek = getWeightAtDate(p, weekStartDate) - getWeightAtDate(p, weekEndDate);
                            if (lossThisWeek > 0) {
                                totalWeeklyLoss += lossThisWeek;
                            }
                        });
                        weeklyLossData.push({ week: i + 1, totalLoss: totalWeeklyLoss });
                    }

                    if (weeklyLossData.every(d => d.totalLoss === 0)) {
                        chartContainer.innerHTML = `<div class="text-center py-10 text-gray-500">Nenhuma perda de peso registrada para o grupo.</div>`;
                    } else {
                        const margin = {top: 20, right: 30, bottom: 40, left: 70}, width = chartContainer.clientWidth - margin.left - margin.right, height = chartContainer.clientHeight - margin.top - margin.bottom;
                        const svg = d3.select(chartContainer).append("svg").attr("width", "100%").attr("height", "100%").attr("viewBox", `0 0 ${chartContainer.clientWidth} ${chartContainer.clientHeight}`).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
                        const xScale = d3.scaleBand().domain(weeklyLossData.map(d => d.week)).range([0, width]).padding(0.2);
                        const yScale = d3.scaleLinear().domain([0, d3.max(weeklyLossData, d => d.totalLoss) * 1.1 || 1]).range([height, 0]);
                        svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(xScale)).append("text").attr("y", 35).attr("x", width / 2).attr("text-anchor", "middle").attr("fill", "var(--text-muted)").text("Semana");
                        svg.append("g").call(d3.axisLeft(yScale).tickFormat(d => `${d.toFixed(1)}kg`)).append("text").attr("transform", "rotate(-90)").attr("y", -margin.left + 20).attr("x", -height / 2).attr("text-anchor", "middle").attr("fill", "var(--text-muted)").text("Perda Total (kg)");
                        svg.selectAll(".bar").data(weeklyLossData).enter().append("rect").attr("class", "bar").attr("x", d => xScale(d.week)).attr("y", d => yScale(Math.max(0, d.totalLoss))).attr("width", xScale.bandwidth()).attr("height", d => Math.abs(yScale(0) - yScale(d.totalLoss))).attr("fill", "var(--primary-color)");
                    }
                    
                    const pieData = participants.map(p => ({ name: p.name, value: Math.max(0, p.peso_inicial - getWeightAtDate(p, new Date())) })).filter(p => p.value > 0);
                    const totalLoss = d3.sum(pieData, d => d.value);

                    if (pieData.length > 0) {
                        pieContainer.innerHTML = `<h3 class="text-xl font-semibold text-center mb-4 text-white">Contribuição Individual para Perda Total</h3><div id="pie-chart-wrapper" class="grid grid-cols-1 md:grid-cols-3 items-center justify-center gap-8"></div>`;
                        const wrapper = d3.select("#pie-chart-wrapper");
                        wrapper.append("div").attr("class", "flex flex-col items-center justify-center text-center bg-gradient-to-br from-indigo-900 to-gray-800 p-6 rounded-2xl shadow-lg h-full").html(`<h4 class="text-lg font-bold text-indigo-300 mb-2">PERDA TOTAL DO GRUPO</h4><p class="text-6xl font-extrabold text-indigo-400">${totalLoss.toFixed(2)}</p><p class="text-2xl font-semibold text-indigo-300">kg</p>`);
                        const svgContainer = wrapper.append("div").attr("class", "flex items-center justify-center");
                        const legendContainer = wrapper.append("div").attr("class", "flex flex-col justify-center");
                        const pieWidth = 300, pieHeight = 300, radius = Math.min(pieWidth, pieHeight) / 2 - 10;
                        const pieSvg = svgContainer.append("svg").attr("width", pieWidth).attr("height", pieHeight).append("g").attr("transform", `translate(${pieWidth / 2},${pieHeight / 2})`);
                        const colors = d3.scaleOrdinal(d3.schemeTableau10);
                        const pie = d3.pie().value(d => d.value);
                        const arc = d3.arc().innerRadius(radius * 0.5).outerRadius(radius);
                        pieSvg.selectAll('slices').data(pie(pieData)).enter().append('path').attr('d', arc).attr('fill', d => colors(d.data.name)).attr("stroke", "#1f2937").style("stroke-width", "2px");
                        const legend = legendContainer.selectAll(".legend-item").data(pieData).enter().append("div").attr("class", "legend-item flex items-center mb-2 text-sm");
                        legend.append("div").style("width", "18px").style("height", "18px").style("background-color", d => colors(d.name)).attr("class", "mr-2 rounded-sm flex-shrink-0");
                        legend.append("span").text(d => `${d.name}: ${d.value.toFixed(2)}kg (${(d.value / totalLoss * 100).toFixed(1)}%)`);
                    }
                }, 0);
            }

            function renderComparisonChart(data, container) {
                let checkboxesHTML = data.map(p => `<label class="inline-flex items-center mr-4 mb-2"><input type="checkbox" class="comparison-checkbox form-checkbox h-5 w-5 text-indigo-500 bg-gray-700 border-gray-600" value="${p.name}"><span class="ml-2">${p.name}</span></label>`).join('');
                let metricsHTML = `<div id="comparison-metrics" class="flex flex-wrap gap-4 mb-4 pb-4 border-b border-gray-700">
                        <label class="inline-flex items-center"><input type="radio" name="comparisonMetric" value="weight" class="form-radio text-indigo-500 bg-gray-700 border-gray-600" checked><span class="ml-2">Peso (kg)</span></label>
                        <label class="inline-flex items-center"><input type="radio" name="comparisonMetric" value="percentLoss" class="form-radio text-indigo-500 bg-gray-700 border-gray-600"><span class="ml-2">B% Perda de Peso</span></label>
                        <label class="inline-flex items-center"><input type="radio" name="comparisonMetric" value="activities" class="form-radio text-indigo-500 bg-gray-700 border-gray-600"><span class="ml-2">Total de Atividades</span></label>
                    </div>`;
                container.innerHTML = `<div id="comparison-content">${metricsHTML}<div id="comparison-checkboxes" class="p-4 rounded-lg mb-4">${checkboxesHTML}</div><div id="comparisonChartContainer" class="w-full h-96"></div></div>`;
                updateComparisonChart();
            }

            function updateComparisonChart() {
                const chartContainer = document.getElementById('comparisonChartContainer');
                const selectedMetric = document.querySelector('input[name="comparisonMetric"]:checked')?.value || 'weight';
                const selectedNames = Array.from(document.querySelectorAll('.comparison-checkbox:checked')).map(cb => cb.value);
                const selectedParticipants = participants.filter(p => selectedNames.includes(p.name));
                chartContainer.innerHTML = '';

                if (selectedParticipants.length === 0) {
                    return chartContainer.innerHTML = `<div class="text-center py-10 text-gray-500">Selecione um ou mais participantes para comparar.</div>`;
                }

                const colors = d3.scaleOrdinal(d3.schemeTableau10);
                const margin = {top: 20, right: 160, bottom: 40, left: 50}, width = chartContainer.clientWidth - margin.left - margin.right, height = chartContainer.clientHeight - margin.top - margin.bottom;
                const svg = d3.select(chartContainer).append("svg").attr("width", "100%").attr("height", "100%").attr("viewBox", `0 0 ${chartContainer.clientWidth} ${chartContainer.clientHeight}`).append("g").attr("transform", `translate(${margin.left},${margin.top})`);

                if (selectedMetric === 'weight' || selectedMetric === 'percentLoss') {
                    const participantsWithHistory = selectedParticipants.filter(p => p.weight_history && p.weight_history.length > 0);
                    if (participantsWithHistory.length === 0) return chartContainer.innerHTML = `<div class="text-center py-10 text-gray-500">Nenhum histórico de peso para os selecionados.</div>`;

                    let allChartDates = [], allChartValues = [];
                    const chartData = participantsWithHistory.map(p => {
                        const sortedHistory = [...p.weight_history].sort((a, b) => parseDateLocal(a.date) - parseDateLocal(b.date));
                        const history = sortedHistory.map(entry => {
                            const value = selectedMetric === 'weight' ? entry.weight : ((p.peso_inicial - entry.weight) / p.peso_inicial) * 100;
                            allChartDates.push(parseDateLocal(entry.date)); allChartValues.push(value);
                            return { date: entry.date, value: value };
                        });
                        return { name: p.name, history };
                    });

                    const xScale = d3.scaleTime().domain(d3.extent(allChartDates)).range([0, width]);
                    const yScale = d3.scaleLinear().domain([d3.min(allChartValues) - 1, d3.max(allChartValues) + 1]).range([height, 0]);
                    const line = d3.line().x(d => xScale(parseDateLocal(d.date))).y(d => yScale(d.value));

                    svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(xScale).tickFormat(d3.timeFormat("%d/%m"))).selectAll("text").style("fill", "var(--text-muted)");
                    svg.append("g").call(d3.axisLeft(yScale).tickFormat(d => selectedMetric === 'weight' ? `${d}kg` : `${d.toFixed(1)}%`)).selectAll("text").style("fill", "var(--text-muted)");

                    chartData.forEach(p => { svg.append("path").datum(p.history).attr("fill", "none").attr("stroke", colors(p.name)).attr("stroke-width", 2).attr("d", line); });
                    const legend = svg.selectAll(".legend").data(chartData).enter().append("g").attr("class", "legend").attr("transform", (d, i) => `translate(${width + 20},${i * 20})`);
                    legend.append("rect").attr("width", 18).attr("height", 18).style("fill", d => colors(d.name));
                    legend.append("text").attr("x", 24).attr("y", 9).attr("dy", ".35em").style("text-anchor", "start").text(d => d.name).style("fill", "var(--text-light)");

                } else if (selectedMetric === 'activities') {
                    const weeks = Array.from({length: MAX_WEEKS}, (_, i) => i + 1);
                    const maxActivities = d3.max(selectedParticipants, p => d3.max(p.semanas_validas, w => w.length));

                    const xScale = d3.scaleBand().domain(weeks).range([0, width]).padding(0.2);
                    const xSubgroup = d3.scaleBand().domain(selectedNames).range([0, xScale.bandwidth()]).padding([0.05]);
                    const yScale = d3.scaleLinear().domain([0, maxActivities > 0 ? maxActivities : 5]).range([height, 0]);

                    svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(xScale)).append("text").attr("x", width / 2).attr("y", margin.bottom - 5).attr("fill", "var(--text-muted)").text("Semana");
                    svg.append("g").call(d3.axisLeft(yScale)).selectAll("text").style("fill", "var(--text-muted)");

                    svg.append("g").selectAll("g").data(selectedParticipants).enter().append("g")
                        .attr("transform", d => `translate(${xSubgroup(d.name)},0)`)
                        .selectAll("rect").data(d => weeks.map(w => ({ key: d.name, week: w, value: (d.semanas_validas[w-1] || []).length })))
                        .enter().append("rect")
                            .attr("x", d => xScale(d.week)).attr("y", d => yScale(d.value))
                            .attr("width", xSubgroup.bandwidth()).attr("height", d => height - yScale(d.value))
                            .attr("fill", d => colors(d.key));
                    
                    const legend = svg.selectAll(".legend").data(selectedParticipants).enter().append("g").attr("class", "legend").attr("transform", (d, i) => `translate(${width + 20},${i * 20})`);
                    legend.append("rect").attr("width", 18).attr("height", 18).style("fill", d => colors(d.name));
                    legend.append("text").attr("x", 24).attr("y", 9).attr("dy", ".35em").style("text-anchor", "start").text(d => d.name).style("fill", "var(--text-light)");
                }
            }

            function renderSettingsPage(container) {
                if (currentUser.role !== 'admin') return;
                const startDate = CHALLENGE_START_DATE.toISOString().split('T')[0];
                const endDate = CHALLENGE_END_DATE.toISOString().split('T')[0];
                
                container.innerHTML = `<div class="space-y-8">
                        <div>
                            <h3 class="text-lg font-semibold mb-2 text-white">Gerenciamento de Participantes</h3>
                            <div class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                                <p class="mb-4 text-gray-300">Adicione, edite ou remova participantes e suas credenciais de login.</p>
                                <button data-action="go-to-participants" style="background-color: var(--primary-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg">Gerenciar Participantes</button>
                            </div>
                        </div>
                        <div>
                             <h3 class="text-lg font-semibold mb-2 text-white">Configurações do Desafio</h3>
                             <form id="challengeConfigForm" class="bg-gray-800 p-6 rounded-xl border border-gray-700">
                                 <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                     <div><label for="startDate" class="block font-bold text-gray-300">Data de Início:</label><input type="date" id="startDate" class="w-full" value="${startDate}" required></div>
                                     <div><label for="endDate" class="block font-bold text-gray-300">Data de Fim:</label><input type="date" id="endDate" class="w-full" value="${endDate}" required></div>
                                 </div>
                                 <button type="submit" style="background-color: var(--success-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded w-full">Salvar Datas</button>
                             </form>
                        </div>
                    </div>`;

                document.getElementById('challengeConfigForm').addEventListener('submit', e => {
                    e.preventDefault();
                    CHALLENGE_START_DATE = new Date(document.getElementById('startDate').value + 'T00:00:00');
                    CHALLENGE_END_DATE = new Date(document.getElementById('endDate').value + 'T23:59:59');
                    saveChallengeConfig(); showFeedbackMessage('Datas do desafio atualizadas!'); updateCurrentView();
                });
            }
            
            function renderRulesPage(container) {
                container.innerHTML = `
                    <div class="max-w-4xl mx-auto space-y-8">
                        <div class="text-center">
                            <h2 class="text-3xl font-extrabold text-white">Regras do Desafio FIT PRO</h2>
                            <p class="mt-2 text-lg text-gray-400">Entenda como funciona a pontuação e conquiste a vitória!</p>
                        </div>

                        <div class="profile-card">
                            <h3 class="text-xl font-bold text-indigo-400 mb-4 flex items-center">
                                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                                Sistema de Pontuação (Máximo 100 Pontos)
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                                    <h4 class="font-bold text-lg text-white">Pontos por Perda de Peso (até 50 pts)</h4>
                                    <p class="text-sm text-gray-400 mt-1">Os pontos são baseados no **percentual de peso perdido** em relação ao seu peso inicial. Quanto maior o percentual, mais pontos você ganha!</p>
                                    <ul class="mt-4 space-y-2 text-sm text-gray-300">
                                        <li class="flex items-start"><span class="font-bold text-indigo-400 mr-2">►</span> 2% de perda = 10 pts</li>
                                        <li class="flex items-start"><span class="font-bold text-indigo-400 mr-2">►</span> 4% de perda = 15 pts</li>
                                        <li class="flex items-start"><span class="font-bold text-indigo-400 mr-2">►</span> 6% de perda = 20 pts</li>
                                        <li class="flex items-start"><span class="font-bold text-indigo-400 mr-2">►</span> 8% de perda = 30 pts</li>
                                        <li class="flex items-start"><span class="font-bold text-indigo-400 mr-2">►</span> 10% de perda = 35 pts</li>
                                        <li class="flex items-start"><span class="font-bold text-indigo-400 mr-2">►</span> 12% de perda = 40 pts</li>
                                        <li class="flex items-start"><span class="font-bold text-indigo-400 mr-2">►</span> 15% de perda = 50 pts</li>
                                    </ul>
                                </div>
                                <div class="bg-gray-800 p-6 rounded-lg border border-gray-700">
                                    <h4 class="font-bold text-lg text-white">Pontos por Atividades (até 50 pts)</h4>
                                    <p class="text-sm text-gray-400 mt-1">Para validar uma semana, você precisa registrar pelo menos **3 atividades físicas**.</p>
                                    <p class="text-sm text-gray-400 mt-2">A pontuação é calculada com base no número de semanas que você validou. Se validar todas as 12 semanas, você ganha os 50 pontos!</p>
                                </div>
                            </div>
                        </div>

                        <div class="profile-card">
                            <h3 class="text-xl font-bold text-amber-400 mb-4 flex items-center">
                                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-12v4m-2-2h4m5 10v4m-2-2h4M5 3a2 2 0 00-2 2v1m14 0V5a2 2 0 00-2-2h-1m-4 18a2 2 0 002-2v-1m-4 0v1a2 2 0 002 2h1M5 21a2 2 0 012-2h1m4 0h1a2 2 0 012 2v0M3 17a2 2 0 012-2h1m4 0h1a2 2 0 012 2v0m6-14a2 2 0 00-2-2h-1m-4 0h-1a2 2 0 00-2 2v1"></path></svg>
                                Emblemas e Conquistas
                            </h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 text-center">
                                <div class="bg-gray-800 p-4 rounded-lg">
                                    <p class="text-4xl">🎯</p>
                                    <p class="font-semibold mt-2 text-white">Meta Atingida</p>
                                    <p class="text-xs text-gray-400">Alcance o seu peso meta.</p>
                                </div>
                                <div class="bg-gray-800 p-4 rounded-lg">
                                    <p class="text-4xl">5️⃣</p>
                                    <p class="font-semibold mt-2 text-white">Clube dos 5kg</p>
                                    <p class="text-xs text-gray-400">Perca 5kg no total.</p>
                                </div>
                                <div class="bg-gray-800 p-4 rounded-lg">
                                    <p class="text-4xl">🔟</p>
                                    <p class="font-semibold mt-2 text-white">Clube dos 10kg</p>
                                    <p class="text-xs text-gray-400">Perca 10kg no total.</p>
                                </div>
                                <div class="bg-gray-800 p-4 rounded-lg">
                                    <p class="text-4xl">🔥</p>
                                    <p class="font-semibold mt-2 text-white">Em Chamas!</p>
                                    <p class="text-xs text-gray-400">Valide 4 semanas seguidas.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // --- MANIPULADORES DE AÇÃO ---
            async function handleUpdateWeight(participantId) {
                const weightInput = document.getElementById('profile-weight-input');
                const dateInput = document.getElementById('profile-weight-date');
                const photoFile = document.getElementById('profile-weight-photo').files[0];
                const photoPrivacy = document.getElementById('profile-weight-photo-privacy').value === 'public';
                
                const newWeight = parseFloat(weightInput.value);
                const dateValue = dateInput.value;

                if (isNaN(newWeight) || newWeight <= 0) return showFeedbackMessage("Peso inválido.", true);
                if (!dateValue) return showFeedbackMessage("Selecione uma data.", true);
                
                const participant = participants.find(p => p.id == participantId);
                if (!participant) return;

                let imageUrl = null;
                if (photoFile) {
                    showFeedbackMessage('Enviando foto da balança...', false);
                    const fileName = `public/weights/${participantId}-${Date.now()}-${photoFile.name}`;
                    const { data: uploadData, error: uploadError } = await supabase.storage.from('activity-photos').upload(fileName, photoFile);
                    
                    if (uploadError) {
                        console.error("Erro no upload da foto da balança:", uploadError);
                        return showFeedbackMessage('Erro ao enviar a foto da balança.', true);
                    }
                    imageUrl = supabase.storage.from('activity-photos').getPublicUrl(fileName).data.publicUrl;
                }

                const newEntry = { 
                    date: new Date(dateValue + 'T00:00:00').toISOString(), 
                    weight: newWeight,
                    imageUrl: imageUrl,
                    is_public: photoPrivacy
                };

                const filteredHistory = (participant.weight_history || []).filter(entry => 
                    parseDateLocal(entry.date).toDateString() !== parseDateLocal(newEntry.date).toDateString()
                );
                const newHistory = [...filteredHistory, newEntry];
                newHistory.sort((a, b) => parseDateLocal(a.date) - parseDateLocal(b.date));
                
                const latestWeightInHistory = newHistory.length > 0 ? newHistory[newHistory.length - 1].weight : participant.peso_inicial;

                const { error } = await supabase.from('participants').update({ 
                    weight_history: newHistory,
                    peso_atual: latestWeightInHistory 
                }).eq('id', participantId);

                if (error) {
                    showFeedbackMessage('Erro ao atualizar peso.', true);
                } else { 
                    showFeedbackMessage(`Peso de ${participant.name} atualizado!`); 
                    reloadData(); 
                }
            }

            async function detectWeightFromImage(participantId) {
                const weightPhotoInput = document.getElementById('profile-weight-photo');
                const weightInput = document.getElementById('profile-weight-input');
                const aiFeedback = document.getElementById('ai-weight-feedback');
                const photoFile = weightPhotoInput.files[0];

                if (!photoFile) {
                    aiFeedback.textContent = 'Por favor, selecione uma foto da balança.';
                    return;
                }

                aiFeedback.textContent = 'Detectando peso via IA...';
                showFeedbackMessage('Enviando foto para análise de IA...', false);

                try {
                    const fileName = `public/temp_uploads/${participantId}-${Date.now()}-${photoFile.name}`;
                    const { data: uploadData, error: uploadError } = await supabase.storage.from('activity-photos').upload(fileName, photoFile);

                    if (uploadError) {
                        throw new Error('Erro ao enviar foto para o storage: ' + uploadError.message);
                    }
                    const imageUrl = supabase.storage.from('activity-photos').getPublicUrl(fileName).data.publicUrl;

                    const { data, error } = await supabase.functions.invoke('get-weight-from-image', {
                        body: { imageUrl: imageUrl },
                    });

                    if (error) {
                        throw new Error('Erro na função de IA: ' + error.message);
                    }
                    
                    if (data && data.weight) {
                        weightInput.value = data.weight.toFixed(2); 
                        aiFeedback.textContent = `Peso detectado: ${data.weight.toFixed(2)} kg. Revise e salve.`;
                        showFeedbackMessage('Peso detectado com sucesso!');
                    } else {
                        aiFeedback.textContent = 'Não foi possível detectar o peso na imagem. Por favor, insira manualmente.';
                        showFeedbackMessage('Não foi possível detectar o peso.', true);
                    }

                    supabase.storage.from('activity-photos').remove([fileName]);

                } catch (error) {
                    console.error("Erro na detecção de peso por IA:", error);
                    aiFeedback.textContent = `Erro ao detectar peso: ${error.message}`;
                    showFeedbackMessage('Erro na detecção de peso por IA.', true);
                }
            }

            async function handleDeleteWeightEntryConfirmed(participantId, entryDateISO) {
                const participant = participants.find(p => p.id == participantId);
                if (!participant) {
                    closeModal(document.getElementById('deleteConfirmModal'));
                    return;
                }

                const newHistory = participant.weight_history.filter(entry => entry.date !== entryDateISO);

                if (newHistory.length === 0 && (participant.peso_inicial === undefined || participant.peso_inicial === null)) {
                    showFeedbackMessage("Não é possível excluir o único registro de peso se não houver peso inicial definido.", true);
                    closeModal(document.getElementById('deleteConfirmModal'));
                    return;
                }
                
                newHistory.sort((a, b) => parseDateLocal(a.date) - parseDateLocal(b.date));
                const newCurrentWeight = newHistory.length > 0 ? newHistory[newHistory.length - 1].weight : participant.peso_inicial;

                const { error } = await supabase.from('participants').update({ 
                    weight_history: newHistory, 
                    peso_atual: newCurrentWeight
                }).eq('id', participant.id);

                if (error) {
                    showFeedbackMessage('Erro ao excluir registro de peso.', true);
                } else { 
                    showFeedbackMessage("Registro de peso excluído!"); 
                    reloadData();
                }
                closeModal(document.getElementById('deleteConfirmModal'));
            }
            
            async function handleAddActivity(participantId) {
                const type = document.getElementById('profile-activity-type').value;
                const duration = parseInt(document.getElementById('profile-activity-duration').value);
                const activityDateInput = document.getElementById('profile-activity-date').value; // Captura a data do novo campo
                const photoFile = document.getElementById('profile-activity-photo').files[0];
                const photoPrivacy = document.getElementById('profile-activity-photo-privacy').value === 'public';
                
                if (!type || !duration || duration <= 0 || !activityDateInput) return showFeedbackMessage('Preencha todos os campos da atividade.', true);
                
                const participant = participants.find(p => p.id == participantId);
                if (!participant) return;

                let imageUrl = null;
                if (photoFile) {
                    showFeedbackMessage('Enviando foto da atividade...', false);
                    const fileName = `public/activities/${participantId}-${Date.now()}-${photoFile.name}`;
                    const { error: uploadError } = await supabase.storage.from('activity-photos').upload(fileName, photoFile);
                    
                    if (uploadError) {
                        console.error("Erro no upload da foto da atividade:", uploadError);
                        return showFeedbackMessage('Erro ao enviar a foto da atividade.', true);
                    }
                    
                    imageUrl = supabase.storage.from('activity-photos').getPublicUrl(fileName).data.publicUrl;
                }

                const activityDate = new Date(activityDateInput + 'T00:00:00'); // Converte a string da data para um objeto Date
                const weekIndex = Math.floor((activityDate - CHALLENGE_START_DATE) / (1000 * 60 * 60 * 24 * 7));

                const newActivity = { 
                    id: Date.now(),
                    participantId: participantId,
                    type, 
                    duration, 
                    date: activityDate.toISOString(),
                    imageUrl: imageUrl,
                    is_public: photoPrivacy
                };

                const newSemanasValidas = JSON.parse(JSON.stringify(participant.semanas_validas));
                if (!Array.isArray(newSemanasValidas[weekIndex])) newSemanasValidas[weekIndex] = [];
                newSemanasValidas[weekIndex].push(newActivity);

                const { error } = await supabase.from('participants').update({ semanas_validas: newSemanasValidas }).eq('id', participantId);
                if (error) {
                    showFeedbackMessage('Erro ao adicionar atividade.', true);
                } else { 
                    showFeedbackMessage('Atividade adicionada com sucesso!'); 
                    await reloadData();
                }
            }

            async function handleDeleteActivityConfirmed(participantId, weekIndex, activityIdStr) {
                const activityId = isNaN(Number(activityIdStr)) ? activityIdStr : Number(activityIdStr);

                const localParticipantIndex = participants.findIndex(p => p.id == participantId);
                if (localParticipantIndex === -1) {
                    closeModal(document.getElementById('deleteConfirmModal'));
                    return;
                }

                const participant = participants[localParticipantIndex];
                const originalParticipantState = JSON.parse(JSON.stringify(participant));

                const updatedParticipant = JSON.parse(JSON.stringify(participant));
                if (updatedParticipant.semanas_validas[weekIndex]) {
                    updatedParticipant.semanas_validas[weekIndex] = updatedParticipant.semanas_validas[weekIndex].filter(act => String(act.id) !== String(activityId));
                } else {
                    closeModal(document.getElementById('deleteConfirmModal'));
                    return;
                }

                participants[localParticipantIndex] = updatedParticipant;

                showFeedbackMessage('Atividade apagada.');
                updateCurrentView();

                const { error } = await supabase
                    .from('participants')
                    .update({ semanas_validas: updatedParticipant.semanas_validas })
                    .eq('id', participantId);

                if (error) {
                    showFeedbackMessage('Erro ao apagar. A atividade será restaurada.', true);
                    participants[localParticipantIndex] = originalParticipantState;
                    updateCurrentView();
                } else {
                    const activityToDelete = originalParticipantState.semanas_validas[weekIndex]?.find(act => String(act.id) === String(activityId));
                    if (activityToDelete && activityToDelete.imageUrl) {
                        const pathToRemove = activityToDelete.imageUrl.split('.co/')[1].split('/').slice(2).join('/'); 
                        supabase.storage.from('activity-photos').remove([pathToRemove]);
                    }
                }
                closeModal(document.getElementById('deleteConfirmModal'));
            }
            
            async function handleUpdateMeasurements(participantId) {
                // Esta função não é mais chamada da página de perfil, mas mantida para referência
                const cintura = parseFloat(document.getElementById('profile-cintura').value);
                const quadril = parseFloat(document.getElementById('profile-quadril').value);
                const abdomen = parseFloat(document.getElementById('profile-abdomen').value);

                const participant = participants.find(p => p.id == participantId);
                if (participant) {
                    const newEntry = {
                        date: new Date().toISOString(),
                        cintura: !isNaN(cintura) ? cintura : null,
                        quadril: !isNaN(quadril) ? quadril : null,
                        abdomen: !isNaN(abdomen) ? abdomen : null,
                    };

                    const newHistory = [...(participant.measurements_history || []), newEntry];
                    const { error } = await supabase.from('participants').update({ measurements_history: newHistory }).eq('id', participantId);

                    if (error) showFeedbackMessage('Erro ao atualizar medidas.', true);
                    else { 
                        showFeedbackMessage(`Medidas de ${participant.name} atualizadas!`); 
                        participant.measurements_history = newHistory;
                        updateCurrentView();
                    }
                }
            }

            async function handleSaveHealthData(participantId) {
                const participant = participants.find(p => p.id == participantId);
                if (!participant) return;

                // Coleta todos os dados do formulário
                const newHealthData = {
                    fuma: document.getElementById('fuma')?.value === 'true',
                    consumo_alcool: document.getElementById('consumo_alcool')?.value,
                    horas_sono: document.getElementById('horas_sono')?.value,
                    nivel_estresse: document.getElementById('nivel_estresse')?.value,
                    tipo_trabalho: document.getElementById('tipo_trabalho')?.value,
                    objetivo_principal: document.getElementById('objetivo_principal')?.value,
                    principal_obstaculo: document.getElementById('principal_obstaculo')?.value,
                    fator_motivacao: document.getElementById('fator_motivacao')?.value,
                    atividade_antes_desafio: document.getElementById('atividade_antes_desafio')?.value,
                    lesoes_atuais: document.getElementById('lesoes_atuais')?.value,
                    alergias: document.getElementById('alergias')?.value,
                    consumo_agua: document.getElementById('consumo_agua')?.value,
                    forca_inicial: document.getElementById('forca_inicial')?.value,
                    performance_cardio: document.getElementById('performance_cardio')?.value,
                    cintura: parseFloat(document.getElementById('cintura')?.value) || null,
                    quadril: parseFloat(document.getElementById('quadril')?.value) || null,
                    abdomen: parseFloat(document.getElementById('abdomen')?.value) || null,
                    pressao_sistolica: parseFloat(document.getElementById('pressao_sistolica')?.value) || null,
                    pressao_diastolica: parseFloat(document.getElementById('pressao_diastolica')?.value) || null,
                    glicemia: parseFloat(document.getElementById('glicemia')?.value) || null,
                    colesterol_total: parseFloat(document.getElementById('colesterol_total')?.value) || null,
                    triglicerideos: parseFloat(document.getElementById('triglicerideos')?.value) || null,
                    percentual_gordura: parseFloat(document.getElementById('percentual_gordura')?.value) || null,
                    tmb: parseFloat(document.getElementById('tmb')?.value) || null,
                };
                
                // Coleta dados do histórico familiar
                const historicoFamiliar = {};
                document.querySelectorAll('#historico-familiar input[type="checkbox"]').forEach(checkbox => {
                    historicoFamiliar[checkbox.dataset.field] = checkbox.checked;
                });
                newHealthData.historico_familiar = historicoFamiliar;

                const initialHealthData = participant.initial_health_data || newHealthData;
                
                const { error } = await supabase.from('participants').update({ 
                    health_data: newHealthData,
                    initial_health_data: participant.initial_health_data ? participant.initial_health_data : initialHealthData
                }).eq('id', participantId);

                if (error) {
                    showFeedbackMessage('Erro ao salvar a ficha de saúde.', true);
                } else {
                    showFeedbackMessage(`Ficha de saúde de ${participant.name} atualizada!`);
                    reloadData();
                }
            }
            
            // --- MODAIS (Adicionado o modal de edição de participante) ---
            function openParticipantModal(participantId = null) {
                const modal = document.getElementById('participantModal');
                const isEditing = participantId !== null;
                const participant = isEditing ? participants.find(p => p.id == participantId) : {};

                document.body.style.overflow = 'hidden';
                modal.classList.add('show');

                modal.innerHTML = `
                    <div class="modal-content text-center">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-2xl font-bold text-white">${isEditing ? 'Editar Participante' : 'Adicionar Participante'}</h3>
                            <button type="button" class="close-button" onclick="closeModal(document.getElementById('participantModal'))">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16"><path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/></svg>
                            </button>
                        </div>
                        <form id="participantForm">
                            <input type="hidden" id="participantId" value="${participant.id || ''}">
                            <div class="mb-6">
                                <img id="profile-pic-preview" src="${participant.avatar_url || 'https://placehold.co/100x100/1f2937/fff?text=Adicionar+Foto'}" class="w-24 h-24 rounded-full mx-auto object-cover border-4 border-gray-600 mb-2" alt="Foto de Perfil">
                                <label class="block text-sm font-medium text-gray-300">
                                    <span class="cursor-pointer bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg">Selecionar Foto</span>
                                    <input type="file" id="profile-pic-upload" class="hidden">
                                </label>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                <div><label class="block text-sm font-medium text-gray-300">Nome:</label><input type="text" id="participantName" class="w-full" value="${participant.name || ''}" required></div>
                                <div><label class="block text-sm font-medium text-gray-300">Sexo:</label>
                                    <select id="participantSexo" class="w-full">
                                        <option value="Masculino" ${participant.sexo === 'Masculino' ? 'selected' : ''}>Masculino</option>
                                        <option value="Feminino" ${participant.sexo === 'Feminino' ? 'selected' : ''}>Feminino</option>
                                    </select>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                                <div><label class="block text-sm font-medium text-gray-300">Peso Inicial (kg):</label><input type="number" id="participantPesoInicial" step="any" class="w-full" value="${participant.peso_inicial || ''}" required></div>
                                <div><label class="block text-sm font-medium text-gray-300">Peso Atual (kg):</label><input type="number" id="participantPesoAtual" step="any" class="w-full" value="${participant.peso_atual || ''}" ${isEditing ? '' : 'readonly'}></div>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                                <div><label class="block text-sm font-medium text-gray-300">Altura (m):</label><input type="number" id="participantAltura" step="any" class="w-full" value="${participant.altura || ''}" required></div>
                                <div><label class="block text-sm font-medium text-gray-300">Meta de Peso (kg):</label><input type="number" id="participantMetaPeso" step="any" class="w-full" value="${participant.target_weight || ''}"></div>
                            </div>
                            <div class="p-4 bg-gray-800 rounded-lg border border-gray-700 mb-6">
                                <h4 class="font-bold text-lg text-white mb-2">Credenciais de Acesso</h4>
                                <p class="text-xs text-gray-400 mb-4">Crie um login para o participante acessar o próprio perfil.</p>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div><label class="block text-sm font-medium text-gray-300">Usuário:</label><input type="text" id="participantUsername" class="w-full" value="${participant.username || ''}" required></div>
                                    <div><label class="block text-sm font-medium text-gray-300">Senha:</label><input type="password" id="participantPassword" class="w-full" placeholder="${isEditing ? 'Deixe em branco para não alterar' : 'Digite a senha'}" ${!isEditing ? 'required' : ''}></div>
                                </div>
                            </div>
                            <div class="flex justify-center gap-4">
                                <button type="button" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg" onclick="closeModal(document.getElementById('participantModal'))">Cancelar</button>
                                <button type="submit" style="background-color: var(--primary-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg">Salvar</button>
                            </div>
                        </form>
                    </div>`;

                document.getElementById('participantForm').addEventListener('submit', handleSaveParticipant);
                document.getElementById('profile-pic-upload').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        document.getElementById('profile-pic-preview').src = URL.createObjectURL(file);
                    }
                });
            }

            async function handleSaveParticipant(e) {
                e.preventDefault();
                const participantId = document.getElementById('participantId').value;
                const name = document.getElementById('participantName').value;
                const sexo = document.getElementById('participantSexo').value;
                const peso_inicial = parseFloat(document.getElementById('participantPesoInicial').value);
                const altura = parseFloat(document.getElementById('participantAltura').value);
                const target_weight = parseFloat(document.getElementById('participantMetaPeso').value) || null;
                const username = document.getElementById('participantUsername').value;
                const password = document.getElementById('participantPassword').value;
                const photoFile = document.getElementById('profile-pic-upload').files[0];

                let avatarUrl = null;
                let currentPesoAtual = peso_inicial;

                if (photoFile) {
                    showFeedbackMessage('Enviando foto de perfil...', false);
                    const fileName = `public/avatars/${name.replace(/\s/g, '_')}-${Date.now()}-${photoFile.name}`;
                    const { error: uploadError } = await supabase.storage.from('activity-photos').upload(fileName, photoFile);
                    if (uploadError) {
                        showFeedbackMessage('Erro ao fazer upload da foto.', true);
                        return;
                    }
                    avatarUrl = supabase.storage.from('activity-photos').getPublicUrl(fileName).data.publicUrl;
                }

                let participantData = {
                    name, sexo, peso_inicial, altura, target_weight, username, avatar_url: avatarUrl
                };

                if (!participantId) {
                     participantData.peso_atual = peso_inicial;
                     participantData.weight_history = [{ date: new Date().toISOString(), weight: peso_inicial, is_public: true }];
                     participantData.semanas_validas = Array.from({ length: 12 }, () => []);
                     participantData.measurements_history = [];
                }

                if (password) {
                    participantData.password = password;
                }
                
                let error;
                if (participantId) {
                    const originalParticipant = participants.find(p => p.id == participantId);
                    if (originalParticipant) {
                         currentPesoAtual = document.getElementById('participantPesoAtual').value || originalParticipant.peso_atual;
                         if (document.getElementById('participantPesoAtual').value !== "") {
                            participantData.peso_atual = parseFloat(currentPesoAtual);
                             const newEntry = {
                                date: new Date().toISOString(),
                                weight: parseFloat(currentPesoAtual),
                                is_public: true
                            };
                            const existingHistory = originalParticipant.weight_history || [];
                            participantData.weight_history = [...existingHistory, newEntry].sort((a,b) => parseDateLocal(a.date) - parseDateLocal(b.date));
                         } else {
                            delete participantData.peso_atual;
                         }

                         if (!avatarUrl) {
                            participantData.avatar_url = originalParticipant.avatar_url;
                         }
                    }
                    
                    const { error: updateError } = await supabase.from('participants').update(participantData).eq('id', participantId);
                    error = updateError;
                } else {
                    const { error: insertError } = await supabase.from('participants').insert([participantData]);
                    error = insertError;
                }

                if (error) {
                    showFeedbackMessage('Erro ao salvar participante.', true);
                    console.error('Erro ao salvar participante:', error);
                } else {
                    showFeedbackMessage('Participante salvo com sucesso!');
                    closeModal(document.getElementById('participantModal'));
                    reloadData();
                }
            }
            
            // --- MODAIS (Generalizado openConfirmModal) ---
            function openConfirmModal(messageHTML, onConfirmCallback) {
                const modal = document.getElementById('deleteConfirmModal');
                document.body.style.overflow = 'hidden';
                modal.classList.add('show');
                modal.innerHTML = `<div class="modal-content text-center">
                        <h3 class="text-2xl font-bold mb-4 text-white">Confirmar Exclusão</h3>
                        <p class="mb-6 text-gray-300">${messageHTML}</p>
                        <div class="flex justify-center gap-4">
                            <button class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg" id="cancelConfirm">Cancelar</button>
                            <button style="background-color: var(--danger-color);" class="hover:opacity-90 text-white font-bold py-2 px-4 rounded-lg" id="confirmAction">Confirmar</button>
                        </div>
                    </div>`;
                
                modal.querySelector('#cancelConfirm').onclick = () => { 
                    closeModal(modal); 
                };
                modal.querySelector('#confirmAction').onclick = () => {
                    onConfirmCallback();
                };
            }
            
            // --- NOVO MODAL PARA VISUALIZAR IMAGEM ---
            function openImageViewerModal(imageUrl) {
                const modal = document.getElementById('imageViewerModal');
                const modalImage = document.getElementById('modalImage');
                modalImage.src = imageUrl;
                document.body.style.overflow = 'hidden';
                modal.classList.add('show');
            }

            // --- FUNÇÕES DE UTILIDADE ---
            function updateSummaryBoxes() {
                const leaderBox = document.getElementById('leaderBox');
                const weeklyBox = document.getElementById('weeklyHighlightBox');
                const monthlyBox = document.getElementById('monthlyHighlightBox');
                const daysBox = document.getElementById('daysRemainingBox');

                const ranked = participants.map(p => calculateMetrics(p, new Date())).sort((a, b) => b.totalPoints - a.totalPoints);
                if (ranked.length > 0) {
                    const leader = ranked[0];
                    leaderBox.innerHTML = `<div class="text-sm font-medium text-gray-400">👑 Líder Atual</div><div class="text-2xl font-bold" style="color: var(--success-color);">${leader.name}</div><div class="text-sm text-gray-300">${leader.totalPoints.toFixed(2)} pts</div>`;
                } else {
                    leaderBox.innerHTML = `<div class="text-sm font-medium text-gray-400">👑 Líder Atual</div><div class="text-2xl font-bold">N/A</div>`;
                }
                
                let weeklyWinner = { name: 'N/A', loss: Number.NEGATIVE_INFINITY };
                const oneWeekAgo = new Date(); oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                participants.forEach(p => {
                    const loss = getWeightAtDate(p, oneWeekAgo) - getWeightAtDate(p, new Date()); 
                    if (loss > weeklyWinner.loss) weeklyWinner = { name: p.name, loss };
                });
                weeklyBox.innerHTML = `<div class="text-sm font-medium text-gray-400">🔥 Destaque da Semana</div><div class="text-2xl font-bold" style="color: var(--warning-color);">${weeklyWinner.loss > 0 ? weeklyWinner.name : 'N/A'}</div><div class="text-sm text-gray-300">${weeklyWinner.loss > 0 ? weeklyWinner.loss.toFixed(2) : '0.00'} kg</div>`;

                let monthlyWinner = { name: 'N/A', loss: Number.NEGATIVE_INFINITY };
                const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
                participants.forEach(p => {
                    const loss = getWeightAtDate(p, firstDayOfMonth) - getWeightAtDate(p, new Date()); 
                    if (loss > monthlyWinner.loss) monthlyWinner = { name: p.name, loss };
                });
                monthlyBox.innerHTML = `<div class="text-sm font-medium text-gray-400">🌟 Destaque do Mês</div><div class="text-2xl font-bold" style="color: var(--primary-color);">${monthlyWinner.loss > 0 ? monthlyWinner.name : 'N/A'}</div><div class="text-sm text-gray-300">Perdeu ${monthlyWinner.loss > 0 ? monthlyWinner.loss.toFixed(2) : '0.00'} kg</div>`;

                const daysRemaining = Math.max(0, Math.ceil((CHALLENGE_END_DATE - new Date()) / (1000 * 60 * 60 * 24)));
                daysBox.innerHTML = `<div class="text-sm font-medium text-gray-400">⏳ Dias Restantes</div><div class="text-3xl font-bold text-white">${daysRemaining}</div>`;
            }
            
            function calculateTrendLine(data) {
                if (data.length < 2) return null;
                const n = data.length;
                const firstDay = new Date(data[0].date).getTime();
                const x = data.map(d => (parseDateLocal(d.date).getTime() - firstDay) / (1000 * 60 * 60 * 24));
                const y = data.map(d => d.weight);
                const sumX = d3.sum(x), sumY = d3.sum(y), sumXY = d3.sum(x.map((xi,i) => xi * y[i])), sumXX = d3.sum(x.map(xi => xi*xi));
                const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
                const intercept = (sumY - slope * sumX) / n;
                const predict = (day) => slope * day + intercept;
                const startDay = (new Date(data[0].date).getTime() - firstDay) / (1000 * 60 * 60 * 24);
                const endDay = (CHALLENGE_END_DATE.getTime() - firstDay) / (1000 * 60 * 60 * 24);
                return { start: { date: new Date(data[0].date), weight: predict(startDay) }, end: { date: CHALLENGE_END_DATE, weight: predict(endDay) } };
            }

            function calculateHealthRisk(p) {
                const initial = p.initial_health_data || {};
                const current = p.health_data || {};
                
                let initialRiskScore = 0;
                let currentRiskScore = 0;

                const hasInitialData = Object.keys(initial).length > 0;
                const hasCurrentData = Object.keys(current).length > 0;

                // Pontuação baseada em condições iniciais (simplificado)
                if (initial.fuma) initialRiskScore += 20;
                if (initial.consumo_alcool === 'Regular' || initial.consumo_alcool === 'Diário') initialRiskScore += 10;
                if (initial.nivel_estresse === 'Alto') initialRiskScore += 10;
                if (initial.imc && initial.imc >= 29.9) initialRiskScore += 15;
                if (initial.pressao_sistolica && initial.pressao_sistolica > 140) initialRiskScore += 15;
                if (initial.glicemia && initial.glicemia > 100) initialRiskScore += 10;
                if (initial.historico_familiar?.diabetes) initialRiskScore += 10;
                if (initial.historico_familiar?.hipertensao) initialRiskScore += 10;
                if (initial.historico_familiar?.obesidade) initialRiskScore += 10;
                if (initial.historico_familiar?.infarto) initialRiskScore += 10;

                // Pontuação atual baseada nas condições atuais
                if (current.fuma) currentRiskScore += 20;
                if (current.consumo_alcool === 'Regular' || current.consumo_alcool === 'Diário') currentRiskScore += 10;
                if (current.nivel_estresse === 'Alto') currentRiskScore += 10;
                if (p.imc && p.imc >= 29.9) currentRiskScore += 15;
                if (current.pressao_sistolica && current.pressao_sistolica > 140) currentRiskScore += 15;
                if (current.glicemia && current.glicemia > 100) currentRiskScore += 10;
                if (current.historico_familiar?.diabetes) currentRiskScore += 10;
                if (current.historico_familiar?.hipertensao) currentRiskScore += 10;
                if (current.historico_familiar?.obesidade) currentRiskScore += 10;
                if (current.historico_familiar?.infarto) currentRiskScore += 10;
                
                // Pontuação de melhoria
                if (hasInitialData && hasCurrentData) {
                    if (current.fuma === false && initial.fuma === true) currentRiskScore -= 20;
                    if (current.consumo_alcool === 'Nenhum' && (initial.consumo_alcool === 'Regular' || initial.consumo_alcool === 'Diário')) currentRiskScore -= 10;
                    if (current.nivel_estresse === 'Baixo' && initial.nivel_estresse === 'Alto') currentRiskScore -= 10;
                    
                    const initialIMC = calculateIMC(p.peso_inicial, p.altura).value;
                    const currentIMC = p.imc;

                    if (currentIMC < initialIMC) {
                        const improvement = (initialIMC - currentIMC) / initialIMC;
                        currentRiskScore -= Math.min(15, Math.max(0, improvement * 100 * 0.5));
                    }
                    if (current.pressao_sistolica && initial.pressao_sistolica && current.pressao_sistolica < initial.pressao_sistolica) {
                        currentRiskScore -= 5;
                    }
                    if (current.glicemia && initial.glicemia && current.glicemia < initial.glicemia) {
                        currentRiskScore -= 5;
                    }
                }
                
                const riskReduction = Math.max(0, (initialRiskScore - currentRiskScore) / Math.max(1, initialRiskScore));
                
                if (!hasCurrentData) {
                    return `Preencha sua ficha para ver sua pontuação de risco.`;
                } else if (riskReduction > 0) {
                    return `Você reduziu seu risco de problemas de saúde em ${Math.round(riskReduction * 100)}%!`;
                } else if (hasInitialData) {
                    return `Seus dados mostram que você está mantendo um bom controle de saúde. Continue assim!`;
                } else {
                    return `Preencha sua ficha inicial para compararmos seu progresso!`;
                }
            }

            // --- FUNÇÕES DE IA ---

            async function getAIGeneration(prompt, resultContainer) {
                resultContainer.innerHTML = '<div class="ai-tip-loader"></div>';
                try {
                    const { data, error } = await supabase.functions.invoke('get-ai-tip', {
                        body: { prompt: prompt },
                    });

                    if (error) throw error;
                    
                    if (data && data.tip) {
                        resultContainer.innerHTML = data.tip.replace(/\n/g, '<br>');
                    } else {
                        throw new Error("Resposta da IA inválida.");
                    }

                } catch (error) {
                    console.error("Erro ao chamar a IA:", error);
                    resultContainer.innerHTML = 'Ocorreu um erro ao gerar a resposta. Tente novamente mais tarde.';
                }
            }

            async function handleGenerateMealPlan() {
                const resultContainer = document.getElementById('meal-plan-result');
                const participantId = currentUser.role === 'admin' && participants.length > 0 ? participants[0].id : currentUser.participantId;
                const p = participants.find(p => p.id === participantId);
                if (!p) return resultContainer.innerHTML = 'Nenhum participante encontrado para gerar o plano.';

                const likedFoods = document.getElementById('liked-foods').value || 'nenhuma preferência';
                const dislikedFoods = document.getElementById('disliked-foods').value || 'nenhuma restrição';
                
                const currentWeight = getWeightAtDate(p, new Date()); 

                const prompt = `Aja como um nutricionista. Crie um plano de refeições simples para um dia (café da manhã, almoço, lanche da tarde e jantar) para a/o ${p.name}, que atualmente pesa ${currentWeight.toFixed(1)} kg e tem como meta perder peso. O plano deve ter aproximadamente 1800 calorias. Considere que ele(a) gosta de ${likedFoods} e deve evitar ${dislikedFoods}.`;
                getAIGeneration(prompt, resultContainer);
            }

            async function handleGenerateWorkout() {
                const resultContainer = document.getElementById('workout-result');
                const participantId = currentUser.role === 'admin' && participants.length > 0 ? participants[0].id : currentUser.participantId;
                const p = participants.find(p => p.id === participantId);
                if (!p) return resultContainer.innerHTML = 'Nenhum participante encontrado para gerar o treino.';

                const lastActivities = (p.semanas_validas || []).flat().slice(-3).map(a => a.type).join(', ') || 'nenhuma atividade recente';
                const prompt = `Aja como um personal trainer. O participante ${p.name} registrou recentemente as seguintes atividades: ${lastActivities}. Sugira um treino complementar para o próximo dia, com 3 a 4 exercícios que podem ser feitos em casa, explicando cada um brevemente.`;
                getAIGeneration(prompt, resultContainer);
            }

            async function handleGenerateMotivation() {
                const resultContainer = document.getElementById('motivation-result');
                const participantId = currentUser.role === 'admin' && participants.length > 0 ? participants[0].id : currentUser.participantId;
                const p = participants.find(p => p.id === participantId);
                if (!p) return resultContainer.innerHTML = 'Nenhum participante encontrado para gerar o resumo.';

                const today = new Date();
                const oneWeekAgo = new Date(); oneWeekAgo.setDate(today.getDate() - 7);
                const weightThen = getWeightAtDate(p, oneWeekAgo);
                const weightNow = getWeightAtDate(p, today);
                const weightLossThisWeek = weightThen - weightNow;
                const currentWeekIndex = Math.floor((today - CHALLENGE_START_DATE) / (1000 * 60 * 60 * 24 * 7));
                const activitiesThisWeek = (p.semanas_validas[currentWeekIndex] || []).length;
                
                const totalLost = p.peso_inicial - getWeightAtDate(p, today);

                const prompt = `Escreva um resumo motivacional curto e amigável para ${p.name}. Dados da última semana: perdeu ${weightLossThisWeek.toFixed(1)}kg, registrou ${activitiesThisWeek} atividades. Perda total no desafio: ${totalLost.toFixed(1)}kg. Parabenize-o(a) pelo esforço e incentive-o(a) a manter o foco.`;
                getAIGeneration(prompt, resultContainer);
            }
            
            async function handleGenerateGroupAnalysis() {
                if (currentUser.role !== 'admin') return;
                const resultContainer = document.getElementById('group-analysis-result');
                
                let weeklyDataString = '';
                const currentWeekIndex = Math.floor((new Date() - CHALLENGE_START_DATE) / (1000 * 60 * 60 * 24 * 7));

                for (let i = 0; i <= currentWeekIndex && i < MAX_WEEKS; i++) {
                    const weekStartDate = new Date(CHALLENGE_START_DATE);
                    weekStartDate.setDate(weekStartDate.getDate() + i * 7);
                    const weekEndDate = new Date(weekStartDate);
                    weekEndDate.setDate(weekEndDate.getDate() + 7);

                    let totalWeeklyLoss = 0;
                    let totalWeeklyActivities = 0;

                    participants.forEach(p => {
                        const weightStart = getWeightAtDate(p, weekStartDate);
                        const weightEnd = getWeightAtDate(p, weekEndDate);
                        if (weightStart > weightEnd) {
                            totalWeeklyLoss += weightStart - weightEnd;
                        }
                        totalWeeklyActivities += (p.semanas_validas[i] || []).length;
                    });
                    weeklyDataString += `Na Semana ${i + 1}, o grupo perdeu um total de ${totalWeeklyLoss.toFixed(1)}kg e registrou ${totalWeeklyActivities} atividades. `;
                }

                const prompt = `Analise os seguintes dados agregados de um desafio de fitness: ${weeklyDataString} Identifique a tendência geral (o ritmo está diminuindo, aumentando ou estável?), aponte a semana de maior sucesso e sugira uma ação para o administrador, como enviar uma mensagem de incentivo geral.`;
                getAIGeneration(prompt, resultContainer);
            }

            async function handleGenerateStagnationTip() {
                const resultContainer = document.getElementById('stagnation-tip-result');
                const participantId = currentUser.role === 'admin' && participants.length > 0 ? (document.getElementById('stagnation-participant-selector')?.value || participants[0].id) : currentUser.participantId;
                const p = participants.find(p => p.id == participantId);
                if (!p) return resultContainer.innerHTML = 'Nenhum participante encontrado.';

                const history = p.weight_history || [];
                if (history.length < 2) {
                    return resultContainer.innerHTML = 'Dados insuficientes. Continue registrando seu peso para detectarmos tendências.';
                }

                const sortedHistory = [...history].sort((a, b) => parseDateLocal(a.date) - parseDateLocal(b.date));
                const lastWeightEntry = sortedHistory[sortedHistory.length - 1];
                const secondLastWeightEntry = sortedHistory[sortedHistory.length - 2];

                if (lastWeightEntry.weight >= secondLastWeightEntry.weight) {
                    const lastActivities = (p.semanas_validas || []).flat().slice(-3).map(a => a.type).join(', ') || 'Caminhada';
                    const prompt = `O participante ${p.name} não perdeu peso na última pesagem registrada (${lastWeightEntry.weight.toFixed(1)} kg) em comparação com a penúltima (${secondLastWeightEntry.weight.toFixed(1)} kg). Suas atividades principais recentes são '${lastActivities}'. Crie uma mensagem curta, amigável e encorajadora sugerindo uma forma de quebrar o platô. Sugira, por exemplo, aumentar a intensidade, variar o tipo de treino ou uma dica de nutrição.`;
                    getAIGeneration(prompt, resultContainer);
                } else {
                    resultContainer.innerHTML = `Ótimo trabalho! Seu progresso está constante (perdeu ${(secondLastWeightEntry.weight - lastWeightEntry.weight).toFixed(1)} kg na última pesagem) e não detectamos sinais de estagnação. Continue assim!`;
                }
            }
            
            async function getAICoachingTip(participantId) {
                const participant = participants.find(p => p.id == participantId);
                if (!participant) return;

                const tipContainer = document.getElementById('ai-tip-container');
                const activityHistory = participant.semanas_validas.slice(-4).map(week => (Array.isArray(week) ? week.length : 0)).join(', ');
                
                const currentWeight = getWeightAtDate(participant, new Date());

                const prompt = `Seja um coach de fitness motivador e amigável, em português do Brasil. Dê uma dica curta e prática para o participante: Nome: ${participant.name}, Peso Inicial: ${participant.peso_inicial.toFixed(1)} kg, Peso Atual: ${currentWeight.toFixed(1)} kg, Meta: ${participant.target_weight ? participant.target_weight.toFixed(1) : 'N/A'} kg. Atividades nas últimas 4 semanas: ${activityHistory}. Fale diretamente com o participante (use "você").`;
                
                getAIGeneration(prompt, tipContainer);
            }
            
            async function handleReactionClick(button) {
                const activityId = button.dataset.activityId;
                const reactionType = button.dataset.reactionType; // CORREÇÃO AQUI
                const userId = currentUser.participantId;
                
                if (!userId) {
                    showFeedbackMessage('Apenas participantes podem reagir.', true);
                    return;
                }

                // ATUALIZAÇÃO OTIMISTA
                const postContainer = button.closest('[data-post-id]');
                let currentCount = parseInt(button.querySelector('span').textContent);
                let userReacted = button.classList.contains('reacted');

                if (userReacted) {
                    button.classList.remove('reacted');
                    button.querySelector('span').textContent = currentCount - 1;
                } else {
                    button.classList.add('reacted');
                    button.querySelector('span').textContent = currentCount + 1;
                }
                button.classList.add('reacted-animation');
                button.addEventListener('animationend', () => {
                    button.classList.remove('reacted-animation');
                }, { once: true });


                const existingReaction = reactions.find(r => String(r.activity_id) === String(activityId) && r.user_id === userId && r.reaction_type === reactionType);

                let error = null;
                if (existingReaction) {
                    const { error: deleteError } = await supabase.from('reactions').delete().match({ id: existingReaction.id });
                    error = deleteError;
                } else {
                    const { error: insertError } = await supabase.from('reactions').insert([{ activity_id: activityId, user_id: userId, reaction_type: reactionType }]);
                    error = insertError;
                }
                
                if (error) {
                    showFeedbackMessage(`Não foi possível ${userReacted ? 'remover' : 'adicionar'} a reação.`, true);
                    // REVERTE ATUALIZAÇÃO OTIMISTA
                    if (userReacted) {
                        button.classList.add('reacted');
                        button.querySelector('span').textContent = currentCount;
                    } else {
                        button.classList.remove('reacted');
                        button.querySelector('span').textContent = currentCount;
                    }
                    console.error("Erro na reação:", error);
                } else {
                    const { data: reactionsData, error: reactionsError } = await supabase.from('reactions').select('*');
                    if (!reactionsError) {
                        reactions = reactionsData;
                    }
                    // A tela não precisa ser recarregada inteira, pois a atualização otimista já ocorreu.
                    // A busca de dados serve para manter o estado local sincronizado para futuras interações.
                }
            }

             async function exportDetailsToPDF(participantId) {
                const detailsElement = document.getElementById('profile-content');
                const participant = participants.find(p => p.id == participantId);
                if (!detailsElement || !participant) return;
                
                showFeedbackMessage('Gerando relatório PDF...', false);
                html2canvas(detailsElement, { scale: 2, useCORS: true, backgroundColor: '#1f2937' }).then(canvas => {
                    const { jsPDF } = window.jspdf;
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF({ orientation: 'portrait', unit: 'px', format: [canvas.width, canvas.height] });
                    pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
                    pdf.save(`relatorio_${participant.name.replace(/\s/g, '_')}.pdf`);
                });
            }

            function showFeedbackMessage(message, isError = false) {
                feedbackMessageDiv.textContent = message;
                feedbackMessageDiv.className = `feedback-message show ${isError ? 'error' : ''}`;
                setTimeout(() => feedbackMessageDiv.classList.remove('show'), 4000);
            }
            
            function debounce(func, delay) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            }

            function formatTimeAgo(date) {
                const seconds = Math.floor((new Date() - date) / 1000);
                let interval = seconds / 31536000;
                if (interval > 1) return Math.floor(interval) + " anos atrás";
                interval = seconds / 2592000;
                if (interval > 1) return Math.floor(interval) + " meses atrás";
                interval = seconds / 86400;
                if (interval > 1) return Math.floor(interval) + " dias atrás";
                interval = seconds / 3600;
                if (interval > 1) return Math.floor(interval) + " horas atrás";
                interval = seconds / 60;
                if (interval > 1) return Math.floor(interval) + " minutos atrás";
                return "agora mesmo";
            }
            
            function getActivityTimestamp(activity) {
                if (activity && activity.date) {
                    return parseDateLocal(activity.date).getTime();
                }
                if (activity && typeof activity.id === 'number') {
                    return activity.id;
                }
                if (activity && typeof activity.id === 'string' && activity.id.includes('-')) {
                    return parseInt(activity.id.split('-').pop() || '0', 10);
                }
                return 0;
            }

            initApp();
        

function renderDailyLogPage(container) {
                const pMetric = calculateMetrics(participants.find(p => p.id == currentProfileParticipantId), new Date()); 
                if (!pMetric) {
                    container.innerHTML = `<div class="card"><div class="text-center py-10 text-gray-500">Participante não encontrado.</div></div>`;
                    return;
                }
                
                const isOwnProfile = currentUser.participantId == pMetric.id;
                const canEditProfile = currentUser.role === 'admin' || isOwnProfile;
                const canEditDate = currentUser.role === 'admin';

                const avatarSrc = pMetric.avatar_url || `https://placehold.co/100x100/E2E8F0/4A5568?text=${pMetric.name.charAt(0)}`;
                const todayStr = getTodayStrLocal();
                const pesoPerdido = pMetric.pesoPerdidoTotal; 

                let backButtonHTML = '';
                if (currentUser.role === 'admin' && !isOwnProfile) {
                    backButtonHTML = `<a href="#" data-action="go-to-participants" style="color: var(--primary-color);" class="hover:underline mb-4 inline-block">&larr; Voltar para todos os participantes</a>`;
                }
                
                container.innerHTML = `
                    <div id="daily-log-content" class="max-w-4xl mx-auto space-y-6">
                        <div class="flex justify-between items-start mb-2">
                            ${backButtonHTML}
                            ${currentUser.role === 'admin' ? `<div><button data-action="generate-report" data-id="${pMetric.id}" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-1 px-3 rounded-lg text-sm">Gerar PDF</button></div>` : '<div></div>'}
                        </div>

                        <div class="profile-card flex flex-col sm:flex-row items-center gap-6">
                            <img src="${avatarSrc}" onerror="this.onerror=null;this.src='https://placehold.co/100x100/E2E8F0/4A5568?text=${pMetric.name.charAt(0)}';" class="rounded-full w-24 h-24 object-cover border-4 border-indigo-500">
                            <div class="flex-grow text-center sm:text-left">
                                <h3 class="text-3xl font-bold text-white">${pMetric.name} <span class="text-2xl">${getBadges(pMetric)}</span></h3>
                                <div class="flex items-center gap-4 mt-1 justify-center sm:justify-start flex-wrap">
                                    <p class="text-gray-400">Altura: ${pMetric.altura ? pMetric.altura.toFixed(2) + 'm' : 'N/A'}</p>
                                    <p class="text-gray-400 flex items-center gap-2">IMC: <strong>${pMetric.imc}</strong> <span class="imc-badge ${pMetric.imcClassName}">${pMetric.imcClassification}</span></p>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-4 text-center w-full sm:w-auto mt-4 sm:mt-0">
                                <div>
                                    <p class="text-2xl font-bold text-indigo-400">${pMetric.totalPoints.toFixed(1)}</p>
                                    <p class="text-xs text-gray-400 uppercase">Pontos</p>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold ${pesoPerdido >= 0 ? 'text-green-400' : 'text-red-400'}">${pesoPerdido.toFixed(1)}</p>
                                    <p class="text-xs text-gray-400 uppercase">Kg Perdidos</p>
                                </div>
                                <div>
                                    <p class="text-2xl font-bold text-indigo-400">${pMetric.progressToTarget ? pMetric.progressToTarget.toFixed(0) : '0'}%</p>
                                    <p class="text-xs text-gray-400 uppercase">Meta</p>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="space-y-6">
                                ${canEditProfile ? `
                                <div class="profile-card">
                                    <h4 class="font-bold text-lg mb-4 text-white">Registrar Peso</h4>
                                    <div class="space-y-4">
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300">Novo Peso (kg)</label>
                                            <input id="profile-weight-input" type="number" step="any" class="mt-1 w-full p-2" placeholder="${pMetric.peso_atual.toFixed(2)}">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300">Data do Registro</label>
                                            <input id="profile-weight-date" type="date" class="mt-1 w-full p-2" value="${todayStr}" max="${todayStr}" ${currentUser.role !== 'admin' ? 'readonly' : ''}>
                                        </div>
                                        
                                        <div class="border border-gray-700 p-3 rounded-lg bg-gray-800">
                                            <label for="profile-weight-photo" class="block text-sm font-medium text-gray-300 mb-1">Foto da Balança (Opcional)</label>
                                            <input type="file" id="profile-weight-photo" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-200 file:text-indigo-700 hover:file:bg-indigo-300" accept="image/*">
                                            <button data-action="detect-weight-ai" data-id="${pMetric.id}" class="w-full mt-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md text-sm">Detectar Peso (IA)</button>
                                            <p id="ai-weight-feedback" class="text-xs text-gray-400 mt-2 text-center"></p>
                                            <div class="mt-2">
                                                <label for="profile-weight-photo-privacy" class="block text-sm font-medium text-gray-300 mb-1">Privacidade da Foto:</label>
                                                <select id="profile-weight-photo-privacy" class="w-full p-2">
                                                    <option value="public">Público (Visível no Mural)</option>
                                                    <option value="private">Privado (Visível apenas para você e Administrador)</option>
                                                </select>
                                            </div>
                                        </div>

                                        <button data-action="update-weight" data-id="${pMetric.id}" style="background-color: var(--primary-color);" class="w-full hover:opacity-90 text-white font-bold py-2.5 px-4 rounded-md">Salvar Peso</button>
                                    </div>
                                </div>
                                <div class="profile-card">
                                    <h4 class="font-bold text-lg mb-4 text-white">Registrar Atividade</h4>
                                    <div class="space-y-4">
                                        <div><label class="block text-sm font-medium text-gray-300">Tipo</label><select id="profile-activity-type" class="mt-1 w-full p-2">${ACTIVITY_TYPES.map(t => `<option value="${t}">${t}</option>`).join('')}</select></div>
                                        <div><label class="block text-sm font-medium text-gray-300">Duração (min)</label><input type="number" id="profile-activity-duration" class="w-full p-2"></div>
                                        <div>
                                            <label class="block text-sm font-medium text-gray-300">Data do Registro</label>
                                            <input type="date" id="profile-activity-date" class="mt-1 w-full p-2" value="${todayStr}" max="${todayStr}" ${canEditDate ? '' : 'readonly'}>
                                        </div>
                                        <div>
                                            <label for="profile-activity-photo" class="text-sm font-medium text-gray-300">Foto do Treino (Opcional)</label>
                                            <input type="file" id="profile-activity-photo" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-200 file:text-indigo-700 hover:file:bg-indigo-300" accept="image/*">
                                            <div class="mt-2">
                                                <label for="profile-activity-photo-privacy" class="block text-sm font-medium text-gray-300 mb-1">Privacidade da Foto:</label>
                                                <select id="profile-activity-photo-privacy" class="w-full p-2">
                                                    <option value="public">Público (Visível no Mural)</option>
                                                    <option value="private">Privado (Visível apenas para você e Administrador)</option>
                                                </select>
                                            </div>
                                        </div>
                                        <button data-action="add-activity" data-id="${pMetric.id}" style="background-color: var(--success-color);" class="w-full hover:opacity-90 text-white font-bold py-2.5 px-4 rounded-md">Adicionar Atividade</button>
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            <div class="space-y-6">
                                <div class="profile-card"><h4 class="font-bold text-lg mb-3 text-white">Histórico de Pesagem</h4><div id="profile-weight-history-list" class="max-h-60 overflow-y-auto pr-2 space-y-2"></div></div>
                                <div class="profile-card"><h4 class="font-bold text-lg mb-3 text-white">Histórico de Atividades</h4><div id="profile-activity-history-list" class="max-h-60 overflow-y-auto pr-2 space-y-2"></div></div>
                                <div class="profile-card">
                                    <div class="flex justify-between items-center mb-3">
                                        <h4 class="text-lg font-semibold text-white">🤖 Dica do Coach</h4>
                                        <button data-action="ai-coach" data-id="${pMetric.id}" style="background-color: var(--primary-color);" class="hover:opacity-90 text-white font-bold py-2 px-3 rounded-lg text-sm">Gerar Dica</button>
                                    </div>
                                    <div id="ai-tip-container" class="p-4 bg-gray-800 rounded-lg text-gray-300 min-h-[80px]">Clique no botão para receber uma dica personalizada.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                updateProfileWeightList(pMetric);
                updateProfileActivityList(pMetric);
            }

function renderEditProfilePage(container) {
                const participant = participants.find(p => p.id == currentProfileParticipantId);
                if (!participant) {
                    container.innerHTML = `<div class="card"><div class="text-center py-10 text-gray-500">Participante não encontrado.</div></div>`;
                    return;
                }

                const isReadOnlyForUser = currentUser.role !== 'admin';
                const birthDate = participant.birth_date ? new Date(participant.birth_date).toISOString().split('T')[0] : '';
                
                let backButtonHTML = '';
                if (currentUser.role === 'admin') {
                    backButtonHTML = `<a href="#" data-action="go-to-participants" style="color: var(--primary-color);" class="hover:underline mb-4 inline-block">&larr; Voltar para todos os participantes</a>`;
                }

                container.innerHTML = `
                    <div class="max-w-3xl mx-auto space-y-6">
                        ${backButtonHTML}
                        <form id="editProfileForm" class="card space-y-8">
                            <div>
                                <h3 class="text-2xl font-bold text-white mb-6 text-center">Editar Perfil</h3>
                                <div class="flex flex-col items-center mb-6">
                                    <img id="profile-pic-preview" src="${participant.avatar_url || 'https://placehold.co/128x128/1f2937/fff?text=Adicionar+Foto'}" class="w-32 h-32 rounded-full mx-auto object-cover border-4 border-gray-600 mb-4" alt="Foto de Perfil">
                                    <label class="cursor-pointer bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-lg">
                                        <span>Alterar Foto</span>
                                        <input type="file" id="profile-pic-upload" class="hidden" accept="image/*">
                                    </label>
                                </div>
                            </div>

                            <div class="p-4 bg-gray-800 rounded-lg border border-gray-700">
                                <h4 class="font-bold text-lg text-indigo-300 mb-4">Dados Pessoais</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label class="block text-sm font-medium text-gray-300">Nome</label><input type="text" id="edit-name" value="${participant.name || ''}" class="w-full mt-1"></div>
                                    <div><label class="block text-sm font-medium text-gray-300">Email</label><input type="email" id="edit-email" value="${participant.email || ''}" class="w-full mt-1"></div>
                                    <div><label class="block text-sm font-medium text-gray-300">Data de Nascimento</label><input type="date" id="edit-birthdate" value="${birthDate}" class="w-full mt-1"></div>
                                    <div><label class="block text-sm font-medium text-gray-300">Cidade</label><input type="text" id="edit-city" value="${participant.city || ''}" class="w-full mt-1"></div>
                                </div>
                            </div>

                            <div class="p-4 bg-gray-800 rounded-lg border border-gray-700">
                                <h4 class="font-bold text-lg text-indigo-300 mb-4">Dados Físicos</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300">Peso Inicial (kg)</label>
                                        <input type="number" step="any" id="edit-peso-inicial" value="${participant.peso_inicial || ''}" class="w-full mt-1" ${isReadOnlyForUser ? 'readonly' : ''}>
                                        ${isReadOnlyForUser ? '<p class="text-xs text-gray-500 mt-1">Este valor não pode ser alterado.</p>' : ''}
                                    </div>
                                    <div><label class="block text-sm font-medium text-gray-300">Altura (m)</label><input type="number" step="any" id="edit-altura" value="${participant.altura || ''}" class="w-full mt-1"></div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300">Sexo</label>
                                        <select id="edit-sexo" class="w-full mt-1">
                                            <option value="Masculino" ${participant.sexo === 'Masculino' ? 'selected' : ''}>Masculino</option>
                                            <option value="Feminino" ${participant.sexo === 'Feminino' ? 'selected' : ''}>Feminino</option>
                                        </select>
                                    </div>
                                    <div><label class="block text-sm font-medium text-gray-300">Meta de Peso (kg)</label><input type="number" step="any" id="edit-meta-peso" value="${participant.target_weight || ''}" class="w-full mt-1"></div>
                                </div>
                            </div>
                            
                            <div class="p-4 bg-gray-800 rounded-lg border border-gray-700">
                                <h4 class="font-bold text-lg text-indigo-300 mb-4">Segurança</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div><label class="block text-sm font-medium text-gray-300">Usuário</label><input type="text" id="edit-username" value="${participant.username || ''}" class="w-full mt-1"></div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-300">Nova Senha</label>
                                        <input type="password" id="edit-password" placeholder="Deixe em branco para não alterar" class="w-full mt-1">
                                    </div>
                                </div>
                            </div>

                            <div class="mt-8">
                                <button type="button" data-action="save-profile-changes" data-id="${participant.id}" style="background-color: var(--primary-color);" class="w-full hover:opacity-90 text-white font-bold py-3 px-4 rounded-lg">Salvar Alterações</button>
                            </div>
                        </form>
                    </div>
                `;

                document.getElementById('profile-pic-upload').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        document.getElementById('profile-pic-preview').src = URL.createObjectURL(file);
                    }
                });
            }




    async function handleSaveProfile(id) {
        try {
            const p = participants.find(pp => pp.id == id);
            if (!p) throw new Error('Participante não encontrado!');

            // Coleta os dados do formulário usando os IDs CORRETOS
            const name = document.getElementById('edit-name')?.value?.trim() || p.name;
            const email = document.getElementById('edit-email')?.value || p.email || null;
            const birthdate = document.getElementById('edit-birthdate')?.value || p.birth_date || null;
            const cidade = document.getElementById('edit-city')?.value || p.city || null; // CORRIGIDO
            const altura = parseFloat(document.getElementById('edit-altura')?.value) || p.altura || null;
            const sexo = document.getElementById('edit-sexo')?.value || p.sexo || null; // CORRIGIDO
            const target_weight = parseFloat(document.getElementById('edit-meta-peso')?.value) || p.target_weight || null; // CORRIGIDO
            const username = document.getElementById('edit-username')?.value || p.username;
            const password = document.getElementById('edit-password')?.value; // Pega a nova senha

            let avatar_url = p.avatar_url || null;
            const fileInput = document.getElementById('profile-pic-upload'); // CORRIGIDO
            if (fileInput && fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];
                const fileName = `public/avatars/avatar_${id}_${Date.now()}`;
                
                showFeedbackMessage('Enviando nova foto...', false);
                const { data: uploadData, error: uploadError } = await supabase.storage.from('activity-photos').upload(fileName, file);

                if (uploadError) {
                    throw new Error('Falha ao enviar a foto.');
                }
                
                avatar_url = supabase.storage.from('activity-photos').getPublicUrl(fileName).data.publicUrl;
            }

            // Monta o objeto com os dados para atualizar
            const dataToUpdate = {
                name,
                email,
                birth_date: birthdate,
                city: cidade,
                altura,
                sexo,
                target_weight,
                username,
                avatar_url
            };
            
            // Só adiciona a senha no objeto se o usuário digitou uma nova
            if (password && password.length > 0) {
                dataToUpdate.password = password;
            }

            const { error } = await supabase.from('participants').update(dataToUpdate).eq('id', id);
            
            if (error) throw error;
            
            showFeedbackMessage('Perfil atualizado com sucesso!');
            await reloadData(); // Recarrega os dados para refletir as alterações

        } catch (e) {
            console.error("Erro ao salvar perfil:", e);
            showFeedbackMessage(`Não foi possível salvar o perfil: ${e.message}`, true);
        }
    }
    

});
    </script>

<script>
(function applyModernUI(){
  const inputs=document.querySelectorAll('input:not([type=checkbox]):not([type=radio]):not([type=range])');
  const selects=document.querySelectorAll('select');
  const textareas=document.querySelectorAll('textarea');
  const checks=document.querySelectorAll('input[type=checkbox]');
  const radios=document.querySelectorAll('input[type=radio]');
  const buttons=document.querySelectorAll('button,.button');

  inputs.forEach(el=>el.classList.add('ui-input'));
  selects.forEach(el=>el.classList.add('ui-select'));
  textareas.forEach(el=>el.classList.add('ui-textarea'));
  checks.forEach(el=>el.classList.add('ui-check'));
  radios.forEach(el=>el.classList.add('ui-radio'));
  buttons.forEach(btn=>{
    btn.classList.add('btn','btn-sm');
    if(btn.dataset.variant==='primary') btn.classList.add('btn-primary');
    else if(btn.dataset.variant==='secondary') btn.classList.add('btn-secondary');
    else if(btn.dataset.variant==='ghost') btn.classList.add('btn-ghost');
    else if(btn.dataset.variant==='danger') btn.classList.add('btn-danger');
  });
  document.querySelectorAll('.card,.panel,.section').forEach(c=>c.classList.add('card-modern'));
})();
</script>

</body>
</html>