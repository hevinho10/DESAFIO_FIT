<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desafio Família FIT 90 DIAS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --font-inter: 'Inter', sans-serif;
            --background-light-gray: #f3f4f6;
            --text-dark: #333;
            --container-bg: #ffffff;
            --border-light: #e5e7eb;
            --header-bg-light-blue: #e0f2f7;
            --header-text-dark-blue: #2c5282;
            --input-valid-green: #34d399;
            --input-missed-red: #dc2626;
            --missed-week-bg-red: #fee2e2;
            --leader-row-bg-orange: #ffedd5;
            --leader-row-border-orange: #f97316;
            --feedback-success-bg: #10b981;
            --feedback-error-bg: #ef4444;
            --modal-bg-overlay: rgba(0,0,0,0.4);
            --blue-600: #2563eb;
            --progress-bar-bg: #e5e7eb;
            --progress-bar-fill: #22c55e;
        }
        body { font-family: var(--font-inter); background-color: var(--background-light-gray); color: var(--text-dark); }
        .container { max-width: 1200px; margin: 2rem auto; padding: 1.5rem; background-color: var(--container-bg); border-radius: 1rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); }
        .container-mobile-view { max-width: 600px; margin: 1rem auto; padding: 1rem; background-color: var(--container-bg); border-radius: 1rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); }
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-bottom: 2rem; border-radius: 0.75rem; overflow: hidden; }
        th, td { padding: 0.5rem 0.75rem; text-align: left; border-bottom: 1px solid var(--border-light); vertical-align: middle; }
        th { background-color: var(--header-bg-light-blue); font-weight: 600; color: var(--header-text-dark-blue); position: sticky; top: 0; z-index: 10; white-space: nowrap; }
        #weeklyParticipationTable th, #weeklyParticipationTable td { padding: 0.2rem 0.3rem; white-space: nowrap; }
        #weeklyParticipationTable td:first-child { min-width: 60px; padding-right: 0.1rem; }
        #weeklyParticipationTable th:not(:first-child), #weeklyParticipationTable td:not(:first-child) { text-align: center; }
        #weeklyParticipationTable input[type="number"] { width: 40px; height: 28px; padding: 0.2rem 0.1rem; text-align: center; border-radius: 0.25em; font-size: 0.9em; -moz-appearance: textfield; background-color: white; border: 1px solid var(--input-border-gray); }
        #weeklyParticipationTable input[type="number"]::-webkit-outer-spin-button, #weeklyParticipationTable input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .activity-content { display: flex; justify-content: center; align-items: center; gap: 0.25rem; height: 100%; width: 100%; }
        #weeklyParticipationTable td.valid-week input[type="number"] { background-color: var(--input-valid-green); border-color: var(--input-valid-green); color: white; }
        #weeklyParticipationTable td.valid-week .checkmark-icon { color: white; visibility: visible; opacity: 1; }
        #weeklyParticipationTable td.missed-week input[type="number"] { background-color: var(--missed-week-bg-red); border-color: var(--input-missed-red); color: var(--input-missed-red); }
        #weeklyParticipationTable td.missed-week .checkmark-icon { visibility: hidden; opacity: 0; }
        .checkmark-icon { width: 16px; height: 16px; flex-shrink: 0; visibility: hidden; opacity: 0; transition: opacity 0.2s; }
        tr:last-child td { border-bottom: none; }
        tr:nth-child(even) { background-color: #f9fafb; }
        .summary-box { background-color: var(--container-bg); border: 1px solid var(--border-light); padding: 1.5rem; border-radius: 0.75rem; font-weight: 600; color: var(--text-dark); text-align: center; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .tooltip { position: relative; display: inline-block; cursor: help; }
        .tooltip .tooltiptext { visibility: hidden; width: 180px; background-color: #555; color: #fff; text-align: center; border-radius: 6px; padding: 5px 0; position: absolute; z-index: 1; bottom: 125%; left: 50%; margin-left: -90px; opacity: 0; transition: opacity 0.3s; }
        .tooltip:hover .tooltiptext { visibility: visible; opacity: 1; }
        .leader-row { background-color: var(--leader-row-bg-orange) !important; border-left: 4px solid var(--leader-row-border-orange); }
        .feedback-message { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--feedback-success-bg); color: white; padding: 0.75rem 1.5rem; border-radius: 0.5rem; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); opacity: 0; transition: opacity 0.3s; z-index: 1001; }
        .feedback-message.show { opacity: 1; }
        .feedback-message.error { background-color: var(--feedback-error-bg); }
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: var(--modal-bg-overlay); display: flex; justify-content: center; align-items: center; opacity: 0; visibility: hidden; transition: opacity 0.3s; }
        .modal.show { opacity: 1; visibility: visible; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 2rem; border-radius: 1rem; box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 500px; position: relative; transform: scale(0.95); transition: transform 0.3s; }
        .modal.show .modal-content { transform: scale(1); }
        .close-button { position: absolute; top: 10px; right: 20px; color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; }
        .input-error { border-color: var(--error-red); }
        .error-message { color: var(--error-red); font-size: 0.875rem; margin-top: 0.25rem; }
        .empty-table-message { text-align: center; padding: 2rem; color: #6b7280; font-style: italic; }
        .current-week { background-color: #dbeafe !important; border-bottom: 2px solid #60a5fa !important; color: #1e40af !important; }
        .current-week-cell { background-color: #eff6ff; }
        .nav-tabs { display: flex; justify-content: center; margin-bottom: 1.5rem; border-bottom: 2px solid var(--border-light); overflow-x: auto; }
        .nav-tab-item { padding: 0.75rem 1.25rem; cursor: pointer; font-weight: 600; color: #6b7280; border-bottom: 2px solid transparent; transition: all 0.2s; white-space: nowrap; }
        .nav-tab-item:hover { color: var(--header-text-dark-blue); }
        .nav-tab-item.active { color: var(--header-text-dark-blue); border-color: var(--blue-600); }
        #weightHistoryChart svg, #details-chart svg { display: block; margin: auto; background-color: #fefefe; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); overflow: visible; }
        .axis path, .axis line { fill: none; stroke: #d1d5db; shape-rendering: crispEdges; }
        .axis text { font-size: 0.8rem; fill: #6b7280; }
        .line { fill: none; stroke-width: 2px; }
        .dot { fill: white; stroke-width: 1.5px; }
        .tooltip-chart { position: absolute; text-align: center; padding: 8px; font: 12px sans-serif; background: rgba(0, 0, 0, 0.7); color: white; border-radius: 8px; pointer-events: none; opacity: 0; transition: opacity 0.2s; }
        .progress-bar-container { width: 100%; background-color: var(--progress-bar-bg); border-radius: 9999px; height: 1.25rem; overflow: hidden; position: relative; }
        .progress-bar-fill { height: 100%; background-color: var(--progress-bar-fill); border-radius: 9999px; transition: width 0.5s ease-in-out; display: flex; align-items: center; justify-content: center; }
        .progress-bar-text { color: white; font-size: 0.75rem; font-weight: 600; }
        .badge { font-size: 1.1rem; margin-left: 0.25rem; }
        .mobile-menu-button { display: none; background-color: var(--blue-600); color: white; padding: 0.75rem 1rem; border-radius: 0.5rem; font-weight: 600; width: 100%; text-align: center; margin-bottom: 1rem; }
        .mobile-menu-dropdown { display: none; flex-direction: column; background-color: var(--container-bg); border-radius: 0.5rem; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 1rem; overflow: hidden; }
        .mobile-menu-dropdown.open { display: flex; }
        .mobile-menu-dropdown .nav-tab-item { padding: 1rem; border-bottom: 1px solid var(--border-light); }
        @media (min-width: 768px) { .nav-tabs { display: flex; } .mobile-menu-button, .mobile-menu-dropdown { display: none !important; } }
        @media (max-width: 767px) { .nav-tabs { display: none; } .mobile-menu-button { display: block; } }
    </style>
</head>
<body class="p-4">

    <div id="loginScreen" class="flex items-center justify-center min-h-screen bg-gradient-to-br from-blue-100 via-green-100 to-blue-200 p-4">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <h2 class="text-4xl font-extrabold text-center mb-10 text-gray-800">Acesso ao Desafio FIT</h2>
            <form id="loginForm">
                <div class="mb-4"><input type="text" id="username" placeholder="Usuário" class="shadow-sm appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required></div>
                <div class="mb-6"><input type="password" id="password" placeholder="Senha" class="shadow-sm appearance-none border rounded w-full py-3 px-4 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-blue-500" required></div>
                <p id="loginError" class="text-red-500 text-sm italic mb-4 hidden text-center">Usuário ou senha inválidos.</p>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition w-full">Entrar</button>
            </form>
        </div>
    </div>

    <div id="mobileDashboard" class="container-mobile-view hidden">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-2xl font-bold text-gray-800">Ranking Geral</h1>
            <button id="logoutBtnMobile" class="text-red-500 font-semibold">Sair</button>
        </div>
        <div id="leaderHighlightCard" class="bg-gradient-to-r from-yellow-100 to-orange-100 p-4 rounded-lg shadow-lg border-2 border-orange-300 mb-6 text-center"></div>
        <div id="mobileRankingList" class="space-y-3"></div>
        <button id="viewFullDashboardBtn" class="mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md w-full">Ver Planilha Completa</button>
    </div>

    <div class="container hidden">
        <div class="mb-4 pb-4 border-b">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 text-center mb-4">💪🍎 Desafio Família FIT 90 DIAS! 🏆</h1>
            <div class="flex justify-between items-center">
                <div id="main-action-buttons" class="flex items-center gap-2 flex-wrap">
                   <button id="addParticipantBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Adicionar</button>
                   <button id="exportDataBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Exportar</button>
                   <input type="file" id="importDataInput" accept=".json" class="hidden">
                   <button id="importDataBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Importar</button>
                   <button id="resetDataBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md">Resetar</button>
                </div>
                <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md">Sair</button>
            </div>
        </div>

        <button id="mobileMenuToggleButton" class="mobile-menu-button">Menu</button>
        <nav id="mainNavTabs" class="nav-tabs"></nav>
        <div id="mobileMenuDropdown" class="mobile-menu-dropdown"></div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div id="leaderBox" class="summary-box"></div>
            <div id="weeklyHighlightBox" class="summary-box"></div>
            <div id="daysRemainingBox" class="summary-box"></div>
        </div>

        <div class="flex justify-end mb-6">
            <div class="relative w-full sm:w-1/3">
                <input type="text" id="searchParticipantInput" placeholder="Buscar participante..." class="p-2 border rounded-md w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
        </div>

        <div id="sectionRanking" class="content-section"></div>
        <div id="sectionWeekly" class="content-section hidden"></div>
        <div id="sectionActivity" class="content-section hidden"></div>
        <div id="sectionCurrentWeight" class="content-section hidden"></div>
        <div id="sectionWeightHistory" class="content-section hidden"></div>

        <button id="backToMobileRankingBtn" class="mt-6 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hidden md:hidden">Voltar ao Ranking</button>
    </div>

    <div id="feedbackMessage" class="feedback-message"></div>
    <div id="participantModal" class="modal"></div>
    <div id="deleteConfirmModal" class="modal"></div>
    <div id="participantDetailsModal" class="modal"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // CONFIGURAÇÕES E CONSTANTES
            const USERS = { admin: { password: 'admin', canEdit: true }, root: { password: '1', canEdit: false } };
            const CHALLENGE_START_DATE = new Date('2025-07-07T00:00:00');
            const CHALLENGE_END_DATE = new Date('2025-10-07T23:59:59');
            const MAX_WEEKS = 12;
            const MIN_ACTIVITIES_FOR_VALID_WEEK = 3;
            const MAX_ACTIVITY_POINTS = 50;
            const NAV_LINKS = [
                { id: 'ranking', text: '🏆 Ranking' }, { id: 'weekly', text: '🗓️ Semanas' },
                { id: 'activity', text: '📈 Atividades' }, { id: 'currentWeight', text: '⚖️ Registrar Peso' },
                { id: 'weightHistory', text: '📊 Evolução' },
            ];
            const defaultParticipants = [
                { name: "Amanda", pesoInicial: 69.1, pesoAtual: 69.1, targetWeight: 65, semanasValidas: Array(12).fill(0), weightHistory: [{ date: '2025-07-07T03:00:00.000Z', weight: 69.1 }] },
                { name: "Hevinho", pesoInicial: 85.3, pesoAtual: 85.3, targetWeight: 75.0, semanasValidas: [3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], weightHistory: [{ date: '2025-07-07T03:00:00.000Z', weight: 85.3 }] },
                { name: "Junior", pesoInicial: 113.9, pesoAtual: 113.9, targetWeight: 100.0, semanasValidas: Array(12).fill(0), weightHistory: [{ date: '2025-07-07T03:00:00.000Z', weight: 113.9 }] },
                { name: "Midian Diniz", pesoInicial: 89.85, pesoAtual: 89.85, targetWeight: 80, semanasValidas: Array(12).fill(0), weightHistory: [{ date: '2025-07-07T03:00:00.000Z', weight: 89.85 }] },
                { name: "Midian Fernandes", pesoInicial: 65.15, pesoAtual: 65.15, targetWeight: 60.0, semanasValidas: [3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0], weightHistory: [{ date: '2025-07-07T03:00:00.000Z', weight: 65.15 }] },
                { name: "Paulinha", pesoInicial: 75.9, pesoAtual: 75.9, targetWeight: 70.0, semanasValidas: Array(12).fill(0), weightHistory: [{ date: '2025-07-07T03:00:00.000Z', weight: 75.9 }] },
                { name: "Rayanne", pesoInicial: 86.4, pesoAtual: 86.4, targetWeight: 80, semanasValidas: Array(12).fill(0), weightHistory: [{ date: '2025-07-07T03:00:00.000Z', weight: 86.4 }] },
                { name: "Wellington", pesoInicial: 117.7, pesoAtual: 117.7, targetWeight: 110.0, semanasValidas: Array(12).fill(0), weightHistory: [{ date: '2025-07-07T03:00:00.000Z', weight: 117.7 }] },
            ];

            // ESTADO DA APLICAÇÃO
            let currentUser = null;
            let participants = [];
            let currentViewIsMobile = window.innerWidth < 768;

            // ELEMENTOS DO DOM
            const loginScreen = document.getElementById('loginScreen');
            const mainContent = document.querySelector('.container');
            const mobileDashboard = document.getElementById('mobileDashboard');
            const feedbackMessageDiv = document.getElementById('feedbackMessage');
            
            // FUNÇÕES DE INICIALIZAÇÃO E AUTENTICAÇÃO
            function initApp() {
                loadData();
                setupEventListeners();
                checkLoginState();
            }

            function loadData() {
                try {
                    const stored = localStorage.getItem('challengeParticipants');
                    const parsed = stored ? JSON.parse(stored) : JSON.parse(JSON.stringify(defaultParticipants));
                    participants = parsed.map(p => ({
                        ...p,
                        pesoAtual: p.pesoAtual !== undefined ? p.pesoAtual : (p.pesoFinal || p.pesoInicial),
                        targetWeight: p.targetWeight !== undefined ? p.targetWeight : null,
                        semanasValidas: p.semanasValidas || Array(12).fill(0),
                        weightHistory: p.weightHistory || [{ date: new Date().toISOString(), weight: p.pesoAtual }]
                    }));
                } catch (e) {
                    console.error("Error loading data:", e);
                    participants = JSON.parse(JSON.stringify(defaultParticipants));
                }
            }

            function checkLoginState() {
                currentUser = sessionStorage.getItem('currentUser');
                if (currentUser && USERS[currentUser]) {
                    loginScreen.classList.add('hidden');
                    updateAllViews();
                } else {
                    loginScreen.classList.remove('hidden');
                    mainContent.classList.add('hidden');
                    mobileDashboard.classList.add('hidden');
                }
            }

            function handleLogin(e) {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                if (USERS[username] && USERS[username].password === password) {
                    currentUser = username;
                    sessionStorage.setItem('currentUser', username);
                    document.getElementById('loginError').classList.add('hidden');
                    checkLoginState();
                } else {
                    document.getElementById('loginError').classList.remove('hidden');
                }
            }

            function handleLogout() {
                currentUser = null;
                sessionStorage.removeItem('currentUser');
                checkLoginState();
            }

            // SETUP DE EVENTOS
            function setupEventListeners() {
                document.getElementById('loginForm').addEventListener('submit', handleLogin);
                document.getElementById('logoutBtn').addEventListener('click', handleLogout);
                document.getElementById('logoutBtnMobile').addEventListener('click', handleLogout);
                document.getElementById('viewFullDashboardBtn').addEventListener('click', () => toggleView(false));
                document.getElementById('backToMobileRankingBtn').addEventListener('click', () => toggleView(true));
                document.getElementById('addParticipantBtn').addEventListener('click', () => openModal());
                document.getElementById('exportDataBtn').addEventListener('click', exportData);
                document.getElementById('importDataBtn').addEventListener('click', () => document.getElementById('importDataInput').click());
                document.getElementById('importDataInput').addEventListener('change', importData);
                document.getElementById('resetDataBtn').addEventListener('click', () => openDeleteModal(null, true));
                document.getElementById('searchParticipantInput').addEventListener('keyup', debounce(updateAllViews, 300));
                
                const navContainer = document.getElementById('mainNavTabs');
                const mobileNavContainer = document.getElementById('mobileMenuDropdown');
                navContainer.innerHTML = '';
                mobileNavContainer.innerHTML = '';
                NAV_LINKS.forEach(link => {
                    navContainer.innerHTML += `<a href="#" class="nav-tab-item" data-section="${link.id}">${link.text}</a>`;
                    mobileNavContainer.innerHTML += `<a href="#" class="nav-tab-item" data-section="${link.id}">${link.text}</a>`;
                });

                document.querySelectorAll('.nav-tab-item').forEach(item => {
                    item.addEventListener('click', e => {
                        e.preventDefault();
                        showSection(e.currentTarget.dataset.section);
                        mobileNavContainer.classList.remove('open');
                    });
                });
                
                document.getElementById('mobileMenuToggleButton').addEventListener('click', () => mobileNavContainer.classList.toggle('open'));
                mainContent.addEventListener('click', handleMainContentClick);
                mainContent.addEventListener('input', debounce(e => {
                    if (e.target.matches('.activity-input')) {
                        handleActivityInputChange(e.target);
                    }
                }, 400));
                
                window.addEventListener('resize', debounce(() => {
                    const isNowMobile = window.innerWidth < 768;
                    if(isNowMobile !== currentViewIsMobile) {
                        currentViewIsMobile = isNowMobile;
                        updateAllViews();
                    }
                }, 200));
            }

            function handleMainContentClick(e) {
                const button = e.target.closest('button');
                const link = e.target.closest('a.participant-name-link');

                if (link) {
                    e.preventDefault();
                    const name = link.dataset.name;
                    openDetailsModal(name);
                    return;
                }

                if (!button) return;
                
                const name = button.dataset.name;
                if (button.matches('.edit-participant-icon')) {
                    const index = participants.findIndex(p => p.name === name);
                    if (index !== -1) openModal(index);
                } else if (button.matches('.delete-participant-icon')) {
                    openDeleteModal(name);
                } else if (button.matches('.update-weight-btn')) {
                    handleUpdateWeight(button);
                }
            }

            function handleActivityInputChange(input) {
                if (input.disabled) return;
                const name = input.dataset.name;
                const weekIndex = parseInt(input.dataset.week);
                let numActivities = parseInt(input.value);
                if (isNaN(numActivities) || numActivities < 0) numActivities = 0;
                
                const participant = participants.find(p => p.name === name);
                if (participant) {
                    participant.semanasValidas[weekIndex] = numActivities;
                    saveData();
                    updateAllViews();
                }
            }

            function handleUpdateWeight(button) {
                if (button.disabled) return;
                const name = button.dataset.name;
                const row = button.closest('tr');
                const weightInput = row.querySelector('input[type="number"]');
                const dateInput = row.querySelector('input[type="date"]');
                const newWeight = parseFloat(weightInput.value);
                const dateValue = dateInput.value;

                if (isNaN(newWeight) || newWeight <= 0) return showFeedbackMessage("Peso inválido.", true);
                if (!dateValue) return showFeedbackMessage("Selecione uma data.", true);
                if (new Date(dateValue) > new Date()) return showFeedbackMessage("Não é possível registrar datas futuras.", true);

                const participant = participants.find(p => p.name === name);
                if (participant) {
                    const newEntry = { date: new Date(dateValue + 'T00:00:00').toISOString(), weight: newWeight };
                    participant.pesoAtual = newWeight;
                    participant.weightHistory.push(newEntry);
                    participant.weightHistory.sort((a, b) => new Date(a.date) - new Date(b.date));
                    saveData();
                    updateAllViews();
                    showFeedbackMessage(`Peso de ${name} atualizado!`);
                }
            }
            
            // LÓGICA DE DADOS E CÁLCULOS
            function saveData() {
                localStorage.setItem('challengeParticipants', JSON.stringify(participants));
            }

            function calculateMetrics(p) {
                const pesoPerdido = p.pesoInicial - p.pesoAtual;
                const percentLoss = p.pesoInicial > 0 ? (pesoPerdido / p.pesoInicial) * 100 : 0;
                let weightPoints = 0;
                if (percentLoss >= 10) weightPoints = 50;
                else if (percentLoss >= 8) weightPoints = 45;
                else if (percentLoss >= 6) weightPoints = 40;
                else if (percentLoss >= 4) weightPoints = 35;
                else if (percentLoss >= 2) weightPoints = 30;
                else if (percentLoss > 0) weightPoints = 10;
                
                const validWeeksCount = p.semanasValidas.filter(num => num >= MIN_ACTIVITIES_FOR_VALID_WEEK).length;
                const activityPoints = (validWeeksCount / MAX_WEEKS) * MAX_ACTIVITY_POINTS;
                
                let progressToTarget = null;
                if (p.targetWeight && p.pesoInicial > p.targetWeight) {
                    const totalNeeded = p.pesoInicial - p.targetWeight;
                    const currentLoss = p.pesoInicial - p.pesoAtual;
                    progressToTarget = Math.max(0, Math.min(100, (currentLoss / totalNeeded) * 100));
                }
                return { ...p, percentLoss: Math.max(0, percentLoss), weightPoints, validWeeksCount, activityPoints, totalPoints: weightPoints + activityPoints, progressToTarget };
            }

            function getBadges(p) {
                let badges = '';
                if (p.semanasValidas[0] >= MIN_ACTIVITIES_FOR_VALID_WEEK) badges += `<span class="badge tooltip"><span class="tooltiptext">Primeira Semana Completa!</span>🥇</span>`;
                if ((p.pesoInicial - p.pesoAtual) >= 5) badges += `<span class="badge tooltip"><span class="tooltiptext">Marco de 5kg Atingido!</span>⚖️</span>`;
                const consecutive = p.semanasValidas.map(w => w >= MIN_ACTIVITIES_FOR_VALID_WEEK ? '1' : '0').join('').split('0').reduce((max, s) => Math.max(max, s.length), 0);
                if (consecutive >= 4) badges += `<span class="badge tooltip"><span class="tooltiptext">${consecutive} Semanas em Chamas!</span>🔥</span>`;
                return badges;
            }

            // LÓGICA DE RENDERIZAÇÃO E UI
            function updateAllViews() {
                if (currentViewIsMobile) {
                    mainContent.classList.add('hidden');
                    mobileDashboard.classList.remove('hidden');
                    renderMobileDashboard();
                } else {
                    mainContent.classList.remove('hidden');
                    mobileDashboard.classList.add('hidden');
                    updatePlanilha();
                }
                applyPermissions();
            }

            function toggleView(showMobile) {
                currentViewIsMobile = showMobile;
                updateAllViews();
            }

            function updatePlanilha() {
                const activeSectionId = document.querySelector('.nav-tab-item.active')?.dataset.section || 'ranking';
                showSection(activeSectionId);
                updateSummaryBoxes();
            }

            function showSection(sectionId) {
                document.querySelectorAll('.content-section').forEach(s => s.classList.add('hidden'));
                const activeSection = document.getElementById(`section${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}`);
                if (activeSection) {
                    activeSection.classList.remove('hidden');
                    const title = NAV_LINKS.find(l => l.id === sectionId)?.text || 'Seção';
                    
                    const allMetrics = participants.map(calculateMetrics);
                    const searchTerm = document.getElementById('searchParticipantInput').value.toLowerCase();
                    const filteredMetrics = allMetrics.filter(p => p.name.toLowerCase().includes(searchTerm));
                    const ranked = [...filteredMetrics].sort((a, b) => b.totalPoints - a.totalPoints);

                    if (sectionId === 'ranking') renderRankingTable(ranked, activeSection, title);
                    else if (sectionId === 'weekly') renderWeeklyTable(filteredMetrics, activeSection, title);
                    else if (sectionId === 'activity') renderActivityChart(ranked, activeSection, title);
                    else if (sectionId === 'currentWeight') renderCurrentWeightTable(filteredMetrics, activeSection, title);
                    else if (sectionId === 'weightHistory') renderWeightHistoryChart(filteredMetrics, activeSection, title);
                }
                document.querySelectorAll('.nav-tab-item').forEach(item => item.classList.toggle('active', item.dataset.section === sectionId));
            }

            function renderRankingTable(data, container, title) {
                const canEdit = USERS[currentUser]?.canEdit;
                let tableHTML = `
                    <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-700">${title}</h2>
                    <div class="overflow-x-auto rounded-xl shadow-md">
                        <table class="w-full">
                            <thead><tr>
                                <th class="rounded-tl-xl">Rank</th>
                                <th>Nome</th>
                                <th>Progresso Meta</th>
                                <th>% Perda</th>
                                <th>Pts Peso</th>
                                <th>Sem. Válidas</th>
                                <th>Pts Ativ.</th>
                                <th>Total</th>
                                <th class="rounded-tr-xl"></th>
                            </tr></thead>
                            <tbody>`;
                
                if (data.length === 0) {
                    tableHTML += `<tr><td colspan="9" class="text-center p-4">Nenhum participante encontrado.</td></tr>`;
                } else {
                    data.forEach((p, index) => {
                        const crown = ['👑', '🥈', '🥉'][index] || '';
                        const badges = getBadges(p);
                        const progress = p.progressToTarget !== null ? `
                            <div class="progress-bar-container tooltip"><span class="tooltiptext">${p.progressToTarget.toFixed(1)}% da meta</span>
                                <div class="progress-bar-fill" style="width: ${p.progressToTarget}%;"><span class="progress-bar-text">${p.progressToTarget.toFixed(0)}%</span></div>
                            </div>` : 'N/A';
                        
                        tableHTML += `
                            <tr class="${index === 0 ? 'leader-row' : ''}">
                                <td class="font-semibold">${index + 1} ${crown}</td>
                                <td><a href="#" class="participant-name-link text-blue-600 hover:underline" data-name="${p.name}">${p.name}</a> ${badges}</td>
                                <td>${progress}</td>
                                <td>${p.percentLoss.toFixed(2)}%</td>
                                <td>${p.weightPoints.toFixed(2)}</td>
                                <td>${p.validWeeksCount}</td>
                                <td>${p.activityPoints.toFixed(2)}</td>
                                <td class="font-bold">${p.totalPoints.toFixed(2)}</td>
                                <td class="flex items-center space-x-2">
                                    ${canEdit ? `
                                    <button class="text-blue-500 hover:text-blue-700 edit-participant-icon" data-name="${p.name}">✏️</button>
                                    <button class="text-red-500 hover:text-red-700 delete-participant-icon" data-name="${p.name}">🗑️</button>
                                    ` : ''}
                                </td>
                            </tr>`;
                    });
                }
                tableHTML += `</tbody></table></div>`;
                container.innerHTML = tableHTML;
            }

            function renderWeeklyTable(data, container, title) {
                const canEdit = USERS[currentUser]?.canEdit;
                const today = new Date();
                const currentWeek = Math.floor((today - CHALLENGE_START_DATE) / (1000 * 60 * 60 * 24 * 7)) + 1;
                
                let headers = `<th>Nome</th>`;
                for (let i = 1; i <= MAX_WEEKS; i++) {
                    headers += `<th class="${i === currentWeek ? 'current-week' : ''}">${i}</th>`;
                }

                let bodyHTML = '';
                if (data.length > 0) {
                    data.sort((a,b) => a.name.localeCompare(b.name)).forEach(p => {
                        bodyHTML += `<tr><td class="font-medium">${p.name}</td>`;
                        p.semanasValidas.forEach((num, weekIndex) => {
                            const isPastOrCurrent = (weekIndex + 1) <= currentWeek;
                            let tdClasses = weekIndex + 1 === currentWeek ? 'current-week-cell' : '';
                            if (isPastOrCurrent) tdClasses += num >= MIN_ACTIVITIES_FOR_VALID_WEEK ? ' valid-week' : ' missed-week';
                            
                            bodyHTML += `
                                <td class="${tdClasses}">
                                    <div class="activity-content">
                                        <input type="number" class="activity-input" min="0" value="${num}" data-name="${p.name}" data-week="${weekIndex}" ${!canEdit ? 'disabled' : ''}>
                                        <span class="checkmark-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg></span>
                                    </div>
                                </td>`;
                        });
                        bodyHTML += `</tr>`;
                    });
                } else {
                    bodyHTML = `<tr><td colspan="${MAX_WEEKS + 1}" class="text-center p-4">Nenhum participante.</td></tr>`;
                }

                container.innerHTML = `
                    <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-700">${title}</h2>
                    <div class="overflow-x-auto rounded-xl shadow-md">
                        <table id="weeklyParticipationTable" class="w-full">
                            <thead><tr>${headers}</tr></thead>
                            <tbody>${bodyHTML}</tbody>
                        </table>
                    </div>`;
            }

            function renderCurrentWeightTable(data, container, title) {
                const canEdit = USERS[currentUser]?.canEdit;
                const todayStr = new Date().toISOString().split('T')[0];
                let bodyHTML = '';

                if (data.length > 0) {
                    data.sort((a,b) => a.name.localeCompare(b.name)).forEach(p => {
                        bodyHTML += `
                            <tr>
                                <td class="font-medium">${p.name}</td>
                                <td><input type="number" step="any" class="shadow-sm border rounded w-full py-2 px-3" value="${p.pesoAtual.toFixed(2)}" ${!canEdit ? 'disabled' : ''}></td>
                                <td><input type="date" class="shadow-sm border rounded w-full py-2 px-3" value="${todayStr}" max="${todayStr}" ${!canEdit ? 'disabled' : ''}></td>
                                <td class="text-center"><button class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg update-weight-btn" data-name="${p.name}" ${!canEdit ? 'disabled' : ''}>Salvar</button></td>
                            </tr>`;
                    });
                } else {
                    bodyHTML = `<tr><td colspan="4" class="text-center p-4">Nenhum participante.</td></tr>`;
                }

                container.innerHTML = `
                    <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-700">${title}</h2>
                    <div class="overflow-x-auto rounded-xl shadow-md">
                        <table class="w-full">
                            <thead><tr>
                                <th class="rounded-tl-xl">Nome</th><th>Peso (kg)</th><th>Data</th><th class="rounded-tr-xl">Ação</th>
                            </tr></thead>
                            <tbody>${bodyHTML}</tbody>
                        </table>
                    </div>`;
            }
            
            function renderActivityChart(data, container, title) {
                let contentHTML = `<h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-700">${title}</h2><div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">`;
                if (data.length > 0) {
                    const percentActivities = (p) => (p.activityPoints / MAX_ACTIVITY_POINTS) * 100;
                    data.forEach(p => {
                        const pA = percentActivities(p);
                        let fillColor = '#34d399'; // Verde
                        if (pA < 50) fillColor = '#f59e0b'; // Amarelo
                        if (pA < 25) fillColor = '#ef4444'; // Vermelho
                        
                        const sanitizedName = p.name.replace(/[^a-zA-Z0-9]/g, '');

                        contentHTML += `
                            <div class="flex flex-col items-center text-center">
                                <div class="relative w-16 h-16 mb-1">
                                    <svg width="64" height="64" viewBox="0 0 24 24">
                                        <defs>
                                            <clipPath id="clip-${sanitizedName}">
                                                <rect x="0" y="${24 - (24 * pA / 100)}" width="24" height="${24 * pA / 100}"></rect>
                                            </clipPath>
                                        </defs>
                                        <g fill="#e5e7eb">
                                            <circle cx="12" cy="5" r="3"/><rect x="10" y="8" width="4" height="8"/><rect x="6" y="9" width="4" height="2"/><rect x="14" y="9" width="4" height="2"/><rect x="9" y="16" width="2" height="6"/><rect x="13" y="16" width="2" height="6"/>
                                        </g>
                                        <g clip-path="url(#clip-${sanitizedName})" fill="${fillColor}">
                                            <circle cx="12" cy="5" r="3"/><rect x="10" y="8" width="4" height="8"/><rect x="6" y="9" width="4" height="2"/><rect x="14" y="9" width="4" height="2"/><rect x="9" y="16" width="2" height="6"/><rect x="13" y="16" width="2" height="6"/>
                                        </g>
                                    </svg>
                                </div>
                                <div class="text-sm font-medium">${p.name} - ${pA.toFixed(1)}%</div>
                            </div>`;
                    });
                } else {
                    contentHTML += `<div class="col-span-full text-center p-4">Nenhum participante.</div>`;
                }
                contentHTML += `</div>`;
                container.innerHTML = contentHTML;
            }
            
            function renderWeightHistoryChart(data, container, title) {
                container.innerHTML = `<h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-700">${title}</h2><div id="weightHistoryChartContainer" class="w-full"></div>`;
                const chartContainer = document.getElementById('weightHistoryChartContainer');
                
                const participantsWithHistory = data.filter(p => p.weightHistory && p.weightHistory.length > 1);
                if (participantsWithHistory.length === 0) {
                    chartContainer.innerHTML = `<div class="empty-table-message">Não há histórico de peso suficiente para exibir.</div>`;
                    return;
                }
                
                const margin = {top: 20, right: 120, bottom: 30, left: 40},
                      containerWidth = chartContainer.clientWidth || 800,
                      width = containerWidth - margin.left - margin.right,
                      height = 350 - margin.top - margin.bottom;

                const svg = d3.select(chartContainer).append("svg")
                    .attr("width", "100%")
                    .attr("height", "100%")
                    .attr("viewBox", `0 0 ${containerWidth} ${height + margin.top + margin.bottom}`)
                    .append("g").attr("transform", `translate(${margin.left},${margin.top})`);

                let allDates = [], allWeights = [];
                participantsWithHistory.forEach(p => p.weightHistory.forEach(d => {
                    allDates.push(new Date(d.date));
                    allWeights.push(d.weight);
                }));

                const xScale = d3.scaleTime().domain(d3.extent(allDates)).range([0, width]);
                const yScale = d3.scaleLinear().domain([d3.min(allWeights) - 2, d3.max(allWeights) + 2]).range([height, 0]);
                const line = d3.line().x(d => xScale(new Date(d.date))).y(d => yScale(d.weight));
                const colors = d3.scaleOrdinal(d3.schemeCategory10);

                svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(xScale).tickFormat(d3.timeFormat("%d/%m")));
                svg.append("g").call(d3.axisLeft(yScale).tickFormat(d => `${d}kg`));

                participantsWithHistory.forEach(p => {
                    svg.append("path").datum(p.weightHistory).attr("fill", "none").attr("stroke", colors(p.name)).attr("stroke-width", 2).attr("d", line);
                });
                
                const legend = svg.selectAll(".legend").data(participantsWithHistory).enter().append("g")
                    .attr("class", "legend").attr("transform", (d, i) => `translate(${width + 20},${i * 20})`);
                legend.append("rect").attr("width", 18).attr("height", 18).style("fill", d => colors(d.name));
                legend.append("text").attr("x", 24).attr("y", 9).attr("dy", ".35em").style("text-anchor", "start").text(d => d.name);
            }

            function renderMobileDashboard() {
                const card = document.getElementById('leaderHighlightCard');
                const list = document.getElementById('mobileRankingList');
                const allMetrics = participants.map(calculateMetrics);
                const ranked = [...allMetrics].sort((a, b) => b.totalPoints - a.totalPoints);
                
                if (ranked.length > 0) {
                    const leader = ranked[0];
                    card.innerHTML = `
                        <p class="text-lg font-semibold text-orange-700">Líder Atual: <span class="text-xl font-bold text-orange-900">${leader.name}</span> 👑</p>
                        <p class="text-md text-gray-700">Pontuação: <span class="font-bold text-orange-800">${leader.totalPoints.toFixed(2)}</span> pts</p>`;
                } else {
                    card.innerHTML = `<p>Nenhum líder ainda.</p>`;
                }

                list.innerHTML = '';
                ranked.forEach((p, index) => {
                    const crown = ['👑', '🥈', '🥉'][index] || '';
                    list.innerHTML += `
                        <div class="bg-white p-3 rounded-md shadow-sm border flex justify-between items-center ${index === 0 ? 'bg-yellow-50 border-orange-300' : 'border-gray-200'}">
                            <div><span class="font-bold text-gray-800">${index + 1}. ${p.name} ${crown}</span></div>
                            <span class="text-lg font-bold text-blue-700">${p.totalPoints.toFixed(2)} pts</span>
                        </div>`;
                });
            }

            function updateSummaryBoxes() {
                const allMetrics = participants.map(calculateMetrics);
                const ranked = [...allMetrics].sort((a, b) => b.totalPoints - a.totalPoints);
                
                const leaderBox = document.getElementById('leaderBox');
                const weeklyBox = document.getElementById('weeklyHighlightBox');
                const daysBox = document.getElementById('daysRemainingBox');

                if (ranked.length > 0) {
                    const leader = ranked[0];
                    leaderBox.innerHTML = `<div>👑 Líder Atual</div><div class="text-xl font-bold text-green-700">${leader.name}</div><div>${leader.totalPoints.toFixed(2)} pts</div>`;
                } else {
                    leaderBox.innerHTML = `<div>👑 Líder Atual</div><div class="text-xl">N/A</div>`;
                }

                let weeklyWinner = { name: 'N/A', loss: 0 };
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
                participants.forEach(p => {
                    const recentHistory = p.weightHistory.filter(h => new Date(h.date) >= oneWeekAgo && new Date(h.date) <= new Date());
                    if (recentHistory.length > 0) {
                        const firstWeight = p.weightHistory.filter(h => new Date(h.date) < oneWeekAgo).pop()?.weight || p.pesoInicial;
                        const lastWeight = recentHistory[recentHistory.length - 1].weight;
                        const loss = firstWeight - lastWeight;
                        if (loss > weeklyWinner.loss) {
                            weeklyWinner = { name: p.name, loss };
                        }
                    }
                });
                weeklyBox.innerHTML = `<div>🔥 Destaque da Semana</div><div class="text-xl font-bold text-purple-700">${weeklyWinner.name}</div><div>Perdeu ${weeklyWinner.loss.toFixed(2)} kg</div>`;

                const daysRemaining = Math.max(0, Math.ceil((CHALLENGE_END_DATE - new Date()) / (1000 * 60 * 60 * 24)));
                daysBox.innerHTML = `<div>⏳ Dias Restantes</div><div class="text-3xl font-bold text-blue-700">${daysRemaining}</div><div>Término em ${CHALLENGE_END_DATE.toLocaleDateString('pt-BR')}</div>`;
            }

            function applyPermissions() {
                const canEdit = USERS[currentUser]?.canEdit;
                document.querySelectorAll('button, input').forEach(el => {
                    const noDisable = ['logoutBtn', 'logoutBtnMobile', 'viewFullDashboardBtn', 'backToMobileRankingBtn', 'username', 'password'].includes(el.id) || el.closest('.nav-tab-item');
                    if (!noDisable) {
                         el.disabled = !canEdit;
                    }
                });
                document.querySelectorAll('.edit-participant-icon, .delete-participant-icon, #addParticipantBtn').forEach(el => el.classList.toggle('hidden', !canEdit));
            }
            
            function openModal(index = null) {
                const modal = document.getElementById('participantModal');
                const isEdit = index !== null;
                const p = isEdit ? participants[index] : {};

                modal.innerHTML = `
                    <div class="modal-content">
                        <span class="close-button">&times;</span>
                        <h3 class="text-2xl font-bold mb-4">${isEdit ? 'Editar' : 'Adicionar'} Participante</h3>
                        <form id="participantForm">
                            <input type="hidden" id="participantIndex" value="${isEdit ? index : ''}">
                            <div class="mb-4">
                                <label for="pName" class="block font-bold">Nome:</label>
                                <input type="text" id="pName" class="border rounded w-full py-2 px-3" value="${p.name || ''}" required>
                            </div>
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div><label for="pInitial" class="block font-bold">Peso Inicial:</label><input type="number" step="any" id="pInitial" class="border rounded w-full py-2 px-3" value="${p.pesoInicial || ''}" required></div>
                                <div><label for="pCurrent" class="block font-bold">Peso Atual:</label><input type="number" step="any" id="pCurrent" class="border rounded w-full py-2 px-3" value="${p.pesoAtual || ''}" required></div>
                            </div>
                            <div class="mb-6"><label for="pTarget" class="block font-bold">Meta de Peso:</label><input type="number" step="any" id="pTarget" class="border rounded w-full py-2 px-3" value="${p.targetWeight || ''}"></div>
                            <div class="flex justify-end gap-4">
                                <button type="button" class="bg-gray-500 text-white font-bold py-2 px-4 rounded close-button-action">Cancelar</button>
                                <button type="submit" class="bg-blue-500 text-white font-bold py-2 px-4 rounded">Salvar</button>
                            </div>
                        </form>
                    </div>`;
                
                modal.querySelector('.close-button').onclick = () => modal.classList.remove('show');
                modal.querySelector('.close-button-action').onclick = () => modal.classList.remove('show');
                modal.querySelector('#participantForm').onsubmit = handleParticipantFormSubmit;
                modal.classList.add('show');
            }

            function handleParticipantFormSubmit(e) {
                e.preventDefault();
                const index = e.target.querySelector('#participantIndex').value;
                const name = document.getElementById('pName').value.trim();
                const initialWeight = parseFloat(document.getElementById('pInitial').value);
                const currentWeight = parseFloat(document.getElementById('pCurrent').value);
                const targetWeight = parseFloat(document.getElementById('pTarget').value) || null;

                if (!name || !initialWeight || !currentWeight) return showFeedbackMessage("Preencha todos os campos obrigatórios.", true);

                if (index) { // Edit
                    const p = participants[index];
                    if (p.pesoAtual !== currentWeight) p.weightHistory.push({ date: new Date().toISOString(), weight: currentWeight });
                    p.name = name;
                    p.pesoInicial = initialWeight;
                    p.pesoAtual = currentWeight;
                    p.targetWeight = targetWeight;
                } else { // Add
                    participants.push({ name, pesoInicial: initialWeight, pesoAtual: currentWeight, targetWeight, semanasValidas: Array(12).fill(0), weightHistory: [{ date: new Date().toISOString(), weight: currentWeight }] });
                }
                saveData();
                updateAllViews();
                document.getElementById('participantModal').classList.remove('show');
                showFeedbackMessage(`Participante ${index ? 'atualizado' : 'adicionado'}!`);
            }

            function openDeleteModal(name, isReset = false) {
                const modal = document.getElementById('deleteConfirmModal');
                modal.innerHTML = `
                    <div class="modal-content text-center">
                        <h3 class="text-2xl font-bold mb-4">Confirmar Ação</h3>
                        <p class="mb-6">Tem certeza que deseja ${isReset ? 'resetar todos os dados para o padrão?' : `excluir <strong>${name}</strong>?`}</p>
                        <div class="flex justify-center gap-4">
                            <button class="bg-gray-500 text-white font-bold py-2 px-4 rounded" id="cancelDelete">Cancelar</button>
                            <button class="bg-red-500 text-white font-bold py-2 px-4 rounded" id="confirmDelete">Confirmar</button>
                        </div>
                    </div>`;
                
                modal.querySelector('#cancelDelete').onclick = () => modal.classList.remove('show');
                modal.querySelector('#confirmDelete').onclick = () => {
                    if (isReset) {
                        participants = JSON.parse(JSON.stringify(defaultParticipants));
                        showFeedbackMessage("Dados resetados!");
                    } else {
                        participants = participants.filter(p => p.name !== name);
                        showFeedbackMessage("Participante excluído!");
                    }
                    saveData();
                    updateAllViews();
                    modal.classList.remove('show');
                };
                modal.classList.add('show');
            }

            function openDetailsModal(name) {
                const p = calculateMetrics(participants.find(p => p.name === name));
                const modal = document.getElementById('participantDetailsModal');
                
                const progress = p.progressToTarget !== null ? `
                    <div class="progress-bar-container tooltip"><span class="tooltiptext">${p.progressToTarget.toFixed(1)}% da meta</span>
                        <div class="progress-bar-fill" style="width: ${p.progressToTarget}%;"><span class="progress-bar-text">${p.progressToTarget.toFixed(0)}%</span></div>
                    </div>` : 'N/A';
                
                modal.innerHTML = `
                    <div class="modal-content" style="max-width: 600px;">
                        <span class="close-button">&times;</span>
                        <div class="flex items-center gap-4 mb-4">
                            <img src="https://placehold.co/100x100/E2E8F0/4A5568?text=${p.name.charAt(0)}" class="rounded-full">
                            <div>
                                <h3 class="text-3xl font-bold">${p.name}</h3>
                                <div class="text-2xl">${getBadges(p)}</div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-center mb-4">
                            <div class="bg-gray-100 p-2 rounded-lg">
                                <div class="text-sm font-bold text-gray-500">PESO INICIAL</div>
                                <div class="text-2xl font-bold">${p.pesoInicial.toFixed(2)}kg</div>
                            </div>
                            <div class="bg-gray-100 p-2 rounded-lg">
                                <div class="text-sm font-bold text-gray-500">PESO ATUAL</div>
                                <div class="text-2xl font-bold text-blue-600">${p.pesoAtual.toFixed(2)}kg</div>
                            </div>
                            <div class="bg-gray-100 p-2 rounded-lg">
                                <div class="text-sm font-bold text-gray-500">META</div>
                                <div class="text-2xl font-bold text-green-600">${p.targetWeight ? p.targetWeight.toFixed(2) + 'kg' : 'N/A'}</div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <div class="text-sm font-bold text-gray-500 mb-1">PROGRESSO PARA META</div>
                            ${progress}
                        </div>
                        <div>
                            <div class="text-sm font-bold text-gray-500 mb-1">HISTÓRICO DE PESO</div>
                            <div id="details-chart"></div>
                        </div>
                    </div>`;
                
                modal.querySelector('.close-button').onclick = () => modal.classList.remove('show');
                modal.classList.add('show');
                
                if (p.weightHistory.length > 1) {
                    renderMiniChart(p.weightHistory, '#details-chart');
                } else {
                    document.getElementById('details-chart').innerHTML = `<div class="text-center p-4 text-gray-500">Não há dados suficientes para o gráfico.</div>`;
                }
            }
            
            function renderMiniChart(data, containerSelector) {
                const container = d3.select(containerSelector);
                container.select("svg").remove();
                
                const margin = {top: 10, right: 10, bottom: 20, left: 30},
                      width = 500 - margin.left - margin.right,
                      height = 200 - margin.top - margin.bottom;

                const svg = container.append("svg")
                    .attr("viewBox", `0 0 ${width + margin.left + margin.right} ${height + margin.top + margin.bottom}`)
                    .append("g").attr("transform", `translate(${margin.left},${margin.top})`);
                
                const xScale = d3.scaleTime().domain(d3.extent(data, d => new Date(d.date))).range([0, width]);
                const yScale = d3.scaleLinear().domain([d3.min(data, d => d.weight) - 1, d3.max(data, d => d.weight) + 1]).range([height, 0]);
                
                svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(xScale).ticks(5).tickFormat(d3.timeFormat("%d/%m")));
                svg.append("g").call(d3.axisLeft(yScale).ticks(5));
                
                svg.append("path").datum(data).attr("fill", "none").attr("stroke", "steelblue").attr("stroke-width", 2)
                   .attr("d", d3.line().x(d => xScale(new Date(d.date))).y(d => yScale(d.weight)));
            }

            // Funções de import/export (completas)
            function exportData() {
                const dataStr = JSON.stringify(participants, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'desafio_fit_data.json';
                a.click();
                URL.revokeObjectURL(url);
                showFeedbackMessage("Dados exportados!");
            }

            function importData(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const imported = JSON.parse(e.target.result);
                        if (Array.isArray(imported)) {
                            participants = imported;
                            saveData();
                            updateAllViews();
                            showFeedbackMessage("Dados importados com sucesso!");
                        } else {
                            throw new Error("Formato inválido.");
                        }
                    } catch (err) {
                        showFeedbackMessage("Erro ao importar arquivo.", true);
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            }

            function showFeedbackMessage(message, isError = false) {
                feedbackMessageDiv.textContent = message;
                feedbackMessageDiv.className = `feedback-message show ${isError ? 'error' : ''}`;
                setTimeout(() => feedbackMessageDiv.classList.remove('show'), 3000);
            }
            
            function debounce(func, delay) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            }

            // Chamar a inicialização
            initApp();
        });
    </script>
</body>
</html>