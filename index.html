<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Natal Fam√≠lia 2026</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéÖ</text></svg>">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonte Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- √çcones -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Calend√°rio -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://npmcdn.com/flatpickr/dist/themes/dark.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/pt.js"></script>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        slate: {
                            850: '#151e32',
                            900: '#0f172a',
                            950: '#020617',
                        }
                    },
                    animation: {
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #0f172a; /* Slate 900 */
            color: #f1f5f9; /* Slate 100 */
            overflow-x: hidden;
        }

        /* ===========================================================
           LOGIN
           =========================================================== */
        #loginOverlay { isolation: isolate; }
        #loginOverlay .login-bg{
            background:
                radial-gradient(1200px circle at 20% 20%, rgba(99, 102, 241, 0.15), transparent 55%),
                radial-gradient(1200px circle at 85% 15%, rgba(16, 185, 129, 0.10), transparent 55%),
                radial-gradient(900px circle at 50% 85%, rgba(236, 72, 153, 0.10), transparent 55%),
                linear-gradient(180deg, #020617 0%, #0f172a 100%);
        }
        #loginOverlay .login-topline{
            background: linear-gradient(90deg, #ec4899, #6366f1, #10b981);
        }

        .card {
            background-color: #1e293b; /* Slate 800 */
            border: 1px solid #334155; /* Slate 700 */
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .tab-btn { 
            padding: 0.5rem 1rem; 
            border-radius: 0.5rem; 
            font-size: 0.875rem; 
            font-weight: 500; 
            color: #94a3b8; 
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }
        .tab-btn:hover { color: white; background-color: #334155; }
        .tab-btn.active { background-color: #4f46e5; color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }

        /* Scrollbar da tabela */
        ::-webkit-scrollbar { height: 8px; width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Badges de Status (Cores Din√¢micas) */
        .status-badge {
            font-size: 0.75rem; 
            font-weight: 700; 
            padding: 3px 0; 
            width: 100%; 
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px; 
            text-align: center;
            transition: transform 0.1s;
        }
        
        /* Regras de Cores */
        .bg-paid { background-color: rgba(34, 197, 94, 0.15); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.25); } /* Verde */
        .bg-partial { background-color: rgba(250, 204, 21, 0.15); color: #facc15; border: 1px solid rgba(250, 204, 21, 0.25); } /* Amarelo */
        .bg-missed { background-color: rgba(248, 113, 113, 0.15); color: #f87171; border: 1px solid rgba(248, 113, 113, 0.25); } /* Vermelho */
        .bg-none { background-color: rgba(148, 163, 184, 0.05); color: #64748b; border: 1px dashed rgba(148, 163, 184, 0.15); } /* Cinza */
        
        /* Anivers√°rio */
        .bg-birthday { 
            background: linear-gradient(135deg, rgba(236, 72, 153, 0.2), rgba(168, 85, 247, 0.2)); 
            color: #f472b6; 
            border: 1px solid rgba(236, 72, 153, 0.4);
            position: relative;
            overflow: hidden;
        }
        .bg-birthday::after {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.1) 50%, transparent 60%);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer { from { transform: translateX(-100%); } to { transform: translateX(100%); } }

        .input-dark {
            background-color: #0f172a;
            border: 1px solid #334155;
            color: white;
            border-radius: 0.5rem;
            padding: 0.6rem;
            width: 100%;
            font-size: 0.875rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .input-dark:focus { outline: none; border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); }

        /* Anima√ß√£o simples */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Ajuste da Coluna Fixa para mesclar com o fundo */
        th.sticky-col, td.sticky-col {
            position: sticky;
            left: 0;
            z-index: 20;
            background-color: #1e293b;
            box-shadow: 4px 0 8px rgba(0,0,0,0.25);
        }
        tr:hover td.sticky-col { background-color: #273549; }
        tr:hover { background-color: #273549; }
        
        /* Imagem de Perfil */
        .profile-pic {
            object-fit: cover;
            width: 100%;
            height: 100%;
        }
    
        /* ===========================
           RESPONSIVIDADE (MOBILE)
           =========================== */
        @media (max-width: 640px) {
            .month-col { display: none !important; }
            .extra-col { display: none !important; }
            #editColHead, td.edit-col { display: none !important; }
            th.sticky-col, td.sticky-col { min-width: 160px; box-shadow: 2px 0 5px rgba(0,0,0,0.3); }
            
            .card { padding: 1rem !important; }
            
            /* Tabela compacta (sem scroll lateral no body, mas tabela controlada) */
            .table-compact th, .table-compact td { padding: 0.5rem 0.25rem !important; }
            
            .col-multa { width: 60px !important; min-width: 60px !important; }
            .col-total { width: 90px !important; min-width: 90px !important; }
            .col-falta { width: 90px !important; min-width: 90px !important; }
        }

        /* ===========================================================
           NATAL UI (PAPAI NOEL NO PROGRESSO + √ÅRVORE NO STATUS)
           =========================================================== */
        #mainProgressBarContainer {
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }
        #mainProgressBar{
            display:flex;
            align-items:center;
            justify-content:flex-end;
            position:relative;
            transition: width 1.5s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        #mainProgressBar .santa-badge{
            width: 36px;
            height: 36px;
            display:flex;
            align-items:center;
            justify-content:center;
            border-radius:9999px;
            background: #0f172a;
            border: 2px solid #334155;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            position: absolute;
            right: -18px;
            z-index: 10;
            animation: santaBob 3s ease-in-out infinite;
        }
        #mainProgressBar .santa-emoji{
            font-size: 22px;
            line-height: 1;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));
        }

        @keyframes santaBob{
            0%,100%{ transform: translateY(0) rotate(0deg); }
            50%{ transform: translateY(-3px) rotate(5deg); }
        }

        /* √Årvore SVG */
        .tree-base{ fill: rgba(255,255,255,0.05); stroke: #334155; stroke-width: 1; }
        .tree-fill{ fill: rgba(16,185,129,0.2); }
        .tree-cover{
            fill: #1e293b; /* Mesma cor do card */
            transition: transform 1.5s ease;
            transform-origin: bottom;
            transform-box: fill-box;
            will-change: transform;
        }
        .tree-trunk{ fill: #475569; }
        .tree-pct{
            font-size: 20px;
            font-weight: 800;
            fill: #e2e8f0;
            font-family: 'Inter', sans-serif;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .tree-star{
            fill: #334155;
            transition: all 0.5s ease;
        }
        .tree-star.on{
            fill: #fbbf24;
            filter: drop-shadow(0 0 8px rgba(251, 191, 36, 0.6));
            animation: pulseStar 2s infinite;
        }
        @keyframes pulseStar {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        /* Modal Transitions */
        dialog { transition: opacity 0.3s; }
        dialog::backdrop { background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); }

        /* Cloud Status Indicator */
        #cloudStatus {
            transition: opacity 0.5s ease;
        }
        .status-dot {
            height: 8px; width: 8px; border-radius: 50%; display: inline-block;
        }
        .status-saving { background-color: #fbbf24; animation: pulse 1s infinite; }
        .status-saved { background-color: #10b981; }
        .status-error { background-color: #f43f5e; }
    </style>
</head>
<body class="flex flex-col min-h-screen text-slate-100">

    <!-- Login Overlay -->
    <div id="loginOverlay" class="fixed inset-0 z-[200] flex items-center justify-center p-4">
        <div class="absolute inset-0 login-bg"></div>

        <div class="relative w-full max-w-md rounded-2xl overflow-hidden border border-white/10 bg-slate-900/60 backdrop-blur-xl shadow-2xl fade-in">
            <div class="h-1.5 w-full login-topline"></div>

            <div class="p-8 sm:p-10">
                <div class="mx-auto w-16 h-16 rounded-2xl bg-gradient-to-br from-indigo-500/20 to-purple-500/20 flex items-center justify-center ring-1 ring-white/10 shadow mb-6">
                    <span class="text-4xl filter drop-shadow-lg">üéÖ</span>
                </div>

                <h1 class="text-center text-3xl font-extrabold text-white tracking-tight">
                    Natal Fam√≠lia <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-cyan-300">2026</span>
                </h1>
                <p class="mt-2 text-center text-sm text-slate-400">Gest√£o Financeira &amp; Metas</p>

                <div class="mt-8 space-y-5">
                    <div>
                        <label class="block text-xs font-bold tracking-wider text-slate-500 mb-1">USU√ÅRIO</label>
                        <div class="relative">
                            <i class="ph ph-user absolute left-3 top-3 text-slate-500"></i>
                            <input id="loginUser" class="input-dark pl-10" placeholder="Ex: admin" autocomplete="username" />
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold tracking-wider text-slate-500 mb-1">SENHA</label>
                        <div class="relative">
                            <i class="ph ph-lock-key absolute left-3 top-3 text-slate-500"></i>
                            <input id="loginPass" type="password" class="input-dark pl-10" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
                        </div>
                    </div>

                    <p id="loginError" class="text-xs text-rose-400 font-bold hidden bg-rose-950/30 p-2 rounded border border-rose-900/50 text-center"></p>

                    <button id="loginBtn" onclick="doLogin()" class="w-full rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white py-3 font-bold tracking-wide shadow-lg shadow-indigo-600/20 transition transform active:scale-95">
                        ACESSAR SISTEMA
                    </button>
                    
                    <div class="text-center mt-4">
                        <p class="text-[10px] text-slate-500">
                            Acesso Admin: <strong>admin / Admin2026</strong><br>
                            Acesso Leitura: <strong>natal / 2026</strong>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="bg-slate-800/80 backdrop-blur-md border-b border-slate-700 sticky top-0 z-50 h-16 shadow-lg">
        <div class="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-gradient-to-br from-indigo-600 to-violet-600 p-2 rounded-lg shadow-lg">
                    <i class="ph ph-gift text-xl text-white"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-white tracking-tight hidden sm:block">Natal Fam√≠lia <span class="text-indigo-400">2026</span></h1>
                    <!-- Cloud Status Indicator -->
                    <div id="cloudStatus" class="flex items-center gap-1.5 text-[10px] text-slate-400 font-medium opacity-0">
                        <span id="cloudDot" class="status-dot status-saved"></span>
                        <span id="cloudText">Conectado</span>
                    </div>
                </div>
            </div>
            
            <div class="flex bg-slate-900/50 p-1 rounded-lg border border-slate-700/50">
                <button onclick="switchTab('dashboard')" id="btn-dashboard" class="tab-btn active">
                    <i class="ph ph-chart-pie-slice mr-2 text-lg"></i> Painel
                </button>
                <button onclick="switchTab('admin')" id="btn-admin" class="tab-btn hidden">
                    <i class="ph ph-gear mr-2 text-lg"></i> Admin
                </button>
            </div>

            <button onclick="logout()" class="text-xs text-slate-400 hover:text-white font-medium px-3 py-2 rounded border border-slate-700 hover:bg-slate-700 transition flex items-center gap-2">
                <i class="ph ph-sign-out text-lg"></i> <span class="hidden sm:inline">Sair</span>
            </button>
        </div>
    </nav>

    <!-- Conte√∫do Principal -->
    <main class="flex-grow p-4 sm:p-6 w-full max-w-7xl mx-auto space-y-6">

        <!-- VIEW: DASHBOARD -->
        <div id="view-dashboard" class="fade-in space-y-6">
            
            <!-- Header A√ß√µes -->
            <div class="flex flex-col sm:flex-row justify-between items-end sm:items-center gap-4 border-b border-slate-800 pb-4">
                <div>
                    <h2 class="text-2xl font-bold text-white">Vis√£o Geral</h2>
                    <p class="text-sm text-slate-400">Acompanhamento financeiro e status dos participantes.</p>
                </div>
                <div class="flex flex-wrap gap-2 justify-end">
                    <button id="btn-reset" onclick="resetData()" class="hidden text-xs text-rose-400 hover:text-rose-300 font-bold px-3 py-2 border border-rose-900 rounded hover:bg-rose-900/20 transition flex items-center gap-2">
                        <i class="ph ph-trash"></i> RESETAR TUDO
                    </button>
                    
                    <div id="admin-actions" class="hidden flex gap-2">
                        <button onclick="document.getElementById('csvInput').click()" class="bg-slate-800 hover:bg-slate-700 border border-slate-600 text-slate-300 px-3 py-2 rounded text-xs font-bold uppercase transition flex items-center gap-2">
                            <i class="ph ph-file-csv text-green-400 text-lg"></i> Importar CSV
                        </button>
                        <input type="file" id="csvInput" accept=".csv" class="hidden">

                        <button onclick="document.getElementById('jsonBackupInput').click()" class="bg-slate-800 hover:bg-slate-700 border border-slate-600 text-slate-300 px-3 py-2 rounded text-xs font-bold uppercase transition flex items-center gap-2">
                            <i class="ph ph-upload-simple text-sky-400 text-lg"></i> Restaurar JSON
                        </button>
                        <input type="file" id="jsonBackupInput" accept=".json" class="hidden">

                        <button onclick="exportBackupJSON()" class="bg-slate-800 hover:bg-slate-700 border border-slate-600 text-slate-300 px-3 py-2 rounded text-xs font-bold uppercase transition flex items-center gap-2">
                            <i class="ph ph-download-simple text-sky-400 text-lg"></i> Backup JSON
                        </button>
                        
                        <button onclick="exportParticipantsCSV()" class="bg-slate-800 hover:bg-slate-700 border border-slate-600 text-slate-300 px-3 py-2 rounded text-xs font-bold uppercase transition flex items-center gap-2">
                            <i class="ph ph-table text-emerald-400 text-lg"></i> Excel
                        </button>
                    </div>
                </div>
            </div>

            <!-- Cards Resumo -->
            <div id="dashboardSummary" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- JS Preenche -->
            </div>

            <!-- Se√ß√£o Gr√°fica -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Gr√°fico Status -->
                <div class="card lg:col-span-1 flex flex-col items-center justify-center relative overflow-hidden group">
                    <div class="absolute inset-0 bg-gradient-to-b from-slate-800 to-slate-900 z-0"></div>
                    <div class="relative z-10 w-full flex flex-col items-center">
                        <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-6 w-full text-center border-b border-slate-700 pb-2">
                            Progresso Individual
                        </h3>
                        
                        <div class="relative w-40 h-48 flex items-end justify-center">
                            <svg class="w-full h-full drop-shadow-xl" viewBox="0 0 120 140" role="img">
                                <defs>
                                    <clipPath id="treeClipNatal2026">
                                        <path d="M60 10 C55 20,45 30,38 40 L48 40 C40 52,32 64,26 76 L38 76 C30 88,22 100,16 112 L48 112 L48 126 L72 126 L72 112 L104 112 C98 100,90 88,82 76 L94 76 C88 64,80 52,72 40 L82 40 C75 30,65 20,60 10 Z"></path>
                                    </clipPath>
                                </defs>
                                <g id="treeStar" class="tree-star origin-center box-border" style="transform-box: fill-box; transform-origin: 50% 50%;">
                                    <polygon points="60,2 65,15 78,15 68,22 72,35 60,27 48,35 52,22 42,15 55,15"></polygon>
                                </g>
                                <path d="M60 10 C55 20,45 30,38 40 L48 40 C40 52,32 64,26 76 L38 76 C30 88,22 100,16 112 L48 112 L48 126 L72 126 L72 112 L104 112 C98 100,90 88,82 76 L94 76 C88 64,80 52,72 40 L82 40 C75 30,65 20,60 10 Z" class="tree-base"></path>
                                
                                <g clip-path="url(#treeClipNatal2026)">
                                    <rect x="0" y="0" width="120" height="140" class="tree-fill"></rect>
                                    <!-- O cover diminui a escala Y para revelar a √°rvore -->
                                    <rect id="treeCover" x="0" y="0" width="120" height="140" class="tree-cover"></rect>
                                </g>

                                <rect x="52" y="126" width="16" height="10" rx="2" class="tree-trunk"></rect>
                                <text id="treePercent" x="60" y="80" text-anchor="middle" class="tree-pct">0%</text>
                            </svg>
                        </div>

                        <div class="grid grid-cols-2 gap-3 w-full mt-6">
                            <div class="bg-slate-900/50 p-2 rounded text-center border border-slate-700">
                                <span id="countOk" class="block text-xl font-bold text-emerald-400">0</span>
                                <span class="text-[10px] uppercase text-slate-500 font-bold">Em dia</span>
                            </div>
                            <div class="bg-slate-900/50 p-2 rounded text-center border border-slate-700">
                                <span id="countPending" class="block text-xl font-bold text-rose-400">0</span>
                                <span class="text-[10px] uppercase text-slate-500 font-bold">Atrasado</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Barra Progresso Global -->
                <div class="card lg:col-span-2 flex flex-col justify-between">
                    <div>
                        <div class="flex justify-between items-center mb-6 border-b border-slate-700 pb-2">
                            <h3 class="text-sm font-bold text-slate-300 flex items-center gap-2">
                                <i class="ph ph-trend-up text-emerald-400 text-lg"></i> Evolu√ß√£o da Arrecada√ß√£o
                            </h3>
                            <span id="metaLabel" class="text-xs font-mono text-slate-500 bg-slate-900 px-2 py-1 rounded border border-slate-700">Meta: R$ 0</span>
                        </div>
                        
                        <div class="relative pt-6 pb-2">
                            <div id="mainProgressBarContainer" class="w-full bg-slate-900 rounded-full h-6 border border-slate-700 relative">
                                <div id="mainProgressBar" class="bg-gradient-to-r from-emerald-600 to-teal-400 h-full rounded-full flex items-center justify-end" style="width: 0%">
                                    <div class="santa-badge">
                                        <span class="santa-emoji">üéÖ</span>
                                    </div>
                                </div>
                            </div>
                            <div class="flex justify-between mt-2 text-xs font-bold text-slate-500">
                                <span>0%</span>
                                <span id="mainProgressText" class="text-emerald-400">0%</span>
                                <span>100%</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-4 mt-8">
                        <div class="bg-slate-900 p-4 rounded-xl border border-slate-700 text-center shadow-inner">
                            <p class="text-[10px] text-slate-500 font-bold uppercase mb-1">Total Esperado</p>
                            <p id="summaryTotalExpected" class="text-sm sm:text-lg font-bold text-white">R$ 0</p>
                        </div>
                        <div class="bg-slate-900 p-4 rounded-xl border border-slate-700 text-center shadow-inner">
                            <p class="text-[10px] text-slate-500 font-bold uppercase mb-1">Em Caixa</p>
                            <p id="summaryTotalPaid" class="text-sm sm:text-lg font-bold text-emerald-400">R$ 0</p>
                        </div>
                        <div class="bg-slate-900 p-4 rounded-xl border border-slate-700 text-center shadow-inner">
                            <p class="text-[10px] text-slate-500 font-bold uppercase mb-1">A Receber</p>
                            <p id="summaryTotalMissing" class="text-sm sm:text-lg font-bold text-rose-400">R$ 0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabela Detalhada -->
            <div class="card overflow-hidden !p-0 border border-slate-700 shadow-xl">
                <div class="p-4 border-b border-slate-700 flex flex-col sm:flex-row justify-between items-center bg-slate-800 gap-4">
                    <h3 class="text-sm font-bold text-white flex items-center gap-2">
                        <i class="ph ph-users text-indigo-400"></i> Detalhamento
                    </h3>
                    <div class="relative w-full sm:w-auto">
                        <i class="ph ph-magnifying-glass absolute left-3 top-2.5 text-slate-500"></i>
                        <input type="text" id="searchInput" placeholder="Buscar participante..." class="input-dark pl-9 !py-1.5 !text-xs !w-full sm:!w-64">
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse table-compact">
                        <thead>
                            <tr class="bg-slate-900 text-slate-400 text-[10px] uppercase font-bold border-b border-slate-700">
                                <th class="p-3 sticky-col min-w-[180px] pl-4 text-slate-300">Participante</th>
                                <th class="p-2 text-center w-12 month-col">Jan</th>
                                <th class="p-2 text-center w-12 month-col">Fev</th>
                                <th class="p-2 text-center w-12 month-col">Mar</th>
                                <th class="p-2 text-center w-12 month-col">Abr</th>
                                <th class="p-2 text-center w-12 month-col">Mai</th>
                                <th class="p-2 text-center w-12 month-col">Jun</th>
                                <th class="p-2 text-center w-12 month-col">Jul</th>
                                <th class="p-2 text-center w-12 month-col">Ago</th>
                                <th class="p-2 text-center w-12 month-col">Set</th>
                                <th class="p-2 text-center w-12 month-col">Out</th>
                                <th class="p-2 text-center w-12 month-col">Nov</th>
                                <th class="p-2 text-center w-12 month-col">Dez</th>
                                <th class="p-2 text-center bg-rose-900/10 border-l border-rose-900/20 text-rose-400 min-w-[70px] col-multa" title="D√≠vida de Multa">Multa</th>
                                <th class="p-2 text-center bg-indigo-900/10 border-l border-indigo-900/20 text-indigo-400 min-w-[70px] extra-col" title="Valor Extra Pago">Extra</th>
                                <th class="p-2 text-right bg-slate-800/50 min-w-[100px] col-total">Total Pago</th>
                                <th class="p-2 text-right bg-slate-800/50 border-r border-slate-700 min-w-[100px] col-falta">Falta</th>
                                <th id="editColHead" class="p-2 text-center sticky right-0 bg-slate-900 z-10 w-14 shadow-[-5px_0_10px_rgba(0,0,0,0.2)] hidden">Editar</th>
                            </tr>
                        </thead>
                        <tbody id="participantsTableBody" class="text-sm divide-y divide-slate-700 bg-slate-800">
                            <!-- JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- VIEW: ADMIN -->
        <div id="view-admin" class="hidden fade-in max-w-5xl mx-auto space-y-8 pb-10">
            <h2 class="text-2xl font-bold text-white border-b border-slate-700 pb-4">Configura√ß√µes do Sistema</h2>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                
                <!-- 1. Metas Mensais -->
                <div class="card border-l-4 border-l-indigo-500">
                    <h3 class="text-base font-bold text-white mb-2 flex items-center gap-2">
                        <i class="ph ph-currency-dollar text-indigo-400"></i> Metas Mensais (R$)
                    </h3>
                    <p class="text-xs text-slate-400 mb-6">Defina o valor base que cada participante deve pagar por m√™s.</p>

                    <div class="grid grid-cols-3 sm:grid-cols-4 gap-3" id="monthlyGoalsContainer">
                        <!-- JS Inputs -->
                    </div>
                    
                    <div class="mt-6 pt-4 border-t border-slate-700 flex justify-between items-center">
                        <div class="text-xs text-slate-400">Total Anual por Pessoa: <span id="totalAnnualGoal" class="text-white font-mono font-bold ml-1">R$ 0,00</span></div>
                        <button onclick="saveMonthlyGoals()" class="bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold uppercase py-2 px-4 rounded transition shadow-lg">Salvar Metas</button>
                    </div>
                </div>

                <!-- Coluna Direita -->
                <div class="space-y-6">
                    
                    <!-- 2. Cadastro R√°pido -->
                    <div class="card border-l-4 border-l-emerald-500">
                        <h3 class="text-base font-bold text-white mb-4 flex items-center gap-2">
                            <i class="ph ph-user-plus text-emerald-400"></i> Novo Participante
                        </h3>
                        
                        <div class="space-y-3">
                            <input type="text" id="newUserName" placeholder="Nome Completo" class="input-dark">
                            <div class="flex gap-2 items-center">
                                <!-- Bot√£o de Upload de Foto -->
                                <label class="cursor-pointer bg-slate-700 hover:bg-slate-600 text-white p-2 rounded text-xs flex items-center justify-center min-w-[40px] border border-slate-600 transition h-[38px]" title="Escolher Foto">
                                    <i class="ph ph-camera text-lg"></i>
                                    <input type="file" id="newUserPhotoFile" accept="image/*" class="hidden" onchange="previewAddUserImage(this)">
                                </label>
                                <span id="newUserPhotoName" class="text-xs text-emerald-400 truncate max-w-[100px] hidden font-bold">Foto OK</span>

                                <select id="newUserBirthday" class="input-dark text-xs flex-grow h-[38px]">
                                    <option value="">M√™s do Anivers√°rio</option>
                                    <option value="0">Janeiro</option><option value="1">Fevereiro</option><option value="2">Mar√ßo</option>
                                    <option value="3">Abril</option><option value="4">Maio</option><option value="5">Junho</option>
                                    <option value="6">Julho</option><option value="7">Agosto</option><option value="8">Setembro</option>
                                    <option value="9">Outubro</option><option value="10">Novembro</option><option value="11">Dezembro</option>
                                </select>
                            </div>
                            <button onclick="addParticipant()" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white py-2 rounded font-bold transition shadow-lg">Adicionar Participante</button>
                        </div>
                        
                        <!-- Mini Lista -->
                        <div class="mt-6 border-t border-slate-700 pt-4">
                            <h4 class="text-xs font-bold text-slate-500 uppercase mb-2">Cadastrados Recentemente</h4>
                            <div class="overflow-y-auto max-h-40 rounded border border-slate-700">
                                <table class="w-full text-left">
                                    <tbody id="adminUsersTableBody" class="divide-y divide-slate-700 text-xs text-slate-300 bg-slate-900"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- 3. Multas -->
                    <div class="card border-l-4 border-l-rose-500">
                        <h3 class="text-base font-bold text-white mb-2 flex items-center gap-2">
                            <i class="ph ph-siren text-rose-400"></i> Auditoria de Inadimpl√™ncia
                        </h3>
                        <p class="text-[10px] text-slate-400 mb-4 bg-slate-900 p-2 rounded border border-slate-700">
                            <strong>Regra:</strong> Quem n√£o tiver pago o m√≠nimo at√© a data limite recebe uma <strong>Multa (D√≠vida)</strong>.
                        </p>

                        <div class="space-y-3">
                            <div>
                                <label class="text-[10px] text-slate-500 font-bold uppercase block mb-1">Data Limite (Prazo)</label>
                                <input type="text" id="fineDeadline" class="input-dark bg-slate-900 text-center cursor-pointer" placeholder="Selecione data..." onchange="saveFineConfig()">
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-[10px] text-slate-500 font-bold uppercase block mb-1">M√≠nimo Pago (R$)</label>
                                    <input type="number" id="fineThreshold" class="input-dark" value="50" onchange="saveFineConfig()">
                                </div>
                                <div>
                                    <label class="text-[10px] text-slate-500 font-bold uppercase block mb-1">Multa (R$)</label>
                                    <input type="number" id="fineValue" class="input-dark border-rose-500/30 text-rose-400 font-bold" value="15" onchange="saveFineConfig()">
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 pt-3 border-t border-slate-700">
                            <button onclick="manualFineCheck()" class="w-full bg-rose-950/30 border border-rose-500/30 hover:bg-rose-900/50 text-rose-200 text-xs font-bold uppercase py-2 rounded transition flex items-center justify-center gap-2 hover:border-rose-500">
                                <i class="ph ph-gavel"></i> Verificar e Aplicar
                            </button>
                            <p id="fineFeedback" class="text-center text-xs mt-2 text-slate-500 h-4"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- Modal Editar -->
    <div id="editPaymentModal" class="hidden fixed inset-0 z-[100] flex items-center justify-center px-4 bg-slate-950/80 backdrop-blur-sm fade-in">
        <div class="bg-slate-800 rounded-lg shadow-2xl border border-slate-600 w-full max-w-xl overflow-hidden transform transition-all scale-100">
            <div class="bg-slate-900 px-6 py-4 border-b border-slate-700 flex justify-between items-center">
                <h3 class="text-lg font-bold text-white flex items-center gap-2"><i class="ph ph-pencil-simple text-indigo-400"></i> Editar Dados</h3>
                <button onclick="closeEditModal()" class="text-slate-400 hover:text-white transition"><i class="ph ph-x text-xl"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto max-h-[80vh]">
                <!-- Info do Usu√°rio -->
                <div class="mb-6 pb-4 border-b border-slate-700">
                    <h4 class="text-xs font-bold uppercase text-slate-500 mb-3">Informa√ß√µes Pessoais</h4>
                    <div class="flex gap-4 items-center">
                        <!-- Foto Clic√°vel para Editar -->
                        <div class="relative w-16 h-16 rounded-full bg-slate-700 flex-shrink-0 border-2 border-slate-600 overflow-hidden cursor-pointer group hover:border-indigo-500 transition" onclick="document.getElementById('editPhotoFile').click()">
                            <img id="modalAvatarImg" class="profile-pic hidden" src="" alt="">
                            <div id="modalAvatarText" class="absolute inset-0 flex items-center justify-center text-2xl font-bold text-slate-400">A</div>
                            <!-- Overlay de Edi√ß√£o -->
                            <div class="absolute inset-0 bg-black/50 hidden group-hover:flex items-center justify-center text-white text-xl">
                                <i class="ph ph-camera"></i>
                            </div>
                            <input type="file" id="editPhotoFile" accept="image/*" class="hidden" onchange="previewEditUserImage(this)">
                        </div>

                        <div class="space-y-2 flex-grow">
                            <h2 class="text-xl font-bold text-white" id="modalParticipantName">Nome</h2>
                            <div class="flex items-center gap-2">
                                <i class="ph ph-cake text-slate-500"></i>
                                <select id="editBirthdayMonth" class="input-dark !py-1 !px-2 !w-auto text-xs bg-slate-900">
                                    <option value="-1">Sem registro</option>
                                    <option value="0">Janeiro</option><option value="1">Fevereiro</option><option value="2">Mar√ßo</option>
                                    <option value="3">Abril</option><option value="4">Maio</option><option value="5">Junho</option>
                                    <option value="6">Julho</option><option value="7">Agosto</option><option value="8">Setembro</option>
                                    <option value="9">Outubro</option><option value="10">Novembro</option><option value="11">Dezembro</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <input type="hidden" id="editParticipantIndex">

                <h4 class="text-xs font-bold uppercase text-slate-500 mb-3">Pagamentos Mensais</h4>
                <div class="grid grid-cols-3 sm:grid-cols-4 gap-3 mb-6" id="editMonthsContainer">
                    <!-- JS Inputs -->
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <!-- Campo MULTA (D√çVIDA) -->
                    <div class="bg-rose-900/10 p-3 rounded border border-rose-500/20">
                        <label class="text-xs font-bold uppercase text-rose-400 block mb-2">Multa (D√≠vida)</label>
                        <div class="flex items-center gap-2">
                            <span class="text-slate-500 text-sm">R$</span>
                            <input type="number" id="editFineValue" class="bg-slate-900 border border-rose-500/30 text-rose-400 font-bold rounded w-full p-1 text-right focus:border-rose-500 outline-none">
                        </div>
                    </div>

                    <!-- Campo EXTRA (PAGAMENTO) -->
                    <div class="bg-indigo-900/10 p-3 rounded border border-indigo-500/20">
                        <label class="text-xs font-bold uppercase text-indigo-400 block mb-2">Extra Pago (Cr√©dito)</label>
                        <div class="flex items-center gap-2">
                            <span class="text-slate-500 text-sm">R$</span>
                            <input type="number" id="editExtraValue" class="bg-slate-900 border border-indigo-500/30 text-indigo-400 font-bold rounded w-full p-1 text-right focus:border-indigo-500 outline-none">
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-slate-900 px-6 py-4 flex justify-end gap-3 border-t border-slate-700">
                <button onclick="closeEditModal()" class="px-4 py-2 rounded text-sm font-bold text-slate-400 hover:text-white hover:bg-slate-800 transition">Cancelar</button>
                <button onclick="saveEditModal()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2 rounded text-sm font-bold shadow-lg transition">Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>

    <!-- JS Logic -->
    <script>
        const MONTHS_FULL = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
        const MONTH_ABBR = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
        
        // Configura√ß√£o Inicial de 2026
        const DEFAULT_MONTHLY_GOALS = [0, 0, 30, 30, 30, 30, 30, 30, 30, 30, 55, 55]; // Jan/Fev 0, resto configurado
        let monthlyGoals = [...DEFAULT_MONTHLY_GOALS];
        let participantsData = [];
        const DEFAULT_FINE_CONFIG = { deadline: '20/05/2026', threshold: 50, value: 15 };
        let fineConfig = { ...DEFAULT_FINE_CONFIG };
        
        // Vars Temp
        let tempAddPhotoBase64 = '';
        let tempEditPhotoBase64 = '';

        // --- SUPABASE CONFIG ---
        const SUPABASE_URL = "https://nctjowqubtfbejipxhhd.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5jdGpvd3F1YnRmYmVqaXB4aGhkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczODk1NjYsImV4cCI6MjA4Mjk2NTU2Nn0.63GaaShzKx0oO6n4ci0Rj3onmenYycjcE0EN7vVvErE";
        const SUPABASE_TABLE = "app_state"; 
        const SUPABASE_KEYS = { participants: "participants", goals: "goals", fine: "fine" };

        let sb = null;
        if (typeof supabase !== 'undefined') {
            sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } else {
            console.error("Supabase SDK not loaded properly.");
        }

        // --- AUTH ---
        const AUTH_USERS = {
            admin: { password: 'Admin2026', role: 'admin' },
            natal: { password: '2026', role: 'viewer' }
        };

        let currentRole = null; 
        let isAdmin = false;

        function setRole(role) {
            currentRole = role;
            isAdmin = (role === 'admin');
            applyRoleUI();
        }

        function applyRoleUI() {
            const btnAdmin = document.getElementById('btn-admin');
            const viewAdmin = document.getElementById('view-admin');
            const adminActions = document.getElementById('admin-actions');
            const resetBtn = document.getElementById('btn-reset');
            const editColHead = document.getElementById('editColHead');

            if (!isAdmin) {
                btnAdmin.classList.add('hidden');
                if (!viewAdmin.classList.contains('hidden')) switchTab('dashboard');
                
                adminActions.classList.add('hidden');
                resetBtn.classList.add('hidden');
                editColHead.classList.add('hidden');
                
                // Remove edit columns from table rows
                document.querySelectorAll('.edit-col').forEach(el => el.classList.add('hidden'));
            } else {
                btnAdmin.classList.remove('hidden');
                adminActions.classList.remove('hidden');
                resetBtn.classList.remove('hidden');
                editColHead.classList.remove('hidden');
                document.querySelectorAll('.edit-col').forEach(el => el.classList.remove('hidden'));
            }
        }

        function requireAdmin() {
            if (isAdmin) return true;
            alert("Acesso restrito: somente Admin pode editar.");
            return false;
        }

        function initAuth() {
            const sessionRaw = localStorage.getItem('natal2026_session');
            if (sessionRaw) {
                try {
                    const sess = JSON.parse(sessionRaw);
                    if (sess && (sess.role === 'admin' || sess.role === 'viewer')) {
                        setRole(sess.role);
                        document.getElementById('loginOverlay').classList.add('hidden');
                        return;
                    }
                } catch (e) {}
            }
            // Enter para logar
            document.getElementById('loginPass').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') doLogin();
            });
        }

        function doLogin() {
            const user = (document.getElementById('loginUser').value || '').trim().toLowerCase();
            const pass = (document.getElementById('loginPass').value || '').trim();
            const err = document.getElementById('loginError');

            const rec = AUTH_USERS[user];
            if (!rec || rec.password !== pass) {
                err.innerText = 'Usu√°rio ou senha incorretos.';
                err.classList.remove('hidden');
                return;
            }

            setRole(rec.role);
            localStorage.setItem('natal2026_session', JSON.stringify({ role: rec.role, user }));
            document.getElementById('loginOverlay').classList.add('hidden');
            
            // Recalcula para atualizar UI (colunas de edi√ß√£o)
            calculateTotalsAndRender();
        }

        function logout() {
            localStorage.removeItem('natal2026_session');
            setRole(null);
            isAdmin = false;
            document.getElementById('loginOverlay').classList.remove('hidden');
            document.getElementById('loginUser').value = '';
            document.getElementById('loginPass').value = '';
        }

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            initAuth();
            await loadFromLocal();
            initDatePickers();
            renderMonthlyGoalsInputs();
            updateTotalAnnualGoalUI();
            
            // Config Multa UI
            document.getElementById('fineThreshold').value = fineConfig.threshold;
            document.getElementById('fineValue').value = fineConfig.value;

            // Check auto multa
            setTimeout(checkAndApplyFinesAutomatic, 1000); 
        });

        // --- CLOUD STATUS UI ---
        function updateCloudStatus(status) {
            const dot = document.getElementById('cloudDot');
            const text = document.getElementById('cloudText');
            const container = document.getElementById('cloudStatus');
            
            if(!dot || !text || !container) return;

            container.classList.remove('opacity-0');
            dot.className = 'status-dot';
            
            if (status === 'saving') {
                dot.classList.add('status-saving');
                text.innerText = 'Salvando na nuvem...';
                text.className = 'text-amber-400';
            } else if (status === 'saved') {
                dot.classList.add('status-saved');
                text.innerText = 'Salvo na Nuvem';
                text.className = 'text-emerald-400';
            } else if (status === 'local') {
                dot.classList.add('status-saved');
                dot.style.backgroundColor = '#60a5fa'; // Blue
                text.innerText = 'Salvo Localmente (Nuvem offline)';
                text.className = 'text-blue-400';
            } else if (status === 'error') {
                dot.classList.add('status-error');
                text.innerText = 'Erro ao salvar na nuvem';
                text.className = 'text-rose-400';
            }
        }

        // --- DATA LAYER (HYBRID: LOCAL + CLOUD) ---
        async function loadFromLocal() {
            let loaded = false;

            // 1. Tentar carregar do Supabase
            if (sb) {
                try {
                    updateCloudStatus('saving');
                    const { data, error } = await sb
                        .from(SUPABASE_TABLE)
                        .select("key,value")
                        .in("key", [SUPABASE_KEYS.participants, SUPABASE_KEYS.goals, SUPABASE_KEYS.fine]);

                    if (error) throw error;

                    const map = {};
                    (data || []).forEach(row => { map[row.key] = row.value; });

                    if (map[SUPABASE_KEYS.goals]) monthlyGoals = map[SUPABASE_KEYS.goals];
                    if (map[SUPABASE_KEYS.fine]) fineConfig = { ...DEFAULT_FINE_CONFIG, ...map[SUPABASE_KEYS.fine] };
                    
                    if (map[SUPABASE_KEYS.participants] && Array.isArray(map[SUPABASE_KEYS.participants])) {
                        participantsData = map[SUPABASE_KEYS.participants];
                        loaded = true;
                        updateCloudStatus('saved');
                        console.log("Dados carregados do Supabase.");
                    }
                } catch (e) {
                    console.warn("Supabase load failed. Checking local backup...", e);
                    updateCloudStatus('error');
                }
            }

            // 2. Se falhou ou veio vazio do Supabase, tentar LocalStorage (Browser)
            if (!loaded) {
                const localBackup = localStorage.getItem('natal2026_backup');
                if (localBackup) {
                    try {
                        const parsed = JSON.parse(localBackup);
                        if (parsed.participantsData) {
                            participantsData = parsed.participantsData;
                            if (parsed.monthlyGoals) monthlyGoals = parsed.monthlyGoals;
                            if (parsed.fineConfig) fineConfig = parsed.fineConfig;
                            loaded = true;
                            updateCloudStatus('local');
                            console.log("Dados carregados do LocalStorage (Backup Local).");
                        }
                    } catch (e) {
                        console.error("Erro ao ler backup local", e);
                    }
                }
            }

            // 3. Se nada funcionou, carregar Demo
            if (!loaded) {
                console.warn("Nenhum dado encontrado. Carregando demo.");
                loadDemoData(); 
            } else {
                calculateTotalsAndRender();
            }
        }

        function loadDemoData() {
            // Dados de exemplo se o banco estiver vazio
            if(participantsData.length === 0) {
                participantsData = [
                    { id: 1, name: 'Exemplo: Jo√£o', months: [0,0,30,30,0,0,0,0,0,0,0,0], extra: 0, fine: 0, birthdayMonth: 11, photo: '' },
                    { id: 2, name: 'Exemplo: Maria', months: [0,0,30,30,30,30,30,30,30,30,55,55], extra: 50, fine: 0, birthdayMonth: 5, photo: '' }
                ];
            }
            calculateTotalsAndRender();
        }

        async function saveToLocal() {
            // 1. Salvar IMEDIATAMENTE no LocalStorage (Backup Garantido)
            try {
                localStorage.setItem('natal2026_backup', JSON.stringify({
                    participantsData,
                    monthlyGoals,
                    fineConfig,
                    lastSaved: new Date().toISOString()
                }));
            } catch (e) {
                console.error("Falha ao salvar localmente:", e);
            }

            // 2. Tentar salvar no Supabase
            if (!sb) {
                updateCloudStatus('local');
                return;
            }

            updateCloudStatus('saving');
            
            const rows = [
                { key: SUPABASE_KEYS.participants, value: participantsData, updated_at: new Date().toISOString() },
                { key: SUPABASE_KEYS.goals, value: monthlyGoals, updated_at: new Date().toISOString() },
                { key: SUPABASE_KEYS.fine, value: fineConfig, updated_at: new Date().toISOString() }
            ];

            try {
                const { error } = await sb.from(SUPABASE_TABLE).upsert(rows, { onConflict: "key" });
                if (error) throw error;
                updateCloudStatus('saved');
            } catch (e) {
                console.error("Erro ao salvar no Supabase:", e);
                updateCloudStatus('error');
            }
        }

        async function resetData() {
            if(!requireAdmin()) return;
            if(confirm("ATEN√á√ÉO: Isso apagar√° TODOS os dados do sistema. Continuar?")) {
                participantsData = [];
                monthlyGoals = [...DEFAULT_MONTHLY_GOALS];
                fineConfig = { ...DEFAULT_FINE_CONFIG };
                
                // Limpa backup local tamb√©m
                localStorage.removeItem('natal2026_backup');
                
                await saveToLocal();
                location.reload();
            }
        }

        // --- CORE LOGIC ---
        function calculateTotalsAndRender() {
            const baseTotalGoal = monthlyGoals.reduce((a,b) => a+b, 0);

            participantsData.forEach(p => {
                if (p.fine === undefined) p.fine = 0;
                
                let personalGoal = baseTotalGoal;
                let paidSum = 0;

                // Desconto Anivers√°rio (meta do m√™s vira 0)
                if (p.birthdayMonth !== null && p.birthdayMonth >= 0 && p.birthdayMonth < 12) {
                    const discount = monthlyGoals[p.birthdayMonth];
                    personalGoal -= discount;
                }

                p.months.forEach(val => paidSum += val);
                
                // Total Pago = Soma Meses + Extra
                p.totalPaid = paidSum + (p.extra || 0);
                
                // Meta Total = Meta Pessoal (com desconto) + Multa
                p.totalGoal = personalGoal + (p.fine || 0);

                let missingCalc = p.totalGoal - p.totalPaid;
                p.missing = missingCalc < 0 ? 0 : missingCalc;
            });

            updateDashboardUI();
            if(isAdmin) saveToLocal(); // Auto-save on calc usually happens after edit, but safe here
        }

        function updateDashboardUI() {
            const totalArrecadado = participantsData.reduce((acc, p) => acc + p.totalPaid, 0);
            const totalFalta = participantsData.reduce((acc, p) => acc + p.missing, 0);
            const totalEsperado = totalArrecadado + totalFalta;
            
            const progress = totalEsperado > 0 ? (totalArrecadado / totalEsperado) * 100 : 0;
            const peopleOk = participantsData.filter(p => p.missing <= 0).length;

            // HTML Updates
            document.getElementById('dashboardSummary').innerHTML = `
                <div class="card border-l-4 border-l-emerald-500 hover:bg-slate-800/80 transition shadow-lg">
                    <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Caixa Atual</p>
                    <h2 class="text-3xl font-bold text-white mt-1">R$ ${totalArrecadado.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</h2>
                </div>
                <div class="card border-l-4 border-l-rose-500 hover:bg-slate-800/80 transition shadow-lg">
                    <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Falta Receber</p>
                    <h2 class="text-3xl font-bold text-white mt-1">R$ ${totalFalta.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</h2>
                </div>
                <div class="card border-l-4 border-l-indigo-500 hover:bg-slate-800/80 transition shadow-lg">
                    <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Participantes</p>
                    <div class="flex items-end gap-2 mt-1">
                        <h2 class="text-3xl font-bold text-white">${participantsData.length}</h2>
                        <span class="text-xs text-indigo-300 font-bold mb-1.5 px-2 py-0.5 rounded bg-indigo-900/50 border border-indigo-500/30">${peopleOk} Quitados</span>
                    </div>
                </div>
                <div class="card border-l-4 border-l-amber-500 hover:bg-slate-800/80 transition shadow-lg">
                    <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">Extra / Cr√©ditos</p>
                    <h2 class="text-3xl font-bold text-white mt-1">R$ ${participantsData.reduce((acc, p) => acc + (p.extra || 0), 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</h2>
                </div>
            `;

            // Charts & Visuals
            const pct = Math.max(0, Math.min(Number(progress) || 0, 100));
            
            // Santa Bar
            document.getElementById('mainProgressBar').style.width = `${pct}%`;
            document.getElementById('mainProgressText').innerText = `${pct.toFixed(0)}%`;
            document.getElementById('metaLabel').innerText = `Meta: R$ ${totalEsperado.toLocaleString('pt-BR')}`;

            // Tree Visual
            const treePctEl = document.getElementById('treePercent');
            if (treePctEl) treePctEl.textContent = `${pct.toFixed(0)}%`;
            
            const treeCover = document.getElementById('treeCover');
            if(treeCover) treeCover.style.transform = `scaleY(${(100 - pct) / 100})`;
            
            const star = document.getElementById('treeStar');
            if(star) {
                if(pct >= 100) star.classList.add('on');
                else star.classList.remove('on');
            }

            // Text Counts
            document.getElementById('countOk').innerText = peopleOk;
            document.getElementById('countPending').innerText = participantsData.length - peopleOk;
            
            // Small stats
            document.getElementById('summaryTotalExpected').innerText = `R$ ${totalEsperado.toLocaleString('pt-BR')}`;
            document.getElementById('summaryTotalPaid').innerText = `R$ ${totalArrecadado.toLocaleString('pt-BR')}`;
            document.getElementById('summaryTotalMissing').innerText = `R$ ${totalFalta.toLocaleString('pt-BR')}`;

            // Sort alphabetical
            participantsData.sort((a,b) => (a.name||'').localeCompare((b.name||''), 'pt-BR', {sensitivity:'base'}));

            renderTable(participantsData);
            if(isAdmin) renderAdminUserList();
        }

        function renderTable(data) {
            const tbody = document.getElementById('participantsTableBody');
            tbody.innerHTML = '';

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="18" class="p-8 text-center text-slate-500 italic">Nenhum participante encontrado.</td></tr>`;
                return;
            }

            data.forEach((p, index) => {
                const realIndex = participantsData.findIndex(pp => pp.id === p.id);
                // Admin Click
                const clickAttr = isAdmin ? `onclick="openEditModal(${realIndex})"` : '';
                const cursorClass = isAdmin ? 'cursor-pointer hover:text-indigo-300' : '';
                
                // Edit button logic
                const editTdClass = isAdmin ? 'edit-col' : 'edit-col hidden';
                
                let monthsHTML = '';
                p.months.forEach((val, idx) => {
                    const goal = monthlyGoals[idx];
                    let badgeClass = 'bg-none'; 
                    let content = '';

                    if (p.birthdayMonth == idx) {
                        badgeClass = 'bg-birthday';
                        content = '<i class="ph ph-cake text-base"></i>';
                        if (val > 0) content += `<span class="ml-1 text-[10px]">${val}</span>`;
                    } else {
                        if (goal > 0) {
                            if (val >= goal) badgeClass = 'bg-paid';
                            else if (val > 0) badgeClass = 'bg-partial';
                            else badgeClass = 'bg-missed';
                        } else {
                            if (val > 0) badgeClass = 'bg-paid'; // Pagou algo num m√™s sem meta
                        }
                        content = val > 0 ? (Number.isInteger(val) ? val : val.toFixed(0)) : '-';
                    }
                    monthsHTML += `<td class="p-2 text-center align-middle month-col"><div class="status-badge ${badgeClass}">${content}</div></td>`;
                });

                // Avatar
                let avatarHTML = '';
                if (p.photo && p.photo.trim() !== "") {
                    avatarHTML = `<div class="w-8 h-8 rounded-full overflow-hidden border-2 border-slate-600 flex-shrink-0 bg-slate-800"><img src="${p.photo}" class="profile-pic" onerror="this.src=''"></div>`;
                } else {
                    avatarHTML = `<div class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center text-[10px] text-slate-300 border border-slate-600 font-bold flex-shrink-0">${p.name.charAt(0)}</div>`;
                }

                // Values
                const fineDisplay = p.fine > 0 ? `<span class="text-rose-400 font-bold">R$${p.fine}</span>` : '-';
                const extraDisplay = p.extra > 0 ? `<span class="text-indigo-400 font-bold">+R$${p.extra}</span>` : '-';

                const row = document.createElement('tr');
                row.className = 'transition border-b border-slate-700 last:border-0 group';
                
                row.innerHTML = `
                    <td class="p-3 sticky-col z-20 font-medium text-white whitespace-nowrap ${cursorClass} flex items-center gap-3" ${clickAttr}>
                        ${avatarHTML}
                        <span>${p.name}</span>
                    </td>
                    ${monthsHTML}
                    <td class="p-2 text-center align-middle bg-rose-900/10 border-l border-rose-900/20 text-xs col-multa">${fineDisplay}</td>
                    <td class="p-2 text-center align-middle bg-indigo-900/10 border-l border-indigo-900/20 text-xs extra-col">${extraDisplay}</td>
                    <td class="p-2 text-right align-middle bg-slate-800/50 font-mono font-medium text-emerald-400 text-xs col-total">R$ ${(p.totalPaid).toFixed(0)}</td>
                    <td class="p-2 text-right align-middle bg-slate-800/50 border-r border-slate-700 font-mono font-medium ${p.missing > 0 ? 'text-rose-400' : 'text-slate-600'} text-xs col-falta">R$ ${p.missing.toFixed(0)}</td>
                    <td class="p-2 text-center align-middle sticky right-0 bg-slate-800 z-10 border-l border-slate-700 ${editTdClass} shadow-[-5px_0_10px_rgba(0,0,0,0.2)]">
                        <button onclick="openEditModal(${realIndex})" class="text-indigo-400 hover:text-white p-1.5 rounded hover:bg-indigo-600 transition"><i class="ph ph-pencil-simple text-lg"></i></button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // --- UI UTILS ---
        function switchTab(tabName) {
            if(tabName === 'admin' && !isAdmin) { alert('Acesso restrito.'); return; }
            
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-admin').classList.add('hidden');
            document.getElementById('btn-dashboard').classList.remove('active');
            document.getElementById('btn-admin').classList.remove('active');

            document.getElementById(`view-${tabName}`).classList.remove('hidden');
            document.getElementById(`btn-${tabName}`).classList.add('active');
        }

        function initDatePickers() {
            flatpickr("#fineDeadline", {
                dateFormat: "d/m/Y",
                locale: "pt",
                defaultDate: fineConfig.deadline,
                theme: "dark",
                onChange: function(dates, str) {
                    fineConfig.deadline = str;
                    saveToLocal();
                }
            });
        }

        // --- ADMIN FUNCTIONS ---
        function renderMonthlyGoalsInputs() {
            const container = document.getElementById('monthlyGoalsContainer');
            container.innerHTML = '';
            monthlyGoals.forEach((val, idx) => {
                const div = document.createElement('div');
                div.className = "bg-slate-900 p-2 rounded border border-slate-700 flex flex-col hover:border-indigo-500/50 transition";
                div.innerHTML = `
                    <label class="text-[10px] uppercase text-slate-500 font-bold mb-1">${MONTH_ABBR[idx]}</label>
                    <div class="flex items-center"><span class="text-xs text-slate-500 mr-1">R$</span><input type="number" id="goal-${idx}" value="${val}" onchange="updateTotalAnnualGoalUI()" class="bg-transparent text-white text-sm w-full font-mono focus:outline-none"></div>
                `;
                container.appendChild(div);
            });
        }

        function updateTotalAnnualGoalUI() {
            const inputs = document.querySelectorAll('[id^="goal-"]');
            let total = 0;
            inputs.forEach(input => total += parseFloat(input.value) || 0);
            document.getElementById('totalAnnualGoal').innerText = `R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        }

        function saveMonthlyGoals() {
            if(!requireAdmin()) return;
            const inputs = document.querySelectorAll('[id^="goal-"]');
            inputs.forEach((input, idx) => monthlyGoals[idx] = parseFloat(input.value) || 0);
            calculateTotalsAndRender();
            alert("Metas atualizadas com sucesso!");
        }

        function renderAdminUserList() {
            const tbody = document.getElementById('adminUsersTableBody');
            tbody.innerHTML = '';
            participantsData.forEach((p, index) => {
                const row = document.createElement('tr');
                row.className = "hover:bg-slate-800 transition border-b border-slate-700 last:border-0";
                row.innerHTML = `
                    <td class="p-2 text-white font-medium">${p.name}</td>
                    <td class="p-2 text-right font-mono text-emerald-400 text-xs">R$ ${p.totalPaid}</td>
                    <td class="p-2 text-center"><button onclick="removeParticipant(${index})" class="text-rose-400 hover:text-white hover:bg-rose-600 p-1 rounded transition"><i class="ph ph-trash"></i></button></td>
                `;
                tbody.appendChild(row);
            });
        }

        async function addParticipant() {
            if(!requireAdmin()) return;

            const name = document.getElementById('newUserName').value.trim();
            if (!name) return;
            
            const bMonthVal = document.getElementById('newUserBirthday').value;
            const bMonth = bMonthVal === "" ? null : parseInt(bMonthVal);

            participantsData.push({ 
                id: Date.now(), 
                name: name, 
                months: Array(12).fill(0), 
                extra: 0,
                fine: 0, 
                totalPaid: 0, 
                missing: 0,
                photo: tempAddPhotoBase64 || '', // Usa o base64 carregado
                birthdayMonth: bMonth
            });
            
            // Limpa campos e vars tempor√°rias
            document.getElementById('newUserName').value = '';
            document.getElementById('newUserBirthday').value = '';
            document.getElementById('newUserPhotoFile').value = ''; 
            document.getElementById('newUserPhotoName').classList.add('hidden');
            tempAddPhotoBase64 = '';

            calculateTotalsAndRender();
        }

        function removeParticipant(idx) {
            if(!requireAdmin()) return;
            if(confirm("Remover participante?")) { participantsData.splice(idx, 1); calculateTotalsAndRender(); }
        }

        // Logic for checking fines
        function checkAndApplyFinesAutomatic() {
            const deadlineStr = fineConfig.deadline;
            if (!deadlineStr) return;

            const parts = deadlineStr.split('/');
            const deadlineDate = new Date(parts[2], parts[1] - 1, parts[0]);
            deadlineDate.setHours(23, 59, 59, 999);
            const today = new Date();

            if (today > deadlineDate) {
                let appliedCount = 0;
                participantsData.forEach(p => { 
                    const monthlyPaid = p.months.reduce((a,b)=>a+b,0);
                    if (monthlyPaid < fineConfig.threshold && (p.fine || 0) === 0) { 
                        p.fine = fineConfig.value; 
                        appliedCount++; 
                    } 
                });
                if (appliedCount > 0) calculateTotalsAndRender();
            }
        }

        function manualFineCheck() {
            if(!requireAdmin()) return;
            applyFineRules();
        }

        function applyFineRules() {
            saveFineConfig();
            
            const deadlineStr = fineConfig.deadline;
            const threshold = fineConfig.threshold;
            const fineVal = fineConfig.value;

            if(!threshold || !fineVal || !deadlineStr) { 
                alert("Preencha todos os campos da multa!"); return; 
            }

            const parts = deadlineStr.split('/');
            const deadlineDate = new Date(parts[2], parts[1] - 1, parts[0]);
            const today = new Date();
            deadlineDate.setHours(23, 59, 59, 999);
            today.setHours(0, 0, 0, 0);

            if (today <= deadlineDate) {
                const diasRestantes = Math.ceil((deadlineDate - today) / (1000 * 60 * 60 * 24));
                const confirmApply = confirm(`ATEN√á√ÉO: A data limite (${deadlineStr}) ainda n√£o chegou! Faltam ${diasRestantes} dias.\n\nDeseja aplicar a multa ANTECIPADAMENTE em quem n√£o pagou?`);
                if (!confirmApply) return;
            }
            
            let count = 0;
            participantsData.forEach(p => { 
                const monthlyPaid = p.months.reduce((a,b)=>a+b,0);
                if (monthlyPaid < threshold && (p.fine || 0) === 0) { 
                    p.fine = fineVal; 
                    count++; 
                } 
            });
            
            calculateTotalsAndRender();
            document.getElementById('fineFeedback').innerText = `Auditoria conclu√≠da. ${count} multas aplicadas.`;
            setTimeout(() => document.getElementById('fineFeedback').innerText = "", 4000);
        }

        function saveFineConfig() {
            fineConfig.deadline = document.getElementById('fineDeadline').value;
            fineConfig.threshold = parseFloat(document.getElementById('fineThreshold').value);
            fineConfig.value = parseFloat(document.getElementById('fineValue').value);
            saveToLocal();
        }

        // CSV Logic
        const fileInput = document.getElementById('csvInput');
        fileInput.addEventListener('change', (e) => {
            if(!isAdmin) { alert('Acesso restrito.'); e.target.value=''; return; }
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => parseCSV(evt.target.result);
            reader.readAsText(file);
        });

        // Backup JSON Logic
        const backupInput = document.getElementById('jsonBackupInput');
        backupInput.addEventListener('change', (e) => {
            if (!requireAdmin()) { e.target.value = ''; return; }
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => {
                importBackupJSON(String(evt.target.result || ''));
            };
            reader.readAsText(file);
            e.target.value = '';
        });

        function exportBackupJSON() {
            if (!requireAdmin()) return;
            const backup = {
                version: 1,
                exportedAt: new Date().toISOString(),
                monthlyGoals,
                fineConfig,
                participantsData
            };
            const json = JSON.stringify(backup, null, 2);
            const blob = new Blob([json], { type: 'application/json;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'natal_familia_2026_backup.json';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        function importBackupJSON(text) {
            try {
                const data = JSON.parse(text);
                if (!data || !Array.isArray(data.participantsData)) throw new Error("Formato inv√°lido");
                
                if (confirm('Isso substituir√° os dados atuais. Continuar?')) {
                    monthlyGoals = data.monthlyGoals || DEFAULT_MONTHLY_GOALS;
                    fineConfig = data.fineConfig || DEFAULT_FINE_CONFIG;
                    participantsData = data.participantsData;
                    syncConfigInputs();
                    calculateTotalsAndRender();
                    alert("Backup restaurado!");
                }
            } catch (e) {
                alert('Erro ao ler backup JSON.');
            }
        }
        
        function syncConfigInputs() {
            renderMonthlyGoalsInputs();
            document.getElementById('fineDeadline').value = fineConfig.deadline || '';
            document.getElementById('fineThreshold').value = fineConfig.threshold || '';
            document.getElementById('fineValue').value = fineConfig.value || '';
        }

        function parseCSV(text) {
            const lines = text.split('\n');
            const newData = [];
            // Basic parser expecting specific columns... simplified for demo
            alert("Fun√ß√£o CSV simplificada: Implementar parser completo se necess√°rio.");
        }

        function exportParticipantsCSV() {
            if (!Array.isArray(participantsData)) return;
            const headers = ['id','nome','jan','fev','mar','abr','mai','jun','jul','ago','set','out','nov','dez','multa','extra','total','falta'];
            const rows = participantsData.map(p => {
                const months = p.months || Array(12).fill(0);
                return [p.id, p.name, ...months, p.fine, p.extra, p.totalPaid, p.missing].join(',');
            });
            const csv = [headers.join(','), ...rows].join('\n');
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'natal_familia_2026.csv';
            document.body.appendChild(a);
            a.click();
            a.remove();
        }

        // Image Utils
        function readFileAsBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function previewAddUserImage(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                tempAddPhotoBase64 = await readFileAsBase64(file);
                const label = document.getElementById('newUserPhotoName');
                label.classList.remove('hidden');
                input.parentElement.classList.remove('bg-slate-700');
                input.parentElement.classList.add('bg-emerald-600');
            }
        }

        async function previewEditUserImage(input) {
            if (input.files && input.files[0]) {
                tempEditPhotoBase64 = await readFileAsBase64(input.files[0]);
                const imgEl = document.getElementById('modalAvatarImg');
                const txtEl = document.getElementById('modalAvatarText');
                imgEl.src = tempEditPhotoBase64;
                imgEl.classList.remove('hidden');
                txtEl.classList.add('hidden');
            }
        }
        
        // --- EDIT MODAL ---
        function openEditModal(index) {
            if(!requireAdmin()) return;

            const p = participantsData[index];
            if(!p) return;
            
            tempEditPhotoBase64 = ''; 

            document.getElementById('modalParticipantName').innerText = p.name;
            
            const imgEl = document.getElementById('modalAvatarImg');
            const txtEl = document.getElementById('modalAvatarText');
            if (p.photo && p.photo.trim() !== "") {
                imgEl.src = p.photo;
                imgEl.classList.remove('hidden');
                txtEl.classList.add('hidden');
            } else {
                imgEl.classList.add('hidden');
                txtEl.classList.remove('hidden');
                txtEl.innerText = p.name.charAt(0);
            }

            document.getElementById('editParticipantIndex').value = index;
            document.getElementById('editFineValue').value = p.fine || 0;
            document.getElementById('editExtraValue').value = p.extra || 0;
            document.getElementById('editBirthdayMonth').value = (p.birthdayMonth === undefined || p.birthdayMonth === null) ? -1 : p.birthdayMonth;

            const container = document.getElementById('editMonthsContainer');
            container.innerHTML = '';
            p.months.forEach((val, idx) => {
                const div = document.createElement('div');
                div.className = "bg-slate-900 border border-slate-700 rounded p-2 flex flex-col items-center";
                div.innerHTML = `
                    <label class="text-[10px] uppercase text-slate-500 font-bold mb-1">${MONTH_ABBR[idx]}</label>
                    <input type="number" id="edit-month-${idx}" value="${val}" class="bg-transparent text-white text-center font-mono focus:outline-none border-b border-transparent focus:border-indigo-500 transition-colors w-full">
                `;
                container.appendChild(div);
            });
            document.getElementById('editPaymentModal').classList.remove('hidden');
            document.getElementById('editPaymentModal').classList.add('flex');
        }

        function closeEditModal() {
            document.getElementById('editPaymentModal').classList.add('hidden');
            document.getElementById('editPaymentModal').classList.remove('flex');
        }

        async function saveEditModal() {
            if(!requireAdmin()) return;

            const index = document.getElementById('editParticipantIndex').value;
            const p = participantsData[index];
            if(!p) return;
            
            const oldTotalPaid = p.months.reduce((a,b)=>a+b,0); 

            for(let i=0; i<12; i++) { p.months[i] = parseFloat(document.getElementById(`edit-month-${i}`).value) || 0; }
            
            p.fine = parseFloat(document.getElementById('editFineValue').value) || 0;
            p.extra = parseFloat(document.getElementById('editExtraValue').value) || 0;
            
            const bMonth = parseInt(document.getElementById('editBirthdayMonth').value);
            p.birthdayMonth = bMonth === -1 ? null : bMonth;

            if (tempEditPhotoBase64) {
                p.photo = tempEditPhotoBase64;
            }

            // Late payment check
            const parts = fineConfig.deadline.split('/');
            const deadlineDate = new Date(parts[2], parts[1] - 1, parts[0]);
            deadlineDate.setHours(23, 59, 59, 999);
            const today = new Date();

            if (today > deadlineDate) {
                if (p.fine === 0) {
                    if (oldTotalPaid < fineConfig.threshold) {
                        const apply = confirm(`‚ö†Ô∏è PAGAMENTO EM ATRASO!\nDeseja aplicar a MULTA de R$ ${fineConfig.value} automaticamente?`);
                        if (apply) p.fine = fineConfig.value;
                    }
                }
            }

            calculateTotalsAndRender();
            closeEditModal();
        }
        
        // Search
        document.getElementById('searchInput').addEventListener('keyup', (e) => {
            const term = e.target.value.toLowerCase();
            const filtered = participantsData.filter(p => p.name.toLowerCase().includes(term));
            renderTable(filtered);
        });

    </script>
</body>
</html>