<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desafio fam√≠lia FIT 90 DIAS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* Vari√°veis CSS para cores e tamanhos comuns */
        :root {
            --font-inter: 'Inter', sans-serif;
            --background-light-gray: #f3f4f6;
            --text-dark: #333;
            --container-bg: #ffffff;
            --border-light: #e5e7eb;
            --header-bg-light-blue: #e0f2f7;
            --header-text-dark-blue: #2c5282;
            --checkbox-border-gray: #9ca3af;
            --checkbox-checked-green: #34d399;
            --missed-week-bg-red: #fee2e2;
            --missed-week-border-red: #dc2626;
            --leader-row-bg-orange: #ffedd5;
            --leader-row-border-orange: #f97316;
            --feedback-success-bg: #10b981;
            --feedback-error-bg: #ef4444; /* Nova vari√°vel para fundo de erro */
            --modal-bg-overlay: rgba(0,0,0,0.4);
            --error-red: #ef4444;
            --blue-600: #2563eb; /* Adicionado para consist√™ncia */
            --yellow-600: #ca8a04; /* Adicionado para consist√™ncia */
            --red-600: #dc2626; /* Adicionado para consist√™ncia */
        }

        body {
            font-family: var(--font-inter);
            background-color: var(--background-light-gray);
            color: var(--text-dark);
        }
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: var(--container-bg);
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 2rem;
            border-radius: 0.75rem;
            overflow: hidden;
        }
        th, td {
            padding: 0.5rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-light);
        }
        th {
            background-color: var(--header-bg-light-blue);
            font-weight: 600;
            color: var(--header-text-dark-blue);
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }
        /* Specific styles for weekly participation table to make it more compact */
        #weeklyParticipationTable th,
        #weeklyParticipationTable td {
            padding: 0.2rem 0.3rem;
            white-space: nowrap;
        }
        #weeklyParticipationTable td:first-child {
            min-width: 60px;
            padding-right: 0.1rem;
        }
        #weeklyParticipationTable th:not(:first-child),
        #weeklyParticipationTable td:not(:first-child) {
            text-align: center;
        }
        /* Style for missed week cells - now only for the checkbox itself */
        .missed-week-cell {
            background-color: transparent;
        }

        /* Custom checkbox styling */
        input[type="checkbox"] {
            transform: scale(1.2);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 1.2em;
            height: 1.2em;
            border: 2px solid var(--checkbox-border-gray);
            border-radius: 0.25em;
            cursor: pointer;
            vertical-align: middle;
            display: inline-block;
            position: relative;
            transition: background-color 0.2s, border-color 0.2s;
        }

        /* Checked state (green) */
        input[type="checkbox"]:checked {
            background-color: var(--checkbox-checked-green);
            border-color: var(--checkbox-checked-green);
        }

        /* Checkmark for checked state */
        input[type="checkbox"]:checked::after {
            content: '‚úî';
            font-size: 0.8em;
            color: white;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            line-height: 1;
        }

        /* Missed week, unchecked state (red checkbox) */
        .missed-week-cell input[type="checkbox"]:not(:checked) {
            background-color: var(--missed-week-bg-red);
            border-color: var(--missed-week-border-red);
        }
        /* No checkmark for unchecked missed boxes */
        .missed-week-cell input[type="checkbox"]:not(:checked)::after {
            content: '';
        }

        /* If a missed-week-cell checkbox is *then* checked, it becomes green */
        .missed-week-cell input[type="checkbox"]:checked {
            background-color: var(--checkbox-checked-green);
            border-color: var(--checkbox-checked-green);
        }

        tr:last-child td {
            border-bottom: none;
        }
        tr:nth-child(even) {
            background-color: #f9fafb;
        }

        /* Agrupamento de estilos para leader-box e days-remaining-box */
        .leader-box, .days-remaining-box {
            background-color: var(--container-bg);
            border: 1px solid var(--border-light);
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin-bottom: 1.5rem;
            font-weight: 600;
            color: var(--text-dark);
            text-align: center;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .days-remaining-box .date-info {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: #4a5568;
        }
        .days-remaining-box .countdown-message {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--header-text-dark-blue);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            white-space: nowrap;
        }
        .days-remaining-box .countdown-message .days-value {
            font-size: 2rem;
            color: #3182ce;
        }
        .days-remaining-box .duration-info {
            font-size: 0.9rem;
            color: #6b7280;
            margin-top: 0.75rem;
        }

        .checkbox-cell {
            text-align: center;
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 180px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -90px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #555 transparent transparent transparent;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .leader-row {
            background-color: var(--leader-row-bg-orange) !important;
            border-left: 4px solid var(--leader-row-border-orange);
        }
        .feedback-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--feedback-success-bg); /* Usando vari√°vel */
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            z-index: 1000;
        }
        .feedback-message.show {
            opacity: 1;
        }
        .feedback-message.error { /* Nova classe para mensagens de erro */
            background-color: var(--feedback-error-bg);
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: var(--modal-bg-overlay);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 500px;
            position: relative;
            transform: translateY(-50px);
            transition: transform 0.3s ease-in-out;
        }
        .modal.show .modal-content {
            transform: translateY(0);
        }
        .close-button {
            position: absolute;
            top: 10px;
            right: 20px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .input-error {
            border-color: var(--error-red);
        }
        .error-message {
            color: var(--error-red);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        /* Style for empty table message */
        .empty-table-message {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
            font-style: italic;
        }
        /* CSS for activity bar SVG fill animation */
        #activityChart svg g rect,
        #activityChart svg g circle {
            transition: fill 0.5s ease-out; /* Smooth transition for fill color */
        }
        /* Estilo para a semana atual */
        .current-week {
            background-color: #dbeafe !important; /* Light blue for current week header */
            border-bottom: 2px solid #60a5fa !important; /* Blue border for current week */
            color: #1e40af !important;
        }
        .current-week-cell {
            background-color: #eff6ff; /* Very light blue for current week cells */
        }
    </style>
</head>
<body class="p-4">
    <div class="container">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">üí™üçé Desafio Fam√≠lia FIT 90 DIAS! üèÜ</h1>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
            <div id="leaderBox" class="leader-box">
                L√≠der Atual: Carregando...
            </div>
            <div id="daysRemainingBox" class="days-remaining-box">
                Dias Restantes: Carregando...
            </div>
        </div>

        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 gap-4">
            <button id="addParticipantBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 w-full sm:w-auto">
                Adicionar Participante
            </button>
            <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                <button id="exportDataBtn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 w-full sm:w-auto">
                    Exportar Dados
                </button>
                <input type="file" id="importDataInput" accept=".json" class="hidden">
                <button id="importDataBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 w-full sm:w-auto">
                    Importar Dados
                </button>
                <button id="resetDataBtn" class="bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105 w-full sm:w-auto">
                    Resetar Dados
                </button>
            </div>
            <div class="relative w-full sm:w-1/2">
                <input type="text" id="searchParticipantInput" placeholder="Buscar participante..." class="p-2 border border-gray-300 rounded-md w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                <svg class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
            </div>
        </div>

        <h2 class="text-2xl font-semibold mb-4 text-gray-700">üèÜ Ranking e Pontua√ß√£o</h2>
        <div class="overflow-x-auto rounded-xl shadow-md">
            <table id="rankingTable">
                <thead>
                    <tr>
                        <th class="rounded-tl-xl">Ranking</th>
                        <th>Nome</th>
                        <th>
                            Peso Inicial
                            <span class="tooltip">
                                <span class="tooltiptext">O peso do participante no in√≠cio do desafio (kg). Clique no nome para editar.</span>
                            </span>
                        </th>
                        <th>
                            Peso Final
                            <span class="tooltip">
                                <span class="tooltiptext">O peso atual ou final do participante (kg). Clique no nome para editar.</span>
                            </span>
                        </th>
                        <th>
                            % Perda
                            <span class="tooltip">
                                <span class="tooltiptext">Porcentagem de peso perdido em rela√ß√£o ao peso inicial.</span>
                            </span>
                        </th>
                        <th>
                            Pts Peso
                            <span class="tooltip">
                                <span class="tooltiptext">Pontos de peso baseados na % de perda. M√°ximo de 50 pontos.</span>
                            </span>
                        </th>
                        <th>
                            Sem. V√°lidas
                            <span class="tooltip">
                                <span class="tooltiptext">N√∫mero de semanas com 3 ou mais treinos registrados.</span>
                            </span>
                        </th>
                        <th>
                            Pts Ativ.
                            <span class="tooltip">
                                <span class="tooltiptext">Pontos de atividade baseados nas semanas v√°lidas. M√°ximo de 50 pontos.</span>
                            </span>
                        </th>
                        <th>
                            Total
                            <span class="tooltip">
                                <span class="tooltiptext">Soma dos pontos de peso e atividade.</span>
                            </span>
                        </th>
                        <th class="rounded-tr-xl"></th> <!-- Coluna para o bot√£o de edi√ß√£o/exclus√£o -->
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be populated by JavaScript -->
                </tbody>
            </table>
            <div id="noRankingData" class="empty-table-message hidden">Nenhum participante encontrado no ranking.</div>
        </div>

        <h2 class="text-2xl font-semibold mt-8 mb-4 text-gray-700">üóìÔ∏è Registro Semanal de Participa√ß√£o</h2>
        <div class="overflow-x-auto rounded-xl shadow-md">
            <table id="weeklyParticipationTable">
                <thead>
                    <tr>
                        <th class="rounded-tl-xl">
                            Nome
                            <span class="tooltip">
                                <span class="tooltiptext">Semanas de 1 a 12. Marque a caixa se a semana for v√°lida (3+ treinos).</span>
                            </span>
                        </th>
                        <!-- Semanas ser√£o geradas dinamicamente pelo JavaScript para aplicar a classe 'current-week' -->
                    </tr>
                </thead>
                <tbody>
                    <!-- Data will be populated by JavaScript -->
                </tbody>
            </table>
            <div id="noWeeklyData" class="empty-table-message hidden">Nenhum participante para o registro semanal.</div>
        </div>

        <div class="flex justify-center mt-6">
            <button id="saveDataBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 ease-in-out transform hover:scale-105">
                Salvar Dados
            </button>
        </div>

        <h2 class="text-2xl font-semibold mt-8 mb-4 text-gray-700">üìà Participa√ß√£o nas Atividades (%)</h2>
        <!-- Adjusted grid gap for closer spacing -->
        <div id="activityChart" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-4 gap-x-4 gap-y-6 min-h-[100px] justify-items-center">
            <!-- Chart icons will be populated by JavaScript -->
            <div id="noChartData" class="empty-table-message hidden col-span-full">Nenhum participante para o gr√°fico de atividades.</div>
        </div>
    </div>

    <div id="feedbackMessage" class="feedback-message">
        Dados salvos com sucesso!
    </div>

    <!-- Modal para Adicionar/Editar Participante -->
    <div id="participantModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeModalBtn">&times;</span>
            <h3 class="text-2xl font-bold mb-4" id="modalTitle">Adicionar Novo Participante</h3>
            <form id="participantForm">
                <input type="hidden" id="participantIndex">
                <div class="mb-4">
                    <label for="participantName" class="block text-gray-700 text-sm font-bold mb-2">Nome:</label>
                    <input type="text" id="participantName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    <p class="error-message hidden" id="nameError">O nome √© obrigamento.</p>
                </div>
                <div class="mb-4">
                    <label for="participantInitialWeight" class="block text-gray-700 text-sm font-bold mb-2">Peso Inicial (kg):</label>
                    <input type="number" step="any" id="participantInitialWeight" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    <p class="error-message hidden" id="initialWeightError">Peso inicial deve ser um n√∫mero positivo.</p>
                </div>
                <div class="mb-6">
                    <label for="participantFinalWeight" class="block text-gray-700 text-sm font-bold mb-2">Peso Final (kg):</label>
                    <input type="number" step="any" id="participantFinalWeight" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    <p class="error-message hidden" id="finalWeightError">Peso final deve ser um n√∫mero positivo.</p>
                </div>
                <div class="flex items-center justify-between">
                    <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        Salvar
                    </button>
                    <button type="button" id="cancelModalBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                        Cancelar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Confirma√ß√£o de Exclus√£o -->
    <div id="deleteConfirmModal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="closeDeleteModalBtn">&times;</span>
            <h3 class="text-2xl font-bold mb-4">Confirmar Exclus√£o</h3>
            <p class="mb-6">Tem certeza que deseja excluir <span id="participantNameToDelete" class="font-semibold text-red-600"></span> do desafio?</p>
            <div class="flex justify-end gap-4">
                <button id="confirmDeleteBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Excluir
                </button>
                <button id="cancelDeleteBtn" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <script>
        // Constantes para chaves do localStorage e classes CSS
        const LOCAL_STORAGE_KEY = 'challengeParticipants';
        const HIDDEN_CLASS = 'hidden';
        const INPUT_ERROR_CLASS = 'input-error';
        const SHOW_CLASS = 'show';
        const MILLISECONDS_PER_WEEK = 1000 * 60 * 60 * 24 * 7;

        // Dados iniciais dos participantes (baseado na imagem e nas regras)
        // A propriedade 'semanasValidas' √© um array de booleanos para cada uma das 12 semanas.
        // true = semana v√°lida (3+ treinos), false = semana n√£o v√°lida.
        const defaultParticipants = [
            { name: "Amanda", pesoInicial: 69.1, pesoFinal: 69.1, semanasValidas: Array(12).fill(false) },
            { name: "Hevinho", pesoInicial: 85.3, pesoFinal: 85.3, semanasValidas: [true, false, false, false, false, false, false, false, false, false, false, false] },
            { name: "Junior", pesoInicial: 113.9, pesoFinal: 113.9, semanasValidas: Array(12).fill(false) },
            { name: "Midian Diniz", pesoInicial: 89.85, pesoFinal: 89.85, semanasValidas: Array(12).fill(false) },
            { name: "Midian Fernandes", pesoInicial: 65.15, pesoFinal: 65.15, semanasValidas: [true, false, false, false, false, false, false, false, false, false, false, false] },
            { name: "Paulinha", pesoInicial: 75.9, pesoFinal: 75.9, semanasValidas: Array(12).fill(false) },
            { name: "Rayanne", pesoInicial: 86.4, pesoFinal: 86.4, semanasValidas: Array(12).fill(false) },
            { name: "Wellington", pesoInicial: 117.7, pesoFinal: 117.7, semanasValidas: Array(12).fill(false) },
        ];

        // Tenta carregar os dados do localStorage, se n√£o houver, usa os dados padr√£o
        let participants = [];
        try {
            const storedParticipants = localStorage.getItem(LOCAL_STORAGE_KEY);
            participants = storedParticipants ? JSON.parse(storedParticipants) : defaultParticipants;
        } catch (e) {
            console.error("Erro ao carregar dados do localStorage:", e);
            participants = defaultParticipants; // Fallback para dados padr√£o em caso de erro
        }

        // Data de in√≠cio do desafio: 07/07/2025
        const CHALLENGE_START_DATE = new Date('2025-07-07T00:00:00');
        // Data final do desafio: 07/10/2025 (90 dias a partir de 07/07/2025)
        const CHALLENGE_END_DATE = new Date('2025-10-07T23:59:59'); 
        const MAX_WEEKS = 12; // N√∫mero total de semanas no desafio
        const MAX_ACTIVITY_POINTS = 50; // Pontua√ß√£o m√°xima para atividade

        // Refer√™ncias aos elementos do DOM
        const participantModal = document.getElementById('participantModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const cancelModalBtn = document.getElementById('cancelModalBtn');
        const addParticipantBtn = document.getElementById('addParticipantBtn');
        const participantForm = document.getElementById('participantForm');
        const modalTitle = document.getElementById('modalTitle');
        const participantIndexInput = document.getElementById('participantIndex');
        const participantNameInput = document.getElementById('participantName');
        const participantInitialWeightInput = document.getElementById('participantInitialWeight');
        const participantFinalWeightInput = document.getElementById('participantFinalWeight');
        const searchParticipantInput = document.getElementById('searchParticipantInput');
        const feedbackMessageDiv = document.getElementById('feedbackMessage');
        const rankingTableBody = document.querySelector('#rankingTable tbody');
        const weeklyParticipationTableHead = document.querySelector('#weeklyParticipationTable thead tr'); // Para adicionar as semanas
        const weeklyParticipationTableBody = document.querySelector('#weeklyParticipationTable tbody');
        const activityChartDiv = document.getElementById('activityChart');
        const noRankingData = document.getElementById('noRankingData');
        const noWeeklyData = document.getElementById('noWeeklyData');
        const noChartData = document.getElementById('noChartData');

        // Refer√™ncias para mensagens de erro
        const nameError = document.getElementById('nameError');
        const initialWeightError = document.getElementById('initialWeightError');
        const finalWeightError = document.getElementById('finalWeightError');

        // Refer√™ncias para o modal de exclus√£o
        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const closeDeleteModalBtn = document.getElementById('closeDeleteModalBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const participantNameToDeleteSpan = document.getElementById('participantNameToDelete');
        let participantToDeleteName = null; // Vari√°vel para armazenar o nome do participante a ser exclu√≠do

        // Bot√µes de exportar/importar/resetar
        const exportDataBtn = document.getElementById('exportDataBtn');
        const importDataInput = document.getElementById('importDataInput');
        const importDataBtn = document.getElementById('importDataBtn');
        const resetDataBtn = document.getElementById('resetDataBtn');

        /**
         * Fun√ß√£o utilit√°ria para debounce.
         * @param {Function} func A fun√ß√£o a ser debounced.
         * @param {number} delay O atraso em milissegundos.
         * @returns {Function} A fun√ß√£o debounced.
         */
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        /**
         * Salva os dados dos participantes no localStorage.
         */
        function saveData() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(participants));
                showFeedbackMessage("Dados salvos com sucesso!");
            } catch (e) {
                console.error("Erro ao salvar dados no localStorage:", e);
                showFeedbackMessage("Erro ao salvar dados!", true); // Exibe mensagem de erro
            }
        }

        /**
         * Exibe uma mensagem de feedback tempor√°ria.
         * @param {string} message A mensagem a ser exibida.
         * @param {boolean} isError Se a mensagem √© de erro (opcional, padr√£o: false).
         */
        function showFeedbackMessage(message, isError = false) {
            feedbackMessageDiv.textContent = message;
            feedbackMessageDiv.classList.remove('bg-green-500', 'bg-red-500', 'error'); // Limpa classes anteriores
            feedbackMessageDiv.classList.add(isError ? 'bg-red-500' : 'bg-green-500'); // Adiciona cor correta
            if (isError) {
                feedbackMessageDiv.classList.add('error'); // Adiciona classe 'error' para estilos espec√≠ficos de erro
            }
            feedbackMessageDiv.classList.add(SHOW_CLASS);
            setTimeout(() => {
                feedbackMessageDiv.classList.remove(SHOW_CLASS);
                feedbackMessageDiv.classList.remove('error'); // Remove a classe 'error' ap√≥s a transi√ß√£o
            }, 3000); // Mensagem desaparece ap√≥s 3 segundos
        }

        /**
         * Exibe uma mensagem de erro para um input espec√≠fico.
         * @param {HTMLElement} inputElement O elemento input.
         * @param {HTMLElement} errorElement O elemento onde a mensagem de erro ser√° exibida.
         * @param {string} message A mensagem de erro.
         */
        function displayError(inputElement, errorElement, message) {
            errorElement.textContent = message;
            errorElement.classList.remove(HIDDEN_CLASS);
            inputElement.classList.add(INPUT_ERROR_CLASS);
        }

        /**
         * Esconde a mensagem de erro para um input espec√≠fico.
         * @param {HTMLElement} inputElement O elemento input.
         * @param {HTMLElement} errorElement O elemento onde a mensagem de erro √© exibida.
         */
        function hideError(inputElement, errorElement) {
            errorElement.classList.add(HIDDEN_CLASS);
            inputElement.classList.remove(INPUT_ERROR_CLASS);
        }

        /**
         * Limpa todas as mensagens de erro e estilos de erro dos inputs.
         */
        function clearErrorMessages() {
            hideError(participantNameInput, nameError);
            hideError(participantInitialWeightInput, initialWeightError);
            hideError(participantFinalWeightInput, finalWeightError);
        }

        /**
         * Abre o modal para adicionar ou editar um participante.
         * @param {number|null} index O √≠ndice do participante a ser editado, ou null para adicionar.
         */
        function openModal(index = null) {
            // Limpa os campos e mensagens de erro
            participantForm.reset();
            clearErrorMessages();

            if (index !== null) {
                // Modo de edi√ß√£o
                modalTitle.textContent = 'Editar Participante';
                const p = participants[index];
                participantIndexInput.value = index;
                participantNameInput.value = p.name;
                participantInitialWeightInput.value = p.pesoInicial;
                participantFinalWeightInput.value = p.pesoFinal;
            } else {
                // Modo de adi√ß√£o
                modalTitle.textContent = 'Adicionar Novo Participante';
                participantIndexInput.value = ''; // Limpa o √≠ndice para indicar nova adi√ß√£o
            }
            participantModal.classList.add(SHOW_CLASS); // Adiciona a classe 'show' para exibir e aplicar transi√ß√£o
        }

        /**
         * Fecha o modal.
         */
        function closeModal() {
            participantModal.classList.remove(SHOW_CLASS); // Remove a classe 'show' para esconder e aplicar transi√ß√£o
        }

        /**
         * Abre o modal de confirma√ß√£o de exclus√£o.
         * @param {string} name O nome do participante a ser exclu√≠do.
         */
        function openDeleteModal(name) {
            participantNameToDeleteSpan.textContent = name;
            participantToDeleteName = name; // Armazena o nome para uso na exclus√£o
            deleteConfirmModal.classList.add(SHOW_CLASS);
        }

        /**
         * Fecha o modal de confirma√ß√£o de exclus√£o.
         */
        function closeDeleteModal() {
            deleteConfirmModal.classList.remove(SHOW_CLASS);
            participantToDeleteName = null; // Limpa o nome armazenado
        }

        /**
         * Lida com a exclus√£o de um participante.
         */
        function deleteParticipant() {
            if (participantToDeleteName) {
                const indexToDelete = participants.findIndex(p => p.name === participantToDeleteName);
                if (indexToDelete !== -1) {
                    participants.splice(indexToDelete, 1); // Remove o participante do array
                    saveData(); // Salva os dados atualizados
                    updatePlanilha(); // Atualiza a UI
                    showFeedbackMessage(`Participante "${participantToDeleteName}" exclu√≠do com sucesso!`);
                } else {
                    showFeedbackMessage(`Erro: Participante "${participantToDeleteName}" n√£o encontrado.`, true);
                }
            }
            closeDeleteModal(); // Fecha o modal de confirma√ß√£o
        }

        /**
         * Valida os campos do formul√°rio do modal.
         * @returns {boolean} True se os campos s√£o v√°lidos, false caso contr√°rio.
         */
        function validateForm() {
            clearErrorMessages();
            let isValid = true;

            const name = participantNameInput.value.trim();
            const initialWeight = parseFloat(participantInitialWeightInput.value);
            const finalWeight = parseFloat(participantFinalWeightInput.value);
            const index = participantIndexInput.value;

            if (name === '') {
                displayError(participantNameInput, nameError, "O nome √© obrigat√≥rio.");
                isValid = false;
            } else {
                // Valida√ß√£o de nome duplicado
                const isEditing = index !== '';
                const isNameTaken = participants.some((p, i) => 
                    p.name.toLowerCase() === name.toLowerCase() && (!isEditing || i !== parseInt(index))
                );
                if (isNameTaken) {
                    displayError(participantNameInput, nameError, "J√° existe um participante com este nome.");
                    isValid = false;
                }
            }

            if (isNaN(initialWeight) || initialWeight <= 0) {
                displayError(participantInitialWeightInput, initialWeightError, "Peso inicial deve ser um n√∫mero positivo.");
                isValid = false;
            }

            if (isNaN(finalWeight) || finalWeight <= 0) {
                displayError(participantFinalWeightInput, finalWeightError, "Peso final deve ser um n√∫mero positivo.");
                isValid = false;
            }

            return isValid;
        }

        /**
         * Lida com o envio do formul√°rio do modal (adicionar/editar participante).
         * @param {Event} event O evento de envio.
         */
        function handleParticipantFormSubmit(event) {
            event.preventDefault(); // Impede o recarregamento da p√°gina

            if (!validateForm()) {
                return; // Se a valida√ß√£o falhar, n√£o prossegue
            }

            const name = participantNameInput.value.trim();
            const initialWeight = parseFloat(participantInitialWeightInput.value);
            const finalWeight = parseFloat(participantFinalWeightInput.value);
            const index = participantIndexInput.value;

            if (index !== '') {
                // Edi√ß√£o de participante existente
                const existingParticipant = participants[parseInt(index)];
                existingParticipant.name = name;
                existingParticipant.pesoInicial = initialWeight;
                existingParticipant.pesoFinal = finalWeight;
            } else {
                // Adi√ß√£o de novo participante
                const newParticipant = {
                    name: name,
                    pesoInicial: initialWeight,
                    pesoFinal: finalWeight,
                    semanasValidas: Array(MAX_WEEKS).fill(false) // Novas semanas vazias
                };
                participants.push(newParticipant);
            }

            saveData(); // Salva os dados no localStorage
            updatePlanilha(); // Recalcula e atualiza a UI
            closeModal(); // Fecha o modal
        }

        /**
         * Calcula a pontua√ß√£o de peso com base na porcentagem de perda.
         * @param {number} initialWeight Peso inicial do participante.
         * @param {number} finalWeight Peso final do participante.
         * @returns {object} Um objeto contendo a porcentagem de perda e os pontos de peso.
         */
        function calculateWeightLossPoints(initialWeight, finalWeight) {
            const pesoPerdido = initialWeight - finalWeight;
            let percentLoss = (pesoPerdido / initialWeight) * 100;

            if (isNaN(percentLoss) || percentLoss < 0) {
                percentLoss = 0; // Se ganhou peso ou c√°lculo inv√°lido, % perda √© 0
            }

            let points = 0;
            if (percentLoss >= 10) {
                points = 50;
            } else if (percentLoss >= 8) {
                points = 45;
            } else if (percentLoss >= 6) {
                points = 40;
            } else if (percentLoss >= 4) {
                points = 35;
            } else if (percentLoss >= 2) {
                points = 30;
            } else if (percentLoss >= 1) {
                points = 20;
            } else if (percentLoss > 0 && percentLoss < 1) {
                points = 10;
            } else {
                points = 0;
            }

            return { percentLoss: percentLoss, points: points };
        }

        /**
         * Calcula a pontua√ß√£o de atividade com base no n√∫mero de semanas v√°lidas.
         * @param {number} validWeeks N√∫mero de semanas em que o participante fez 3+ treinos.
         * @returns {number} Pontos de atividade.
         */
        function calculateActivityPoints(validWeeks) {
            return (validWeeks / MAX_WEEKS) * MAX_ACTIVITY_POINTS;
        }

        /**
         * Calcula todas as m√©tricas para um participante.
         * @param {object} participant O objeto participante.
         * @returns {object} O objeto participante com m√©tricas calculadas.
         */
        function calculateParticipantMetrics(participant) {
            const { percentLoss, points: weightPoints } = calculateWeightLossPoints(participant.pesoInicial, participant.pesoFinal);
            const validWeeksCount = participant.semanasValidas.filter(s => s).length; // Conta as semanas marcadas como true
            const activityPoints = calculateActivityPoints(validWeeksCount);
            const totalPoints = weightPoints + activityPoints;
            const percentActivities = (activityPoints / MAX_ACTIVITY_POINTS) * 100;

            return {
                ...participant, // Retorna todas as propriedades originais
                percentLoss: parseFloat(percentLoss.toFixed(2)),
                weightPoints: parseFloat(weightPoints.toFixed(2)),
                validWeeksCount: validWeeksCount,
                activityPoints: parseFloat(activityPoints.toFixed(2)),
                totalPoints: parseFloat(totalPoints.toFixed(2)),
                percentActivities: parseFloat(percentActivities.toFixed(1)),
            };
        }

        /**
         * Atualiza as tabelas e o gr√°fico da planilha com os dados dos participantes.
         */
        function updatePlanilha() {
            rankingTableBody.innerHTML = ''; // Limpa as linhas existentes
            weeklyParticipationTableBody.innerHTML = '';
            activityChartDiv.innerHTML = '';

            // Filtrar participantes com base na busca
            const searchTerm = searchParticipantInput.value.toLowerCase().trim();
            const filteredParticipants = participants.filter(p => 
                p.name.toLowerCase().includes(searchTerm)
            );

            // Calcular todos os dados para cada participante filtrado
            const calculatedParticipants = filteredParticipants.map(calculateParticipantMetrics);

            // Ordenar participantes por pontua√ß√£o total para o ranking
            const rankedParticipants = [...calculatedParticipants].sort((a, b) => b.totalPoints - a.totalPoints);

            // Preencher a tabela de Ranking
            if (rankedParticipants.length === 0) {
                noRankingData.classList.remove(HIDDEN_CLASS);
            } else {
                noRankingData.classList.add(HIDDEN_CLASS);
                rankedParticipants.forEach((p, index) => {
                    let crownEmoji = '';
                    if (index === 0) {
                        crownEmoji = 'üëë'; // Ouro
                    } else if (index === 1) {
                        crownEmoji = 'ü•à'; // Prata
                    } else if (index === 2) {
                        crownEmoji = 'ü•â'; // Bronze
                    }

                    const row = rankingTableBody.insertRow();
                    if (index === 0) { // Destaca o l√≠der
                        row.classList.add('leader-row');
                    }
                    row.innerHTML = `
                        <td class="font-semibold">${index + 1} ${crownEmoji}</td>
                        <td><a href="#" class="text-blue-600 hover:underline edit-participant" data-name="${p.name}">${p.name}</a></td>
                        <td>${p.pesoInicial.toFixed(1)}</td>
                        <td>${p.pesoFinal.toFixed(1)}</td>
                        <td>${p.percentLoss.toFixed(2)}%</td>
                        <td>${p.weightPoints.toFixed(2)}</td>
                        <td>${p.validWeeksCount}</td>
                        <td>${p.activityPoints.toFixed(2)}</td>
                        <td class="font-bold">${p.totalPoints.toFixed(2)}</td>
                        <td class="flex items-center space-x-2">
                            <button class="text-blue-500 hover:text-blue-700 edit-participant-icon" data-name="${p.name}" aria-label="Editar participante ${p.name}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                            </button>
                            <button class="text-red-500 hover:text-red-700 delete-participant-icon" data-name="${p.name}" aria-label="Excluir participante ${p.name}">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                            </button>
                        </td>
                    `;
                });
            }

            // 1. Determine which weeks are "active" (at least one participant completed it)
            const activeWeeksStatus = Array(MAX_WEEKS).fill(false);
            participants.forEach(p => {
                p.semanasValidas.forEach((isValid, weekIndex) => {
                    if (isValid) {
                        activeWeeksStatus[weekIndex] = true;
                    }
                });
            });

            // Calcular a semana atual
            const today = new Date();
            const diffTime = today.getTime() - CHALLENGE_START_DATE.getTime();
            // Adiciona 1 para que a primeira semana seja a semana 1, n√£o a semana 0
            const currentWeek = Math.floor(diffTime / MILLISECONDS_PER_WEEK) + 1; 

            // Preencher o cabe√ßalho da tabela de Participa√ß√£o Semanal com as semanas
            let weekHeaders = `<th class="rounded-tl-xl">Nome
                                    <span class="tooltip">
                                        <span class="tooltiptext">Semanas de 1 a 12. Marque a caixa se a semana for v√°lida (3+ treinos).</span>
                                    </span>
                                </th>`;
            for (let i = 1; i <= MAX_WEEKS; i++) {
                const isCurrentWeek = i === currentWeek;
                weekHeaders += `<th class="${isCurrentWeek ? 'current-week' : ''}">${i}</th>`;
            }
            // Adiciona rounded-tr-xl ao √∫ltimo th gerado
            weekHeaders = weekHeaders.replace(/<th class="([^"]*)">12<\/th>/, `<th class="$1 rounded-tr-xl">12</th>`);
            weeklyParticipationTableHead.innerHTML = weekHeaders;


            // Criar uma c√≥pia dos participantes filtrados e ordenar alfabeticamente para a tabela semanal
            const alphabeticalFilteredParticipants = [...filteredParticipants].sort((a, b) => a.name.localeCompare(b.name));

            // Preencher a tabela de Participa√ß√£o Semanal
            if (alphabeticalFilteredParticipants.length === 0) {
                noWeeklyData.classList.remove(HIDDEN_CLASS);
            } else {
                noWeeklyData.classList.add(HIDDEN_CLASS);
                alphabeticalFilteredParticipants.forEach(p => {
                    const row = weeklyParticipationTableBody.insertRow();
                    let weeklyCells = `<td class="font-medium">${p.name}</td>`;
                    p.semanasValidas.forEach((isValid, weekIndex) => {
                        let cellClasses = 'checkbox-cell';
                        // Aplica fundo vermelho se n√£o for v√°lido E algu√©m mais completou esta semana
                        if (!isValid && activeWeeksStatus[weekIndex]) {
                            cellClasses += ' missed-week-cell';
                        }
                        // Adiciona classe para a semana atual
                        if (weekIndex + 1 === currentWeek) {
                            cellClasses += ' current-week-cell';
                        }
                        weeklyCells += `
                            <td class="${cellClasses}">
                                <input type="checkbox" ${isValid ? 'checked' : ''} data-name="${p.name}" data-week="${weekIndex}">
                            </td>
                        `;
                    });
                    row.innerHTML = weeklyCells;
                });
            }

            // Ordenar participantes para o gr√°fico de atividades por percentual (do maior para o menor)
            const chartSortedParticipants = [...calculatedParticipants].sort((a, b) => b.percentActivities - a.percentActivities);

            // Preencher o gr√°fico de Participa√ß√£o nas Atividades
            if (chartSortedParticipants.length === 0) {
                noChartData.classList.remove(HIDDEN_CLASS);
            } else {
                noChartData.classList.add(HIDDEN_CLASS);
                chartSortedParticipants.forEach(p => {
                    const chartItem = document.createElement('div');
                    // Adjusted classes for closer spacing and centered content
                    chartItem.className = 'flex flex-col items-center justify-center text-center';
                    chartItem.innerHTML = `
                        <div class="relative w-16 h-16 mb-1"> <!-- Increased container size for larger SVG -->
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <defs>
                                    <clipPath id="fillClip-${p.name.replace(/\s/g, '')}">
                                        <!-- The person's total height in the viewBox is from y=2 (top of head) to y=22 (bottom of feet), so 20 units. -->
                                        <!-- The fill should start from the bottom (y=22) and go upwards. -->
                                        <rect x="0"
                                            y="${22 - (20 * (p.percentActivities / 100))}"
                                            width="24"
                                            height="${20 * (p.percentActivities / 100)}"></rect>
                                    </clipPath>
                                </defs>

                                <!-- Base (empty) person - light gray -->
                                <circle cx="12" cy="5" r="3" fill="#d1d5db"/> <!-- Head -->
                                <rect x="10" y="8" width="4" height="8" fill="#d1d5db"/> <!-- Torso -->
                                <rect x="6" y="9" width="4" height="2" fill="#d1d5db"/> <!-- Left Arm -->
                                <rect x="14" y="9" width="4" height="2" fill="#d1d5db"/> <!-- Right Arm -->
                                <rect x="9" y="16" width="2" height="6" fill="#d1d5db"/> <!-- Left Leg -->
                                <rect x="13" y="16" width="2" height="6" fill="#d1d5db"/> <!-- Right Leg -->

                                <!-- Filled person - green, clipped by the dynamic rectangle -->
                                <g clip-path="url(#fillClip-${p.name.replace(/\s/g, '')})">
                                    <circle cx="12" cy="5" r="3" fill="#34d399" class="activity-fill"/> <!-- Head -->
                                    <rect x="10" y="8" width="4" height="8" fill="#34d399" class="activity-fill"/> <!-- Torso -->
                                    <rect x="6" y="9" width="4" height="2" fill="#34d399" class="activity-fill"/> <!-- Left Arm -->
                                    <rect x="14" y="9" width="4" height="2" fill="#34d399" class="activity-fill"/> <!-- Right Arm -->
                                    <rect x="9" y="16" width="2" height="6" fill="#34d399" class="activity-fill"/> <!-- Left Leg -->
                                    <rect x="13" y="16" width="2" height="6" fill="#34d399" class="activity-fill"/> <!-- Right Leg -->
                                </g>
                            </svg>
                        </div>
                        <div class="text-center text-sm font-medium leading-tight">${p.name} - <span class="font-bold">${p.percentActivities.toFixed(1)}%</span></div>
                    `;
                    activityChartDiv.appendChild(chartItem);
                });
            }

            // Atualizar os boxes de l√≠der e dias restantes
            updateSummaryBoxes(rankedParticipants);
        }

        /**
         * Lida com a mudan√ßa nos checkboxes de semanas v√°lidas.
         * @param {Event} event O evento de mudan√ßa.
         */
        function handleCheckboxChange(event) {
            const name = event.target.dataset.name;
            const weekIndex = parseInt(event.target.dataset.week);
            const isChecked = event.target.checked;

            const participant = participants.find(p => p.name === name);
            if (participant) {
                participant.semanasValidas[weekIndex] = isChecked;
                updatePlanilha(); // Recalcula e atualiza a UI
                // N√£o salva automaticamente aqui, o bot√£o "Salvar Dados" far√° isso
            }
        }

        /**
         * Atualiza os boxes de l√≠der atual e dias restantes.
         * @param {Array} rankedParticipants O array de participantes j√° ordenado por pontua√ß√£o.
         */
        function updateSummaryBoxes(rankedParticipants) {
            const leaderBox = document.getElementById('leaderBox');
            const daysRemainingBox = document.getElementById('daysRemainingBox');

            // L√≠der Atual: Pega o primeiro participante do array j√° ordenado por pontua√ß√£o
            const currentLeader = rankedParticipants[0]; 
            if (currentLeader) {
                leaderBox.innerHTML = `
                    <div class="text-xl font-bold text-gray-800 mb-2">üëë L√≠der: <span class="text-green-700">${currentLeader.name}</span></div>
                    <div class="text-lg text-gray-700">Total: <span class="font-bold">${currentLeader.totalPoints.toFixed(2)} pts</span></div>
                    <div class="text-sm text-gray-600">
                        (Peso: ${currentLeader.weightPoints.toFixed(2)} pts | Atividade: ${currentLeader.activityPoints.toFixed(2)} pts)
                    </div>
                `;
            } else {
                leaderBox.innerHTML = `L√≠der Atual: N/A`;
            }

            // Datas do desafio
            const today = new Date();
            const startDate = CHALLENGE_START_DATE;
            const endDate = CHALLENGE_END_DATE;

            // Calcula dias restantes
            let daysRemaining = Math.ceil((endDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
            if (daysRemaining < 0) daysRemaining = 0; // Se o desafio j√° terminou

            // Formata as datas de in√≠cio e fim
            const startDateFormatted = startDate.toLocaleDateString('pt-BR');
            const endDateFormatted = endDate.toLocaleDateString('pt-BR');

            let countdownMessage = '';
            let countdownColorClass = '';

            if (daysRemaining > 0) {
                countdownMessage = `Faltam <span class="days-value">${daysRemaining}</span> dias para o final do desafio!`;
                countdownColorClass = 'text-blue-600'; // Azul para dias restantes
            } else if (daysRemaining === 0) {
                countdownMessage = `O desafio termina <span class="font-bold">hoje!</span>`;
                countdownColorClass = 'text-yellow-600'; // Amarelo para hoje
            } else {
                countdownMessage = `O desafio <span class="font-bold">j√° terminou!</span>`;
                countdownColorClass = 'text-red-600'; // Vermelho para terminado
            }

            daysRemainingBox.innerHTML = `
                <div class="flex justify-around mb-2 text-gray-700">
                    <div>
                        <span class="date-label">üèÅ In√≠cio:</span> <span class="date-value">${startDateFormatted}</span>
                    </div>
                    <div>
                        <span class="date-label">üèÜ Fim:</span> <span class="date-value">${endDateFormatted}</span>
                    </div>
                </div>
                <div class="countdown-message ${countdownColorClass}">
                    ${countdownMessage}
                </div>
            `;
        }

        // Inicializa a planilha ao carregar a p√°gina
        window.onload = () => {
            updatePlanilha();
            // Adiciona listener para o bot√£o de salvar
            document.getElementById('saveDataBtn').addEventListener('click', saveData);

            // Listeners para o modal de adicionar/editar
            addParticipantBtn.addEventListener('click', () => openModal());
            closeModalBtn.addEventListener('click', closeModal);
            cancelModalBtn.addEventListener('click', closeModal);
            participantModal.addEventListener('click', (e) => {
                if (e.target === participantModal) {
                    closeModal(); // Fecha o modal se clicar fora do conte√∫do
                }
            });
            participantForm.addEventListener('submit', handleParticipantFormSubmit);

            // Listeners para o modal de exclus√£o
            closeDeleteModalBtn.addEventListener('click', closeDeleteModal);
            cancelDeleteBtn.addEventListener('click', closeDeleteModal);
            confirmDeleteBtn.addEventListener('click', deleteParticipant);
            deleteConfirmModal.addEventListener('click', (e) => {
                if (e.target === deleteConfirmModal) {
                    closeDeleteModal(); // Fecha o modal se clicar fora do conte√∫do
                }
            });

            // Listener para o campo de busca com debounce
            searchParticipantInput.addEventListener('keyup', debounce(updatePlanilha, 300)); // Debounce de 300ms

            // Event delegation para a tabela de ranking (edi√ß√£o e exclus√£o)
            rankingTableBody.addEventListener('click', function(event) {
                const target = event.target.closest('.edit-participant, .edit-participant-icon, .delete-participant-icon');
                if (!target) return; // Se o clique n√£o foi em um dos bot√µes/links

                event.preventDefault(); // Evita o comportamento padr√£o do link/bot√£o

                const participantName = target.dataset.name;

                if (target.classList.contains('edit-participant') || target.classList.contains('edit-participant-icon')) {
                    const indexToEdit = participants.findIndex(p => p.name === participantName);
                    if (indexToEdit !== -1) {
                        openModal(indexToEdit);
                    }
                } else if (target.classList.contains('delete-participant-icon')) {
                    openDeleteModal(participantName);
                }
            });

            // Event delegation para checkboxes na tabela de participa√ß√£o semanal
            weeklyParticipationTableBody.addEventListener('change', function(event) {
                if (event.target.type === 'checkbox') {
                    handleCheckboxChange(event);
                }
            });

            // Listeners para exportar, importar e resetar dados
            exportDataBtn.addEventListener('click', () => {
                const dataStr = JSON.stringify(participants, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'desafio_fit_data.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showFeedbackMessage("Dados exportados como desafio_fit_data.json!");
            });

            importDataBtn.addEventListener('click', () => {
                importDataInput.click(); // Simula o clique no input de arquivo
            });

            importDataInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const importedData = JSON.parse(e.target.result);
                            // Valida√ß√£o b√°sica para garantir que os dados importados s√£o v√°lidos
                            if (Array.isArray(importedData) && importedData.every(p => 
                                typeof p.name === 'string' && p.name.trim() !== '' &&
                                typeof p.pesoInicial === 'number' && p.pesoInicial > 0 &&
                                typeof p.pesoFinal === 'number' && p.pesoFinal > 0 &&
                                Array.isArray(p.semanasValidas) && p.semanasValidas.length === MAX_WEEKS &&
                                p.semanasValidas.every(s => typeof s === 'boolean')
                            )) {
                                participants = importedData;
                                saveData();
                                updatePlanilha();
                                showFeedbackMessage("Dados importados com sucesso!");
                            } else {
                                showFeedbackMessage("Formato de arquivo JSON inv√°lido. Verifique a estrutura dos dados.", true);
                            }
                        } catch (error) {
                            console.error("Erro ao ler ou parsear arquivo JSON:", error);
                            showFeedbackMessage("Erro ao importar dados. Verifique o arquivo.", true);
                        }
                    };
                    reader.readAsText(file);
                }
                // Limpa o valor do input de arquivo para permitir a importa√ß√£o do mesmo arquivo novamente
                event.target.value = ''; 
            });

            resetDataBtn.addEventListener('click', () => {
                // Usar um modal de confirma√ß√£o customizado em vez de `confirm()`
                openConfirmResetModal();
            });

            // Fun√ß√µes para o modal de confirma√ß√£o de reset
            function openConfirmResetModal() {
                // Reutilizar o modal de exclus√£o, mas com texto diferente
                participantNameToDeleteSpan.textContent = "todos os dados"; // Altera o texto para o reset
                deleteConfirmModal.querySelector('h3').textContent = "Confirmar Resetar Dados";
                deleteConfirmModal.querySelector('p').innerHTML = "Tem certeza que deseja <span class='font-semibold text-red-600'>resetar todos os dados</span>? Isso ir√° APAGAR tudo e carregar os participantes padr√£o.";
                confirmDeleteBtn.textContent = "Resetar";
                confirmDeleteBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                confirmDeleteBtn.classList.add('bg-orange-500', 'hover:bg-orange-600'); // Cor diferente para reset

                // Adiciona um listener tempor√°rio para a a√ß√£o de reset
                confirmDeleteBtn.onclick = () => {
                    participants = JSON.parse(JSON.stringify(defaultParticipants)); // Deep copy para n√£o referenciar o default
                    saveData();
                    updatePlanilha();
                    showFeedbackMessage("Dados resetados para o padr√£o com sucesso!");
                    closeDeleteModal();
                    // Restaura os textos e classes originais do modal de exclus√£o
                    restoreDeleteModalDefaults();
                };
                cancelDeleteBtn.onclick = () => {
                    closeDeleteModal();
                    restoreDeleteModalDefaults();
                };

                deleteConfirmModal.classList.add(SHOW_CLASS);
            }

            function restoreDeleteModalDefaults() {
                deleteConfirmModal.querySelector('h3').textContent = "Confirmar Exclus√£o";
                deleteConfirmModal.querySelector('p').innerHTML = "Tem certeza que deseja excluir <span id='participantNameToDelete' class='font-semibold text-red-600'></span> do desafio?";
                confirmDeleteBtn.textContent = "Excluir";
                confirmDeleteBtn.classList.remove('bg-orange-500', 'hover:bg-orange-600');
                confirmDeleteBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                // Restaura os listeners originais
                confirmDeleteBtn.onclick = deleteParticipant;
                cancelDeleteBtn.onclick = closeDeleteModal;
            }
        };
    </script>
</body>
</html>